<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咨询任务管理系统 4.2.3 (协作版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        #root:empty::before {
            content: "正在加载应用...";
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.5rem;
            color: #6b7280;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .action-column {}

        @keyframes pulse-bg {

            0%,
            100% {
                background-color: #fef3c7;
            }

            50% {
                background-color: #fde68a;
            }
        }

        .banner-pulse {
            animation: pulse-bg 4s infinite ease-in-out;
        }

        .dark .banner-pulse {
            animation-name: pulse-bg-dark;
        }

        @keyframes pulse-bg-dark {

            0%,
            100% {
                background-color: rgba(217, 119, 6, 0.2);
            }

            50% {
                background-color: rgba(217, 119, 6, 0.3);
            }
        }

        input[type="date"] {
            position: relative;
        }

        input[type="date"]:not([value*="-"])::-webkit-datetime-edit {
            color: transparent;
        }

        input[type="date"]:not([value*="-"])::before {
            content: attr(placeholder);
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            color: #9ca3af;
            pointer-events: none;
        }

        .dark input[type="date"]:not([value*="-"])::before {
            color: #6b7280;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        .quote-modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .quote-modal-exit {
            animation: fadeOut 0.3s ease-in forwards;
        }

        .quote-bubble {
            position: relative;
            background: linear-gradient(to right, #d4fc79, #96e6a1);
            /* fallback */
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            /* Green to Blue */
        }

        .dark .quote-bubble {
            background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
        }

        .quote-bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 12px solid transparent;
            border-top-color: #8fd3f4;
            /* Match gradient end color */
            border-bottom: 0;
            margin-left: -12px;
            margin-bottom: -12px;
        }

        .dark .quote-bubble::after {
            border-top-color: #2c5364;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>

<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useMemo, useCallback, useRef, useLayoutEffect } = React;

        // --- 1. 初始化 Supabase 客户端 ---
        const supabaseUrl = 'https://ybhopioytqpjmoojslfv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliaG9waW95dHFwam1vb2pzbGZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTEzODEsImV4cCI6MjA3MTY4NzM4MX0.c5Qzde1oi54g3oCK0uEClZ-MdzD7OMMoKrmrfVLzHNc';
        const { createClient } = window.supabase;
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- 全局辅助函数 ---
        const fromSnakeCase = (task) => {
            if (!task) return null;
            return {
                id: task.id,
                createdAt: task.created_at,
                updatedAt: task.updated_at,
                customTaskId: task.custom_task_id,
                projectName: task.project_name,
                region: task.region,
                taskType: task.task_type,
                department: task.department,
                contractAmount: task.contract_amount,
                salesPerson: task.sales_person,
                projectManager: task.project_manager,
                isArchived: task.is_archived,
                status: task.status,
                contractualDueDate: task.contractual_due_date,
                actualCompletionDate: task.actual_completion_date,
                progressDetails: task.progress_details,
                history: task.history
            };
        };

        const toSnakeCase = (data) => ({
            custom_task_id: data.customTaskId,
            project_name: data.projectName,
            region: data.region,
            task_type: data.taskType,
            department: data.department,
            contract_amount: data.contractAmount,
            sales_person: data.salesPerson,
            project_manager: data.projectManager,
            is_archived: data.isArchived,
            status: data.status,
            progress_details: data.progressDetails,
            history: data.history,
            created_at: data.createdAt,
            updated_at: new Date().toISOString(),
            contractual_due_date: data.contractualDueDate || null,
            actual_completion_date: data.actualCompletionDate || null,
        });

        // --- Icon Components (您的所有图标组件) ---
        const Icon = ({ children, size = 20, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const Edit = (props) => <Icon {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12"></polyline></Icon>;
        const Archive = (props) => <Icon {...props}><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></Icon>;
        const BarChart2 = (props) => <Icon {...props}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></Icon>;
        const Ban = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></Icon>;
        const Bell = (props) => <Icon {...props}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 3.46l.22.38a2 2 0 0 0 1.73 1l.25.43a2 2 0 0 1-3.46 2l-.38-.22a2 2 0 0 0-1-1.73V20a2 2 0 0 0 2 2h4.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2-3.46l-.22-.38a2 2 0 0 0-1-1.73l-.25-.43a2 2 0 0 1 3.46-2l.38.22a2 2 0 0 0 1 1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
        const Maximize = (props) => <Icon {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></Icon>;
        const Minimize = (props) => <Icon {...props}><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>;
        const ArrowUpDown = (props) => <Icon {...props}><path d="m21 16-4 4-4-4m-12-8 4-4 4 4" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 2v6h6"></path><path d="M3 13a9 9 0 1 0 3-7.7L3 8"></path></Icon>;
        const ChevronDown = (props) => <Icon {...props}><polyline points="6 9 12 15 18 9"></polyline></Icon>;
        const MoreHorizontal = (props) => <Icon {...props}><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></Icon>;
        const Moon = (props) => <Icon {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></Icon>;
        const Sun = (props) => <Icon {...props}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></Icon>;
        const Database = (props) => <Icon {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></Icon>;
        const Calendar = (props) => <Icon {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></Icon>;
        const LogOut = (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></Icon>;
        const Users = (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></Icon>;

        // --- 您的所有UI组件和辅助函数 ---
        const GRID_COLS = { INPROGRESS: "grid-cols-[auto_0.9fr_0.9fr_2.25fr_1.5fr_1.45fr_1.2fr_0.8fr_0.8fr_0.9fr_3.5fr_1fr_0.65fr_0.45fr]", DONE: "grid-cols-[auto_0.9fr_0.9fr_2.25fr_1.5fr_1.45fr_1.2fr_0.8fr_0.8fr_0.9fr_0.9fr_3fr_0.8fr_0.65fr_0.45fr]", DELETED: "grid-cols-[auto_1.2fr_2.5fr_1.8fr_1.2fr_1.5fr_1.5fr]" };
        const FIELD_LABELS = { projectName: "项目名称", region: "所属地区", taskType: "任务类型", department: "所属部门", salesPerson: "业务人员", projectManager: "项目负责人", contractAmount: "合同金额", contractualDueDate: "合同规定完成日期", actualCompletionDate: "实际完成日期", isArchived: "存档状态", createdAt: "任务下达日期" };
        const formatDate = (dateStr) => { if (!dateStr) return ''; try { const d = new Date(dateStr); return isNaN(d.getTime()) ? '' : d.toISOString().split('T')[0]; } catch (e) { return ''; } };
        const formatDateTime = (dateStr) => { if (!dateStr) return ''; try { return new Date(dateStr).toLocaleString('zh-CN', { hour12: false }); } catch (e) { return ''; } };
        const formatDuration = (totalDays) => { if (totalDays === null || isNaN(totalDays)) return { status: '-', time: '' }; if (totalDays === 0) return { status: '今天截止', time: '' }; const status = totalDays < 0 ? '已逾期' : '剩余'; const absDays = Math.abs(totalDays); if (absDays < 30) return { status, time: `${absDays}天` }; const years = Math.floor(absDays / 365); const months = Math.floor((absDays % 365) / 30); const days = (absDays % 365) % 30; let parts = []; if (years > 0) parts.push(`${years}年`); if (months > 0) parts.push(`${months}月`); if (days > 0) parts.push(`${days}天`); return { status, time: parts.join('') }; };
        const formatAmount = (amount) => { if (amount === null || amount === undefined || amount === '' || isNaN(Number(amount))) return 'N/A'; return `${Number(amount).toLocaleString('zh-CN')} 元`; };
        const generateChangeLog = (oldData, newData) => { const changes = []; const getDisplayValue = (value, key) => { if (value === null || value === undefined || value === '') return '[空]'; if (key && (key.toLowerCase().includes('date') || key === 'createdAt')) return `"${formatDate(value)}"`; if (key === 'isArchived') return value ? '"是"' : '"否"'; if (key === 'contractAmount') return `"${formatAmount(value)}"`; return `"${value}"`; }; for (const key in FIELD_LABELS) { if (key === 'contractAmount') { if (Number(oldData[key] || 0) !== Number(newData[key] || 0)) { changes.push(`编辑: ${FIELD_LABELS[key]} 从 ${getDisplayValue(oldData[key], key)} 修改为 ${getDisplayValue(newData[key], key)}`); } } else { const oldValue = oldData[key]; const newValue = newData[key]; const oldFormatted = (key.endsWith('Date') || key === 'createdAt') ? formatDate(oldValue) : oldValue; const newFormatted = (key.endsWith('Date') || key === 'createdAt') ? formatDate(newValue) : newValue; if (String(oldFormatted || '') !== String(newFormatted || '')) { changes.push(`编辑: ${FIELD_LABELS[key]} 从 ${getDisplayValue(oldValue, key)} 修改为 ${getDisplayValue(newValue, key)}`); } } } return changes; };
        function useOutsideAlerter(ref, callback) { useEffect(() => { function handleClickOutside(event) { if (ref.current && !ref.current.contains(event.target)) { callback(); } } document.addEventListener("mousedown", handleClickOutside); return () => { document.removeEventListener("mousedown", handleClickOutside); }; }, [ref, callback]); }
        function useDebounce(value, delay) { const [debouncedValue, setDebouncedValue] = useState(value); useEffect(() => { const handler = setTimeout(() => { setDebouncedValue(value); }, delay); return () => { clearTimeout(handler); }; }, [value, delay]); return debouncedValue; }

        const exportData = async (format, tasksToExport, fileName, visibleColumns, onExportSuccess, viewSelection) => {
            const statusMap = { inprogress: '进行中', done: '已完成', void: '作废' };
            const columnMap = { createdAt: "任务下达日期", customTaskId: "任务编号", projectName: "项目名称", taskType: "任务类型", department: "所属部门", contractAmount: "合同金额", salesPerson: "业务人员", projectManager: "项目负责人", contractualDueDate: "合同规定完成日期", actualCompletionDate: "实际完成日期", progressDetails: "项目进展情况", region: "所属地区", isArchived: "是否存档", status: "状态", timeRemaining: "剩余时间" };

            try {
                if (format === 'excel' || format === 'csv') {
                    if (tasksToExport.length === 0) { alert("没有可导出的任务。"); return; }
                    const headers = visibleColumns.map(key => columnMap[key]);
                    const dataForExport = tasksToExport.map(task => {
                        const row = {};
                        visibleColumns.forEach(key => {
                            const header = columnMap[key];
                            switch (key) {
                                case 'createdAt': case 'contractualDueDate': case 'actualCompletionDate': row[header] = formatDate(task[key]); break;
                                case 'progressDetails': row[header] = (task.progressDetails && task.progressDetails.length > 0) ? [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0].text : ""; break;
                                case 'isArchived': row[header] = task.isArchived ? "是" : "否"; break;
                                case 'status': row[header] = statusMap[task.status] || task.status; break;
                                case 'contractAmount': row[header] = formatAmount(task.contractAmount); break;
                                case 'timeRemaining':
                                    if (task.status === 'inprogress' && task.contractualDueDate) {
                                        const today = new Date(); today.setHours(0, 0, 0, 0);
                                        const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
                                        const diffTime = dueDate.getTime() - today.getTime();
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        const duration = formatDuration(diffDays);
                                        row[header] = `${duration.status} ${duration.time}`;
                                    } else {
                                        row[header] = "N/A";
                                    }
                                    break;
                                default: row[header] = task[key];
                            }
                        });
                        return row;
                    });
                    const ws = window.XLSX.utils.json_to_sheet(dataForExport, { header: headers });
                    if (format === 'excel') {
                        const wb = window.XLSX.utils.book_new();
                        window.XLSX.utils.book_append_sheet(wb, ws, "Tasks");
                        window.XLSX.writeFile(wb, `${fileName}_${formatDate(new Date())}.xlsx`);
                    } else {
                        const csvOutput = window.XLSX.utils.sheet_to_csv(ws);
                        const blob = new Blob([`\uFEFF${csvOutput}`], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.setAttribute('href', url);
                        link.setAttribute('download', `${fileName}_${formatDate(new Date())}.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    if (onExportSuccess) onExportSuccess();

                } else if (format === 'png') {
                    if (!tasksToExport || tasksToExport.length === 0) { alert("没有符合筛选条件的任务可供导出为图片。"); return; }
                    const ALL_COLUMNS = Object.entries(columnMap).map(([key, label]) => ({ key, label }));
                    const columnWidthMap = { projectName: '4fr', progressDetails: '5fr', taskType: '2.5fr', department: '2.5fr', createdAt: '1.8fr', contractualDueDate: '1.8fr', actualCompletionDate: '1.8fr', customTaskId: '1.5fr', contractAmount: '1.8fr', default: '1fr' };
                    const columnsToRender = ALL_COLUMNS.filter(c => visibleColumns.includes(c.key));
                    const gridTemplateColumns = columnsToRender.map(col => columnWidthMap[col.key] || columnWidthMap.default).join(' ');

                    let tableHtml = `<div style="display: grid; grid-template-columns: ${gridTemplateColumns}; gap: 5px; padding: 10px 5px; background-color: #f1f5f9; font-weight: bold; border-bottom: 2px solid #e2e8f0; font-size: 15px;">`;
                    columnsToRender.forEach(col => { tableHtml += `<div style="text-align: center; word-break: break-word;">${col.label}</div>`; });
                    tableHtml += `</div>`;

                    const getRowBgColor = (task, index) => {
                        if (task.status === 'inprogress' && task.contractualDueDate) {
                            const today = new Date(); today.setHours(0, 0, 0, 0);
                            const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
                            const diffTime = dueDate.getTime() - today.getTime();
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (diffDays < 0) return '#fee2e2';
                            if (diffDays <= 7) return '#fef3c7';
                            return '#ecfdf5';
                        }
                        return index % 2 === 0 ? '#ffffff' : '#f8fafc';
                    };

                    tasksToExport.forEach((task, index) => {
                        const bgColor = getRowBgColor(task, index);
                        tableHtml += `<div style="display: grid; grid-template-columns: ${gridTemplateColumns}; gap: 5px; padding: 10px 5px; border-bottom: 1px solid #f1f5f9; background-color: ${bgColor};">`;
                        columnsToRender.forEach(col => {
                            let content = '';
                            switch (col.key) {
                                case 'createdAt': case 'contractualDueDate': case 'actualCompletionDate': content = formatDate(task[col.key]); break;
                                case 'progressDetails': content = (task.progressDetails && task.progressDetails.length > 0) ? [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0].text : ""; break;
                                case 'isArchived': content = task.isArchived ? "是" : "否"; break;
                                case 'status': content = statusMap[task.status] || task.status; break;
                                case 'contractAmount': content = formatAmount(task.contractAmount); break;
                                case 'timeRemaining':
                                    if (task.status === 'inprogress' && task.contractualDueDate) {
                                        const today = new Date(); today.setHours(0, 0, 0, 0);
                                        const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
                                        const diffTime = dueDate.getTime() - today.getTime();
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        const duration = formatDuration(diffDays);
                                        content = `${duration.status} ${duration.time}`;
                                    } else {
                                        content = "N/A";
                                    }
                                    break;
                                default: content = task[col.key] || '';
                            }
                            tableHtml += `<div style="display: flex; align-items: center; justify-content: center; text-align: center; white-space: pre-wrap; word-break: break-word; padding: 2px; width: 100%; height: 100%;">${content}</div>`;
                        });
                        tableHtml += `</div>`;
                    });

                    const dynamicTitle = viewSelection && viewSelection.length > 0 ? `${viewSelection.join('、')} 任务筛选结果` : fileName;
                    const printContainer = document.createElement('div');
                    printContainer.style.position = 'absolute'; printContainer.style.left = '-9999px'; printContainer.style.backgroundColor = '#ffffff'; printContainer.style.padding = '20px'; printContainer.style.width = '2800px'; printContainer.style.fontSize = '14px'; printContainer.style.fontFamily = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif"; printContainer.style.color = '#1e293b';
                    printContainer.innerHTML = `<h2 style="text-align: center; font-size: 24px; margin-bottom: 20px;">${dynamicTitle}</h2>` + tableHtml;
                    document.body.appendChild(printContainer);

                    try {
                        await new Promise(resolve => setTimeout(resolve, 250));
                        const canvas = await window.html2canvas(printContainer, { scale: 1.5, useCORS: true });
                        const image = canvas.toDataURL("image/png", 1.0);
                        if (image === 'data:,') { alert("导出图片失败，生成的图片为空。请重试。"); return; }
                        const link = document.createElement('a');
                        link.download = `${dynamicTitle}_${formatDate(new Date())}.png`; link.href = image; link.click();
                        if (onExportSuccess) onExportSuccess();
                    } catch (e) {
                        console.error("导出PNG时出错:", e);
                        alert("导出图片失败，请查看控制台获取详细信息。");
                    } finally {
                        document.body.removeChild(printContainer);
                    }
                }
            } catch (error) { console.error("Export error:", error); alert(`导出为 ${format} 失败。`); }
        };

        // --- UI Components ---
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, children, confirmVariant = 'primary' }) => { if (!isOpen) return null; const confirmButtonClasses = { primary: 'bg-emerald-500 hover:bg-emerald-600', danger: 'bg-red-500 hover:bg-red-600' }; return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg"> <header className="p-4 border-b dark:border-slate-700"><h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">{title}</h2></header> <div className="p-6 text-gray-600 dark:text-gray-300 max-h-[60vh] overflow-y-auto">{children}</div> <footer className="p-4 flex justify-end gap-4 bg-gray-50 dark:bg-slate-800/50 rounded-b-xl"> <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button> <button onClick={onConfirm} className={`px-6 py-2 rounded-md text-white font-semibold ${confirmButtonClasses[confirmVariant]}`}>确认</button> </footer> </div> </div>); };
        const SmartDropdown = ({ children, trigger, forceDirection = 'auto' }) => { const [isOpen, setIsOpen] = useState(false); const [positionClass, setPositionClass] = useState('mt-1'); const wrapperRef = useRef(null); const triggerRef = useRef(null); const dropdownRef = useRef(null); useOutsideAlerter(wrapperRef, () => setIsOpen(false)); useLayoutEffect(() => { if (isOpen && triggerRef.current && dropdownRef.current) { if (forceDirection === 'up') { setPositionClass('bottom-full mb-1'); return; } if (forceDirection === 'down') { setPositionClass('mt-1'); return; } const rect = triggerRef.current.getBoundingClientRect(); const dropdownHeight = dropdownRef.current.offsetHeight; const spaceBelow = window.innerHeight - rect.bottom; if (spaceBelow < dropdownHeight + 10 && rect.top > dropdownHeight) { setPositionClass('bottom-full mb-1'); } else { setPositionClass('mt-1'); } } }, [isOpen, forceDirection]); return (<div className="relative w-full" ref={wrapperRef}> {React.cloneElement(trigger, { ref: triggerRef, onClick: () => setIsOpen(prev => !prev), isOpen })} {isOpen && React.cloneElement(children, { ref: dropdownRef, positionClass })} </div>); };
        const SingleSelectDropdown = ({ options, value, onChange, placeholder, className = '', buttonClassName = '', forceDirection = 'auto' }) => { const isObjectOptions = useMemo(() => options.length > 0 && typeof options[0] === 'object' && options[0] !== null, [options]); const handleSelect = (option) => { const selectedValue = isObjectOptions ? option.value : option; onChange(selectedValue); }; let displayText = placeholder; if (value !== null && value !== undefined) { if (isObjectOptions) { const selectedOption = options.find(opt => opt.value === value); displayText = selectedOption ? selectedOption.label : placeholder; } else { displayText = value || placeholder; } } const Trigger = React.forwardRef(({ onClick, isOpen }, ref) => (<button ref={ref} type="button" onClick={onClick} className={`w-full flex justify-between items-center bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 text-left focus:ring-2 focus:ring-emerald-500 ${buttonClassName}`}> <span className="truncate">{displayText}</span> <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} /> </button>)); const DropdownContent = React.forwardRef(({ positionClass }, ref) => (<div ref={ref} className={`absolute z-30 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto dark:bg-slate-700 dark:border-slate-600 ${positionClass}`}> <ul className="py-1"> {options.map((option, index) => { const optionValue = isObjectOptions ? option.value : option; const optionLabel = isObjectOptions ? option.label : option; const isSelected = value === optionValue; const key = `${isObjectOptions ? String(optionValue) : option}-${index}`; return (<li key={key}> <button type="button" onClick={() => handleSelect(option)} className={`w-full text-left flex items-center justify-between px-3 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer ${isSelected ? 'font-semibold text-emerald-500' : 'dark:text-gray-200'}`}> <span>{optionLabel}</span> {isSelected && <Check size={16} />} </button> </li>) })} </ul> </div>)); return <SmartDropdown trigger={<Trigger />} children={<DropdownContent />} forceDirection={forceDirection} />; };
        const ComboBox = ({ options, value, onChange, placeholder, className = '' }) => {
            const [inputValue, setInputValue] = useState(value || ''); const [isOpen, setIsOpen] = useState(false); const [forceShowAll, setForceShowAll] = useState(false); const [positionClass, setPositionClass] = useState('mt-1'); const wrapperRef = useRef(null); const inputRef = useRef(null); const dropdownRef = useRef(null); useEffect(() => { setInputValue(value || ''); }, [value]); useOutsideAlerter(wrapperRef, () => setIsOpen(false)); useLayoutEffect(() => { if (isOpen && inputRef.current && dropdownRef.current) { const rect = inputRef.current.getBoundingClientRect(); const dropdownHeight = dropdownRef.current.offsetHeight; const spaceBelow = window.innerHeight - rect.bottom; if (spaceBelow < dropdownHeight + 10 && rect.top > dropdownHeight) { setPositionClass('bottom-full mb-1'); } else { setPositionClass('mt-1'); } } }, [isOpen, inputValue, forceShowAll]); const optionsToShow = useMemo(() => { if (forceShowAll || !inputValue) return options; return options.filter(option => option.toLowerCase().includes(inputValue.toLowerCase())); }, [inputValue, options, forceShowAll]); const handleSelect = (option) => { onChange(option); setInputValue(option); setIsOpen(false); setForceShowAll(false); }; const handleInputChange = (e) => { setForceShowAll(false); setInputValue(e.target.value); if (!isOpen) setIsOpen(true); }; const handleChevronClick = () => { if (!isOpen) { setForceShowAll(true); } else { setForceShowAll(false); } setIsOpen(!isOpen); }; const handleBlur = () => { setTimeout(() => { if (document.activeElement === inputRef.current || (dropdownRef.current && dropdownRef.current.contains(document.activeElement))) { return; } if (inputValue && !options.includes(inputValue)) { onChange(value || ''); setInputValue(value || ''); } setIsOpen(false); }, 150); }; return (<div className={`relative w-full ${className}`} ref={wrapperRef}> <div className="relative"> <input ref={inputRef} type="text" value={inputValue} onChange={handleInputChange} onFocus={() => setIsOpen(true)} onBlur={handleBlur} placeholder={placeholder} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 focus:ring-2 focus:ring-emerald-500 pr-8 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" /> <button type="button" onClick={handleChevronClick} className="absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 dark:text-gray-400"> <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} /> </button> </div> {isOpen && ( // FIX: Further reduced max-height to prevent scrolling.
                <div ref={dropdownRef} className={`absolute z-30 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-52 overflow-y-auto dark:bg-slate-700 dark:border-slate-600 ${positionClass}`}> {optionsToShow.length > 0 ? (<ul className="py-1"> {optionsToShow.map((option, index) => (<li key={`${option}-${index}`}> <button type="button" onMouseDown={(e) => { e.preventDefault(); handleSelect(option); }} className={`w-full text-left flex items-center justify-between px-3 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer ${value === option ? 'font-semibold text-emerald-500' : 'dark:text-gray-200'}`}> <span>{option}</span> {value === option && <Check size={16} />} </button> </li>))} </ul>) : (<div className="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">无匹配项</div>)} </div>)} </div>);
        };
        const ManagementModal = ({ isOpen, onClose, managementData, onSave }) => { const [activeTab, setActiveTab] = useState('taskTypes'); const [localData, setLocalData] = useState(null); const [searchTerms, setSearchTerms] = useState({ departments: '', salesPersons: '', projectManagers: '', regions: '', taskTypes: '' }); useEffect(() => { if (isOpen && managementData) { setLocalData(JSON.parse(JSON.stringify(managementData))); setActiveTab('taskTypes'); } }, [isOpen, managementData]); if (!isOpen) return null; const handleAddItem = (type) => { const value = searchTerms[type].trim(); if (value && localData && !localData[type].includes(value)) { setLocalData(prev => ({ ...prev, [type]: [...prev[type], value].sort() })); setSearchTerms(prev => ({ ...prev, [type]: '' })); } }; const handleSearchChange = (type, value) => { setSearchTerms(prev => ({ ...prev, [type]: value })); }; const handleDeleteItem = (type, itemToDelete) => { setLocalData(prev => ({ ...prev, [type]: prev[type].filter(item => item !== itemToDelete) })); }; const handleSave = () => { onSave(localData); onClose(); }; const tabs = [{ key: 'taskTypes', label: '任务类型' }, { key: 'regions', label: '所属地区' }, { key: 'departments', label: '部门' }, { key: 'salesPersons', label: '业务人员' }, { key: 'projectManagers', label: '项目负责人' }]; const renderListEditor = (type, title) => { const filteredList = localData && localData[type] ? localData[type].filter(item => item.toLowerCase().includes(searchTerms[type].toLowerCase())) : []; return (<div className="p-4 bg-gray-50 dark:bg-slate-800 rounded-lg flex flex-col h-full"> <div className="flex gap-2 mb-3"> <input type="text" value={searchTerms[type]} onChange={(e) => handleSearchChange(type, e.target.value)} className="w-full bg-white border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" placeholder={`搜索或添加新的${title}`} /> <button onClick={() => handleAddItem(type)} className="px-4 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold flex-shrink-0">添加</button> </div> <div className="space-y-2 flex-grow overflow-y-auto pr-2"> {filteredList.map(item => (<div key={item} className="flex justify-between items-center bg-white dark:bg-slate-700 p-2 rounded-md border dark:border-slate-600"> <span className="dark:text-gray-200 break-all">{item}</span> <button onClick={() => handleDeleteItem(type, item)} className="p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 flex-shrink-0 ml-2"><Trash2 size={16} /></button> </div>))} </div> </div>); }; return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200"> <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">管理配置</h2> <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button> </header> <div className="flex-grow p-6 flex flex-col md:flex-row gap-6 overflow-hidden"> <div className="flex-shrink-0 border-b md:border-b-0 md:border-r border-gray-200 dark:border-slate-700 pr-4"> <nav className="flex flex-row md:flex-col gap-1">{tabs.map(tab => <button key={tab.key} onClick={() => setActiveTab(tab.key)} className={`px-4 py-2 text-left text-sm font-semibold rounded-md ${activeTab === tab.key ? 'bg-emerald-500 text-white' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}`}>{tab.label}</button>)}</nav> </div> <div className="flex-grow overflow-y-auto h-[450px]">{renderListEditor(activeTab, tabs.find(t => t.key === activeTab).label)}</div> </div> <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button> <button onClick={handleSave} className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">保存更改</button> </footer> </div> </div>); };
        const TaskModal = ({ isOpen, onClose, onSave, task, error, setError, managementData }) => {
            const [formData, setFormData] = useState({}); useEffect(() => { if (isOpen) { setError(null); const initialData = { customTaskId: 'HB', projectName: '', region: '', taskType: '', department: '', contractAmount: null, salesPerson: '', projectManager: '', isArchived: false, status: 'inprogress', contractualDueDate: '', actualCompletionDate: '', progressDetails: [], createdAt: new Date().toISOString() }; if (task) { setFormData({ ...initialData, ...task, contractualDueDate: formatDate(task.contractualDueDate), actualCompletionDate: formatDate(task.actualCompletionDate) }); } else { setFormData(initialData); } } }, [task, isOpen, setError]); if (!isOpen) return null; const handleFormChange = (name, value) => { setFormData(prev => ({ ...prev, [name]: value })); }; const handleInputChange = (e) => { const { name, value, type, checked } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value })); }; const handleSubmit = (e) => { e.preventDefault(); if (!task && !formData.customTaskId) { setError("任务编号是必填项。"); return; } const finalData = { ...formData, contractAmount: formData.contractAmount ? Number(formData.contractAmount) : null }; onSave(finalData, !!task); }; return (<div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4">
                <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-3xl h-[70vh] flex flex-col text-gray-800 dark:text-gray-200">
                    <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 rounded-t-xl dark:border-slate-700 dark:bg-slate-800 flex-shrink-0">
                        <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">{task ? '编辑任务详情' : '创建新任务'}</h2>
                        <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button>
                    </header>
                    <form onSubmit={handleSubmit} className="flex flex-col flex-grow min-h-0">
                        <div className="p-6 overflow-y-auto flex-grow">
                            {error && <div className="mb-4 bg-red-100 border border-red-300 text-red-800 px-4 py-2 rounded-lg text-center text-sm">{error}</div>}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">任务编号</label><input type="text" name="customTaskId" value={formData.customTaskId || ''} onChange={handleInputChange} disabled={!!task} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-200 disabled:cursor-not-allowed dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:disabled:bg-slate-800" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">项目名称</label><input type="text" name="projectName" value={formData.projectName || ''} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required /></div>
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">任务类型</label><ComboBox options={managementData.taskTypes} value={formData.taskType} onChange={(val) => handleFormChange('taskType', val)} placeholder="搜索或选择任务类型" /></div>
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">所属部门</label><ComboBox options={managementData.departments} value={formData.department} onChange={(val) => handleFormChange('department', val)} placeholder="搜索或选择所属部门" /></div>
                                </div>
                                <div className="space-y-4">
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">所属地区</label><ComboBox options={managementData.regions} value={formData.region} onChange={(val) => handleFormChange('region', val)} placeholder="搜索或选择所属地区" /></div>
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">业务人员</label><ComboBox options={managementData.salesPersons} value={formData.salesPerson} onChange={(val) => handleFormChange('salesPerson', val)} placeholder="搜索或选择业务人员" /></div>
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">项目负责人</label><ComboBox options={managementData.projectManagers} value={formData.projectManager} onChange={(val) => handleFormChange('projectManager', val)} placeholder="搜索或选择项目负责人" /></div>
                                </div>
                                <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-4 border-t border-gray-200 dark:border-gray-700 pt-4 mt-2">
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">合同金额 (元)</label><input type="number" name="contractAmount" value={formData.contractAmount || ''} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" placeholder="请输入金额" step="any" /></div>
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">任务下达日期</label><input type="date" name="createdAt" value={formatDate(formData.createdAt)} onChange={(e) => setFormData({ ...formData, createdAt: new Date(e.target.value).toISOString() })} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" /></div>
                                    <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">合同规定完成日期</label><input type="date" name="contractualDueDate" placeholder="yyyy-mm-dd" value={formData.contractualDueDate || ''} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" /></div>
                                    {task && task.status === 'done' && (<div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">实际完成日期</label><input type="date" name="actualCompletionDate" placeholder="yyyy-mm-dd" value={formatDate(formData.actualCompletionDate)} onChange={handleInputChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" /></div>)}
                                </div>
                            </div>
                        </div>
                        <footer className="p-4 border-t border-gray-200 dark:border-slate-700 flex justify-end gap-4 flex-shrink-0">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button>
                            <button type="submit" className="px-6 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold">保存</button>
                        </footer>
                    </form>
                </div>
            </div>
            );
        };
        const HistoryModal = ({ isOpen, onClose, onSave, task }) => { const [newProgress, setNewProgress] = useState(''); const combinedLog = useMemo(() => { if (!task) return []; const progressEntries = (task.progressDetails || []).map(p => ({ ...p, type: 'progress' })); const historyEntries = (task.history || []).map(h => ({ ...h, type: 'action', text: h.action })); return [...progressEntries, ...historyEntries].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); }, [task]); if (!isOpen) return null; const handleSave = () => { if (newProgress.trim()) { onSave(task.id, newProgress.trim()); setNewProgress(''); onClose(); } }; const getIconForAction = (actionText) => { if (actionText.includes('创建')) return <Plus size={16} className="text-green-500" />; if (actionText.includes('编辑')) return <Edit size={16} className="text-blue-500" />; if (actionText.includes('完成')) return <CheckCircle size={16} className="text-green-600" />; if (actionText.includes('作废')) return <Ban size={16} className="text-orange-500" />; if (actionText.includes('退回')) return <RotateCcw size={16} className="text-blue-500" />; if (actionText.includes('存档')) return <Archive size={16} className="text-yellow-600" />; if (actionText.includes('恢复')) return <RotateCcw size={16} className="text-green-500" />; if (actionText.includes('删除')) return <Trash2 size={16} className="text-red-500" />; return <Settings size={16} className="text-gray-500" />; }; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200"> <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">任务历史与进展日志</h2> <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button> </header> <div className="p-6 flex-grow overflow-y-auto"> <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">历史记录</h3> <div className="space-y-3 max-h-80 overflow-y-auto pr-2 border-b dark:border-slate-700 pb-4 mb-4"> {combinedLog.length > 0 ? combinedLog.map((entry, index) => (<div key={index} className="flex items-start gap-3"> <div className="mt-1"> {entry.type === 'progress' ? <MessageSquare size={16} className="text-emerald-500" /> : getIconForAction(entry.text)} </div> <div className="flex-1 bg-gray-100 dark:bg-slate-800 p-3 rounded-lg"> <p className={`text-gray-800 dark:text-gray-200 ${entry.type === 'action' ? 'font-semibold' : ''}`}>{entry.text}</p> <p className="text-xs text-gray-500 dark:text-gray-400 mt-2 text-right">{formatDateTime(entry.timestamp)}</p> </div> </div>)) : <p className="text-gray-500 dark:text-gray-400">暂无历史记录。</p>} </div> <div> <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">添加新进展</label> <textarea value={newProgress} onChange={(e) => setNewProgress(e.target.value)} rows="4" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" placeholder="在此输入最新的项目进展..." /> </div> </div> <footer className="p-4 flex justify-between items-center gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">关闭</button> <button onClick={handleSave} className="px-6 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold">保存进展</button> </footer> </div> </div>); };
        const CompleteTaskModal = ({ isOpen, onClose, onConfirm, task }) => { const [completionDate, setCompletionDate] = useState(formatDate(new Date())); if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"><div className="bg-white text-gray-800 dark:bg-slate-900 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-md"><header className="p-4 bg-gray-50 dark:bg-slate-800 rounded-t-xl border-b dark:border-slate-700"><h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">完成任务</h2><p className="text-sm text-gray-500 dark:text-gray-400 mt-1">请确认任务 "{task?.customTaskId}" 的实际完成日期。</p></header><div className="p-4"> <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">实际完成日期</label> <input type="date" value={completionDate} onChange={(e) => setCompletionDate(e.target.value)} placeholder="yyyy-mm-dd" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" /> </div><footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"><button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button><button onClick={() => onConfirm(task, completionDate)} className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">确认完成</button></footer></div></div>); };
        const BulkCompleteModal = ({ isOpen, onClose, onConfirm, tasksToComplete = [] }) => { const [completionDate, setCompletionDate] = useState(formatDate(new Date())); if (!isOpen) return null; const handleConfirm = () => { if (!completionDate) { alert('请选择一个完成日期。'); return; } onConfirm(completionDate); }; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 text-gray-800 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col"> <header className="p-4 bg-gray-50 dark:bg-slate-800 rounded-t-xl border-b dark:border-slate-700"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">批量完成任务</h2> </header> <div className="p-6 overflow-y-auto"> <p className="text-gray-600 dark:text-gray-300 mb-2"> 您选择了 <span className="font-bold text-emerald-500">{tasksToComplete.length}</span> 个任务，将统一标记为完成。 </p> <div className="mb-4"> <h3 className="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">将要完成以下任务：</h3> <div className="bg-gray-50 dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg p-3 max-h-48 overflow-y-auto space-y-2"> {tasksToComplete.map(task => (<div key={task.id} className="text-sm"> <p className="font-semibold text-gray-800 dark:text-gray-200">{task.projectName}</p> <p className="text-xs text-gray-500 dark:text-gray-400 pl-2">{task.taskType}</p> </div>))} </div> </div> <div> <label htmlFor="bulk-completion-date" className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">请指定统一完成日期</label> <input id="bulk-completion-date" type="date" value={completionDate} onChange={(e) => setCompletionDate(e.target.value)} placeholder="yyyy-mm-dd" className="w-full bg-white border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:[color-scheme:dark]" /> </div> </div> <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button> <button onClick={handleConfirm} className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">确认完成</button> </footer> </div> </div>); };
        const MultiSelectDropdown = ({ options, selectedOptions, onChange, placeholder, forceDirection = 'auto' }) => { const [searchTerm, setSearchTerm] = useState(''); const handleSelect = (option) => { const newSelectedOptions = selectedOptions.includes(option) ? selectedOptions.filter(o => o !== option) : [...selectedOptions, option]; onChange(newSelectedOptions); }; const filteredOptions = useMemo(() => options.filter(option => option.toLowerCase().includes(searchTerm.toLowerCase())), [options, searchTerm]); const handleSelectAll = () => { if (filteredOptions.every(o => selectedOptions.includes(o))) { onChange(selectedOptions.filter(o => !filteredOptions.includes(o))); } else { onChange([...new Set([...selectedOptions, ...filteredOptions])]); } }; const displayText = selectedOptions.length === 0 ? placeholder : selectedOptions.length === 1 ? selectedOptions[0] : `${selectedOptions.length} 项已选择`; const Trigger = React.forwardRef(({ onClick, isOpen }, ref) => (<button ref={ref} type="button" onClick={onClick} className="w-full flex justify-between items-center bg-gray-50 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 text-left focus:ring-2 focus:ring-emerald-500"> <span className="truncate">{displayText}</span> <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} /> </button>)); const DropdownContent = React.forwardRef(({ positionClass }, ref) => (<div ref={ref} className={`absolute z-20 w-full bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md shadow-lg ${positionClass}`}> <div className="p-2 border-b dark:border-slate-600"> <input type="text" placeholder="搜索选项..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full px-2 py-1 text-sm border-gray-200 rounded-md focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-600 dark:border-slate-500 dark:text-gray-200" /> </div> <div className="max-h-60 overflow-y-auto"> <div className="p-2 border-b dark:border-slate-600"> <label className="flex items-center space-x-2 px-2 py-1 hover:bg-gray-100 dark:hover:bg-slate-600 rounded"> <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={filteredOptions.length > 0 && filteredOptions.every(o => selectedOptions.includes(o))} onChange={handleSelectAll} /> <span className="dark:text-gray-200 text-sm">全选 (搜索结果)</span> </label> </div> <ul className="py-1"> {filteredOptions.map(option => (<li key={option}> <label className="flex items-center space-x-2 px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer"> <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={selectedOptions.includes(option)} onChange={() => handleSelect(option)} /> <span className="dark:text-gray-200">{option}</span> </label> </li>))} </ul> </div> </div>)); return <SmartDropdown trigger={<Trigger />} children={<DropdownContent />} forceDirection={forceDirection} />; };
        const TaskFilter = ({ onFilterChange, allTasks, forceDirection = 'auto' }) => { const [filters, setFilters] = useState({ regions: [], taskTypes: [], departments: [], salesPersons: [], projectManagers: [], dateFilterType: 'createdAt', startDate: '', endDate: '', archiveStatus: 'all' }); useEffect(() => { onFilterChange(filters); }, [filters]); const handleMultiSelectChange = (name, value) => { setFilters(prev => ({ ...prev, [name]: value })); }; const handleFilterChange = (name, value) => { setFilters(prev => ({ ...prev, [name]: value })); }; const handleInputChange = (e) => { const { name, value } = e.target; setFilters(prev => ({ ...prev, [name]: value })); }; const uniqueOptions = useMemo(() => ({ regions: [...new Set(allTasks.map(t => t.region).filter(Boolean))].sort(), taskTypes: [...new Set(allTasks.map(t => t.taskType).filter(Boolean))].sort(), departments: [...new Set(allTasks.map(t => t.department).filter(Boolean))].sort(), salesPersons: [...new Set(allTasks.map(t => t.salesPerson).filter(Boolean))].sort(), projectManagers: [...new Set(allTasks.map(t => t.projectManager).filter(Boolean))].sort(), }), [allTasks]); const archiveStatusOptions = [{ value: 'all', label: '所有存档状态' }, { value: 'archived', label: '已存档' }, { value: 'not-archived', label: '未存档' }]; const dateFilterTypeOptions = [{ value: 'createdAt', label: '任务下达日期' }, { value: 'actualCompletionDate', label: '实际完成日期' }]; return (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"> <div className="w-full"><MultiSelectDropdown options={uniqueOptions.regions} selectedOptions={filters.regions} onChange={(v) => handleMultiSelectChange('regions', v)} placeholder="所有地区" forceDirection={forceDirection} /></div> <div className="w-full"><MultiSelectDropdown options={uniqueOptions.taskTypes} selectedOptions={filters.taskTypes} onChange={(v) => handleMultiSelectChange('taskTypes', v)} placeholder="所有任务类型" forceDirection={forceDirection} /></div> <div className="w-full"><MultiSelectDropdown options={uniqueOptions.departments} selectedOptions={filters.departments} onChange={(v) => handleMultiSelectChange('departments', v)} placeholder="所有部门" forceDirection={forceDirection} /></div> <div className="w-full"><MultiSelectDropdown options={uniqueOptions.salesPersons} selectedOptions={filters.salesPersons} onChange={(v) => handleMultiSelectChange('salesPersons', v)} placeholder="所有业务人员" forceDirection={forceDirection} /></div> <div className="w-full"><MultiSelectDropdown options={uniqueOptions.projectManagers} selectedOptions={filters.projectManagers} onChange={(v) => handleMultiSelectChange('projectManagers', v)} placeholder="所有项目负责人" forceDirection={forceDirection} /></div> <div className="w-full"><SingleSelectDropdown options={archiveStatusOptions} value={filters.archiveStatus} onChange={(v) => handleFilterChange('archiveStatus', v)} forceDirection={forceDirection} /></div> <div className="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4"> <SingleSelectDropdown options={dateFilterTypeOptions} value={filters.dateFilterType} onChange={(v) => handleFilterChange('dateFilterType', v)} forceDirection={forceDirection} /> <input type="date" name="startDate" value={filters.startDate} onChange={handleInputChange} placeholder="yyyy-mm-dd" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" /> <input type="date" name="endDate" value={filters.endDate} onChange={handleInputChange} placeholder="yyyy-mm-dd" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" /> </div> </div>); };
        const ColumnToggler = ({ allColumns, visibleColumns, onToggle }) => { const [isOpen, setIsOpen] = useState(false); const wrapperRef = useRef(null); useOutsideAlerter(wrapperRef, () => setIsOpen(false)); return (<div className="relative" ref={wrapperRef}> <button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 px-2.5 py-1 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md text-xs font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-600"> <Icon size={14}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></Icon> 显示/隐藏列 <ChevronDown size={14} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} /> </button> {isOpen && (<div className="absolute right-0 z-20 w-56 mt-1 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md shadow-lg"> <ul className="py-1 max-h-60 overflow-y-auto"> {allColumns.map(col => (<li key={col.key}> <label className="flex items-center space-x-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer text-sm"> <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={visibleColumns.includes(col.key)} onChange={() => onToggle(col.key)} /> <span className="dark:text-gray-200">{col.label}</span> </label> </li>))} </ul> </div>)} </div>); };
        const StatisticsModal = ({ isOpen, onClose, tasks }) => {
            const ALL_COLUMNS = useMemo(() => [{ key: 'customTaskId', label: '任务编号', width: 'w-[10%]' }, { key: 'projectName', label: '项目名称', width: 'w-[25%]' }, { key: 'region', label: '所属地区', width: 'w-[8%]' }, { key: 'taskType', label: '任务类型', width: 'w-[15%]' }, { key: 'department', label: '所属部门', width: 'w-[15%]' }, { key: 'salesPerson', label: '业务人员', width: 'w-[8%]' }, { key: 'projectManager', label: '项目负责人', width: 'w-[9%]' }, { key: 'contractAmount', label: '合同金额', width: 'w-[10%]' }, { key: 'createdAt', label: '下达日期', width: 'w-[10%]' }, { key: 'actualCompletionDate', label: '完成日期', width: 'w-[10%]' }, { key: 'isArchived', label: '存档', width: 'w-[5%]' },], []);
            const [filters, setFilters] = useState(null);
            const [visibleColumns, setVisibleColumns] = useState(ALL_COLUMNS.map(c => c.key));
            const handleFilterChange = useCallback((newFilters) => { setFilters(newFilters); }, []);
            const handleToggleColumn = (keyToToggle) => { const newVisibleSet = new Set(visibleColumns); if (newVisibleSet.has(keyToToggle)) { newVisibleSet.delete(keyToToggle); } else { newVisibleSet.add(keyToToggle); } const newOrderedVisibleColumns = ALL_COLUMNS.filter(col => newVisibleSet.has(col.key)).map(col => col.key); setVisibleColumns(newOrderedVisibleColumns); };
            const filteredTasks = useMemo(() => { if (!filters) return tasks; return tasks.filter(task => { const { regions, taskTypes, departments, salesPersons, projectManagers, dateFilterType, startDate, endDate, archiveStatus } = filters; if (regions.length > 0 && !regions.includes(task.region)) return false; if (taskTypes.length > 0 && !taskTypes.includes(task.taskType)) return false; if (departments.length > 0 && !departments.includes(task.department)) return false; if (salesPersons.length > 0 && !salesPersons.includes(task.salesPerson)) return false; if (projectManagers.length > 0 && !projectManagers.includes(task.projectManager)) return false; if (archiveStatus !== 'all') { if (archiveStatus === 'archived' && !task.isArchived) return false; if (archiveStatus === 'not-archived' && task.isArchived) return false; } if (startDate) { const taskDateStr = task[dateFilterType]; if (!taskDateStr) return false; const taskDate = new Date(taskDateStr); if (isNaN(taskDate.getTime())) return false; if (taskDate.setHours(0, 0, 0, 0) < new Date(startDate).setHours(0, 0, 0, 0)) return false; } if (endDate) { const taskDateStr = task[dateFilterType]; if (!taskDateStr) return false; const taskDate = new Date(taskDateStr); if (isNaN(taskDate.getTime())) return false; if (taskDate.setHours(0, 0, 0, 0) > new Date(endDate).setHours(0, 0, 0, 0)) return false; } return true; }); }, [tasks, filters]);
            const totalAmount = useMemo(() => filteredTasks.reduce((sum, task) => sum + (Number(task.contractAmount) || 0), 0), [filteredTasks]);

            const tableHeader = (
                <thead className="text-xs text-gray-700 dark:text-gray-300 uppercase bg-gray-100 dark:bg-slate-800 sticky top-0 z-10">
                    <tr>{ALL_COLUMNS.filter(c => visibleColumns.includes(c.key)).map(col => (<th key={col.key} className={`p-2 font-medium ${col.width}`}>{col.label}</th>))}</tr>
                </thead>
            );

            const tableBody = (
                <tbody className="dark:bg-slate-900">
                    {filteredTasks.map((task, index) => (
                        <tr key={task.id} className={`border-b border-gray-200 dark:border-slate-700 ${index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50'}`}>
                            {ALL_COLUMNS.filter(c => visibleColumns.includes(c.key)).map(col => {
                                const content = col.key === 'createdAt' || col.key === 'actualCompletionDate' ? formatDate(task[col.key]) : col.key === 'isArchived' ? (task.isArchived ? '是' : '否') : col.key === 'contractAmount' ? formatAmount(task[col.key]) : task[col.key] || '';
                                return (<td key={col.key} className="p-2 break-words" title={typeof content === 'string' ? content : ''}>{content}</td>);
                            })}
                        </tr>
                    ))}
                </tbody>
            );

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-white text-gray-800 dark:bg-slate-900 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-7xl h-[90vh] flex flex-col">
                        <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl shrink-0">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">统计分析</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button>
                        </header>
                        <div className="p-6 flex flex-col flex-grow min-h-0">
                            <div className="shrink-0">
                                <TaskFilter onFilterChange={handleFilterChange} allTasks={tasks} forceDirection="down" />
                                <div className="flex justify-between items-center my-4">
                                    <div className="grid grid-cols-2 gap-4 flex-grow">
                                        <div className="p-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg text-center shadow-sm">
                                            <div className="text-3xl font-bold text-emerald-500">{filteredTasks.length}</div>
                                            <div className="text-sm text-gray-500 dark:text-gray-400">任务总数</div>
                                        </div>
                                        <div className="p-4 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg text-center shadow-sm">
                                            <div className="text-3xl font-bold text-green-500">{formatAmount(totalAmount)}</div>
                                            <div className="text-sm text-gray-500 dark:text-gray-400">合同总金额</div>
                                        </div>
                                    </div>
                                    <div className="ml-8">
                                        <ColumnToggler allColumns={ALL_COLUMNS} visibleColumns={visibleColumns} onToggle={handleToggleColumn} />
                                    </div>
                                </div>
                            </div>
                            <div className="overflow-auto flex-grow">
                                <table className="w-full text-sm text-center text-gray-600 dark:text-gray-300 table-fixed">
                                    {tableHeader}
                                    {tableBody}
                                </table>
                            </div>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700 shrink-0">
                            <button onClick={() => exportData('excel', filteredTasks, "统计结果", visibleColumns, () => alert('统计结果已导出！'), [])} className="px-6 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center gap-2">
                                <Download size={16} />下载统计结果
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };
        const ExportModal = ({ isOpen, onClose, allNonDeletedTasks }) => { const ALL_EXPORT_COLUMNS = useMemo(() => [{ key: 'createdAt', label: '任务下达日期' }, { key: 'customTaskId', label: '任务编号' }, { key: 'projectName', label: '项目名称' }, { key: 'taskType', label: '任务类型' }, { key: 'department', label: '所属部门' }, { key: 'contractAmount', label: '合同金额' }, { key: 'salesPerson', label: '业务人员' }, { key: 'projectManager', label: '项目负责人' }, { key: 'contractualDueDate', label: '合同规定完成日期' }, { key: 'timeRemaining', label: '剩余时间' }, { key: 'progressDetails', label: '项目进展情况' }, { key: 'region', label: '所属地区' }, { key: 'status', label: '状态' }, { key: 'actualCompletionDate', label: '实际完成日期' }, { key: 'isArchived', label: '是否存档' },], []); const viewOptions = ['进行中', '已完成', '已作废']; const statusMap = { '进行中': 'inprogress', '已完成': 'done', '已作废': 'void' }; const defaultColsByView = { inprogress: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'department', 'contractAmount', 'salesPerson', 'projectManager', 'contractualDueDate', 'timeRemaining', 'progressDetails', 'region'], done: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'department', 'contractAmount', 'salesPerson', 'projectManager', 'contractualDueDate', 'actualCompletionDate', 'isArchived', 'progressDetails', 'region'], void: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'department', 'contractAmount', 'salesPerson', 'projectManager', 'progressDetails', 'region'] }; const [selectedViews, setSelectedViews] = useState(['进行中']); const [filters, setFilters] = useState(null); const [visibleColumns, setVisibleColumns] = useState(defaultColsByView.inprogress); useEffect(() => { const selectedStatuses = selectedViews.map(v => statusMap[v]); if (selectedStatuses.length === 0) { setVisibleColumns([]); return; } const newVisibleCols = new Set(); selectedStatuses.forEach(status => { (defaultColsByView[status] || []).forEach(col => newVisibleCols.add(col)); }); if (selectedStatuses.length > 1) { newVisibleCols.add('status'); } setVisibleColumns(ALL_EXPORT_COLUMNS.filter(c => newVisibleCols.has(c.key)).map(c => c.key)); }, [selectedViews, ALL_EXPORT_COLUMNS]); const onExportSuccess = () => alert('数据已成功导出！'); const handleFilterChange = useCallback((newFilters) => { setFilters(newFilters); }, []); const handleToggleColumn = (keyToToggle) => { setVisibleColumns(prev => { const newSet = new Set(prev); if (newSet.has(keyToToggle)) { newSet.delete(keyToToggle); } else { newSet.add(keyToToggle); } return ALL_EXPORT_COLUMNS.filter(c => newSet.has(c.key)).map(c => c.key); }); }; const tasksFromSelectedViews = useMemo(() => { const selectedStatuses = selectedViews.map(v => statusMap[v]); if (selectedStatuses.length === 0) return []; return allNonDeletedTasks.filter(task => selectedStatuses.includes(task.status)); }, [selectedViews, allNonDeletedTasks]); const filterDescription = useMemo(() => { if (!filters) return "所有已选视图中的"; const parts = []; const { regions, taskTypes, departments, salesPersons, projectManagers, archiveStatus, startDate, endDate, dateFilterType } = filters; if (regions.length > 0) parts.push(`地区为 ${regions.join('、')}`); if (taskTypes.length > 0) parts.push(`类型为 ${taskTypes.join('、')}`); if (departments.length > 0) parts.push(`部门为 ${departments.join('、')}`); if (salesPersons.length > 0) parts.push(`业务员 ${salesPersons.join('、')}`); if (projectManagers.length > 0) parts.push(`负责人 ${projectManagers.join('、')}`); if (archiveStatus !== 'all') { parts.push(archiveStatus === 'archived' ? '已存档' : '未存档'); } if (startDate || endDate) { const dateLabel = dateFilterType === 'createdAt' ? '下达日期' : '完成日期'; if (startDate && endDate) { parts.push(`${dateLabel}从 ${startDate} 到 ${endDate}`); } else if (startDate) { parts.push(`${dateLabel}自 ${startDate} 起`); } else { parts.push(`${dateLabel}截止到 ${endDate}`); } } if (parts.length === 0) return "所有已选视图中的"; return parts.join('，') + "的"; }, [filters]); const filteredTasks = useMemo(() => { if (!filters) return tasksFromSelectedViews; return tasksFromSelectedViews.filter(task => { const { regions, taskTypes, departments, salesPersons, projectManagers, dateFilterType, startDate, endDate, archiveStatus } = filters; if (regions.length > 0 && !regions.includes(task.region)) return false; if (taskTypes.length > 0 && !taskTypes.includes(task.taskType)) return false; if (departments.length > 0 && !departments.includes(task.department)) return false; if (salesPersons.length > 0 && !salesPersons.includes(task.salesPerson)) return false; if (projectManagers.length > 0 && !projectManagers.includes(task.projectManager)) return false; if (archiveStatus !== 'all') { if (archiveStatus === 'archived' && !task.isArchived) return false; if (archiveStatus === 'not-archived' && task.isArchived) return false; } if (startDate) { const taskDateStr = task[dateFilterType]; if (!taskDateStr) return false; const taskDate = new Date(taskDateStr); if (isNaN(taskDate.getTime())) return false; if (taskDate.setHours(0, 0, 0, 0) < new Date(startDate).setHours(0, 0, 0, 0)) return false; } if (endDate) { const taskDateStr = task[dateFilterType]; if (!taskDateStr) return false; const taskDate = new Date(taskDateStr); if (isNaN(taskDate.getTime())) return false; if (taskDate.setHours(0, 0, 0, 0) > new Date(endDate).setHours(0, 0, 0, 0)) return false; } return true; }); }, [tasksFromSelectedViews, filters]); const handlePngExport = () => { if (filteredTasks.length === 0) { alert("没有符合当前筛选条件的任务可供导出为图片。"); return; } onClose(); setTimeout(() => { exportData('png', filteredTasks, "筛选结果", visibleColumns, onExportSuccess, selectedViews); }, 250); }; if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 text-gray-800 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-screen-xl max-h-[90vh] flex flex-col"> <header className="flex justify-between items-center p-4 border-b border-gray-200 dark:border-slate-700 bg-gray-50 dark:bg-slate-800 rounded-t-xl"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">导出任务</h2> <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button> </header> <div className="p-6 overflow-y-auto"> <div className="mb-6 border-b border-gray-200 dark:border-slate-700 pb-6"> <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">快速导出</h3> <div className="grid grid-cols-1 md:grid-cols-3 gap-4"> <button onClick={() => exportData('excel', allNonDeletedTasks, "全部任务", ALL_EXPORT_COLUMNS.map(c => c.key), onExportSuccess, ['进行中', '已完成', '已作废'])} className="w-full px-6 py-3 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">导出全部任务</button> <button onClick={() => exportData('excel', allNonDeletedTasks.filter(t => t.status === 'inprogress'), "进行中任务", defaultColsByView.inprogress, onExportSuccess, ['进行中'])} className="w-full px-6 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">导出进行中任务</button> <button onClick={() => exportData('excel', allNonDeletedTasks.filter(t => t.status === 'done'), "已完成任务", defaultColsByView.done, onExportSuccess, ['已完成'])} className="w-full px-6 py-3 rounded-md text-white bg-orange-500 hover:bg-orange-600 font-semibold">导出已完成任务</button> </div> </div> <div> <div className="flex items-center gap-4 mb-4"> <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300">自定义导出</h3> <ColumnToggler allColumns={ALL_EXPORT_COLUMNS} visibleColumns={visibleColumns} onToggle={handleToggleColumn} /> </div> <div className="mb-4"><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">1. 选择视图范围</label><MultiSelectDropdown options={viewOptions} selectedOptions={selectedViews} onChange={setSelectedViews} placeholder="请选择视图" forceDirection="up" /></div> <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">2. 设置筛选条件</label><TaskFilter onFilterChange={handleFilterChange} allTasks={tasksFromSelectedViews} forceDirection="up" /></div> <div className="mt-4 p-4 bg-slate-100 dark:bg-slate-800 rounded-lg"><p className="text-gray-600 dark:text-gray-300">已筛选出<span className="font-semibold text-emerald-500 mx-1">{selectedViews.join('、')}</span>视图下<span className="font-semibold text-emerald-500 mx-1">{filterDescription}</span>相关任务，共<span className="font-bold text-emerald-500 mx-1">{filteredTasks.length}</span>个。</p></div> </div> </div> <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> <div className="flex gap-2"> <button onClick={() => exportData('excel', filteredTasks, "筛选结果", visibleColumns, onExportSuccess, selectedViews)} className="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold" disabled={filteredTasks.length === 0}>Excel</button> <button onClick={() => exportData('csv', filteredTasks, "筛选结果", visibleColumns, onExportSuccess, selectedViews)} className="px-4 py-2 rounded-md text-white bg-sky-600 hover:bg-sky-700 font-semibold" disabled={filteredTasks.length === 0}>CSV</button> <button onClick={handlePngExport} className="px-4 py-2 rounded-md text-white bg-purple-600 hover:bg-purple-700 font-semibold">图片</button> </div> </footer> </div> </div>); };
        const ImportReportModal = ({ isOpen, onClose, report, onExportErrors }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"> <header className="p-4 border-b dark:border-slate-700"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">导入报告</h2> </header> <div className="p-6 overflow-y-auto"> <div className="flex justify-around items-center mb-4 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg"> <div><span className="text-2xl font-bold text-green-500">{report.successful}</span><span className="ml-2 text-gray-600 dark:text-gray-300">条成功</span></div> <div><span className="text-2xl font-bold text-red-500">{report.failed}</span><span className="ml-2 text-gray-600 dark:text-gray-300">条失败</span></div> </div> {report.failed > 0 && (<> <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">失败详情:</h3> <div className="overflow-auto border dark:border-slate-700 rounded-lg max-h-64"> <table className="w-full text-sm"> <thead className="bg-gray-100 dark:bg-slate-800 sticky top-0"> <tr> <th className="p-2 font-medium text-left w-24 dark:text-gray-300">Excel 行号</th> <th className="p-2 font-medium text-left dark:text-gray-300">任务编号</th> <th className="p-2 font-medium text-left dark:text-gray-300">错误原因</th> </tr> </thead> <tbody className="bg-white dark:bg-slate-900"> {report.errors.map((err, i) => (<tr key={i} className="border-t dark:border-slate-700"> <td className="p-2 dark:text-gray-300">{err.row}</td> <td className="p-2 dark:text-gray-300">{err.id || 'N/A'}</td> <td className="p-2 text-red-500">{err.reason}</td> </tr>))} </tbody> </table> </div> <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">提示：请根据以上报告修改您的Excel文件后，重新尝试导入。</p> </>)} </div> <footer className="p-4 flex justify-between items-center gap-4 bg-gray-50 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> {report.failed > 0 && (<button onClick={onExportErrors} className="px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center gap-2"> <Download size={16} /> 导出错误报告 </button>)} <button onClick={onClose} className="px-6 py-2 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold ml-auto">关闭</button> </footer> </div> </div>); };
        const ActionModal = ({ state, onClose, onActionSelect }) => { if (!state.isOpen || !state.task) return null; const { task } = state; const actions = [{ label: '编辑', icon: <Edit size={16} />, action: () => onActionSelect('edit', task), className: 'text-blue-600 hover:bg-blue-50 border-blue-200 dark:text-blue-400 dark:hover:bg-blue-900/50 dark:border-blue-800', show: true }, { label: '完成', icon: <Check size={16} />, action: () => onActionSelect('complete', task), className: 'text-green-600 hover:bg-green-50 border-green-200 dark:text-green-400 dark:hover:bg-green-900/50 dark:border-green-800', show: task.status === 'inprogress' }, { label: '作废', icon: <Ban size={16} />, action: () => onActionSelect('void', task), className: 'text-orange-600 hover:bg-orange-50 border-orange-200 dark:text-orange-400 dark:hover:bg-orange-900/50 dark:border-orange-800', show: task.status === 'inprogress' }, { label: '退回', icon: <RotateCcw size={16} />, action: () => onActionSelect('revert', task), className: 'text-blue-600 hover:bg-blue-50 border-blue-200 dark:text-blue-400 dark:hover:bg-blue-900/50 dark:border-blue-800', show: (task.status === 'done' || task.status === 'void') }, { label: '删除', icon: <Trash2 size={16} />, action: () => onActionSelect('delete', task), className: 'text-red-600 hover:bg-red-50 border-red-200 dark:text-red-400 dark:hover:bg-red-900/50 dark:border-red-800', show: true }].filter(a => a.show); return (<div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-md"> <header className="p-4 border-b dark:border-slate-700"> <h2 className="text-lg font-bold text-gray-900 dark:text-gray-100">任务操作</h2> <div className="text-sm text-gray-600 dark:text-gray-300 mt-2 space-y-1 bg-gray-50 dark:bg-slate-800 p-3 rounded-md border dark:border-slate-700"> <p><span className="font-semibold w-20 inline-block text-gray-500 dark:text-gray-400">任务编号:</span> <span className="font-mono">{task.customTaskId}</span></p> <p><span className="font-semibold w-20 inline-block text-gray-500 dark:text-gray-400">项目名称:</span> {task.projectName}</p> <p><span className="font-semibold w-20 inline-block text-gray-500 dark:text-gray-400">任务类型:</span> {task.taskType}</p> </div> </header> <div className="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3"> {actions.map(item => (<button key={item.label} onClick={item.action} className={`w-full flex items-center justify-center gap-3 px-3 py-2 text-sm rounded-md border ${item.className}`}> {item.icon} <span>{item.label}</span> </button>))} </div> <footer className="p-2 flex justify-end bg-gray-50 dark:bg-slate-800/50 rounded-b-xl"> <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">关闭</button> </footer> </div> </div>); };
        const ListHeader = ({ currentView, onSelectAll, numSelected, taskCount, sortConfig, onRequestSort }) => { const checkboxRef = useRef(null); useEffect(() => { if (checkboxRef.current) { checkboxRef.current.indeterminate = numSelected > 0 && numSelected < taskCount; } }, [numSelected, taskCount]); const isDeletedView = currentView === 'deleted'; const isDoneView = currentView === 'done'; const gridColsClass = isDeletedView ? GRID_COLS.DELETED : isDoneView ? GRID_COLS.DONE : GRID_COLS.INPROGRESS; const SortableHeader = ({ label, sortKey }) => { const isSorted = sortConfig.key === sortKey && sortConfig.isExplicit; const direction = isSorted ? sortConfig.direction : 'none'; return (<div className="flex items-center justify-center relative"><button data-column-key={sortKey} onClick={() => onRequestSort(sortKey)} className="flex items-center justify-center w-full whitespace-normal"> <span className="pr-5">{label}</span> <span className="absolute right-1 top-1/2 -translate-y-1/2"> {isSorted ? (direction === 'ascending' ? <span className="text-emerald-500">▲</span> : <span className="text-emerald-500">▼</span>) : (<ArrowUpDown size={14} className="text-gray-400" />)} </span> </button></div>); }; const HeaderCell = ({ label }) => (<div className="flex items-center justify-center">{label}</div>); return (<div className={`exportable-grid-container grid ${gridColsClass} gap-4 px-4 py-3 bg-slate-100 dark:bg-slate-800 text-sm font-bold text-slate-700 dark:text-slate-300 sticky top-0 z-10 text-center border-b-2 border-slate-200 dark:border-slate-700`}> <div className="flex items-center justify-center"><input type="checkbox" ref={checkboxRef} className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" onChange={onSelectAll} checked={taskCount > 0 && numSelected === taskCount} /></div> {isDeletedView ? (<> <HeaderCell label="任务编号" /> <HeaderCell label="项目名称" /> <HeaderCell label="任务类型" /> <HeaderCell label="项目负责人" /> <SortableHeader label="删除时间" sortKey="deletedAt" /> <HeaderCell label="操作" /> </>) : (<> <SortableHeader label="任务下达日期" sortKey="createdAt" /> <SortableHeader label="任务编号" sortKey="customTaskId" /> <HeaderCell label="项目名称" /> <HeaderCell label="任务类型" /> <HeaderCell label="所属部门" /> <SortableHeader label="合同金额" sortKey="contractAmount" /> <HeaderCell label="业务人员" /> <HeaderCell label="项目负责人" /> <SortableHeader label="合同规定完成日期" sortKey="contractualDueDate" /> {isDoneView && <SortableHeader label="实际完成日期" sortKey="actualCompletionDate" />} <HeaderCell label="项目进展情况" /> {!isDoneView && <HeaderCell label="剩余时间" />} {isDoneView && <HeaderCell label="存档" />} <HeaderCell label="所属地区" /> <HeaderCell label="操作" /> </>)} </div>); };
        const TaskRow = ({ task, onActionConfirm, currentView, index, onSelect, isSelected }) => { let timeRemaining = { status: '', time: '' }; let timeRemainingColorClass = 'text-slate-700 dark:text-slate-300'; let tooltipMessage = ''; let rowBgColor; if (currentView === 'inprogress' && task.contractualDueDate) { const today = new Date(); today.setHours(0, 0, 0, 0); const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0); const diffTime = dueDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); timeRemaining = formatDuration(diffDays); if (diffDays < 0) { timeRemainingColorClass = 'text-rose-600 dark:text-rose-400'; tooltipMessage = `已逾期!`; rowBgColor = 'bg-rose-50 dark:bg-rose-900/20'; } else if (diffDays <= 7) { timeRemainingColorClass = 'text-amber-600 dark:text-amber-400'; tooltipMessage = `即将截止!`; rowBgColor = 'bg-amber-50 dark:bg-amber-900/20'; } else { timeRemainingColorClass = 'text-green-700 dark:text-green-400'; rowBgColor = 'bg-emerald-50 dark:bg-emerald-900/20'; } } else { rowBgColor = index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50'; } if (isSelected) { rowBgColor = 'bg-sky-200 dark:bg-sky-800/50'; } const gridColsClass = currentView === 'done' ? GRID_COLS.DONE : GRID_COLS.INPROGRESS; const latestProgress = useMemo(() => { if (!task.progressDetails || task.progressDetails.length === 0) return '暂无进展'; const sorted = [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); return sorted[0].text; }, [task.progressDetails]); return (<div className={`exportable-grid-container grid ${gridColsClass} gap-4 px-4 py-2 items-center ${rowBgColor} border-b border-gray-200 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-300 text-center hover:bg-sky-100 dark:hover:bg-sky-900/50 transition-colors duration-200`} title={tooltipMessage}> <div className="flex items-center justify-center"><input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={isSelected} onChange={() => onSelect(task.id)} /></div> <div className="flex items-center justify-center">{formatDate(task.createdAt)}</div> <div className="font-mono text-sm flex items-center justify-center">{task.customTaskId}</div> <div className="text-slate-800 dark:text-slate-200 flex items-center justify-center whitespace-normal break-words" title={task.projectName}>{task.projectName}</div> <div className="flex items-center justify-center whitespace-normal break-words" title={task.taskType}>{task.taskType}</div> <div className="flex items-center justify-center whitespace-normal break-words" title={task.department}>{task.department}</div> <div className="flex items-center justify-center">{formatAmount(task.contractAmount)}</div> <div className="flex items-center justify-center">{task.salesPerson || 'N/A'}</div> <div className="flex items-center justify-center">{task.projectManager}</div> <div className="flex items-center justify-center">{formatDate(task.contractualDueDate)}</div> {currentView === 'done' && <div className="flex items-center justify-center">{formatDate(task.actualCompletionDate)}</div>} <div onClick={() => onActionConfirm('progress', task)} className="text-gray-500 dark:text-gray-400 cursor-pointer hover:text-emerald-600 dark:hover:text-emerald-400 flex items-center justify-center gap-2" title={latestProgress}><MessageSquare size={16} className="flex-shrink-0" /><span className="text-left line-clamp-2">{latestProgress}</span></div> {currentView !== 'done' && <div className={`flex flex-col items-center justify-center font-medium ${timeRemainingColorClass}`}> {timeRemaining.time ? (<> <span>{timeRemaining.status}</span> <span>{timeRemaining.time}</span> </>) : <span>-</span>} </div>} {currentView === 'done' && <div className="flex items-center justify-center">{task.isArchived ? (<span className="flex items-center text-green-600 dark:text-green-400"><CheckCircle size={16} className="mr-1" /> 已存档</span>) : (<button onClick={() => onActionConfirm('archive', task)} className="p-2 rounded-md text-gray-600 bg-yellow-100 hover:bg-yellow-200 dark:bg-yellow-900/50 dark:text-yellow-300 dark:hover:bg-yellow-900" title="存档任务"><Archive size={16} /></button>)}</div>} <div className="flex items-center justify-center">{task.region}</div> <div className="flex items-center justify-center action-column"> <button onClick={() => onActionConfirm('openActionModal', task)} className="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 hover:text-gray-800 dark:hover:text-gray-200 transition-colors" title="更多操作"><MoreHorizontal size={20} /></button> </div> </div>); };
        const DeletedTaskRow = ({ task, onPermanentDelete, index, onSelect, isSelected }) => { // 移除了 onRestore
            const bgColor = isSelected ? 'bg-sky-200 dark:bg-sky-800/50' : (index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50');
            const gridColsClass = GRID_COLS.DELETED;
            return (
                <div className={`grid ${gridColsClass} gap-4 px-4 py-2 items-center ${bgColor} border-b border-gray-200 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-300 text-center hover:bg-sky-100 dark:hover:bg-sky-900/50 transition-colors`}>
                    <div className="flex items-center justify-center"><input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={isSelected} onChange={() => onSelect(task.id)} /></div>
                    <div className="font-mono text-sm flex items-center justify-center">{task.customTaskId}</div>
                    <div className="text-slate-800 dark:text-slate-200 flex items-center justify-center">{task.projectName}</div>
                    <div className="flex items-center justify-center">{task.taskType}</div>
                    <div className="flex items-center justify-center">{task.projectManager}</div>
                    <div className="flex items-center justify-center">{formatDateTime(task.deletedAt)}</div>
                    <div className="flex items-center justify-center action-column">
                        {/* 恢复按钮已被删除 */}
                        <button onClick={() => onPermanentDelete(task)} className="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full" title="永久删除"><Trash2 size={16} /></button>
                    </div>
                </div>
            );
        };
        const BulkActionBar = ({ selectedCount, onBulkAction, currentView }) => { return (<div className="flex items-center gap-4 p-1.5 bg-emerald-100/50 dark:bg-emerald-900/30 rounded-lg border border-emerald-200 dark:border-emerald-800"> <span className="text-sm font-semibold text-emerald-800 dark:text-emerald-300">已选择 {selectedCount} 项</span> <div className="h-6 w-px bg-emerald-200 dark:bg-emerald-700"></div> {currentView === 'inprogress' && <button onClick={() => onBulkAction('bulkComplete')} className="flex items-center gap-2 text-sm text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300 font-semibold"><Check size={16} />完成</button>} <button onClick={() => onBulkAction('bulkVoid')} className="flex items-center gap-2 text-sm text-orange-600 hover:text-orange-800 dark:text-orange-400 dark:hover:text-orange-300 font-semibold"><Ban size={16} />作废</button> <button onClick={() => onBulkAction('bulkDelete')} className="flex items-center gap-2 text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold"><Trash2 size={16} />删除</button> <div className="h-6 w-px bg-emerald-200 dark:bg-emerald-700"></div> <button onClick={() => onBulkAction('clearSelection')} className="p-1 rounded-full hover:bg-emerald-200 dark:hover:bg-emerald-700"><X size={18} className="text-emerald-700 dark:text-emerald-300" /></button> </div>) };
        const NotificationModal = ({ isOpen, onClose, tasks }) => { if (!isOpen) return null; const urgentTasks = useMemo(() => { return tasks.filter(t => t.status === 'inprogress' && t.contractualDueDate && (new Date(t.contractualDueDate) - new Date()) / (1000 * 3600 * 24) <= 7).map(task => { const today = new Date(); today.setHours(0, 0, 0, 0); const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0); const diffTime = dueDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); return { ...task, diffDays }; }).sort((a, b) => a.diffDays - b.diffDays); }, [tasks]); return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200"> <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl"><h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">消息提醒</h2><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button></header> <div className="p-6 overflow-y-auto"> {urgentTasks.length > 0 ? (<ul className="space-y-3"> {urgentTasks.map(task => { const isOverdue = task.diffDays < 0; return (<li key={task.id} className={`p-3 rounded-lg flex justify-between items-center ${isOverdue ? 'bg-red-100 dark:bg-red-900/30 border-l-4 border-red-500' : 'bg-yellow-100 dark:bg-yellow-900/30 border-l-4 border-yellow-500'}`}> <div> <p className="font-semibold text-gray-800 dark:text-gray-200">{task.projectName}</p> <p className="text-sm text-gray-600 dark:text-gray-400">任务类型: {task.taskType}</p> <p className="text-sm text-gray-600 dark:text-gray-400 mt-1">负责人: {task.projectManager}</p> </div> <div className={`font-bold text-sm ${isOverdue ? 'text-red-600 dark:text-red-400' : 'text-yellow-600 dark:text-yellow-400'}`}>{formatDuration(task.diffDays).status} {formatDuration(task.diffDays).time}</div> </li>); })} </ul>) : (<p className="text-center text-gray-500 dark:text-gray-400 py-8">没有需要紧急处理的任务。</p>)} </div> <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"><button onClick={onClose} className="px-6 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold">关闭</button></footer> </div> </div>); };
        const ImportModal = ({ isOpen, onClose, onDownloadTemplate, onImportClick }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"> <div className="bg-white text-gray-800 dark:bg-slate-900 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-md"> <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl"><h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">导入任务</h2><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button></header> <div className="p-6 space-y-4"> <p className="text-gray-600 dark:text-gray-300">请先下载模板文件，按照格式填写任务信息后，再上传文件进行批量导入。</p> <button onClick={onDownloadTemplate} className="w-full px-6 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center justify-center gap-2"><Download size={16} />下载模板</button> <button onClick={onImportClick} className="w-full px-6 py-3 rounded-md text-white bg-teal-600 hover:bg-teal-700 font-semibold flex items-center justify-center gap-2"><Upload size={16} />上传文件</button> </div> </div> </div>); };
        const BackupManagementModal = ({ isOpen, onClose, onBackup, history, onClearHistory }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200"> <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">备份管理</h2> <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button> </header> <div className="p-6 overflow-y-auto space-y-6"> <div> <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">我要备份</h3> <div className="p-4 bg-gray-50 dark:bg-slate-800 rounded-lg border dark:border-slate-700"> <p className="text-sm text-gray-600 dark:text-gray-400 mb-4"> 点击下方按钮，将系统中所有任务（包括回收站）及其完整的历史与进展记录，备份到一个Excel文件中。 此操作将被视为一次正式备份，并重置备份提醒计时。 </p> <button onClick={onBackup} className="w-full px-6 py-3 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold flex items-center justify-center gap-2"> <Database size={16} /> 立即执行全量备份 </button> </div> </div> <div> <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">备份记录</h3> <div className="p-4 bg-gray-50 dark:bg-slate-800 rounded-lg border dark:border-slate-700"> {history.length > 0 ? (<div className="space-y-3 max-h-48 overflow-y-auto pr-2"> {history.map((item, index) => (<div key={index} className="p-2 text-sm rounded-md bg-white dark:bg-slate-700 flex justify-between items-center"> <div> <p className="font-medium text-gray-800 dark:text-gray-200"> 备份了 <span className="text-emerald-500">{item.count}</span> 条记录 </p> <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">{formatDateTime(item.timestamp)}</p> </div> <CheckCircle size={16} className="text-green-500" /> </div>))} </div>) : (<p className="text-center text-sm text-gray-500 dark:text-gray-400 py-4">暂无正式的备份记录。</p>)} </div> </div> </div> <footer className="p-4 flex justify-between items-center gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> <button onClick={onClearHistory} disabled={history.length === 0} className="px-4 py-2 rounded-md text-white bg-red-600 hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed font-semibold flex items-center gap-2"> <Trash2 size={16} /> 清空历史 </button> <button onClick={onClose} className="px-6 py-2 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold ml-auto">关闭</button> </footer> </div> </div>); };
        const Clock = ({ onClick }) => { const [time, setTime] = useState(new Date()); useEffect(() => { const timerId = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timerId); }, []); const formatTime = (date) => { const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); const week = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()]; const hours = date.getHours().toString().padStart(2, '0'); const minutes = date.getMinutes().toString().padStart(2, '0'); const seconds = date.getSeconds().toString().padStart(2, '0'); return `${year}-${month}-${day} 星期${week} ${hours}:${minutes}:${seconds}`; }; return (<div onClick={onClick} className="flex items-center gap-2 cursor-pointer p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="每日一语"> <Calendar size={20} /> <span className="text-sm font-mono whitespace-nowrap hidden md:inline">{formatTime(time)}</span> </div>); };
        const QuoteModal = ({ isOpen, onClose, quote }) => { const [isRendered, setIsRendered] = useState(isOpen); useEffect(() => { if (isOpen) setIsRendered(true); }, [isOpen]); const onAnimationEnd = () => { if (!isOpen) setIsRendered(false); }; if (!isRendered) return null; return (<div onClick={onClose} className="fixed inset-0 z-50 flex justify-center items-center p-4 bg-black/20"> <div className={`quote-modal-${isOpen ? 'enter' : 'exit'}`} onAnimationEnd={onAnimationEnd}> <div className="quote-bubble text-white rounded-lg shadow-2xl px-8 py-5 max-w-2xl text-center"> <p className="text-xl md:text-2xl font-serif">“ {quote.text} ”</p> {quote.source && <p className="text-right mt-3 text-sm opacity-80">- {quote.source}</p>} </div> </div> </div>); };
        const TeamManagementModal = ({ isOpen, onClose, showNotification }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [inviteEmail, setInviteEmail] = useState('');

            // 使用 useCallback 将 fetchUsers 函数包裹起来，以便在多个地方复用它，并提升性能
            const fetchUsers = useCallback(async () => {
                setLoading(true);
                setError('');
                try {
                    // 步骤 1: 像以前一样，获取所有用户列表
                    const { data, error } = await supabase.functions.invoke('get-users');
                    if (error) throw error;

                    // 步骤 2: 获取当前登录用户的信息
                    const { data: { session } } = await supabase.auth.getSession();
                    const currentUserId = session.user.id;

                    // 步骤 3: 从列表中过滤掉当前登录的用户
                    const filteredData = data.filter(user => user.id !== currentUserId);

                    setUsers(filteredData); // 将过滤后的列表设置到 state 中

                } catch (e) {
                    setError('获取用户列表失败: ' + e.message);
                } finally {
                    setLoading(false);
                }
            }, []); // 空依赖数组意味着这个函数本身不会因为组件重渲染而重新创建

            // 这个 useEffect 的作用是：当弹窗被打开(isOpen变为true)时，调用一次我们上面定义的 fetchUsers 函数
            useEffect(() => {
                if (isOpen) {
                    fetchUsers();
                }
            }, [isOpen, fetchUsers]);
            const filteredUsers = useMemo(() => {
                if (!searchTerm) {
                    return users; // 如果搜索框为空，直接返回所有用户
                }
                // 返回邮箱中包含搜索词的用户（不区分大小写）
                return users.filter(user =>
                    user.email.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [users, searchTerm]);

            // 点击“批准”按钮时调用的函数
            const handleApproveUser = async (userId) => {
                try {
                    // 调用我们创建的 approve-user 云函数，并把要批准的用户ID传给它
                    const { data, error } = await supabase.functions.invoke('approve-user', {
                        body: { userId },
                    });
                    if (error) throw error;

                    // 审批成功后，手动更新前端UI，立即看到变化（乐观更新）
                    setUsers(currentUsers =>
                        currentUsers.map(user =>
                            user.id === userId ? { ...user, role: 'approved' } : user
                        )
                    );
                    showNotification('用户批准成功！');

                } catch (e) {
                    showNotification('批准用户失败: ' + e.message, 'error');
                }
            };
            // 点击“撤销”按钮时调用的函数
            const handleRevokeUser = async (userId) => {
                try {
                    // 调用我们刚刚创建的 revoke-user 云函数
                    const { data, error } = await supabase.functions.invoke('revoke-user', {
                        body: { userId },
                    });
                    if (error) throw error;

                    // 撤销成功后，手动更新前端UI
                    setUsers(currentUsers =>
                        currentUsers.map(user =>
                            user.id === userId ? { ...user, role: 'pending' } : user
                        )
                    );
                    showNotification('用户权限已撤销！');

                } catch (e) {
                    showNotification('撤销用户权限失败: ' + e.message, 'error');
                }
            };
            // 点击“删除”按钮时调用的函数
            const handleDeleteUser = async (userId, userEmail) => {
                // 使用 window.confirm 弹出一个二次确认框
                if (window.confirm(`你确定要永久删除用户 ${userEmail} 吗？\n此操作无法撤销！`)) {
                    try {
                        // 调用我们刚刚创建的 delete-user 云函数
                        const { data, error } = await supabase.functions.invoke('delete-user', {
                            body: { userId },
                        });
                        if (error) throw error;

                        // 删除成功后，从前端列表中移除该用户
                        setUsers(currentUsers =>
                            currentUsers.filter(user => user.id !== userId)
                        );
                        showNotification('用户已永久删除！');

                    } catch (e) {
                        showNotification('删除用户失败: ' + e.message, 'error');
                    }
                }
            };
            // 点击“邀请”按钮时调用的函数
            const handleInviteUser = async () => {
                if (!inviteEmail) {
                    showNotification('请输入要邀请的邮箱地址。', 'error');
                    return;
                }
                try {
                    // 调用我们刚刚创建的 invite-user 云函数
                    const { data, error } = await supabase.functions.invoke('invite-user', {
                        body: { email: inviteEmail },
                    });
                    if (error) throw error;

                    showNotification(data.message || '邀请成功！');
                    setInviteEmail(''); // 清空输入框
                    fetchUsers(); // 重新加载用户列表，以显示新邀请的用户

                } catch (e) {
                    showNotification('邀请用户失败: ' + e.message, 'error');
                }
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200">
                        <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">团队管理</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button>
                        </header>
                        <div className="p-6 flex-grow overflow-y-auto">
                            {loading && <p className="text-center">正在加载用户列表...</p>}
                            {error && <p className="text-center text-red-500">{error}</p>}
                            {!loading && !error && (
                                <div className="space-y-4">
                                    {/* --- 邀请新用户表单 --- */}
                                    <div className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border dark:border-slate-200 dark:border-slate-700">
                                        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">邀请新成员</label>
                                        <div className="flex gap-2">
                                            <input
                                                type="email"
                                                placeholder="输入新成员的邮箱地址"
                                                className="flex-grow pl-4 pr-4 py-2 w-full border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200"
                                                value={inviteEmail}
                                                onChange={(e) => setInviteEmail(e.target.value)}
                                            />
                                            <button
                                                onClick={handleInviteUser}
                                                className="px-4 py-2 font-semibold text-white bg-emerald-500 rounded-md hover:bg-emerald-600 flex-shrink-0"
                                            >
                                                发送邀请
                                            </button>
                                        </div>
                                    </div>

                                    {/* --- 搜索框 --- */}
                                    <div className="relative">
                                        <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                        <input
                                            type="text"
                                            placeholder="按邮箱搜索用户..."
                                            className="pl-10 pr-4 py-2 w-full border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white dark:bg-slate-800 dark:border-slate-600 dark:text-slate-200"
                                            value={searchTerm}
                                            onChange={(e) => setSearchTerm(e.target.value)}
                                        />
                                    </div>

                                    {/* --- 用户列表 --- */}
                                    <div className="space-y-2">
                                        <div className="grid grid-cols-3 gap-4 font-semibold border-b pb-2 dark:border-slate-700 text-sm text-slate-500 dark:text-slate-400">
                                            <div>用户邮箱</div>
                                            <div>角色</div>
                                            <div className="text-center">操作</div>
                                        </div>
                                        {filteredUsers.map(user => (
                                            <div key={user.id} className="grid grid-cols-3 gap-4 items-center p-2 rounded hover:bg-slate-100 dark:hover:bg-slate-800">
                                                <div className="truncate text-sm" title={user.email}>{user.email}</div>
                                                <div>
                                                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'admin' ? 'bg-indigo-200 text-indigo-800' :
                                                            user.role === 'approved' ? 'bg-green-200 text-green-800' :
                                                                'bg-yellow-200 text-yellow-800'
                                                        }`}>
                                                        {user.role}
                                                    </span>
                                                </div>
                                                <div className="text-center space-x-2">
                                                    {user.role === 'pending' && (
                                                        <button
                                                            onClick={() => handleApproveUser(user.id)}
                                                            className="px-3 py-1 text-xs font-semibold text-white bg-emerald-500 rounded-md hover:bg-emerald-600"
                                                        >
                                                            批准
                                                        </button>
                                                    )}
                                                    {user.role === 'approved' && (
                                                        <button
                                                            onClick={() => handleRevokeUser(user.id)}
                                                            className="px-3 py-1 text-xs font-semibold text-white bg-red-500 rounded-md hover:bg-red-600"
                                                        >
                                                            撤销
                                                        </button>
                                                    )}
                                                    {user.role !== 'admin' && (
                                                        <button
                                                            onClick={() => handleDeleteUser(user.id, user.email)}
                                                            className="px-3 py-1 text-xs font-semibold text-gray-600 bg-gray-200 rounded-md hover:bg-gray-300 dark:bg-slate-700 dark:text-gray-300 dark:hover:bg-slate-600"
                                                        >
                                                            删除
                                                        </button>
                                                    )}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                            <button onClick={onClose} className="px-6 py-2 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">关闭</button>
                        </footer>
                    </div>
                </div>
            );
        };
        const SetPassword = ({ onPasswordSet }) => {
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [message, setMessage] = useState('欢迎！请设置您的初始密码。');

            const handleSetPassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                try {
                    const { error } = await supabase.auth.updateUser({ password: password });
                    if (error) throw error;
                    setMessage('密码设置成功！正在带您进入系统...');
                    // 延迟一小会，然后通知父组件密码已设置成功
                    setTimeout(() => {
                        onPasswordSet();
                    }, 1500);
                } catch (error) {
                    setError(error.message);
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex flex-col justify-center items-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100">设置密码</h1>
                        </div>
                        <div className="bg-white dark:bg-slate-800 shadow-xl rounded-xl p-8">
                            <form onSubmit={handleSetPassword}>
                                <p className="text-center text-slate-500 dark:text-slate-400 mb-4">{message}</p>
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">新密码</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required />
                                </div>
                                {error && <p className="mt-4 text-sm text-center text-red-500">{error}</p>}
                                <div className="mt-8">
                                    <button type="submit" disabled={loading} className="w-full px-6 py-3 rounded-md text-white font-semibold bg-emerald-500 hover:bg-emerald-600 disabled:bg-emerald-300">
                                        {loading ? '设置中...' : '确认并登录'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 登录组件 ---
        const Login = ({ authError }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isSignUp, setIsSignUp] = useState(false);
            const [error, setError] = useState(null);
            const [message, setMessage] = useState(null);
            const [loading, setLoading] = useState(false);
            useEffect(() => {
                if (authError) {
                    setError(authError);
                }
            }, [authError]);
            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true); setError(null); setMessage(null);
                try {
                    let response; if (isSignUp) { response = await supabase.auth.signUp({ email, password }); if (!response.error) { setMessage('注册成功！请检查您的邮箱以完成验证。'); } } else { // 这里是处理登录的逻辑
                        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

                        if (error) {
                            throw error; // 如果密码错误等，直接抛出异常
                        }

                        // 恢复为简单的登录，不再检查角色
                        response = await supabase.auth.signInWithPassword({ email, password });
                    }
                    if (response.error) {
                        throw response.error;
                    }
                } catch (error) {
                    setError(error.message);
                } finally {
                    setLoading(false);
                }
            };
            return (<div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex flex-col justify-center items-center p-4"> <div className="w-full max-w-md"> <div className="text-center mb-8"> <h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100">咨询任务管理系统</h1> <p className="text-slate-500 dark:text-slate-400 mt-2">协作版 - 请登录</p> </div> <div className="bg-white dark:bg-slate-800 shadow-xl rounded-xl p-8"> <form onSubmit={handleAuth}> <div className="space-y-6"> <div> <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">邮箱</label> <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required /> </div> <div> <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">密码</label> <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required /> </div> </div> {(error || authError) && <p className="mt-4 text-sm text-center text-red-500">{error || authError}</p>} {message && <p className="mt-4 text-sm text-center text-green-500">{message}</p>} <div className="mt-8"> <button type="submit" disabled={loading} className="w-full px-6 py-3 rounded-md text-white font-semibold bg-emerald-500 hover:bg-emerald-600 disabled:bg-emerald-300"> {loading ? '处理中...' : (isSignUp ? '注册' : '登录')} </button> </div> </form> <div className="mt-6 text-center"> <button onClick={() => { setIsSignUp(!isSignUp); setError(null); setMessage(null); }} className="text-sm text-emerald-600 hover:underline dark:text-emerald-400"> {isSignUp ? '已有账户？点击登录' : '没有账户？点击注册'} </button> </div> </div> </div> </div>);
        };

        const Notification = ({ notification, onClose }) => {
            if (!notification.show) return null;

            useEffect(() => {
                const timer = setTimeout(() => {
                    onClose();
                }, 2000); // 2秒后自动关闭
                return () => clearTimeout(timer);
            }, [notification]);

            const baseClasses = "fixed top-5 left-1/2 -translate-x-1/2 transform z-[100] px-6 py-3 rounded-lg shadow-lg text-white font-semibold transition-all duration-300";
            const typeClasses = {
                success: "bg-green-500",
                error: "bg-red-500",
            };

            return (
                <div className={`${baseClasses} ${typeClasses[notification.type]}`}>
                    {notification.message}
                </div>
            );
        };

        // --- 验证包装器 ---
        const AuthWrapper = () => {
    const [session, setSession] = useState(null);
    const [loading, setLoading] = useState(true);
    const [authError, setAuthError] = useState(null);
    const [view, setView] = useState('loading'); // loading, login, app, set_password

    useEffect(() => {
        const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_event, session) => {
            let currentView = 'login';
            let currentAuthError = null;

            if (session) {
                const user = session.user;
                const createdAt = new Date(user.created_at);
                const lastSignInAt = new Date(user.last_sign_in_at);

                // 关键检查 1: 这是不是一个刚接受邀请的新用户？
                // 如果最后登录时间 和 创建时间 几乎相同（比如在5秒内），说明是第一次登录，需要设置密码。
                const isFirstSignIn = Math.abs(lastSignInAt.getTime() - createdAt.getTime()) < 5000;

                if (isFirstSignIn) {
                    currentView = 'set_password';
                } 
                // 关键检查 2: 这是不是一个待审批的用户？
                else if (user.app_metadata?.role === 'pending') {
                    await supabase.auth.signOut();
                    currentAuthError = "您的账户正在等待管理员批准。请联系管理员激活账号。";
                    currentView = 'login';
                } 
                // 如果以上都不是，就是一个正常的登录用户
                else {
                    currentView = 'app';
                }
            }
            
            setSession(session);
            setView(currentView);
            setAuthError(currentAuthError);
            setLoading(false);
        });

        return () => subscription.unsubscribe();
    }, []);

    if (loading) {
        return (
            <div className="flex justify-center items-center h-screen bg-slate-50 dark:bg-slate-900">
                <p className="text-lg text-slate-500">正在初始化...</p>
            </div>
        );
    }
    
    if (view === 'set_password') {
        return <SetPassword onPasswordSet={() => {
            supabase.auth.refreshSession(); // 刷新会话信息
            setView('app'); // 直接进入应用
        }} />;
    }
    
    if (view === 'app' && session) {
        return <App session={session} />;
    }
    
    // 所有其他情况都显示登录页
    return <Login authError={authError} />;
};

        // --- Main App Component ---
        function App({ session }) {
            const [tasks, setTasks] = useState([]);
            const [deletedTasks, setDeletedTasks] = useState([]);
            const [managementData, setManagementData] = useState({ departments: [], salesPersons: [], projectManagers: [], regions: [], taskTypes: [] });
            const [backupHistory, setBackupHistory] = useState(() => {
                try {
                    const savedHistory = window.localStorage.getItem('task_manager_backupHistory');
                    return savedHistory ? JSON.parse(savedHistory) : [];
                } catch (error) {
                    console.error("从localStorage加载备份历史失败", error);
                    return [];
                }
            });
            const [isDarkMode, setIsDarkMode] = useState(() => { try { const item = window.localStorage.getItem('task_manager_isDarkMode_v4.2.3'); return item ? JSON.parse(item) : false; } catch (error) { return false; } });
            const [dailyQuote, setDailyQuote] = useState({ text: '正在获取今日箴言...', source: '网络' });
            const [isQuoteModalOpen, setIsQuoteModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [modalError, setModalError] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [isCompleteModalOpen, setIsCompleteModalOpen] = useState(false);
            const [isBulkCompleteModalOpen, setIsBulkCompleteModalOpen] = useState(false);
            const [completingTask, setCompletingTask] = useState(null);
            const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
            const [historyTask, setHistoryTask] = useState(null);
            const [isStatsModalOpen, setIsStatsModalOpen] = useState(false);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isManagementModalOpen, setIsManagementModalOpen] = useState(false);
            const [isNotificationModalOpen, setIsNotificationModalOpen] = useState(false);
            const [isBackupModalOpen, setIsBackupModalOpen] = useState(false);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [confirmationState, setConfirmationState] = useState({ isOpen: false, title: '', message: '', onConfirm: () => { }, confirmVariant: 'primary' });
            const [currentView, setCurrentView] = useState('inprogress');
            const [activeFilters, setActiveFilters] = useState({ department: null });
            const [searchTerm, setSearchTerm] = useState('');
            const debouncedSearchTerm = useDebounce(searchTerm, 300);
            const [selectedTasks, setSelectedTasks] = useState(new Set());
            const [sortConfig, setSortConfig] = useState({ key: 'createdAt', direction: 'ascending', isExplicit: false });
            const [showBackupReminder, setShowBackupReminder] = useState(false);
            const [actionModalState, setActionModalState] = useState({ isOpen: false, task: null });
            const [importReport, setImportReport] = useState({ isOpen: false, successful: 0, failed: 0, errors: [], originalData: [] });
            const appRef = useRef(null);
            const [notification, setNotification] = useState({ show: false, message: '', type: 'success' });
            const [isTeamModalOpen, setIsTeamModalOpen] = useState(false);

            // --- 从 Supabase 拉取初始数据 ---
            useEffect(() => {
                let isMounted = true;
                const fetchData = async () => {
                    if (isMounted) { setIsLoading(true); }
                    try {
                        const { data: tasksData, error: tasksError } = await supabase.from('tasks').select('*');
                        if (tasksError) throw tasksError;
                        const { data: deletedData, error: deletedError } = await supabase.from('deleted_tasks').select('*');
                        if (deletedError) throw deletedError;
                        const { data: mgmtData, error: mgmtError } = await supabase.from('management_data').select('*').eq('id', 1).single();
                        if (mgmtError && mgmtError.code !== 'PGRST116') throw mgmtError;
                        if (isMounted) {
                            setTasks((tasksData || []).map(fromSnakeCase));
                            setDeletedTasks(deletedData.map(item => ({ ...fromSnakeCase(item.data), id: item.id, deletedAt: item.deleted_at })) || []);
                            if (mgmtData) {
                                setManagementData({
                                    id: mgmtData.id, departments: mgmtData.departments || [], regions: mgmtData.regions || [],
                                    salesPersons: mgmtData.sales_persons || [], projectManagers: mgmtData.project_managers || [], taskTypes: mgmtData.task_types || []
                                });
                            }
                        }
                    } catch (error) {
                        console.error("加载数据失败:", error);
                        alert("从云端加载数据失败: " + error.message);
                    } finally {
                        if (isMounted) { setIsLoading(false); }
                    }
                };
                fetchData();
                return () => { isMounted = false; };
            }, []);

            // --- 实时同步 ---
            useEffect(() => {
                const channel = supabase.channel('public-db-changes');
                const handleDbChange = (payload) => {
                    console.log('数据库发生变更:', payload);
                    const { eventType, table, new: newRecord, old: oldRecord } = payload;
                    if (table === 'tasks') {
                        if (eventType === 'INSERT') {
                            const newTask = fromSnakeCase(newRecord);
                            setTasks(currentTasks => {
                                if (currentTasks.some(t => t.id === newTask.id)) return currentTasks;
                                return [...currentTasks, newTask];
                            });
                        }
                        if (eventType === 'UPDATE') {
                            const updatedTask = fromSnakeCase(newRecord);
                            setTasks(currentTasks => currentTasks.map(task => task.id === updatedTask.id ? updatedTask : task));
                        }
                        if (eventType === 'DELETE') {
                            setTasks(currentTasks => currentTasks.filter(task => task.id !== oldRecord.id));
                        }
                    } else if (table === 'deleted_tasks') {
                        if (eventType === 'INSERT') {
                            const newDeletedTask = { ...fromSnakeCase(newRecord.data), id: newRecord.id, deletedAt: newRecord.deleted_at };
                            setDeletedTasks(current => {
                                if (current.some(t => t.id === newDeletedTask.id)) return current;
                                return [...current, newDeletedTask];
                            });
                        }
                        if (eventType === 'DELETE') {
                            setDeletedTasks(current => current.filter(t => t.id !== oldRecord.id));
                        }
                    } else if (table === 'management_data' && eventType === 'UPDATE') {
                        setManagementData({
                            id: newRecord.id, departments: newRecord.departments || [], regions: newRecord.regions || [],
                            salesPersons: newRecord.sales_persons || [], projectManagers: newRecord.project_managers || [], taskTypes: newRecord.task_types || []
                        });
                    }
                };
                channel.on('postgres_changes', { event: '*', schema: 'public' }, handleDbChange).subscribe();
                return () => { supabase.removeChannel(channel); };
            }, []);

            useEffect(() => { const root = window.document.documentElement; if (isDarkMode) root.classList.add('dark'); else root.classList.remove('dark'); localStorage.setItem('task_manager_isDarkMode_v4.2.3', JSON.stringify(isDarkMode)); }, [isDarkMode]);
            useEffect(() => { const handleFullscreenChange = () => setIsFullscreen(!!document.fullscreenElement); document.addEventListener('fullscreenchange', handleFullscreenChange); document.addEventListener('webkitfullscreenchange', handleFullscreenChange); return () => { document.removeEventListener('fullscreenchange', handleFullscreenChange); document.removeEventListener('webkitfullscreenchange', handleFullscreenChange); }; }, []);
            useEffect(() => { const daysSinceLastBackup = backupHistory.length > 0 ? Math.floor((new Date() - new Date(backupHistory[0].timestamp)) / (1000 * 60 * 60 * 24)) : null; if (daysSinceLastBackup === null || daysSinceLastBackup > 30) { setShowBackupReminder(true); } else { setShowBackupReminder(false); } }, [backupHistory]);
            useEffect(() => {
                try {
                    window.localStorage.setItem('task_manager_backupHistory', JSON.stringify(backupHistory));
                } catch (error) {
                    console.error("向localStorage保存备份历史失败", error);
                }
            }, [backupHistory]);

            const filteredAndSortedTasks = useMemo(() => {
                let sourceTasks = currentView === 'deleted' ? [...deletedTasks] : tasks.filter(t => t.status === currentView);
                let filtered = sourceTasks.filter(task => {
                    const { department } = activeFilters;
                    if (department && task.department !== department) return false;
                    if (debouncedSearchTerm.trim() === '') return true;
                    const lowerCaseSearchTerm = debouncedSearchTerm.toLowerCase();
                    return [task.customTaskId, task.projectName, task.region, task.taskType, task.salesPerson, task.projectManager].some(field => field && String(field).toLowerCase().includes(lowerCaseSearchTerm));
                });
                filtered.sort((a, b) => {
                    const key = sortConfig.key;
                    if (a[key] == null) return 1; if (b[key] == null) return -1;
                    let aValue = a[key]; let bValue = b[key];
                    if (['createdAt', 'deletedAt', 'contractualDueDate', 'actualCompletionDate'].includes(key)) { aValue = new Date(aValue); bValue = new Date(bValue); }
                    if (key === 'contractAmount') { aValue = Number(aValue) || 0; bValue = Number(bValue) || 0; }
                    if (aValue < bValue) return sortConfig.direction === 'ascending' ? -1 : 1;
                    if (aValue > bValue) return sortConfig.direction === 'ascending' ? 1 : -1;
                    return 0;
                });
                return filtered;
            }, [tasks, deletedTasks, currentView, activeFilters, debouncedSearchTerm, sortConfig]);

            // --- 所有数据库操作函数和辅助函数 ---
            const showNotification = (message, type = 'success') => {
                setNotification({ show: true, message, type });
            };

            const handleSaveTask = async (taskData, isEdit) => {
                setModalError(null);
                try {
                    if (isEdit) {
                        const originalTask = tasks.find(t => t.id === taskData.id);
                        const changes = generateChangeLog(originalTask, taskData);
                        let newHistory = originalTask.history || [];
                        if (changes.length > 0) {
                            newHistory = [...newHistory, ...changes.map(c => ({ action: c, timestamp: new Date().toISOString() }))];
                        }
                        const dataForSupabase = toSnakeCase({ ...taskData, history: newHistory });
                        const { error } = await supabase.from('tasks').update(dataForSupabase).eq('id', taskData.id);
                        if (error) throw error;
                    } else {
                        const dataForSupabase = toSnakeCase({ ...taskData, history: [{ action: '创建了任务', timestamp: new Date().toISOString() }] });
                        const { data: existing, error: checkError } = await supabase.from('tasks').select('id').eq('custom_task_id', taskData.customTaskId).maybeSingle();
                        if (checkError) throw checkError;
                        if (existing) {
                            throw new Error(`任务编号 "${taskData.customTaskId}" 已存在。`);
                        }
                        const { error } = await supabase.from('tasks').insert(dataForSupabase);
                        if (error) throw error;
                    }
                    handleCloseModal();
                    showNotification(isEdit ? '任务更新成功！' : '任务创建成功！');
                } catch (error) {
                    setModalError("保存失败: " + error.message);
                    showNotification("保存失败: " + error.message, 'error');
                }
            };

            const handleConfirmCompleteTask = async (task, completionDate) => {
                const newHistory = [...(task.history || []), { action: '标记为已完成', timestamp: new Date().toISOString() }];
                const updatedData = { status: 'done', actual_completion_date: completionDate, history: newHistory };
                const { error } = await supabase.from('tasks').update(updatedData).eq('id', task.id);
                if (error) { showNotification("完成任务失败: " + error.message, 'error'); }
                else { showNotification("任务已标记为完成！"); }
                setIsCompleteModalOpen(false);
            };

            const handleConfirmBulkComplete = async (completionDate) => {
                const updates = Array.from(selectedTasks).map(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    const newHistory = [...(task.history || []), { action: '通过批量操作标记为已完成', timestamp: new Date().toISOString() }];
                    const updatedTaskObject = { ...task, status: 'done', actualCompletionDate: completionDate, history: newHistory };
                    return { id: taskId, ...toSnakeCase(updatedTaskObject) };
                });
                const { error } = await supabase.from('tasks').upsert(updates);
                if (error) { showNotification("批量完成失败: " + error.message, 'error'); }
                else { setSelectedTasks(new Set()); showNotification("批量完成操作成功！"); }
                setIsBulkCompleteModalOpen(false);
            };

            const handleDeleteTask = async (taskId) => {
                const taskToDelete = tasks.find(t => t.id === taskId);
                if (!taskToDelete) return;
                const { error: insertError } = await supabase.from('deleted_tasks').insert({ original_id: taskToDelete.id, data: toSnakeCase(taskToDelete) });
                if (insertError) { showNotification("移入回收站失败: " + insertError.message, 'error'); return; }
                const { error: deleteError } = await supabase.from('tasks').delete().eq('id', taskId);
                if (deleteError) { showNotification("删除原始任务失败: " + deleteError.message, 'error'); }
                else { showNotification("任务已移入回收站！"); }
            };

            const handleConfirmBulkDelete = async () => {
                const tasksToDelete = Array.from(selectedTasks).map(id => tasks.find(t => t.id === id)).filter(Boolean);
                const deletedRecords = tasksToDelete.map(task => ({ original_id: task.id, data: toSnakeCase(task) }));
                const { error: insertError } = await supabase.from('deleted_tasks').insert(deletedRecords);
                if (insertError) { showNotification("批量移入回收站失败: " + insertError.message, 'error'); return; }
                const idsToDelete = tasksToDelete.map(t => t.id);
                const { error: deleteError } = await supabase.from('tasks').delete().in('id', idsToDelete);
                if (deleteError) { showNotification("批量删除原始任务失败: " + deleteError.message, 'error'); }
                else { setSelectedTasks(new Set()); showNotification("批量删除操作成功！"); }
            };

            const handleArchiveTask = async (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                const newHistory = [...(task.history || []), { action: '存档了任务', timestamp: new Date().toISOString() }];
                const { error } = await supabase.from('tasks').update({ is_archived: true, history: newHistory }).eq('id', taskId);
                if (error) { showNotification("存档失败: " + error.message, 'error'); }
                else { showNotification("任务已存档！"); }
            };

            const handleVoidTask = async (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                const newHistory = [...(task.history || []), { action: '标记为已作废', timestamp: new Date().toISOString() }];
                const { error } = await supabase.from('tasks').update({ status: 'void', history: newHistory }).eq('id', taskId);
                if (error) { showNotification("作废失败: " + error.message, 'error'); }
                else { showNotification("任务已作废！"); }
            };

            const handleConfirmBulkVoid = async () => {
                const updates = Array.from(selectedTasks).map(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    const newHistory = [...(task.history || []), { action: '通过批量操作标记为已作废', timestamp: new Date().toISOString() }];
                    const updatedTaskObject = { ...task, status: 'void', history: newHistory };
                    return { id: taskId, ...toSnakeCase(updatedTaskObject) };
                });
                const { error } = await supabase.from('tasks').upsert(updates);
                if (error) { showNotification("批量作废失败: " + error.message, 'error'); }
                else { setSelectedTasks(new Set()); showNotification("批量作废操作成功！"); }
            };

            const handleRevertTask = async (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                const fromStatus = task.status === 'done' ? '已完成' : '已作废';
                const newHistory = [...(task.history || []), { action: `从"${fromStatus}"状态退回`, timestamp: new Date().toISOString() }];
                const { error } = await supabase.from('tasks').update({ status: 'inprogress', history: newHistory, actual_completion_date: null }).eq('id', taskId);
                if (error) { showNotification("退回失败: " + error.message, 'error'); }
                else { showNotification("任务已退回到“进行中”！"); }
            };

            const handleSaveProgress = async (taskId, newProgressText) => {
                const task = tasks.find(t => t.id === taskId);
                const newProgressDetails = [...(task.progressDetails || []), { text: newProgressText, timestamp: new Date().toISOString() }];
                const { error } = await supabase.from('tasks').update({ progress_details: newProgressDetails }).eq('id', taskId);
                if (error) { showNotification("保存进展失败: " + error.message, 'error'); }
                else { showNotification("项目进展已保存！"); }
            };

            const handlePermanentDelete = async (taskId) => {
                const { error } = await supabase.from('deleted_tasks').delete().eq('id', taskId);
                if (error) { showNotification("永久删除失败: " + error.message, 'error'); }
                else { showNotification("任务已永久删除！"); }
                closeConfirmationModal();
            };

            const handleSaveManagementData = async (newData) => {
                const dataForSupabase = {
                    departments: newData.departments, regions: newData.regions,
                    sales_persons: newData.salesPersons, project_managers: newData.projectManagers,
                    task_types: newData.taskTypes
                };
                const { error } = await supabase.from('management_data').update(dataForSupabase).eq('id', 1);
                if (error) { showNotification("保存配置失败: " + error.message, 'error'); }
                else { showNotification("配置已成功保存！"); }
            };

            // --- 其他所有非数据库交互的 handler 函数 ---
            const handleTaskAction = (actionType, data) => { setActionModalState({ isOpen: false, task: null }); let confirmationData; switch (actionType) { case 'openActionModal': setActionModalState({ isOpen: true, task: data }); return; case 'edit': handleOpenModal(data); return; case 'progress': setHistoryTask(data); setIsHistoryModalOpen(true); return; case 'complete': setCompletingTask(data); setIsCompleteModalOpen(true); return; case 'archive': confirmationData = { title: '存档任务', children: `您确定要存档任务 "${data.projectName}" 吗？`, onConfirm: () => handleArchiveTask(data.id), confirmVariant: 'primary' }; break; case 'void': confirmationData = { title: '作废任务', confirmVariant: 'danger', onConfirm: () => handleVoidTask(data.id), children: (<div><p>您确定要作废以下任务吗？</p><div className="mt-2 p-2 bg-gray-100 dark:bg-slate-700 border dark:border-slate-600 rounded-md text-sm"><p className="font-semibold">{data.projectName}</p><p className="text-xs text-gray-600 dark:text-gray-400">{data.taskType}</p></div></div>) }; break; case 'delete': confirmationData = { title: '删除任务', confirmVariant: 'danger', onConfirm: () => handleDeleteTask(data.id), children: (<div><p>您确定要删除以下任务吗？它将被移动到回收站。</p><div className="mt-2 p-2 bg-gray-100 dark:bg-slate-700 border dark:border-slate-600 rounded-md text-sm"><p className="font-semibold">{data.projectName}</p><p className="text-xs text-gray-600 dark:text-gray-400">{data.taskType}</p></div></div>) }; break; case 'revert': confirmationData = { title: '退回任务', children: `您确定要将任务 "${data.customTaskId}" 退回到“进行中”状态吗？`, onConfirm: () => handleRevertTask(data.id), confirmVariant: 'primary' }; break; case 'permanentDelete': confirmationData = { title: '永久删除任务', children: `您确定要永久删除任务 "${data.projectName}" 吗？此操作无法撤销。`, onConfirm: () => handlePermanentDelete(data.id), confirmVariant: 'danger' }; break; case 'clearBin': confirmationData = { title: '清空回收站', children: `您确定要永久删除回收站中的所有 ${deletedTasks.length} 个任务吗？此操作无法撤销。`, onConfirm: () => handleClearRecycleBin(), confirmVariant: 'danger' }; break; default: return; } setConfirmationState({ isOpen: true, ...confirmationData }); };
            const handleBulkAction = (action) => { if (action === 'clearSelection') { setSelectedTasks(new Set()); return; } if (action === 'bulkComplete') { setIsBulkCompleteModalOpen(true); return; } let confirmationData; if (action === 'bulkVoid') { confirmationData = { title: '批量作废任务', confirmVariant: 'danger', onConfirm: handleConfirmBulkVoid, children: (<div><p>您确定要作废选中的 <span className="font-bold">{selectedTasks.size}</span> 个任务吗？</p><div className="mt-2 bg-gray-50 border border-gray-200 rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 dark:bg-slate-700 dark:border-slate-600">{selectedTaskObjects.map(task => (<div key={task.id} className="text-sm"><p className="font-semibold text-gray-800 dark:text-gray-200">{task.projectName}</p><p className="text-xs text-gray-500 dark:text-gray-400 pl-2">{task.taskType}</p></div>))}</div></div>) }; } else if (action === 'bulkDelete') { confirmationData = { title: '批量删除任务', confirmVariant: 'danger', onConfirm: handleConfirmBulkDelete, children: (<div><p>您确定要删除选中的 <span className="font-bold">{selectedTasks.size}</span> 个任务吗？它们将被移动到回收站。</p><div className="mt-2 bg-gray-50 border border-gray-200 rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 dark:bg-slate-700 dark:border-slate-600">{selectedTaskObjects.map(task => (<div key={task.id} className="text-sm"><p className="font-semibold text-gray-800 dark:text-gray-200">{task.projectName}</p><p className="text-xs text-gray-500 dark:text-gray-400 pl-2">{task.taskType}</p></div>))}</div></div>) }; } setConfirmationState({ isOpen: true, ...confirmationData }); };
            const handleClearRecycleBin = async () => { const idsToDelete = deletedTasks.map(t => t.id); if (idsToDelete.length === 0) return; const { error } = await supabase.from('deleted_tasks').delete().in('id', idsToDelete); if (error) { showNotification("清空回收站失败: " + error.message, 'error'); } else { showNotification("回收站已清空！"); } closeConfirmationModal(); };
            const toggleDarkMode = () => setIsDarkMode(prev => !prev);
            const toggleFullscreen = () => { const elem = appRef.current; if (!elem) return; if (!document.fullscreenElement) { if (elem.requestFullscreen) elem.requestFullscreen().catch(err => alert(`全屏失败: ${err.message}`)); else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); } };
            const handleOpenModal = (task = null) => { setEditingTask(task); setIsTaskModalOpen(true); };
            const handleCloseModal = () => { setIsTaskModalOpen(false); setEditingTask(null); setModalError(null); };
            const closeConfirmationModal = () => setConfirmationState({ isOpen: false, title: '', message: '', onConfirm: () => { } });
            const handleConfirm = () => { if (typeof confirmationState.onConfirm === 'function') { confirmationState.onConfirm(); } closeConfirmationModal(); };
            const selectedTaskObjects = useMemo(() => { const selectedIds = Array.from(selectedTasks); return tasks.filter(task => selectedIds.includes(task.id)); }, [tasks, selectedTasks]);
            const handleSelectAll = (e) => { if (e.target.checked) { setSelectedTasks(new Set(filteredAndSortedTasks.map(t => t.id))); } else { setSelectedTasks(new Set()); } };
            const handleClearBackupHistory = () => { setConfirmationState({ isOpen: true, title: '清空备份历史', children: '您确定要清空所有备份历史记录吗？此操作无法撤销。', onConfirm: () => { setBackupHistory([]); setIsBackupModalOpen(false); }, confirmVariant: 'danger' }); };
            const handleDownloadTemplate = () => { const templateHeaders = ["任务下达日期", "任务编号", "项目名称", "任务类型", "所属部门", "合同金额(元)", "业务人员", "项目负责人", "合同规定完成日期", "实际完成日期", "项目进展情况", "所属地区", "状态", "是否存档"]; const ws = window.XLSX.utils.aoa_to_sheet([templateHeaders]); const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "Tasks"); window.XLSX.writeFile(wb, "任务导入模板.xlsx"); };
            const handleFileUpload = async (event) => { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = async (e) => { try { const data = new Uint8Array(e.target.result); const workbook = window.XLSX.read(data, { type: 'array' }); const worksheet = workbook.Sheets[workbook.SheetNames[0]]; const fullData = window.XLSX.utils.sheet_to_json(worksheet, { defval: "" }); const { data: existingTasksData } = await supabase.from('tasks').select('custom_task_id'); const existingTaskIds = new Set((existingTasksData || []).map(t => t.custom_task_id)); const importFileTaskIds = new Set(); const validTasksToInsert = []; const rejectedTasks = []; const statusMap = { '进行中': 'inprogress', '已完成': 'done', '已作废': 'void' }; fullData.forEach((row, index) => { const customTaskId = row["任务编号"] ? String(row["任务编号"]).trim() : ''; let errors = []; if (!customTaskId || !row["项目名称"] || !row["任务类型"] || !row["项目负责人"] || !row["任务下达日期"]) { errors.push('必需字段(任务编号,项目名称,任务类型,负责人,下达日期)不能为空'); } if (existingTaskIds.has(customTaskId)) { errors.push('任务编号在系统中已存在'); } if (importFileTaskIds.has(customTaskId)) { errors.push('任务编号在文件中重复'); } if (errors.length > 0) { rejectedTasks.push({ row: index + 2, id: customTaskId, reason: errors.join('; ') }); return; } const parseDate = (excelDate) => { if (!excelDate) return null; if (typeof excelDate === 'number') { return new Date(Math.round((excelDate - 25569) * 86400 * 1000)).toISOString(); } if (typeof excelDate === 'string' && new Date(excelDate).toString() !== 'Invalid Date') { return new Date(excelDate).toISOString(); } return null; }; let taskStatus = 'inprogress'; const excelStatus = row["状态"] ? String(row["状态"]).trim() : ''; if (excelStatus && statusMap[excelStatus]) { taskStatus = statusMap[excelStatus]; } else if (row["实际完成日期"]) { taskStatus = 'done'; } const task = { customTaskId, projectName: row["项目名称"], taskType: row["任务类型"], projectManager: row["项目负责人"], createdAt: parseDate(row["任务下达日期"]), region: row["所属地区"] || '', department: row["所属部门"] || '', contractAmount: Number(row["合同金额(元)"]) || null, salesPerson: row["业务人员"] || '', contractualDueDate: parseDate(row["合同规定完成日期"]), actualCompletionDate: parseDate(row["实际完成日期"]), status: taskStatus, progressDetails: row["项目进展情况"] ? [{ text: row["项目进展情况"], timestamp: new Date().toISOString() }] : [], isArchived: String(row["是否存档"]).trim() === '是', history: [{ action: '通过Excel导入创建', timestamp: new Date().toISOString() }] }; validTasksToInsert.push(toSnakeCase(task)); importFileTaskIds.add(customTaskId); }); if (validTasksToInsert.length > 0) { const { error } = await supabase.from('tasks').insert(validTasksToInsert); if (error) throw error; } if (rejectedTasks.length > 0) { setImportReport({ isOpen: true, successful: validTasksToInsert.length, failed: rejectedTasks.length, errors: rejectedTasks, originalData: fullData }); showNotification(`导入完成，${validTasksToInsert.length}条成功，${rejectedTasks.length}条失败。`, 'success'); } else { showNotification(`导入成功！共 ${validTasksToInsert.length} 条任务已添加。`, 'success'); } } catch (err) { console.error("File Read/Import error:", err); showNotification("读取或导入文件失败: " + err.message, 'error'); } finally { event.target.value = ''; } }; reader.readAsArrayBuffer(file); };
            const exportErrorData = () => { const { errors, originalData } = importReport; const errorMap = new Map(); errors.forEach(err => errorMap.set(err.row, err.reason)); const errorRows = originalData.filter((_, index) => errorMap.has(index + 2)); const dataToExport = errorRows.map((row, index) => ({ ...row, '错误说明': errorMap.get(errors[index].row) })); const ws = window.XLSX.utils.json_to_sheet(dataToExport); const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "错误报告"); window.XLSX.writeFile(wb, "导入错误报告.xlsx"); };
            const handleBackupSuccess = (count) => { const now = new Date().toISOString(); setBackupHistory(prev => [{ timestamp: now, count }, ...prev].slice(0, 50)); setIsBackupModalOpen(false); showNotification(`全量备份成功！共 ${count} 条任务数据已完整备份。`); };
            const exportFullBackup = () => { const allTasksWithData = [...tasks, ...deletedTasks]; const statusMap = { inprogress: '进行中', done: '已完成', void: '作废' }; if (allTasksWithData.length === 0) { showNotification("系统中没有可备份的任务。", "error"); return; } const dataForExport = allTasksWithData.map(task => { const combinedHistory = [...(task.history || []).map(h => ({ ...h, type: '操作' })), ...(task.progressDetails || []).map(p => ({ timestamp: p.timestamp, action: `进展: ${p.text}`, type: '进展' }))].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); const historyString = combinedHistory.map(entry => `[${formatDateTime(entry.timestamp)}] ${entry.action}`).join('\n'); let statusText = statusMap[task.status] || task.status; if (deletedTasks.some(dt => dt.id === task.id)) { statusText = "回收站"; } return { "任务下达日期": formatDate(task.createdAt), "任务编号": task.customTaskId, "项目名称": task.projectName, "任务类型": task.taskType, "所属部门": task.department, "合同金额(元)": task.contractAmount, "业务人员": task.salesPerson, "项目负责人": task.projectManager, "合同规定完成日期": formatDate(task.contractualDueDate), "实际完成日期": formatDate(task.actualCompletionDate), "所属地区": task.region, "是否存档": task.isArchived ? "是" : "否", "状态": statusText, "项目进展与修改全记录": historyString, }; }); try { const ws = window.XLSX.utils.json_to_sheet(dataForExport); const cols = Object.keys(dataForExport[0] || {}).map(key => ({ wch: key === "项目进展与修改全记录" ? 80 : (key === "项目名称" ? 40 : 20) })); ws['!cols'] = cols; const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "系统全量数据"); window.XLSX.writeFile(wb, `系统全量备份_${formatDate(new Date())}.xlsx`); handleBackupSuccess(allTasksWithData.length); } catch (e) { console.error("Full backup export failed:", e); showNotification("全量备份失败，详情请查看控制台。", "error"); } };
            const handleClockClick = async () => { const todayStr = new Date().toISOString().split('T')[0]; const storedQuoteData = localStorage.getItem(`dailyQuote-${todayStr}`); if (storedQuoteData) { setDailyQuote(JSON.parse(storedQuoteData)); } else { try { const response = await fetch('https://v1.hitokoto.cn/?encode=json&charset=utf-8'); if (!response.ok) throw new Error('Network response was not ok'); const data = await response.json(); const newQuote = { text: data.hitokoto, source: data.from_who || data.from }; setDailyQuote(newQuote); localStorage.setItem(`dailyQuote-${todayStr}`, JSON.stringify(newQuote)); } catch (error) { console.error("Failed to fetch daily quote:", error); setDailyQuote({ text: '今日获取箴言失败，请检查网络连接。', source: '系统' }); } } setIsQuoteModalOpen(true); };
            const handleToggleSelectTask = (taskId) => { setSelectedTasks(prev => { const newSet = new Set(prev); if (newSet.has(taskId)) { newSet.delete(taskId); } else { newSet.add(taskId); } return newSet; }); };
            const handleResetFilters = () => { setActiveFilters({ department: null }); setSearchTerm(''); };
            const allNonDeletedTasks = useMemo(() => tasks.filter(t => ['inprogress', 'done', 'void'].includes(t.status)), [tasks]);
            const requestSort = (key) => { let direction = 'ascending'; if (sortConfig.key === key && sortConfig.direction === 'ascending') { direction = 'descending'; } setSortConfig({ key, direction, isExplicit: true }); };
            const clearSort = () => { const defaultSortKey = currentView === 'deleted' ? 'deletedAt' : 'createdAt'; const defaultDirection = currentView === 'deleted' ? 'descending' : 'ascending'; setSortConfig({ key: defaultSortKey, direction: defaultDirection, isExplicit: false }); };
            const departmentFilterOptions = useMemo(() => [{ label: '所有部门', value: null }, ...managementData.departments.map(dep => ({ label: dep, value: dep }))], [managementData.departments]);
            const tasksForCount = useMemo(() => { if (!activeFilters.department) return tasks; return tasks.filter(task => task.department === activeFilters.department); }, [tasks, activeFilters.department]);
            const urgentTaskCount = useMemo(() => tasks.filter(t => t.status === 'inprogress' && t.contractualDueDate && (new Date(t.contractualDueDate) - new Date()) / (1000 * 3600 * 24) <= 7).length, [tasks]);

            return (
                <div ref={appRef} className="h-screen bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 p-4 lg:p-6 flex flex-col">
                    <Notification notification={notification} onClose={() => setNotification({ ...notification, show: false })} />
                    <TaskModal isOpen={isTaskModalOpen} onClose={handleCloseModal} onSave={handleSaveTask} task={editingTask} error={modalError} setError={setModalError} managementData={managementData} />
                    <HistoryModal isOpen={isHistoryModalOpen} onClose={() => setIsHistoryModalOpen(false)} onSave={handleSaveProgress} task={historyTask} />
                    <CompleteTaskModal isOpen={isCompleteModalOpen} onClose={() => setIsCompleteModalOpen(false)} onConfirm={handleConfirmCompleteTask} task={completingTask} />
                    <BulkCompleteModal isOpen={isBulkCompleteModalOpen} onClose={() => setIsBulkCompleteModalOpen(false)} onConfirm={handleConfirmBulkComplete} tasksToComplete={selectedTaskObjects} />
                    <ConfirmationModal isOpen={confirmationState.isOpen} onClose={closeConfirmationModal} onConfirm={handleConfirm} title={confirmationState.title} confirmVariant={confirmationState.confirmVariant}>{confirmationState.children}</ConfirmationModal>
                    <StatisticsModal isOpen={isStatsModalOpen} onClose={() => setIsStatsModalOpen(false)} tasks={allNonDeletedTasks} />
                    <ExportModal isOpen={isExportModalOpen} onClose={() => setIsExportModalOpen(false)} allNonDeletedTasks={allNonDeletedTasks} />
                    <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onDownloadTemplate={handleDownloadTemplate} onImportClick={() => { document.getElementById('fileUploader').click(); setIsImportModalOpen(false); }} />
                    <ManagementModal isOpen={isManagementModalOpen} onClose={() => setIsManagementModalOpen(false)} managementData={managementData} onSave={handleSaveManagementData} />
                    <ActionModal state={actionModalState} onClose={() => setActionModalState({ isOpen: false, task: null })} onActionSelect={handleTaskAction} />
                    <ImportReportModal isOpen={importReport.isOpen} onClose={() => setImportReport(prev => ({ ...prev, isOpen: false }))} report={importReport} onExportErrors={exportErrorData} />
                    <NotificationModal isOpen={isNotificationModalOpen} onClose={() => setIsNotificationModalOpen(false)} tasks={tasks} />
                    <BackupManagementModal isOpen={isBackupModalOpen} onClose={() => setIsBackupModalOpen(false)} history={backupHistory} onClearHistory={handleClearBackupHistory} onBackup={exportFullBackup} />
                    <QuoteModal isOpen={isQuoteModalOpen} onClose={() => setIsQuoteModalOpen(false)} quote={dailyQuote} />
                    <TeamManagementModal isOpen={isTeamModalOpen} onClose={() => setIsTeamModalOpen(false)} showNotification={showNotification} />
                    <input type="file" id="fileUploader" accept=".xlsx, .xls, .csv" style={{ display: 'none' }} onChange={handleFileUpload} />

                    <header className="flex-shrink-0 flex flex-wrap items-center justify-between gap-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                        <div>
                            <h1 className="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-slate-100">咨询任务管理系统</h1>
                            <p className="text-sm text-slate-500 dark:text-slate-400">版本 4.2.3 - 协作版</p>
                        </div>
                        <div className="flex items-center gap-4 ml-auto">
                            <span className="text-sm font-medium text-slate-600 dark:text-slate-300 hidden md:inline">
                                欢迎, {session.user.email}
                            </span>
                            <button onClick={() => supabase.auth.signOut()} className="flex items-center gap-2 px-3 py-2 bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200 rounded-lg font-semibold shadow-sm hover:bg-slate-300 dark:hover:bg-slate-600">
                                <LogOut size={16} />
                                <span>登出</span>
                            </button>
                        </div>
                    </header>

                    <div className="flex-shrink-0 mb-4 flex items-center gap-4 flex-wrap">
                        <div className="flex gap-2 flex-wrap">
                            <button onClick={() => handleOpenModal()} className="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg font-semibold shadow-sm hover:bg-emerald-600"><Plus size={18} />创建任务</button>
                            <button onClick={() => setIsImportModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-sky-500 text-white rounded-lg font-semibold shadow-sm hover:bg-sky-600"><Upload size={16} />导入</button>
                            <button onClick={() => setIsExportModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold shadow-sm hover:bg-blue-600"><Download size={16} />导出</button>
                            <button onClick={() => setIsStatsModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-violet-500 text-white rounded-lg font-semibold shadow-sm hover:bg-violet-600"><BarChart2 size={16} />统计</button>
                            <button onClick={() => setIsManagementModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-500 text-white rounded-lg font-semibold shadow-sm hover:bg-slate-600"><Settings size={16} />管理配置</button>
                            <button onClick={() => setIsTeamModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold shadow-sm hover:bg-indigo-600"><Users size={16} />团队管理</button>
                        </div>
                        {showBackupReminder && (<div className="flex-grow mx-4 p-2 banner-pulse bg-amber-100 border-l-4 border-amber-500 text-amber-800 dark:bg-amber-900/20 dark:text-amber-300 dark:border-amber-500 rounded-lg flex items-center justify-between shadow-sm"> <div className="flex items-center"> <AlertTriangle size={20} className="mr-3 text-amber-600 dark:text-amber-400 flex-shrink-0" /> <p className="text-sm font-semibold">数据备份提醒：您已超过30天未执行全量备份，建议及时处理。</p> </div> <button onClick={() => setShowBackupReminder(false)} className="p-1 text-slate-600 dark:text-slate-300 hover:bg-amber-200 dark:hover:bg-amber-800/50 rounded-full" title="暂时忽略"> <X size={18} /> </button> </div>)}
                        <div className="flex items-center gap-2 ml-auto">
                            <button onClick={() => setIsBackupModalOpen(true)} className="relative p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="备份管理"> <Database size={20} /> {backupHistory.length > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center border-2 border-white dark:border-slate-900">{Math.floor((new Date() - new Date(backupHistory[0].timestamp)) / (1000 * 60 * 60 * 24))}</span>} </button>
                            <button onClick={() => setIsNotificationModalOpen(true)} className="relative p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="消息提醒"> <Bell size={20} /> {urgentTaskCount > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center border-2 border-white dark:border-slate-900">{urgentTaskCount}</span>} </button>
                            <button onClick={toggleDarkMode} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="切换主题"> {isDarkMode ? <Sun size={20} /> : <Moon size={20} />} </button>
                            <button onClick={toggleFullscreen} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="全屏"> {isFullscreen ? <Minimize size={20} /> : <Maximize size={20} />} </button>
                            <Clock onClick={handleClockClick} />
                        </div>
                    </div>

                    <main className="bg-white dark:bg-slate-800/50 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 flex flex-col flex-grow min-h-0 overflow-hidden">
                        <div className="flex-shrink-0 p-2 bg-slate-100/70 dark:bg-slate-800 rounded-t-xl border-b border-slate-200 dark:border-slate-700 flex flex-wrap items-center justify-between gap-4">
                            <div className="flex items-center gap-1 border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 rounded-lg p-1">
                                {['inprogress', 'done', 'void', 'deleted'].map(view => { const viewMap = { inprogress: '进行中', done: '已完成', void: '已作废', deleted: '回收站' }; const count = view === 'deleted' ? deletedTasks.length : tasksForCount.filter(t => t.status === view).length; return (<button key={view} onClick={() => { setCurrentView(view); setSelectedTasks(new Set()); }} className={`px-4 py-1.5 rounded-md text-sm font-semibold transition-colors ${currentView === view ? 'bg-emerald-500 text-white shadow' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'}`}> {viewMap[view]} <span className={`ml-1 px-1.5 py-0.5 rounded-full text-xs ${currentView === view ? 'bg-white/20' : 'bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>{count}</span> </button>); })}
                            </div>

                            <div className="flex items-center gap-2 ml-auto">
                                <div className="w-64"><SingleSelectDropdown options={departmentFilterOptions} value={activeFilters.department} onChange={(val) => setActiveFilters(prev => ({ ...prev, department: val }))} placeholder="所有部门" buttonClassName="bg-white dark:bg-slate-700/80 border-slate-300 dark:border-slate-600" /></div>
                                <div className="relative"><Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" /><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="搜索..." className="pl-10 pr-4 py-2 w-64 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white dark:bg-slate-700/80 dark:border-slate-600 dark:text-slate-200" /></div>
                                <button onClick={clearSort} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="重置排序"><RotateCcw size={20} /></button>
                                <button onClick={handleResetFilters} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="清空筛选">
                                    <X size={20} />
                                </button>
                            </div>

                            {selectedTasks.size > 0 && currentView !== 'deleted' && (<BulkActionBar selectedCount={selectedTasks.size} onBulkAction={handleBulkAction} currentView={currentView} />)}
                            {currentView === 'deleted' && deletedTasks.length > 0 && (<button onClick={() => handleTaskAction('clearBin')} className="flex items-center gap-2 text-sm text-red-500 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold"><Trash2 size={16} />清空回收站</button>)}
                        </div>
                        <div id="task-table-for-export" className="flex-grow overflow-y-auto">
                            <ListHeader currentView={currentView} onSelectAll={handleSelectAll} numSelected={selectedTasks.size} taskCount={filteredAndSortedTasks.length} sortConfig={sortConfig} onRequestSort={requestSort} />
                            {isLoading ? (<div className="text-center py-16 text-slate-500 dark:text-slate-400">加载中...</div>) : filteredAndSortedTasks.length === 0 ? (<div className="text-center py-16 text-slate-500 dark:text-slate-400">此视图下没有任务。</div>) : (currentView === 'deleted' ? (filteredAndSortedTasks.map((task, index) => <DeletedTaskRow key={task.id} task={task} index={index} onPermanentDelete={() => handleTaskAction('permanentDelete', task)} onSelect={handleToggleSelectTask} isSelected={selectedTasks.has(task.id)} />)) : (filteredAndSortedTasks.map((task, index) => <TaskRow key={task.id} task={task} index={index} onActionConfirm={handleTaskAction} currentView={currentView} onSelect={handleToggleSelectTask} isSelected={selectedTasks.has(task.id)} />)))}
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<AuthWrapper />, document.getElementById('root'));
    </script>
</body>

</html>


