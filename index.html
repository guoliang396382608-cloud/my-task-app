<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咨询任务管理系统 4.2.3 (协作版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        #root:empty::before {
            content: "正在加载应用...";
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-size: 1.5rem;
            color: #6b7280;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .dark ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }

        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .action-column {}

        @keyframes pulse-bg {

            0%,
            100% {
                background-color: #fef3c7;
            }

            50% {
                background-color: #fde68a;
            }
        }

        .banner-pulse {
            animation: pulse-bg 4s infinite ease-in-out;
        }

        .dark .banner-pulse {
            animation-name: pulse-bg-dark;
        }

        @keyframes pulse-bg-dark {

            0%,
            100% {
                background-color: rgba(217, 119, 6, 0.2);
            }

            50% {
                background-color: rgba(217, 119, 6, 0.3);
            }
        }

        /* --- 【新增】移动端响应式布局核心样式 --- */
        @media (max-width: 768px) {

            /* 强制所有弹窗宽度不超过屏幕宽度，并留出边距 */
            .fixed.inset-0>div {
                max-width: 95vw !important;
                max-height: 90vh !important;
            }

            /* 将桌面端的宽表格布局转变为移动端的卡片式布局 */
            .task-grid-container {
                display: block !important;
                /* 禁用Grid布局 */
            }

            .task-grid-header {
                display: none !important;
                /* 隐藏桌面端的表头 */
            }

            .task-row-card {
                display: block !important;
                /* 强制任务行变为块级元素（卡片） */
                margin-bottom: 1rem;
                border: 1px solid #e2e8f0;
                border-left-width: 4px;
                border-radius: 0.5rem;
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            }

            .dark .task-row-card {
                border-color: #334155;
            }

            .task-cell {
                display: flex !important;
                justify-content: space-between;
                padding: 0.5rem 1rem;
                border-bottom: 1px solid #f1f5f9;
                text-align: left;
            }

            .dark .task-cell {
                border-bottom-color: #334155;
            }

            .task-cell:last-child {
                border-bottom: none;
            }

            .task-cell::before {
                content: attr(data-label);
                /* 使用 data-label 作为每行的标题 */
                font-weight: 600;
                margin-right: 1rem;
                color: #475569;
            }

            .dark .task-cell::before {
                color: #94a3b8;
            }

            .task-actions-cell {
                justify-content: center !important;
                /* 居中操作按钮 */
                padding-top: 0.75rem;
            }
        }

        input[type="date"] {
            position: relative;
        }

        input[type="date"]:not([value*="-"])::-webkit-datetime-edit {
            color: transparent;
        }

        input[type="date"]:not([value*="-"])::before {
            content: attr(placeholder);
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 100%;
            color: #9ca3af;
            pointer-events: none;
        }

        .dark input[type="date"]:not([value*="-"])::before {
            color: #6b7280;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(10px);
            }
        }

        .quote-modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }

        .quote-modal-exit {
            animation: fadeOut 0.3s ease-in forwards;
        }

        .quote-bubble {
            position: relative;
            background: linear-gradient(to right, #d4fc79, #96e6a1);
            /* fallback */
            background: linear-gradient(to right, #84fab0, #8fd3f4);
            /* Green to Blue */
        }

        .dark .quote-bubble {
            background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
        }

        .quote-bubble::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 0;
            border: 12px solid transparent;
            border-top-color: #8fd3f4;
            /* Match gradient end color */
            border-bottom: 0;
            margin-left: -12px;
            margin-bottom: -12px;
        }

        .dark .quote-bubble::after {
            border-top-color: #2c5364;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        /* --- 【新】加急任务的动画效果 --- */
        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        .task-pulse {
            animation: pulse-border 2s infinite;
            border-radius: 0.5rem;
            /* 确保动画效果作用于圆角 */
        }

        @keyframes pulse-glow-tab {

            0%,
            100% {
                box-shadow: 0 0 2px 1px rgba(239, 68, 68, 0.4);
            }

            50% {
                box-shadow: 0 0 6px 2px rgba(239, 68, 68, 0.8);
            }
        }

        .tab-urgent-glow {
            animation: pulse-glow-tab 1.5s infinite ease-in-out;
        }

        /* --- 【新增】确保日期选择框有可见边框 --- */
        input[type="date"] {
            border-width: 1px;
        }

        .dark input[type="date"] {
            border-color: #475569;
            /* 深色模式下的边框颜色，与普通输入框匹配 */
        }

        /* --- 【新增】五彩纸屑庆祝动画 --- */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 9999;
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 16px;
            background: #f00;
            top: -20px;
            animation: confetti-fall 5s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotateZ(0deg);
                opacity: 1;
            }

            100% {
                transform: translateY(100vh) rotateZ(720deg);
                opacity: 0;
            }
        }

        /* --- 【最终版】每日一语滚动横幅动画 --- */
        @keyframes scroll-left-to-right {
            from {
                transform: translateX(-100%);
            }

            to {
                transform: translateX(100vw);
            }
        }

        .scrolling-quote-banner {
            position: fixed;
            top: 60px;
            left: 0;
            width: 100%;
            padding: 10px 0;

            /* 核心修改：移除背景，只保留文字样式 */
            background: transparent;
            color: #FFD700;
            /* 明亮的标准金色 */
            font-size: 1.2rem;
            /* 字体稍微调大，使其更醒目 */
            font-weight: 600;
            /* 核心修改：使用强烈的辉光效果确保文字可读性 */
            text-shadow: 0 0 2px #000, 0 0 5px #000, 0 0 10px #FFD700;

            z-index: 9999;
            white-space: nowrap;
            cursor: pointer;
            animation: scroll-left-to-right 30s linear forwards;
            pointer-events: all;
            /* 确保无背景时也能被点击 */
        }

        .scrolling-quote-banner p {
            display: inline-block;
            padding-left: 100%;
        }

        .scrolling-quote-banner:hover {
            animation-play-state: paused;
        }

        .scrolling-quote-banner .source-text {
            color: #abc1eb;
            /* 来源文字使用亮灰色 */
            opacity: 0.9;
            font-weight: 400;
            font-size: 1rem;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
</head>

<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useMemo, useCallback, useRef, useLayoutEffect } = React;

        // --- 1. 初始化 Supabase 客户端 ---
        const supabaseUrl = 'https://ybhopioytqpjmoojslfv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliaG9waW95dHFwam1vb2pzbGZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYxMTEzODEsImV4cCI6MjA3MTY4NzM4MX0.c5Qzde1oi54g3oCK0uEClZ-MdzD7OMMoKrmrfVLzHNc';
        const { createClient } = window.supabase;
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- 全局辅助函数 ---
        const toCamelCase = (str) => str.replace(/_([a-z])/g, (g) => g[1].toUpperCase());

        const fromSnakeCase = (task) => {
            if (!task) return null;
            return {
                id: task.id,
                createdAt: task.created_at,
                updatedAt: task.updated_at,
                customTaskId: task.custom_task_id,
                projectName: task.project_name,
                region: task.region,
                taskType: task.task_type,
                sourcing_department: task.sourcing_department,
                execution_department: task.execution_department,
                contractAmount: task.contract_amount,
                salesPerson: task.sales_person,
                projectManager: task.project_manager,
                reviewerId: task.reviewer_id,
                auditorName: task.auditor_name,
                recheckerName: task.rechecker_name,
                issuerName: task.issuer_name,
                isArchived: task.is_archived,
                status: task.status,
                contractualDueDate: task.contractual_due_date,
                actualCompletionDate: task.actual_completion_date,
                progressDetails: task.progress_details,
                history: task.history,
                contractDetails: task.contract_details // <-- 新增此行
            };
        };

        const toSnakeCase = (data) => ({
            custom_task_id: data.customTaskId,
            project_name: data.projectName,
            region: data.region,
            task_type: data.taskType,
            sourcing_department: data.sourcing_department,
            execution_department: data.execution_department,
            contract_amount: data.contractAmount,
            sales_person: data.salesPerson,
            project_manager: data.projectManager,
            reviewer_id: data.reviewerId,
            auditor_name: data.auditorName,
            rechecker_name: data.recheckerName,
            issuer_name: data.issuerName,
            is_archived: data.isArchived,
            status: data.status,
            progress_details: data.progressDetails,
            history: data.history,
            created_at: data.createdAt,
            updated_at: new Date().toISOString(),
            contractual_due_date: data.contractualDueDate || null,
            actual_completion_date: data.actualCompletionDate || null,
            contract_details: data.contractDetails // <-- 新增此行
        });
        const generateTaskSummary = (task) => {
            if (!task) return '';
            // 安全地访问属性，为可能缺失的数据提供备用文本
            const id = task.customTaskId || '无编号';
            const name = task.projectName || '无名称';
            const type = task.taskType || '无类型';
            return `[${id}] ${name} (${type})`;
        };
        // --- Icon Components (您的所有图标组件) ---
        const Icon = ({ children, size = 20, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        const X = (props) => <Icon {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></Icon>;
        const Edit = (props) => <Icon {...props}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></Icon>;
        const Check = (props) => <Icon {...props}><polyline points="20 6 9 17 4 12"></polyline></Icon>;
        const Archive = (props) => <Icon {...props}><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></Icon>;
        const Download = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></Icon>;
        const Upload = (props) => <Icon {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></Icon>;
        const BarChart2 = (props) => <Icon {...props}><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></Icon>;
        const Ban = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></Icon>;
        const AlertTriangle = (props) => <Icon {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></Icon>;
        const Bell = (props) => <Icon {...props}><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></Icon>;
        const Settings = (props) => <Icon {...props}><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 3.46l.22.38a2 2 0 0 0 1.73 1l.25.43a2 2 0 0 1-3.46 2l-.38-.22a2 2 0 0 0-1-1.73V20a2 2 0 0 0 2 2h4.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2-3.46l-.22-.38a2 2 0 0 0-1-1.73l-.25-.43a2 2 0 0 1 3.46-2l.38.22a2 2 0 0 0 1 1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></Icon>;
        const Trash2 = (props) => <Icon {...props}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>;
        const Maximize = (props) => <Icon {...props}><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></Icon>;
        const Minimize = (props) => <Icon {...props}><path d="M8 3v3a2 2 0 0 1-2 2H3m18 0h-3a2 2 0 0 1-2-2V3m0 18v-3a2 2 0 0 1 2-2h3M3 16h3a2 2 0 0 1 2 2v3"></path></Icon>;
        const Search = (props) => <Icon {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>;
        const ArrowUpDown = (props) => <Icon {...props}><path d="m21 16-4 4-4-4m-12-8 4-4 4 4" /></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M3 2v6h6"></path><path d="M3 13a9 9 0 1 0 3-7.7L3 8"></path></Icon>;
        const ChevronDown = (props) => <Icon {...props}><polyline points="6 9 12 15 18 9"></polyline></Icon>;
        const MoreHorizontal = (props) => <Icon {...props}><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></Icon>;
        const Moon = (props) => <Icon {...props}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></Icon>;
        const Sun = (props) => <Icon {...props}><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></Icon>;
        const Database = (props) => <Icon {...props}><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></Icon>;
        const Calendar = (props) => <Icon {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></Icon>;
        const LogOut = (props) => <Icon {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></Icon>;
        const Users = (props) => <Icon {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></Icon>;
        const ClockIcon = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></Icon>;
        const Briefcase = (props) => <Icon {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></Icon>;
        const ImageIcon = (props) => <Icon {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></Icon>;
        // --- 您的所有UI组件和辅助函数 ---
        const GRID_COLS = {
            OVERVIEW: "grid-cols-[0.8fr_1fr_1fr_2.5fr_1.5fr_1fr_1.2fr_1.2fr_1fr_1.2fr_1.2fr_1.2fr_3fr_0.8fr]",
            REVIEWING: "grid-cols-[auto_1fr_1.2fr_3fr_1.8fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_0.5fr]", INPROGRESS: "grid-cols-[auto_1fr_1.2fr_2.5fr_1.5fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_1fr_3fr_0.5fr]",
            DONE: "grid-cols-[auto_1fr_1.2fr_2.5fr_1.5fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_3fr_0.8fr_0.5fr]",
            VOID_DELETED: "grid-cols-[auto_1fr_1.2fr_3fr_1.8fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_1.2fr_3fr_0.5fr]"
        };
        const FIELD_LABELS = {
            projectName: "项目名称",
            region: "所属地区",
            taskType: "任务类型",
            sourcing_department: "承接部门(市场)", // 新增
            execution_department: "执行部门(技术)", // 新增
            salesPerson: "业务人员",
            reviewerId: "评审人员",
            projectManager: "项目负责人", // 新增
            auditor_name: "审核人", // 新增
            rechecker_name: "复核人", // 新增
            issuer_name: "签发人", // 新增
            contractAmount: "合同金额",
            contractualDueDate: "合同规定日期",
            actualCompletionDate: "实际完成日期",
            isArchived: "存档状态",
            createdAt: "任务下达日期",
            // --- 新增合同信息字段 ---
            signingDate: "签订日期",
            signingEntity: "签订单位",
            invoiceType: "发票类型",
            contractAdmin: "合同管理员",
            clientCompany: "委托单位",
            clientAddress: "委托单位地址",
            clientContact: "委托单位联系人",
            clientPhone: "委托人联系电话",
            serviceCompany: "服务单位",
            serviceAddress: "服务单位地址",
            serviceContact: "服务单位联系人",
            servicePhone: "服务人联系电话",
            additionalInfo: "其他附加内容"
        };
        // --- 在这里粘贴新代码 ---
        const STATUS_STYLES = {
            reviewing: { base: 'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300', active: 'bg-blue-500 text-white' },
            assigning: { base: 'bg-cyan-100 text-cyan-800 dark:bg-cyan-900/50 dark:text-cyan-300', active: 'bg-cyan-500 text-white' },
            inprogress: { base: 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300', active: 'bg-amber-500 text-white' },
            auditing: { base: 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-300', active: 'bg-indigo-500 text-white' },
            rechecking: { base: 'bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300', active: 'bg-purple-500 text-white' },
            issuing: { base: 'bg-pink-100 text-pink-800 dark:bg-pink-900/50 dark:text-pink-300', active: 'bg-pink-500 text-white' },
            done: { base: 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300', active: 'bg-green-600 text-white' },
            'void': { base: 'bg-slate-200 text-slate-600 dark:bg-slate-700 dark:text-slate-300', active: 'bg-slate-500 text-white' },
            overview: { base: 'bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200', active: 'bg-gray-700 text-white' },
            deleted: { base: 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300', active: 'bg-red-600 text-white' },
            default: { base: 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300', active: 'bg-gray-500 text-white' }
        };
        const formatDate = (dateStr) => { if (!dateStr) return ''; try { const d = new Date(dateStr); return isNaN(d.getTime()) ? '' : d.toISOString().split('T')[0]; } catch (e) { return ''; } };
        const formatDateTime = (dateStr) => { if (!dateStr) return ''; try { return new Date(dateStr).toLocaleString('zh-CN', { hour12: false }); } catch (e) { return ''; } };
        const formatDuration = (totalDays) => {
            if (totalDays === null || isNaN(totalDays)) return { status: '-', time: '' };
            if (totalDays === 0) return { status: '今天截止', time: '' };

            const status = totalDays < 0 ? '已逾期' : '剩余';
            const absDays = Math.abs(totalDays);

            // 如果天数小于30天，直接显示天数，逻辑保持不变
            if (absDays < 30) {
                return { status, time: `${absDays}天` };
            }

            // --- 使用之前被忽略的、正确的逻辑来计算年、月、日 ---
            const years = Math.floor(absDays / 365);
            const months = Math.floor((absDays % 365) / 30);
            const days = (absDays % 365) % 30;

            let parts = [];
            if (years > 0) parts.push(`${years}年`);
            if (months > 0) parts.push(`${months}月`);
            if (days > 0) parts.push(`${days}天`);

            // 防止出现空结果（例如正好365天的情况）
            if (parts.length === 0) {
                if (years > 0) return { status, time: `${years}年` };
                return { status, time: `${Math.floor(absDays / 30)}月` };
            }

            return { status, time: parts.join('') };
        };
        const formatAmount = (amount) => { if (amount === null || amount === undefined || amount === '' || isNaN(Number(amount))) return 'N/A'; return `${Number(amount).toLocaleString('zh-CN')} 元`; };
        const generateChangeLog = (oldData, newData, userMap) => {
            const changes = [];
            const getDisplayValue = (value, key) => {
                if (value === null || value === undefined || value === '') return '[空]';
                const personFields = ['salesPerson', 'projectManager', 'auditor_name', 'rechecker_name', 'issuer_name', 'reviewerId'];
                if (personFields.includes(key)) return `"${userMap.get(value) || '未知用户'}"`;
                if (key && (key.toLowerCase().includes('date') || key === 'createdAt')) return `"${formatDate(value)}"`;
                if (key === 'isArchived') return value ? '"是"' : '"否"';
                if (key === 'contractAmount') return `"${formatAmount(value)}"`;
                return `"${value}"`;
            };

            // --- 1. 比较顶层字段 ---
            Object.keys(FIELD_LABELS).forEach(key => {
                // 跳过合同详情的字段，因为它们在下面单独处理
                if (oldData.contractDetails && newData.contractDetails && key in oldData.contractDetails) {
                    return;
                }

                const oldValue = oldData[key];
                const newValue = newData[key];
                const oldFormatted = (key.endsWith('Date') || key === 'createdAt') ? formatDate(oldValue) : oldValue;
                const newFormatted = (key.endsWith('Date') || key === 'createdAt') ? formatDate(newValue) : newValue;

                if (String(oldFormatted || '') !== String(newFormatted || '')) {
                    changes.push(`编辑: ${FIELD_LABELS[key]} 从 ${getDisplayValue(oldValue, key)} 修改为 ${getDisplayValue(newValue, key)}`);
                }
            });

            // --- 2. 专门比较嵌套在 contractDetails 内部的字段 ---
            const oldDetails = oldData.contractDetails || {};
            const newDetails = newData.contractDetails || {};
            const allDetailKeys = new Set([...Object.keys(oldDetails), ...Object.keys(newDetails)]);

            allDetailKeys.forEach(key => {
                if (FIELD_LABELS[key]) { // 确保这个key是我们想要追踪的
                    const oldValue = oldDetails[key];
                    const newValue = newDetails[key];
                    const oldFormatted = key.endsWith('Date') ? formatDate(oldValue) : oldValue;
                    const newFormatted = key.endsWith('Date') ? formatDate(newValue) : newValue;

                    if (String(oldFormatted || '') !== String(newFormatted || '')) {
                        changes.push(`编辑: ${FIELD_LABELS[key]} 从 ${getDisplayValue(oldValue, key)} 修改为 ${getDisplayValue(newValue, key)}`);
                    }
                }
            });

            return changes;
        };
        function useOutsideAlerter(ref, callback) { useEffect(() => { function handleClickOutside(event) { if (ref.current && !ref.current.contains(event.target)) { callback(); } } document.addEventListener("mousedown", handleClickOutside); return () => { document.removeEventListener("mousedown", handleClickOutside); }; }, [ref, callback]); }
        function useDebounce(value, delay) { const [debouncedValue, setDebouncedValue] = useState(value); useEffect(() => { const handler = setTimeout(() => { setDebouncedValue(value); }, delay); return () => { clearTimeout(handler); }; }, [value, delay]); return debouncedValue; }

        const exportData = async (format, tasksToExport, fileName, visibleColumns, onExportSuccess, viewSelection, userMap) => {
            const columnMap = {
                createdAt: "任务下达日期", customTaskId: "任务编号", projectName: "项目名称", taskType: "任务类型",
                sourcing_department: "承接部门(市场)", execution_department: "执行部门(技术)",
                contractAmount: "合同金额", salesPerson: "业务人员", reviewerId: "评审人员", projectManager: "项目负责人",
                auditor_name: "审核人", rechecker_name: "复核人", issuer_name: "签发人",
                contractualDueDate: "合同规定日期", actualCompletionDate: "实际完成日期",
                progressDetails: "最新项目进展", region: "所属地区", isArchived: "是否存档",
                status: "状态", timeRemaining: "剩余时间"
            };
            const statusMap = {
                reviewing: '评审中', assigning: '待分配', inprogress: '进行中', auditing: '审核中',
                rechecking: '复核中', issuing: '签发中', done: '已完成', void: '已作废'
            };

            const dataForExport = tasksToExport.map(task => ({
                ...task,
                salesPerson: userMap.get(task.salesPerson) || task.salesPerson,
                reviewerId: userMap.get(task.reviewerId) || task.reviewerId,
                projectManager: userMap.get(task.projectManager) || task.projectManager,
                auditor_name: userMap.get(task.auditorName) || task.auditorName,
                rechecker_name: userMap.get(task.recheckerName) || task.recheckerName,
                issuer_name: userMap.get(task.issuerName) || task.issuerName,
            }));

            try {
                if (tasksToExport.length === 0) { alert("没有可导出的任务。"); return; }

                if (format === 'excel' || format === 'csv') {
                    // Excel and CSV logic (remains unchanged)
                    const headers = visibleColumns.map(key => columnMap[key]);
                    const sheetData = dataForExport.map(task => {
                        const row = {};
                        visibleColumns.forEach(key => {
                            const header = columnMap[key];
                            let cellValue = task[key];
                            switch (key) {
                                case 'createdAt': case 'contractualDueDate': case 'actualCompletionDate': cellValue = formatDate(task[key]); break;
                                case 'progressDetails': cellValue = (task.progressDetails?.length > 0) ? [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0].text : ""; break;
                                case 'isArchived': cellValue = task.isArchived ? "是" : "否"; break;
                                case 'status': cellValue = statusMap[task.status] || task.status; break;
                                case 'contractAmount': cellValue = formatAmount(task.contractAmount); break;
                                case 'timeRemaining':
                                    if (task.status === 'inprogress' && task.contractualDueDate) {
                                        const today = new Date(); today.setHours(0, 0, 0, 0);
                                        const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
                                        const diffTime = dueDate.getTime() - today.getTime();
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        const duration = formatDuration(diffDays);
                                        cellValue = `${duration.status} ${duration.time}`;
                                    } else { cellValue = "N/A"; }
                                    break;
                            }
                            row[header] = cellValue;
                        });
                        return row;
                    });
                    const ws = window.XLSX.utils.json_to_sheet(sheetData, { header: headers });
                    const wb = window.XLSX.utils.book_new();
                    window.XLSX.utils.book_append_sheet(wb, ws, "Tasks");
                    if (format === 'excel') {
                        window.XLSX.writeFile(wb, `${fileName}_${formatDate(new Date())}.xlsx`);
                    } else { /* CSV logic */ }

                } else if (format === 'png') {
                    const ALL_COLUMNS = Object.entries(columnMap).map(([key, label]) => ({ key, label }));
                    const columnWidthMap = { projectName: '3fr', progressDetails: '4fr', sourcing_department: '1.5fr', execution_department: '1.5fr', customTaskId: '1.2fr', default: '1fr' };
                    const columnsToRender = ALL_COLUMNS.filter(c => visibleColumns.includes(c.key));
                    const gridTemplateColumns = columnsToRender.map(col => columnWidthMap[col.key] || columnWidthMap.default).join(' ');

                    let tableHtml = `<div style="display: grid; grid-template-columns: ${gridTemplateColumns}; gap: 5px; padding: 10px 5px; background-color: #f1f5f9; font-weight: bold; border-bottom: 2px solid #e2e8f0; font-size: 15px;">`;
                    columnsToRender.forEach(col => { tableHtml += `<div style="text-align: center; word-break: break-word;">${col.label}</div>`; });
                    tableHtml += `</div>`;

                    // --- 修复2：添加行颜色判断函数 ---
                    const getRowBgColor = (task, index) => {
                        if (task.status === 'inprogress' && task.contractualDueDate) {
                            const today = new Date(); today.setHours(0, 0, 0, 0);
                            const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
                            const diffTime = dueDate.getTime() - today.getTime();
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (diffDays < 0) return '#fee2e2'; // 逾期 - 红色
                            if (diffDays <= 7) return '#fef3c7'; // 即将截止 - 黄色
                        }
                        return index % 2 === 0 ? '#ffffff' : '#f8fafc'; // 默认交替色
                    };

                    dataForExport.forEach((task, index) => {
                        const bgColor = getRowBgColor(task, index); // <-- 调用颜色函数
                        tableHtml += `<div style="display: grid; grid-template-columns: ${gridTemplateColumns}; gap: 5px; padding: 10px 5px; border-bottom: 1px solid #f1f5f9; background-color: ${bgColor};">`;
                        columnsToRender.forEach(col => {
                            let content = task[col.key] ?? '';
                            switch (col.key) {
                                case 'createdAt': case 'contractualDueDate': case 'actualCompletionDate': content = formatDate(task[col.key]); break;
                                case 'progressDetails': content = (task.progressDetails?.length > 0) ? [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0].text : ""; break;
                                case 'isArchived': content = task.isArchived ? "是" : "否"; break;
                                case 'status': content = statusMap[task.status] || task.status; break;
                                case 'contractAmount': content = formatAmount(task.contractAmount); break;
                                // --- 修复1：添加剩余时间计算 ---
                                case 'timeRemaining':
                                    if (task.status === 'inprogress' && task.contractualDueDate) {
                                        const today = new Date(); today.setHours(0, 0, 0, 0);
                                        const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
                                        const diffTime = dueDate.getTime() - today.getTime();
                                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                                        const duration = formatDuration(diffDays);
                                        content = `${duration.status} ${duration.time}`;
                                    } else { content = "N/A"; }
                                    break;
                            }
                            tableHtml += `<div style="display: flex; align-items: center; justify-content: center; text-align: center; white-space: pre-wrap; word-break: break-word; padding: 2px;">${content}</div>`;
                        });
                        tableHtml += `</div>`;
                    });

                    const dynamicTitle = viewSelection && viewSelection.length > 0 ? `${viewSelection.join('、')} 任务筛选结果` : fileName;
                    const printContainer = document.createElement('div');
                    printContainer.style.cssText = "position: absolute; left: -9999px; background-color: #ffffff; padding: 20px; width: 2800px; font-size: 14px; font-family: -apple-system, sans-serif; color: #1e293b;";
                    printContainer.innerHTML = `<h2 style="text-align: center; font-size: 24px; margin-bottom: 20px;">${dynamicTitle}</h2>` + tableHtml;
                    document.body.appendChild(printContainer);

                    try {
                        const canvas = await window.html2canvas(printContainer, { scale: 1.5, useCORS: true });
                        const link = document.createElement('a');
                        link.download = `${dynamicTitle}_${formatDate(new Date())}.png`;
                        link.href = canvas.toDataURL("image/png", 1.0);
                        link.click();
                    } catch (e) {
                        console.error("导出PNG时出错:", e);
                        alert("导出图片失败，请查看控制台获取详细信息。");
                    } finally {
                        document.body.removeChild(printContainer);
                    }
                }
                if (onExportSuccess) onExportSuccess();
            } catch (error) { console.error("Export error:", error); alert(`导出为 ${format} 失败。`); }
        };

        // --- UI Components ---
        const ConfirmationModal = ({ isOpen, onClose, onConfirm, title, children, confirmVariant = 'primary' }) => { if (!isOpen) return null; const confirmButtonClasses = { primary: 'bg-emerald-500 hover:bg-emerald-600', danger: 'bg-red-500 hover:bg-red-600', warning: 'bg-amber-500 hover:bg-amber-600' }; return (<div className="fixed inset-0 flex justify-center items-center p-4" style={{ zIndex: 100 }}> <div className="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-lg"> <header className="p-4 border-b dark:border-slate-700"><h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">{title}</h2></header> <div className="p-6 text-gray-600 dark:text-gray-300 max-h-[60vh] overflow-y-auto">{children}</div> <footer className="p-4 flex justify-end gap-4 bg-gray-50 dark:bg-slate-800/50 rounded-b-xl"> <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button> <button onClick={onConfirm} className={`px-6 py-2 rounded-md text-white font-semibold ${confirmButtonClasses[confirmVariant]}`}>确认</button> </footer> </div> </div>); };
        const SmartDropdown = ({ children, trigger, forceDirection = 'auto' }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [positionClass, setPositionClass] = useState('mt-1');
            const wrapperRef = useRef(null);
            const triggerRef = useRef(null);
            const dropdownRef = useRef(null);
            useOutsideAlerter(wrapperRef, () => setIsOpen(false));
            useLayoutEffect(() => {
                if (isOpen && triggerRef.current && dropdownRef.current) {
                    if (forceDirection === 'up') { setPositionClass('bottom-full mb-1'); return; }
                    if (forceDirection === 'down') { setPositionClass('mt-1'); return; }
                    const rect = triggerRef.current.getBoundingClientRect();
                    const dropdownHeight = dropdownRef.current.offsetHeight;
                    const spaceBelow = window.innerHeight - rect.bottom;
                    if (spaceBelow < dropdownHeight + 10 && rect.top > dropdownHeight) {
                        setPositionClass('bottom-full mb-1');
                    } else {
                        setPositionClass('mt-1');
                    }
                }
            }, [isOpen, forceDirection]);

            // 【关键升级】我们将把关闭自身的函数 (setIsOpen) 传递给子组件
            return (
                <div className="relative w-full" ref={wrapperRef}>
                    {React.cloneElement(trigger, { ref: triggerRef, onClick: () => setIsOpen(prev => !prev), isOpen })}
                    {isOpen && React.cloneElement(children, { ref: dropdownRef, positionClass, closeDropdown: () => setIsOpen(false) })}
                </div>
            );
        };
        const SingleSelectDropdown = ({ options, value, onChange, placeholder, className = '', buttonClassName = '', forceDirection = 'auto' }) => {
            const isObjectOptions = useMemo(() => options.length > 0 && typeof options[0] === 'object' && options[0] !== null, [options]);

            const handleSelect = (option, closeDropdown) => {
                const selectedValue = isObjectOptions ? option.value : option;
                onChange(selectedValue);
                if (closeDropdown) {
                    closeDropdown();
                }
            };

            let displayText = placeholder;
            if (value !== null && value !== undefined) {
                if (isObjectOptions) {
                    const selectedOption = options.find(opt => opt.value === value);
                    displayText = selectedOption ? selectedOption.label : placeholder;
                } else {
                    displayText = value || placeholder;
                }
            }

            const Trigger = React.forwardRef(({ onClick, isOpen }, ref) => (<button ref={ref} type="button" onClick={onClick} className={`w-full flex justify-between items-center bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 text-left focus:ring-2 focus:ring-emerald-500 ${buttonClassName}`}> <span className="truncate">{displayText}</span> <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} /> </button>))

            // 【关键修正】将 => ( 隐式返回，改为 => { return (...) } 显式返回
            const DropdownContent = React.forwardRef(({ positionClass, closeDropdown }, ref) => {
                return (
                    <div ref={ref} className={`absolute z-30 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto dark:bg-slate-700 dark:border-slate-600 ${positionClass}`}>
                        <ul className="py-1">
                            {options.map((option, index) => {
                                const optionValue = isObjectOptions ? option.value : option;
                                const optionLabel = isObjectOptions ? option.label : option;
                                const isSelected = value === optionValue;
                                const key = `${isObjectOptions ? String(optionValue) : option}-${index}`;
                                return (
                                    <li key={key}>
                                        <button type="button" onClick={() => handleSelect(option, closeDropdown)} className={`w-full text-left flex items-center justify-between px-3 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer ${isSelected ? 'font-semibold text-emerald-500' : 'dark:text-gray-200'}`}>
                                            <span>{optionLabel}</span>
                                            {isSelected && <Check size={16} />}
                                        </button>
                                    </li>
                                )
                            })}
                        </ul>
                    </div>
                );
            });

            return <SmartDropdown trigger={<Trigger />} children={<DropdownContent />} forceDirection={forceDirection} />;
        };
        // --- 【健壮版】ComboBox ---
        const ComboBox = ({ options, value, onChange, placeholder, className = '' }) => {
            const [inputValue, setInputValue] = useState(value || '');
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            useEffect(() => {
                // 当外部传入的value变化时，同步更新输入框的显示值
                const selectedOption = options.flatMap(opt => opt.isGroup ? opt.options : [opt]).find(opt => (opt.value ?? opt) === value);
                const displayLabel = typeof selectedOption === 'object' ? selectedOption.label : selectedOption;
                setInputValue(displayLabel || value || '');
            }, [value, options]);

            useOutsideAlerter(wrapperRef, () => setIsOpen(false));

            const filteredOptions = useMemo(() => {
                if (!inputValue) return options;
                const lowerInputValue = inputValue.toLowerCase();

                const filtered = options.map(group => {
                    if (!group.isGroup) {
                        const optionLabel = String(group.label ?? group).toLowerCase();
                        return optionLabel.includes(lowerInputValue) ? group : null;
                    }
                    const filteredGroupOptions = group.options.filter(option => {
                        const optionLabel = String(option.label ?? option).toLowerCase();
                        return optionLabel.includes(lowerInputValue);
                    });
                    return filteredGroupOptions.length > 0 ? { ...group, options: filteredGroupOptions } : null;
                }).filter(Boolean);

                return filtered;
            }, [inputValue, options]);

            const handleSelect = (option) => {
                const selectedValue = option.value ?? option;
                const displayLabel = option.label ?? option;
                onChange(selectedValue);
                setInputValue(displayLabel);
                setIsOpen(false);
            };

            return (
                <div className={`relative w-full ${className}`} ref={wrapperRef}>
                    <div className="relative">
                        <input
                            type="text"
                            value={inputValue}
                            onChange={e => { setInputValue(e.target.value); if (!isOpen) setIsOpen(true); }}
                            onFocus={() => setIsOpen(true)}
                            placeholder={placeholder}
                            className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 focus:ring-2 focus:ring-emerald-500 pr-8 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200"
                        />
                        <button type="button" onClick={() => setIsOpen(!isOpen)} className="absolute inset-y-0 right-0 flex items-center px-2 text-gray-500 dark:text-gray-400">
                            <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
                        </button>
                    </div>
                    {isOpen && (
                        <div className="absolute z-30 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto dark:bg-slate-700 dark:border-slate-600 mt-1">
                            {filteredOptions.length > 0 ? (
                                <ul className="py-1">
                                    {filteredOptions.map((item, index) => {
                                        if (item.isGroup) {
                                            return (
                                                <li key={item.label}>
                                                    <div className="px-3 py-2 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">{item.label}</div>
                                                    <ul>
                                                        {item.options.map(option => {
                                                            const optionValue = option.value ?? option;
                                                            const optionLabel = option.label ?? option;
                                                            return (
                                                                <li key={optionValue}><button type="button" onMouseDown={() => handleSelect(option)} className={`w-full text-left flex items-center justify-between pl-6 pr-3 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 ${value === optionValue ? 'font-semibold text-emerald-500' : 'dark:text-gray-200'}`}><span>{optionLabel}</span>{value === optionValue && <Check size={16} />}</button></li>
                                                            )
                                                        })}
                                                    </ul>
                                                </li>
                                            );
                                        } else {
                                            const optionValue = item.value ?? item;
                                            const optionLabel = item.label ?? item;
                                            return <li key={optionValue}><button type="button" onMouseDown={() => handleSelect(item)} className={`w-full text-left flex items-center justify-between px-3 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 ${value === optionValue ? 'font-semibold text-emerald-500' : 'dark:text-gray-200'}`}><span>{optionLabel}</span>{value === optionValue && <Check size={16} />}</button></li>
                                        }
                                    })}
                                </ul>
                            ) : <div className="px-3 py-2 text-sm text-gray-500 dark:text-gray-400">无匹配项</div>}
                        </div>
                    )}
                </div>
            );
        };
        const RoleEditorModal = ({ isOpen, onClose, onSave, role, viewConfig, columnDefinitions, modalError }) => {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    const baseFormData = {
                        key: '',
                        label: '',
                        default_views: [],
                        default_columns: [],
                    };
                    // 安全地合并数据，即使 role 是 null
                    const finalData = { ...baseFormData, ...(role || {}) };
                    setFormData(finalData);
                }
            }, [isOpen, role]);

            // --- 核心加固 ---
            // 使用 (viewConfig || []) 的方式，即使 props 暂时为 null 也不会导致崩溃
            const viewLabelMap = useMemo(() => Object.fromEntries((viewConfig || []).filter(v => v.key).map(v => [v.label, v.key])), [viewConfig]);
            const viewKeyMap = useMemo(() => Object.fromEntries((viewConfig || []).filter(v => v.key).map(v => [v.key, v.label])), [viewConfig]);
            const columnLabelMap = useMemo(() => Object.fromEntries((columnDefinitions || []).map(c => [c.label, c.key])), [columnDefinitions]);
            const columnKeyMap = useMemo(() => Object.fromEntries((columnDefinitions || []).map(c => [c.key, c.label])), [columnDefinitions]);

            if (!isOpen) return null;

            const handleFormChange = (name, value) => setFormData(prev => ({ ...prev, [name]: value }));
            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-[60] flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl">
                        <form onSubmit={handleSubmit}>
                            <header className="p-4 border-b dark:border-slate-700">
                                <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">{role ? '编辑角色' : '新增角色'}</h2>
                            </header>
                            <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
                                {/* --- 角色基本信息 --- */}
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">角色标签 (显示名称)</label>
                                        <input type="text" value={formData.label || ''} onChange={(e) => handleFormChange('label', e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">角色 Key (唯一英文标识)</label>
                                        <input type="text" value={formData.key || ''} onChange={(e) => handleFormChange('key', e.target.value)} disabled={!!role} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 font-mono focus:ring-2 focus:ring-emerald-500 disabled:bg-gray-200 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:disabled:bg-slate-800" required />
                                        {role && <p className="text-xs text-gray-500 mt-1">Key 在创建后不可修改。</p>}
                                    </div>
                                </div>
                                {modalError && <p className="text-sm text-red-500 mt-2 text-center">{modalError}</p>}
                            </div>
                            <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                                <button type="button" onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button>
                                <button type="submit" className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">保存</button>
                            </footer>
                        </form>
                    </div>
                </div>
            );
        };
        const ManagementModal = ({ isOpen, onClose, managementData, onSave }) => {
            const [activeTab, setActiveTab] = useState('taskTypes');
            const [localData, setLocalData] = useState(null);

            // --- 升级1：动态生成所有搜索词状态 ---
            const initialSearchTerms = useMemo(() => {
                const structure = managementData?.department_structure || {};
                const baseTerms = {
                    taskTypes: '', regions: '', signingEntities: '', invoiceTypes: '', contractAdmins: ''
                };
                const departmentTerms = Object.keys(structure).reduce((acc, key) => ({ ...acc, [key]: '' }), {});
                return { ...baseTerms, ...departmentTerms };
            }, [managementData]);

            const [searchTerms, setSearchTerms] = useState(initialSearchTerms);

            useEffect(() => {
                if (isOpen) {
                    // 深拷贝传入的数据，并确保新字段的数组存在
                    const initialData = JSON.parse(JSON.stringify(managementData || {}));
                    if (!initialData.signingEntities) initialData.signingEntities = [];
                    if (!initialData.invoiceTypes) initialData.invoiceTypes = [];
                    if (!initialData.contractAdmins) initialData.contractAdmins = [];

                    setLocalData(initialData);
                    setActiveTab('taskTypes');
                    setSearchTerms(initialSearchTerms); // 每次打开时重置搜索词
                }
            }, [isOpen, managementData, initialSearchTerms]);

            // --- 升级2：动态生成所有标签页 ---
            const departmentTabs = useMemo(() => {
                const structure = localData?.department_structure || {};
                return Object.entries(structure).map(([key, value]) => ({
                    key: key, label: value.label, isDepartment: true
                }));
            }, [localData]);

            const tabs = useMemo(() => [
                { key: 'taskTypes', label: '任务类型' },
                { key: 'regions', label: '所属地区' },
                { key: 'signingEntities', label: '签订单位' },   // <-- 新增
                { key: 'invoiceTypes', label: '发票类型' },     // <-- 新增
                { key: 'contractAdmins', label: '合同管理员' }, // <-- 新增
                ...departmentTabs,
            ], [departmentTabs]);

            if (!isOpen || !localData) return null;

            const handleAddItem = (type) => {
                const value = searchTerms[type]?.trim();
                if (!value) return;

                setLocalData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    const tabInfo = tabs.find(t => t.key === type);

                    if (tabInfo.isDepartment) {
                        if (!newData.department_structure[type].sub_departments.includes(value)) {
                            newData.department_structure[type].sub_departments.push(value);
                        }
                    } else {
                        const oldArray = newData[type] || [];
                        if (!oldArray.includes(value)) {
                            newData[type] = [...oldArray, value];
                        }
                    }
                    return newData;
                });
                setSearchTerms(prev => ({ ...prev, [type]: '' }));
            };

            const handleSearchChange = (type, value) => setSearchTerms(prev => ({ ...prev, [type]: value }));
            const handleDeleteItem = (type, itemToDelete) => {
                setLocalData(prev => {
                    const newData = JSON.parse(JSON.stringify(prev));
                    const tabInfo = tabs.find(t => t.key === type);
                    if (tabInfo.isDepartment) {
                        newData.department_structure[type].sub_departments = newData.department_structure[type].sub_departments.filter(item => item !== itemToDelete);
                    } else {
                        newData[type] = (prev[type] || []).filter(item => item !== itemToDelete);
                    }
                    return newData;
                });
            };

            const handleSave = () => { onSave(localData); onClose(); };

            const renderListEditor = (type, title) => {
                const tabInfo = tabs.find(t => t.key === type);
                const listSource = tabInfo?.isDepartment ? localData.department_structure[type]?.sub_departments : localData[type];
                if (!Array.isArray(listSource)) return <div className="p-4">无法加载配置项。</div>;

                const filteredList = listSource.filter(item => item.toLowerCase().includes((searchTerms[type] || '').toLowerCase()));

                return (
                    <div className="p-4 bg-gray-50 dark:bg-slate-800 rounded-lg flex flex-col h-full">
                        <div className="flex gap-2 mb-3">
                            <input type="text" value={searchTerms[type] || ''} onChange={(e) => handleSearchChange(type, e.target.value)} className="w-full bg-white border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" placeholder={`搜索或添加新的${title}`} />
                            <button onClick={() => handleAddItem(type)} className="px-4 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold flex-shrink-0">添加</button>
                        </div>
                        <div className="space-y-2 flex-grow overflow-y-auto pr-2">
                            {filteredList.map(item => (
                                <div key={item} className="flex justify-between items-center bg-white dark:bg-slate-700 p-2 rounded-md border dark:border-slate-600">
                                    <span className="dark:text-gray-200 break-all">{item}</span>
                                    <button onClick={() => handleDeleteItem(type, item)} className="p-1 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 dark:hover:bg-red-900/50 flex-shrink-0 ml-2"><Trash2 size={16} /></button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200">
                        <header className="flex justify-between items-center p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold">管理配置</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X /></button>
                        </header>
                        <div className="flex-grow p-6 flex flex-col md:flex-row gap-6 overflow-hidden">
                            <nav className="flex-shrink-0 border-b md:border-b-0 md:border-r dark:border-slate-700 pr-4 flex flex-row md:flex-col gap-1 overflow-x-auto pb-2 md:pb-0">
                                {tabs.map(tab => <button key={tab.key} onClick={() => setActiveTab(tab.key)} className={`px-4 py-2 text-left text-sm font-semibold rounded-md flex-shrink-0 ${activeTab === tab.key ? 'bg-emerald-500 text-white' : 'hover:bg-gray-100 dark:hover:bg-slate-700'}`}>{tab.label}</button>)}
                            </nav>
                            <div className="flex-grow overflow-y-auto h-[450px]">
                                {renderListEditor(activeTab, tabs.find(t => t.key === activeTab)?.label)}
                            </div>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                            <button onClick={onClose} className="px-4 py-2 rounded-md font-semibold">取消</button>
                            <button onClick={handleSave} className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">保存更改</button>
                        </footer>
                    </div>
                </div>
            );
        };
        // --- 修复输入Bug：将辅助组件移到 TaskModal 外部 ---
        const Label = ({ children }) => <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">{children}</label>;
        const Input = ({ name, value, onChange, ...props }) => <input name={name} value={value || ''} onChange={onChange} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" {...props} />;

        const TaskModal = ({ isOpen, onClose, onSave, task, error, setModalError, managementData, workflowStatuses, salesPersonOptions, projectManagerOptions, reviewerOptions }) => {
            const [formData, setFormData] = useState({});

            useEffect(() => {
                if (isOpen) {
                    setModalError(null);
                    const initialData = {
                        customTaskId: 'HB', projectName: '', region: '', taskType: '', sourcing_department: '',
                        execution_department: '', contractAmount: null, salesPerson: null, reviewerId: null,
                        isArchived: false, status: 'reviewing', contractualDueDate: '', actualCompletionDate: '',
                        progressDetails: [], createdAt: new Date().toISOString(),
                        contractDetails: {}
                    };
                    setFormData(task ? { ...initialData, ...task, contractualDueDate: formatDate(task.contractualDueDate), actualCompletionDate: formatDate(task.actualCompletionDate), contractDetails: task.contractDetails || {} } : initialData);
                }
            }, [task, isOpen, setModalError]);

            if (!isOpen) return null;

            const handleFormChange = (name, value) => setFormData(prev => ({ ...prev, [name]: value }));
            const handleInputChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const handleContractDetailsChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, contractDetails: { ...prev.contractDetails, [name]: value } }));
            };

            const handleCopyClientToService = () => {
                setFormData(prev => ({
                    ...prev,
                    contractDetails: {
                        ...prev.contractDetails,
                        serviceCompany: prev.contractDetails.clientCompany,
                        serviceAddress: prev.contractDetails.clientAddress,
                        serviceContact: prev.contractDetails.clientContact,
                        servicePhone: prev.contractDetails.clientPhone,
                    }
                }));
            };

            const handleContractDetailSelect = (name, value) => {
                setFormData(prev => ({ ...prev, contractDetails: { ...prev.contractDetails, [name]: value } }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave({ ...formData, contractAmount: formData.contractAmount ? Number(formData.contractAmount) : null }, !!task);
            };

            // --- 升级：将所有人员相关的下拉菜单统一为可搜索的 ComboBox ---
            const departmentMarketingOptions = (managementData.department_structure?.marketing?.sub_departments || []).map(o => ({ label: o, value: o }));
            const departmentTechnicalOptions = (managementData.department_structure?.technical?.sub_departments || []).map(o => ({ label: o, value: o }));
            const workflowStatusOptions = (workflowStatuses || []).map(o => ({ label: o.label, value: o.value }));


            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <header className="flex justify-between items-center p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold">{task ? '编辑任务详情' : '创建新任务'}</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X /></button>
                        </header>
                        <form onSubmit={handleSubmit} className="flex flex-col flex-grow min-h-0">
                            <div className="p-6 overflow-y-auto flex-grow">
                                {error && <div className="mb-4 bg-red-100 text-red-800 px-4 py-2 rounded-lg text-center text-sm">{error}</div>}

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                    <div className="space-y-4">
                                        <div><Label>任务编号</Label><Input type="text" name="customTaskId" value={formData.customTaskId} onChange={handleInputChange} disabled={!!task} required /></div>
                                        <div><Label>项目名称</Label><Input type="text" name="projectName" value={formData.projectName} onChange={handleInputChange} required /></div>
                                        <div><Label>任务类型</Label><ComboBox options={managementData.taskTypes || []} value={formData.taskType} onChange={(val) => handleFormChange('taskType', val)} placeholder="搜索或选择任务类型" /></div>
                                        <div><Label>承接部门 (市场)</Label><ComboBox options={departmentMarketingOptions.map(o => o.label)} value={formData.sourcing_department} onChange={(val) => handleFormChange('sourcing_department', val)} placeholder="请选择市场部门" /></div>
                                        <div><Label>执行部门 (技术)</Label><ComboBox options={departmentTechnicalOptions.map(o => o.label)} value={formData.execution_department} onChange={(val) => handleFormChange('execution_department', val)} placeholder="请选择技术部门" /></div>
                                    </div>
                                    <div className="space-y-4">
                                        <div><Label>任务阶段</Label><ComboBox options={workflowStatusOptions.map(o => o.label)} value={workflowStatusOptions.find(o => o.value === formData.status)?.label} onChange={(val) => handleFormChange('status', workflowStatusOptions.find(o => o.label === val)?.value)} /></div>
                                        <div><Label>评审人员</Label><ComboBox options={reviewerOptions.map(o => o.label)} value={reviewerOptions.find(o => o.value === formData.reviewerId)?.label} onChange={(val) => handleFormChange('reviewerId', reviewerOptions.find(o => o.label === val)?.value)} placeholder="请选择评审人员" /></div>
                                        <div><Label>所属地区</Label><ComboBox options={managementData.regions || []} value={formData.region} onChange={(val) => handleFormChange('region', val)} placeholder="搜索或选择所属地区" /></div>
                                        <div><Label>业务人员</Label><ComboBox options={salesPersonOptions.map(o => o.label)} value={salesPersonOptions.find(o => o.value === formData.salesPerson)?.label} onChange={(val) => handleFormChange('salesPerson', salesPersonOptions.find(o => o.label === val)?.value)} placeholder="请选择业务人员" /></div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-4 border-t dark:border-gray-700 pt-4 mt-6">
                                    <div><Label>合同金额 (元)</Label><Input type="number" name="contractAmount" value={formData.contractAmount} onChange={handleInputChange} placeholder="请输入金额" step="any" /></div>
                                    <div><Label>任务下达日期</Label><Input type="date" name="createdAt" value={formatDate(formData.createdAt)} onChange={(e) => setFormData({ ...formData, createdAt: new Date(e.target.value).toISOString() })} /></div>
                                    <div><Label>合同规定日期</Label><Input type="date" name="contractualDueDate" value={formData.contractualDueDate} onChange={handleInputChange} /></div>
                                </div>

                                <div className="border-t dark:border-gray-700 pt-4 mt-6">
                                    <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">合同信息</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-x-8 gap-y-4">
                                        <div><Label>签订日期</Label><Input type="date" name="signingDate" value={formatDate(formData.contractDetails?.signingDate)} onChange={handleContractDetailsChange} /></div>
                                        <div><Label>签订单位</Label><ComboBox options={managementData.signingEntities || []} value={formData.contractDetails?.signingEntity} onChange={val => handleContractDetailSelect('signingEntity', val)} placeholder="选择或输入签订单位" /></div>
                                        <div><Label>发票类型</Label><ComboBox options={managementData.invoiceTypes || []} value={formData.contractDetails?.invoiceType} onChange={val => handleContractDetailSelect('invoiceType', val)} placeholder="选择或输入发票类型" /></div>
                                        <div><Label>合同管理员</Label><ComboBox options={managementData.contractAdmins || []} value={formData.contractDetails?.contractAdmin} onChange={val => handleContractDetailSelect('contractAdmin', val)} placeholder="选择或输入合同管理员" /></div>

                                        <div className="md:col-span-3 border-t dark:border-slate-700 mt-2 pt-4"><Label>委托单位</Label><Input name="clientCompany" value={formData.contractDetails?.clientCompany} onChange={handleContractDetailsChange} /></div>
                                        <div><Label>委托单位地址</Label><Input name="clientAddress" value={formData.contractDetails?.clientAddress} onChange={handleContractDetailsChange} /></div>
                                        <div><Label>委托单位联系人</Label><Input name="clientContact" value={formData.contractDetails?.clientContact} onChange={handleContractDetailsChange} /></div>
                                        <div><Label>委托人联系电话</Label><Input name="clientPhone" value={formData.contractDetails?.clientPhone} onChange={handleContractDetailsChange} /></div>

                                        <div className="md:col-span-3 border-t dark:border-slate-700 mt-2 pt-4">
                                            <div className="flex justify-between items-center mb-1">
                                                <Label>服务单位</Label>
                                                <button type="button" onClick={handleCopyClientToService} className="text-xs font-semibold text-emerald-600 hover:text-emerald-800 dark:text-emerald-400 dark:hover:text-emerald-300">同委托单位</button>
                                            </div>
                                            <Input name="serviceCompany" value={formData.contractDetails?.serviceCompany} onChange={handleContractDetailsChange} />
                                        </div>
                                        <div><Label>服务单位地址</Label><Input name="serviceAddress" value={formData.contractDetails?.serviceAddress} onChange={handleContractDetailsChange} /></div>
                                        <div><Label>服务单位联系人</Label><Input name="serviceContact" value={formData.contractDetails?.serviceContact} onChange={handleContractDetailsChange} /></div>
                                        <div><Label>服务人联系电话</Label><Input name="servicePhone" value={formData.contractDetails?.servicePhone} onChange={handleContractDetailsChange} /></div>

                                        <div className="md:col-span-3"><Label>其他附加内容</Label><textarea name="additionalInfo" value={formData.contractDetails?.additionalInfo || ''} onChange={handleContractDetailsChange} rows="3" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200"></textarea></div>
                                    </div>
                                </div>
                            </div>
                            <footer className="p-4 border-t dark:border-slate-700 flex justify-end gap-4 flex-shrink-0">
                                <button type="button" onClick={onClose} className="px-4 py-2 rounded-md font-semibold">取消</button>
                                <button type="submit" className="px-6 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold">保存</button>
                            </footer>
                        </form>
                    </div>
                </div>
            );
        };

        const HistoryModal = ({ isOpen, onClose, onSave, task }) => {
            const [newProgress, setNewProgress] = useState('');

            // --- 核心修改：只获取 progressDetails，不再合并 history ---
            const progressLog = useMemo(() => {
                if (!task || !task.progressDetails) return [];
                // 直接返回进展记录，并按时间倒序排列
                return [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            }, [task]);

            if (!isOpen) return null;

            const handleSave = () => {
                if (newProgress.trim()) {
                    onSave(task.id, newProgress.trim());
                    setNewProgress(''); // 清空输入框
                    // 注意：这里可以根据您的喜好决定是否在保存后关闭弹窗
                    // onClose(); 
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200">
                        {/* --- 核心修改：更新标题 --- */}
                        <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">项目进展记录</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button>
                        </header>
                        <div className="p-6 flex-grow overflow-y-auto">
                            {/* --- 核心修改：更新小标题 --- */}
                            <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-4">进展时间线</h3>
                            <div className="space-y-3 max-h-80 overflow-y-auto pr-2 border-b dark:border-slate-700 pb-4 mb-4">
                                {progressLog.length > 0 ? progressLog.map((entry, index) => (
                                    <div key={index} className="flex items-start gap-3">
                                        <div className="mt-1">
                                            <MessageSquare size={16} className="text-emerald-500" />
                                        </div>
                                        <div className="flex-1 bg-gray-100 dark:bg-slate-800 p-3 rounded-lg">
                                            <p className="text-gray-800 dark:text-gray-200 whitespace-pre-wrap">{entry.text}</p>
                                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-2 text-right">{formatDateTime(entry.timestamp)}</p>
                                        </div>
                                    </div>
                                )) : <p className="text-gray-500 dark:text-gray-400">暂无进展记录。</p>}
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">添加新进展</label>
                                <textarea value={newProgress} onChange={(e) => setNewProgress(e.target.value)} rows="4" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" placeholder="在此输入最新的项目进展..." />
                            </div>
                        </div>
                        <footer className="p-4 flex justify-between items-center gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                            <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">关闭</button>
                            <button onClick={handleSave} className="px-6 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold">保存进展</button>
                        </footer>
                    </div>
                </div>
            );
        };
        const MultiSelectTrigger = React.forwardRef(({ onClick, isOpen, displayText }, ref) => (
            <button ref={ref} type="button" onClick={onClick} className="w-full flex justify-between items-center bg-gray-50 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md px-3 py-2 text-gray-800 dark:text-gray-200 text-left focus:ring-2 focus:ring-emerald-500">
                <span className="truncate">{displayText}</span>
                <ChevronDown size={16} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} />
            </button>
        ));

        // --- 步骤2：将 DropdownContent 定义在外部，并通过 props 接收所需数据 ---
        const MultiSelectDropdownContent = React.forwardRef(({
            positionClass,
            searchTerm,
            setSearchTerm,
            filteredOptions,
            selectedOptions,
            handleSelectAll,
            handleSelect
        }, ref) => (
            <div ref={ref} className={`absolute z-20 w-full bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md shadow-lg ${positionClass}`}>
                <div className="p-2 border-b dark:border-slate-600">
                    <input type="text" placeholder="搜索选项..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="w-full px-2 py-1 text-sm border-gray-200 rounded-md focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-600 dark:border-slate-500 dark:text-gray-200" />
                </div>
                <div className="max-h-60 overflow-y-auto">
                    <div className="p-2 border-b dark:border-slate-600">
                        <label className="flex items-center space-x-2 px-2 py-1 hover:bg-gray-100 dark:hover:bg-slate-600 rounded">
                            <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={filteredOptions.length > 0 && filteredOptions.every(o => selectedOptions.includes(o))} onChange={handleSelectAll} />
                            <span className="dark:text-gray-200 text-sm">全选 (搜索结果)</span>
                        </label>
                    </div>
                    <ul className="py-1">
                        {filteredOptions.map(option => (
                            <li key={option}>
                                <label className="flex items-center space-x-2 px-4 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer">
                                    <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={selectedOptions.includes(option)} onChange={() => handleSelect(option)} />
                                    <span className="dark:text-gray-200">{option}</span>
                                </label>
                            </li>
                        ))}
                    </ul>
                </div>
            </div>
        ));

        // --- 步骤3：修正后的 MultiSelectDropdown 主组件 ---
        const MultiSelectDropdown = ({ options, selectedOptions, onChange, placeholder, forceDirection = 'auto' }) => {
            const [searchTerm, setSearchTerm] = useState('');

            const handleSelect = (option) => {
                const newSelectedOptions = selectedOptions.includes(option)
                    ? selectedOptions.filter(o => o !== option)
                    : [...selectedOptions, option];
                onChange(newSelectedOptions);
            };

            const filteredOptions = useMemo(
                () => options.filter(option => option.toLowerCase().includes(searchTerm.toLowerCase())),
                [options, searchTerm]
            );

            const handleSelectAll = () => {
                if (filteredOptions.every(o => selectedOptions.includes(o))) {
                    onChange(selectedOptions.filter(o => !filteredOptions.includes(o)));
                } else {
                    onChange([...new Set([...selectedOptions, ...filteredOptions])]);
                }
            };

            const displayText = selectedOptions.length === 0
                ? placeholder
                : selectedOptions.length === 1
                    ? selectedOptions[0]
                    : `${selectedOptions.length} 项已选择`;

            return (
                <SmartDropdown
                    trigger={<MultiSelectTrigger displayText={displayText} />}
                    children={
                        <MultiSelectDropdownContent
                            searchTerm={searchTerm}
                            setSearchTerm={setSearchTerm}
                            filteredOptions={filteredOptions}
                            selectedOptions={selectedOptions}
                            handleSelectAll={handleSelectAll}
                            handleSelect={handleSelect}
                        />
                    }
                    forceDirection={forceDirection}
                />
            );
        };
        const TaskFilter = ({ onFilterChange, allTasks, userMap, forceDirection = 'auto' }) => {
            const [filters, setFilters] = useState({ regions: [], taskTypes: [], departments: [], salesPersons: [], projectManagers: [], dateFilterType: 'createdAt', startDate: '', endDate: '', archiveStatus: 'all' });
            useEffect(() => { onFilterChange(filters); }, [filters]);

            const handleMultiSelectChange = (name, value) => setFilters(prev => ({ ...prev, [name]: value }));
            const handleFilterChange = (name, value) => setFilters(prev => ({ ...prev, [name]: value }));
            const handleInputChange = (e) => setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));

            const uniqueOptions = useMemo(() => {
                const safeTasks = allTasks || [];
                // --- 修复1：正确生成部门列表 ---
                const allDepts = safeTasks.flatMap(t => [t.sourcing_department, t.execution_department]);

                // --- 修复2：使用 userMap 将人员ID转换为姓名 ---
                const salesPersonNames = [...new Set(safeTasks.map(t => userMap.get(t.salesPerson)).filter(Boolean))].sort();
                const projectManagerNames = [...new Set(safeTasks.map(t => userMap.get(t.projectManager)).filter(Boolean))].sort();

                return {
                    regions: [...new Set(safeTasks.map(t => t.region).filter(Boolean))].sort(),
                    taskTypes: [...new Set(safeTasks.map(t => t.taskType).filter(Boolean))].sort(),
                    departments: [...new Set(allDepts.filter(Boolean))].sort(),
                    salesPersons: salesPersonNames,
                    projectManagers: projectManagerNames,
                };
            }, [allTasks, userMap]);

            const archiveStatusOptions = [{ value: 'all', label: '所有存档状态' }, { value: 'archived', label: '已存档' }, { value: 'not-archived', label: '未存档' }];
            const dateFilterTypeOptions = [{ value: 'createdAt', label: '任务下达日期' }, { value: 'actualCompletionDate', label: '实际完成日期' }];

            return (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                    <div className="w-full"><MultiSelectDropdown options={uniqueOptions.regions} selectedOptions={filters.regions} onChange={v => handleMultiSelectChange('regions', v)} placeholder="所有地区" forceDirection={forceDirection} /></div>
                    <div className="w-full"><MultiSelectDropdown options={uniqueOptions.taskTypes} selectedOptions={filters.taskTypes} onChange={v => handleMultiSelectChange('taskTypes', v)} placeholder="所有任务类型" forceDirection={forceDirection} /></div>
                    <div className="w-full"><MultiSelectDropdown options={uniqueOptions.departments} selectedOptions={filters.departments} onChange={v => handleMultiSelectChange('departments', v)} placeholder="所有部门" forceDirection={forceDirection} /></div>
                    <div className="w-full"><MultiSelectDropdown options={uniqueOptions.salesPersons} selectedOptions={filters.salesPersons} onChange={v => handleMultiSelectChange('salesPersons', v)} placeholder="所有业务人员" forceDirection={forceDirection} /></div>
                    <div className="w-full"><MultiSelectDropdown options={uniqueOptions.projectManagers} selectedOptions={filters.projectManagers} onChange={v => handleMultiSelectChange('projectManagers', v)} placeholder="所有项目负责人" forceDirection={forceDirection} /></div>
                    <div className="w-full"><SingleSelectDropdown options={archiveStatusOptions} value={filters.archiveStatus} onChange={v => handleFilterChange('archiveStatus', v)} forceDirection={forceDirection} /></div>
                    <div className="lg:col-span-3 grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <SingleSelectDropdown options={dateFilterTypeOptions} value={filters.dateFilterType} onChange={v => handleFilterChange('dateFilterType', v)} forceDirection={forceDirection} />
                        <input type="date" name="startDate" value={filters.startDate} onChange={handleInputChange} placeholder="yyyy-mm-dd" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" />
                        <input type="date" name="endDate" value={filters.endDate} onChange={handleInputChange} placeholder="yyyy-mm-dd" className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 text-gray-800 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]" />
                    </div>
                </div>
            );
        };
        const ColumnToggler = ({ allColumns, visibleColumns, onToggle }) => { const [isOpen, setIsOpen] = useState(false); const wrapperRef = useRef(null); useOutsideAlerter(wrapperRef, () => setIsOpen(false)); return (<div className="relative" ref={wrapperRef}> <button onClick={() => setIsOpen(!isOpen)} className="flex items-center gap-2 px-2.5 py-1 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md text-xs font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-slate-600"> <Icon size={14}><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></Icon> 显示/隐藏列 <ChevronDown size={14} className={`transition-transform ${isOpen ? 'rotate-180' : ''}`} /> </button> {isOpen && (<div className="absolute right-0 z-20 w-56 mt-1 bg-white dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-md shadow-lg"> <ul className="py-1 max-h-60 overflow-y-auto"> {allColumns.map(col => (<li key={col.key}> <label className="flex items-center space-x-2 px-3 py-2 hover:bg-gray-100 dark:hover:bg-slate-600 cursor-pointer text-sm"> <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={visibleColumns.includes(col.key)} onChange={() => onToggle(col.key)} /> <span className="dark:text-gray-200">{col.label}</span> </label> </li>))} </ul> </div>)} </div>); };
        // 这是全新的、修正后的 SnoozeModal 组件
        const SnoozeModal = ({ onClose, onSnoozeSelect }) => {
            const [customDate, setCustomDate] = useState('');

            const snoozeOptions = [
                { label: '1 周后', days: 7 },
                { label: '1 个月后', days: 30 },
                { label: '3 个月后', days: 90 },
            ];

            // 修正了快捷选项的日期计算逻辑
            const handleSelect = (days) => {
                let snoozeUntil = new Date();
                // 直接在当前日期上增加天数
                snoozeUntil.setDate(snoozeUntil.getDate() + days);
                // 将时间设置为目标日期的最后一刻，确保在这一天结束前都不会提醒
                snoozeUntil.setHours(23, 59, 59, 999);
                onSnoozeSelect(snoozeUntil.toISOString());
            };

            // 修正了自定义日期的处理逻辑
            const handleCustomSnooze = () => {
                if (customDate) {
                    // new Date('YYYY-MM-DD') 会创建为当地时间的 00:00:00
                    let snoozeUntil = new Date(customDate);
                    // 同样将时间设置为所选日期的最后一刻
                    snoozeUntil.setHours(23, 59, 59, 999);
                    onSnoozeSelect(snoozeUntil.toISOString());
                } else {
                    alert('请选择一个具体的日期。');
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-30 z-[60] flex justify-center items-center p-4" onClick={onClose}>
                    <div className="bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-xs" onClick={e => e.stopPropagation()}>
                        <ul className="py-1 border-b dark:border-slate-600">
                            {snoozeOptions.map(opt => (
                                <li key={opt.label}>
                                    <button
                                        onClick={() => handleSelect(opt.days)}
                                        className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-600"
                                    >
                                        {opt.label}
                                    </button>
                                </li>
                            ))}
                        </ul>
                        <div className="p-3 space-y-2">
                            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">选择具体日期</label>
                            <input
                                type="date"
                                value={customDate}
                                onChange={(e) => setCustomDate(e.target.value)}
                                className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200 dark:[color-scheme:dark]"
                            />
                            <button
                                onClick={handleCustomSnooze}
                                className="w-full px-4 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold"
                            >
                                确认
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        const NotificationIcon = ({ type }) => {
            switch (type) {
                case 'urgent_task':
                    return <AlertTriangle size={16} className="text-amber-500" />;
                case 'backup_reminder':
                    return <Database size={16} className="text-blue-500" />;
                // 您未来可以为更多类型在这里添加图标
                default:
                    return <Bell size={16} className="text-gray-500" />;
            }
        };
        const PaginatedNotificationList = ({ notifications, selectedIds, onToggleSelect, onToggleSelectAll }) => {
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 5; // 每个分类列表每页显示5条

            // --- 分页逻辑 ---
            const indexOfLastItem = currentPage * itemsPerPage;
            const indexOfFirstItem = indexOfLastItem - itemsPerPage;
            const currentItems = notifications.slice(indexOfFirstItem, indexOfLastItem);
            const totalPages = Math.ceil(notifications.length / itemsPerPage);
            const areAllSelected = notifications.length > 0 && notifications.every(n => selectedIds.has(n.id));
            const paginate = (pageNumber) => setCurrentPage(pageNumber);

            // 如果没有通知，则不渲染任何内容
            if (notifications.length === 0) return null;

            return (
                <div>
                    <div className="p-2 border-b dark:border-slate-700 mb-2">
                        <label className="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-300">
                            <input
                                type="checkbox"
                                className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400"
                                checked={areAllSelected}
                                onChange={onToggleSelectAll}
                            />
                            <span>{areAllSelected ? '取消全选' : '全选此分类'}</span>
                        </label>
                    </div>
                    <ul className="space-y-2">
                        {currentItems.map(item => (
                            <li key={item.id} className={`p-3 flex items-start gap-4 rounded-lg transition-colors ${!item.isRead ? 'bg-emerald-50 dark:bg-emerald-900/30' : 'bg-gray-50 dark:bg-slate-800'}`}>
                                <div className="flex-shrink-0 flex items-center justify-center">
                                    <input
                                        type="checkbox"
                                        className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400"
                                        checked={selectedIds.has(item.id)}
                                        onChange={() => onToggleSelect(item.id)}
                                    />
                                </div>
                                <div className="flex-shrink-0 mt-1"><NotificationIcon type={item.type} /></div>
                                <div className="flex-grow">
                                    <p className="text-sm text-gray-800 dark:text-gray-200">{item.message}</p>
                                    <p className="text-xs text-gray-400 dark:text-gray-500 mt-1">{formatDateTime(item.timestamp || item.created_at)}</p>
                                </div>
                                {/* 复选框和“稍后提醒”按钮的位置将在这里 */}
                            </li>
                        ))}
                    </ul>
                    {totalPages > 1 && (
                        <div className="mt-4">
                            {/* 我们复用您代码中已有的 Pagination 组件 */}
                            <Pagination
                                usersPerPage={itemsPerPage}
                                totalUsers={notifications.length}
                                paginate={paginate}
                                currentPage={currentPage}
                            />
                        </div>
                    )}
                </div>
            );
        };
        const StatisticsModal = ({ isOpen, onClose, tasks, userMap }) => {
            const ALL_COLUMNS = useMemo(() => [
                { key: 'customTaskId', label: '任务编号' }, { key: 'projectName', label: '项目名称' },
                { key: 'region', label: '所属地区' }, { key: 'taskType', label: '任务类型' },
                { key: 'sourcing_department', label: '承接部门(市场)' }, { key: 'execution_department', label: '执行部门(技术)' },
                { key: 'salesPerson', label: '业务人员' }, { key: 'projectManager', label: '项目负责人' },
                { key: 'contractAmount', label: '合同金额' }, { key: 'createdAt', label: '下达日期' },
                { key: 'actualCompletionDate', label: '完成日期' }, { key: 'isArchived', label: '存档' }
            ], []);

            const [filters, setFilters] = useState(null);
            const [visibleColumns, setVisibleColumns] = useState(ALL_COLUMNS.map(c => c.key));

            const handleFilterChange = useCallback((newFilters) => { setFilters(newFilters); }, []);
            const handleToggleColumn = (keyToToggle) => {
                setVisibleColumns(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(keyToToggle)) newSet.delete(keyToToggle); else newSet.add(keyToToggle);
                    return ALL_COLUMNS.filter(c => newSet.has(c.key)).map(c => c.key);
                });
            };

            const filteredTasks = useMemo(() => {
                if (!filters) return tasks;
                return tasks.filter(task => {
                    const { regions, taskTypes, departments, salesPersons, projectManagers, dateFilterType, startDate, endDate, archiveStatus } = filters;
                    if (regions.length > 0 && !regions.includes(task.region)) return false;
                    if (taskTypes.length > 0 && !taskTypes.includes(task.taskType)) return false;
                    if (departments.length > 0 && !departments.includes(task.sourcing_department) && !departments.includes(task.execution_department)) return false;
                    if (salesPersons.length > 0 && !salesPersons.includes(userMap.get(task.salesPerson))) return false;
                    if (projectManagers.length > 0 && !projectManagers.includes(userMap.get(task.projectManager))) return false;
                    if (archiveStatus !== 'all' && (archiveStatus === 'archived' ? !task.isArchived : task.isArchived)) return false;

                    // --- 日期筛选修复 ---
                    const taskDateStr = task[dateFilterType];
                    if (startDate && (!taskDateStr || formatDate(taskDateStr) < startDate)) return false;
                    if (endDate && (!taskDateStr || formatDate(taskDateStr) > endDate)) return false;

                    return true;
                });
            }, [tasks, filters, userMap]);

            const totalAmount = useMemo(() => filteredTasks.reduce((sum, task) => sum + (Number(task.contractAmount) || 0), 0), [filteredTasks]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-white text-gray-800 dark:bg-slate-900 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-full md:max-w-4xl lg:max-w-7xl h-[90vh] flex flex-col">                        <header className="flex justify-between items-center p-4 border-b dark:border-slate-700 shrink-0">
                        <h2 className="text-xl font-bold">统计分析</h2>
                        <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700"><X /></button>
                    </header>
                        <div className="p-4 md:p-6 flex-grow min-h-0 flex flex-col overflow-y-auto md:overflow-y-hidden">
                            {/* --- 顶部区域 (筛选器 + 卡片) --- */}
                            <div className="md:shrink-0">
                                <TaskFilter onFilterChange={handleFilterChange} allTasks={tasks} userMap={userMap} forceDirection="down" />
                                <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center my-4 gap-4">
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 w-full">
                                        <div className="p-4 bg-white dark:bg-slate-800 border rounded-lg text-center shadow-sm"><div className="text-3xl font-bold text-emerald-500">{filteredTasks.length}</div><div className="text-sm text-gray-500 dark:text-gray-400">任务总数</div></div>
                                        <div className="p-4 bg-white dark:bg-slate-800 border rounded-lg text-center shadow-sm"><div className="text-3xl font-bold text-green-500">{formatAmount(totalAmount)}</div><div className="text-sm text-gray-500 dark:text-gray-400">合同总金额</div></div>
                                    </div>
                                    <div className="self-end sm:self-center"><ColumnToggler allColumns={ALL_COLUMNS} visibleColumns={visibleColumns} onToggle={handleToggleColumn} /></div>
                                </div>
                            </div>

                            {/* --- 底部区域 (表格) --- */}
                            <div className="mt-4 md:mt-0 md:flex-grow md:min-h-0 md:overflow-y-auto">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-center">
                                        <thead className="text-xs uppercase bg-gray-100 dark:bg-slate-800 sticky top-0 z-10">
                                            <tr>{ALL_COLUMNS.filter(c => visibleColumns.includes(c.key)).map(col => (<th key={col.key} className="p-2 font-medium">{col.label}</th>))}</tr>
                                        </thead>
                                        <tbody>
                                            {filteredTasks.map((task, index) => (
                                                <tr key={task.id} className={`border-b dark:border-slate-700 ${index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50'}`}>
                                                    {ALL_COLUMNS.filter(c => visibleColumns.includes(c.key)).map(col => {
                                                        let content = task[col.key];
                                                        if (['createdAt', 'actualCompletionDate'].includes(col.key)) content = formatDate(content);
                                                        else if (['salesPerson', 'projectManager'].includes(col.key)) content = userMap.get(content) || content;
                                                        else if (col.key === 'isArchived') content = task.isArchived ? '是' : '否';
                                                        else if (col.key === 'contractAmount') content = formatAmount(content);
                                                        return (<td key={col.key} className="p-2 break-words" title={content}>{content || ''}</td>);
                                                    })}
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t shrink-0">
                            <button onClick={() => exportData('excel', filteredTasks, "统计结果", visibleColumns, () => alert('统计结果已导出！'), [], userMap)} className="px-6 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center gap-2">
                                <Download size={16} />下载统计结果
                            </button>
                        </footer>
                    </div>
                </div>
            );
        };
        const ExportModal = ({ isOpen, onClose, allNonDeletedTasks, userMap }) => {
            const ALL_EXPORT_COLUMNS = useMemo(() => [
                { key: 'createdAt', label: '任务下达日期' }, { key: 'customTaskId', label: '任务编号' }, { key: 'projectName', label: '项目名称' },
                { key: 'taskType', label: '任务类型' }, { key: 'sourcing_department', label: '承接部门(市场)' }, { key: 'execution_department', label: '执行部门(技术)' },
                { key: 'contractAmount', label: '合同金额' }, { key: 'salesPerson', label: '业务人员' }, { key: 'reviewerId', label: '评审人员' },
                { key: 'projectManager', label: '项目负责人' }, { key: 'auditor_name', label: '审核人' }, { key: 'rechecker_name', label: '复核人' }, { key: 'issuer_name', label: '签发人' },
                { key: 'contractualDueDate', label: '合同规定日期' }, { key: 'timeRemaining', label: '剩余时间' }, { key: 'progressDetails', label: '最新项目进展' },
                { key: 'region', label: '所属地区' }, { key: 'status', label: '状态' }, { key: 'actualCompletionDate', label: '实际完成日期' }, { key: 'isArchived', label: '是否存档' },
            ], []);

            const viewOptions = ['评审中', '待分配', '进行中', '审核中', '复核中', '签发中', '已完成', '已作废'];
            const statusMap = { '评审中': 'reviewing', '待分配': 'assigning', '进行中': 'inprogress', '审核中': 'auditing', '复核中': 'rechecking', '签发中': 'issuing', '已完成': 'done', '已作废': 'void' };

            const defaultColsByView = {
                reviewing: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'sourcing_department', 'execution_department', 'contractAmount', 'salesPerson', 'reviewerId', 'contractualDueDate', 'region'],
                inprogress: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'sourcing_department', 'execution_department', 'contractAmount', 'projectManager', 'contractualDueDate', 'timeRemaining', 'progressDetails', 'region'],
                done: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'sourcing_department', 'execution_department', 'contractAmount', 'projectManager', 'contractualDueDate', 'actualCompletionDate', 'isArchived', 'progressDetails', 'region'],
                void: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'sourcing_department', 'execution_department', 'contractAmount', 'salesPerson', 'projectManager', 'progressDetails', 'region']
            };

            const [selectedViews, setSelectedViews] = useState(['进行中']);
            const [filters, setFilters] = useState(null);
            const [visibleColumns, setVisibleColumns] = useState(defaultColsByView.inprogress);

            useEffect(() => {
                const selectedStatuses = selectedViews.map(v => statusMap[v]);
                if (selectedStatuses.length === 0) { setVisibleColumns([]); return; }
                const newVisibleCols = new Set();
                selectedStatuses.forEach(status => {
                    const cols = defaultColsByView[status] || defaultColsByView.inprogress;
                    cols.forEach(col => newVisibleCols.add(col));
                });
                if (selectedStatuses.length > 1) newVisibleCols.add('status');
                setVisibleColumns(ALL_EXPORT_COLUMNS.filter(c => newVisibleCols.has(c.key)).map(c => c.key));
            }, [selectedViews, ALL_EXPORT_COLUMNS]);

            const onExportSuccess = () => alert('数据已成功导出！');
            const handleFilterChange = useCallback((newFilters) => { setFilters(newFilters); }, []);
            const handleToggleColumn = (keyToToggle) => {
                setVisibleColumns(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(keyToToggle)) newSet.delete(keyToToggle); else newSet.add(keyToToggle);
                    return ALL_EXPORT_COLUMNS.filter(c => newSet.has(c.key)).map(c => c.key);
                });
            };

            const tasksFromSelectedViews = useMemo(() => {
                const selectedStatuses = selectedViews.map(v => statusMap[v]);
                return allNonDeletedTasks.filter(task => selectedStatuses.includes(task.status));
            }, [selectedViews, allNonDeletedTasks]);

            const filteredTasks = useMemo(() => {
                if (!filters) return tasksFromSelectedViews;
                return tasksFromSelectedViews.filter(task => {
                    const { regions, taskTypes, departments, salesPersons, projectManagers, dateFilterType, startDate, endDate, archiveStatus } = filters;
                    if (regions.length > 0 && !regions.includes(task.region)) return false;
                    if (taskTypes.length > 0 && !taskTypes.includes(task.taskType)) return false;
                    if (departments.length > 0 && !departments.includes(task.sourcing_department) && !departments.includes(task.execution_department)) return false;
                    if (salesPersons.length > 0 && !salesPersons.includes(userMap.get(task.salesPerson))) return false;
                    if (projectManagers.length > 0 && !projectManagers.includes(userMap.get(task.projectManager))) return false;
                    if (archiveStatus !== 'all' && (archiveStatus === 'archived' ? !task.isArchived : task.isArchived)) return false;

                    // --- 日期筛选修复 ---
                    const taskDateStr = task[dateFilterType];
                    if (startDate && (!taskDateStr || formatDate(taskDateStr) < startDate)) return false;
                    if (endDate && (!taskDateStr || formatDate(taskDateStr) > endDate)) return false;

                    return true;
                });
            }, [tasksFromSelectedViews, filters, userMap]);

            const filterDescription = useMemo(() => {
                if (!filters) return "所有任务";
                const parts = [];
                const { regions, taskTypes, departments, salesPersons, projectManagers, archiveStatus, startDate, endDate, dateFilterType } = filters;
                if (regions.length > 0) parts.push(`地区为 "${regions.join('、')}"`);
                if (taskTypes.length > 0) parts.push(`类型为 "${taskTypes.join('、')}"`);
                if (departments.length > 0) parts.push(`部门为 "${departments.join('、')}"`);
                if (salesPersons.length > 0) parts.push(`业务员为 "${salesPersons.join('、')}"`);
                if (projectManagers.length > 0) parts.push(`负责人为 "${projectManagers.join('、')}"`);
                if (archiveStatus !== 'all') parts.push(archiveStatus === 'archived' ? '已存档' : '未存档');
                if (startDate || endDate) {
                    const dateLabel = dateFilterType === 'createdAt' ? '下达日期' : '完成日期';
                    if (startDate && endDate) parts.push(`${dateLabel}从 ${startDate} 到 ${endDate}`);
                    else if (startDate) parts.push(`${dateLabel}自 ${startDate} 起`);
                    else parts.push(`${dateLabel}截止到 ${endDate}`);
                }
                if (parts.length === 0) return "所有任务";
                return "满足 " + parts.join('，') + " 条件的任务";
            }, [filters]);

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 text-gray-800 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-screen-xl max-h-[90vh] flex flex-col">
                        <header className="flex justify-between items-center p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold">导出任务</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700"><X /></button>
                        </header>
                        <div className="p-6 overflow-y-auto">
                            <div className="mb-6 border-b pb-6">
                                <h3 className="text-lg font-semibold mb-4">快速导出</h3>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <button onClick={() => exportData('excel', allNonDeletedTasks, "全部任务", ALL_EXPORT_COLUMNS.map(c => c.key), onExportSuccess, [], userMap)} className="w-full px-6 py-3 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">导出全部任务</button>
                                    <button onClick={() => exportData('excel', allNonDeletedTasks.filter(t => t.status === 'inprogress'), "进行中任务", defaultColsByView.inprogress, onExportSuccess, ['进行中'], userMap)} className="w-full px-6 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold">导出进行中任务</button>
                                    <button onClick={() => exportData('excel', allNonDeletedTasks.filter(t => t.status === 'done'), "已完成任务", defaultColsByView.done, onExportSuccess, ['已完成'], userMap)} className="w-full px-6 py-3 rounded-md text-white bg-orange-500 hover:bg-orange-600 font-semibold">导出已完成任务</button>
                                </div>
                            </div>
                            <div>
                                <div className="flex items-center gap-4 mb-4">
                                    <h3 className="text-lg font-semibold">自定义导出</h3>
                                    <ColumnToggler allColumns={ALL_EXPORT_COLUMNS} visibleColumns={visibleColumns} onToggle={handleToggleColumn} />
                                </div>
                                <div className="mb-4"><label className="block text-sm font-medium mb-1">1. 选择视图范围</label><MultiSelectDropdown options={viewOptions} selectedOptions={selectedViews} onChange={setSelectedViews} placeholder="请选择视图" forceDirection="up" /></div>
                                <div><label className="block text-sm font-medium mb-1">2. 设置筛选条件</label><TaskFilter onFilterChange={handleFilterChange} allTasks={tasksFromSelectedViews} userMap={userMap} forceDirection="up" /></div>
                                <div className="mt-4 p-4 bg-slate-100 dark:bg-slate-800 rounded-lg">
                                    <p className="text-sm text-gray-600 dark:text-gray-300">
                                        将从 <span className="font-semibold text-emerald-500 mx-1">{selectedViews.join('、') || '未选择'}</span> 视图中，导出 <span className="font-semibold text-emerald-500 mx-1">{filterDescription}</span>，共计 <span className="font-bold text-emerald-500 mx-1">{filteredTasks.length}</span> 个。
                                    </p>
                                </div>
                            </div>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t">
                            <div className="flex gap-2">
                                <button onClick={() => exportData('excel', filteredTasks, "筛选结果", visibleColumns, onExportSuccess, selectedViews, userMap)} className="px-4 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold" disabled={filteredTasks.length === 0}>Excel</button>
                                <button onClick={() => exportData('csv', filteredTasks, "筛选结果", visibleColumns, onExportSuccess, selectedViews, userMap)} className="px-4 py-2 rounded-md text-white bg-sky-600 hover:bg-sky-700 font-semibold" disabled={filteredTasks.length === 0}>CSV</button>
                                <button onClick={() => exportData('png', filteredTasks, "筛选结果", visibleColumns, onExportSuccess, selectedViews, userMap)} className="px-4 py-2 rounded-md text-white bg-purple-600 hover:bg-purple-700 font-semibold" disabled={filteredTasks.length === 0}>图片</button>
                            </div>
                        </footer>
                    </div>
                </div>
            );
        };
        const ImportReportModal = ({ isOpen, onClose, report, onExportErrors }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col"> <header className="p-4 border-b dark:border-slate-700"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">导入报告</h2> </header> <div className="p-6 overflow-y-auto"> <div className="flex justify-around items-center mb-4 p-4 bg-gray-50 dark:bg-slate-800 rounded-lg"> <div><span className="text-2xl font-bold text-green-500">{report.successful}</span><span className="ml-2 text-gray-600 dark:text-gray-300">条成功</span></div> <div><span className="text-2xl font-bold text-red-500">{report.failed}</span><span className="ml-2 text-gray-600 dark:text-gray-300">条失败</span></div> </div> {report.failed > 0 && (<> <h3 className="font-semibold mb-2 text-gray-800 dark:text-gray-200">失败详情:</h3> <div className="overflow-auto border dark:border-slate-700 rounded-lg max-h-64"> <table className="w-full text-sm"> <thead className="bg-gray-100 dark:bg-slate-800 sticky top-0"> <tr> <th className="p-2 font-medium text-left w-24 dark:text-gray-300">Excel 行号</th> <th className="p-2 font-medium text-left dark:text-gray-300">任务编号</th> <th className="p-2 font-medium text-left dark:text-gray-300">错误原因</th> </tr> </thead> <tbody className="bg-white dark:bg-slate-900"> {report.errors.map((err, i) => (<tr key={i} className="border-t dark:border-slate-700"> <td className="p-2 dark:text-gray-300">{err.row}</td> <td className="p-2 dark:text-gray-300">{err.id || 'N/A'}</td> <td className="p-2 text-red-500">{err.reason}</td> </tr>))} </tbody> </table> </div> <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">提示：请根据以上报告修改您的Excel文件后，重新尝试导入。</p> </>)} </div> <footer className="p-4 flex justify-between items-center gap-4 bg-gray-50 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> {report.failed > 0 && (<button onClick={onExportErrors} className="px-4 py-2 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center gap-2"> <Download size={16} /> 导出错误报告 </button>)} <button onClick={onClose} className="px-6 py-2 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold ml-auto">关闭</button> </footer> </div> </div>); };
        // --- 【更新版】ActionModal ---
        const ActionModal = ({ state, onClose, onActionSelect, currentUserProfile, actionPermissions, WORKFLOW_CONFIG, session }) => {
            if (!state.isOpen || !state.task) return null;
            const { task } = state;

            const canPerformAction = (actionKey) => {
                // 关键修复：首先检查是否为硬编码的超级管理员邮箱，如果是，直接授予权限
                if (session?.user?.email === '396382608@qq.com') {
                    return true;
                }

                // 如果不是超级管理员，再执行原有的、基于角色配置的权限检查
                if (!currentUserProfile || !currentUserProfile.permissions?.roles) return false;

                const userRoleKeys = currentUserProfile.permissions.roles.map(p => p.role);
                if (userRoleKeys.includes('admin')) return true;
                if (userRoleKeys.length === 0) return false;

                return actionPermissions.some(p =>
                    p.is_enabled && p.view_key === task.status && p.action_key === actionKey && userRoleKeys.includes(p.role_key)
                );
            };

            // 【核心改造】: 从工作流地图和用户权限的交集中动态生成操作
            const availableActions = useMemo(() => {
                const possibleActions = WORKFLOW_CONFIG[task.status]?.actions || [];
                const actionDefinitions = [
                    { key: 'edit', label: '编辑', icon: <Edit size={16} />, className: 'text-blue-600 hover:bg-blue-50 border-blue-200 dark:text-blue-400 dark:hover:bg-blue-900/50 dark:border-blue-800' },
                    { key: 'submit', label: '提交', icon: <Check size={16} />, className: 'text-green-600 hover:bg-green-50 border-green-200 dark:text-green-400 dark:hover:bg-green-900/50 dark:border-green-800' },
                    { key: 'return', label: '退回', icon: <RotateCcw size={16} />, className: 'text-orange-600 hover:bg-orange-50 border-orange-200 dark:text-orange-400 dark:hover:bg-orange-900/50 dark:border-orange-800' },
                    { key: 'assign', label: '分配任务', icon: <Users size={16} />, className: 'text-teal-600 hover:bg-teal-50 border-teal-200 dark:text-teal-400 dark:hover:bg-teal-900/50 dark:border-teal-800' },
                    { key: 'transfer', label: '转交任务', icon: <Users size={16} />, className: 'text-purple-600 hover:bg-purple-50 border-purple-200 dark:text-purple-400 dark:hover:bg-purple-900/50 dark:border-purple-800' },
                    { key: 'void', label: '作废', icon: <Ban size={16} />, className: 'text-gray-600 hover:bg-gray-50 border-gray-200 dark:text-gray-400 dark:hover:bg-gray-900/50 dark:border-gray-800' },
                    { key: 'delete', label: '删除', icon: <Trash2 size={16} />, className: 'text-red-600 hover:bg-red-50 border-red-200 dark:text-red-400 dark:hover:bg-red-900/50 dark:border-red-800' },
                    { key: 'emergency', label: '加急', icon: <AlertTriangle size={16} />, className: 'text-yellow-600 hover:bg-yellow-50 border-yellow-200 dark:text-yellow-400 dark:hover:bg-yellow-900/50 dark:border-yellow-800' },
                ];

                return actionDefinitions
                    .filter(action => possibleActions.includes(action.key) && canPerformAction(action.key))
                    .map(action => ({ ...action, action: () => onActionSelect(action.key, task) }));
            }, [task, currentUserProfile, actionPermissions]);

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-40 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-md">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-lg font-bold text-gray-900 dark:text-gray-100">任务操作</h2>
                            <div className="text-sm text-gray-600 dark:text-gray-300 mt-2 space-y-1 bg-gray-50 dark:bg-slate-800 p-3 rounded-md border dark:border-slate-700">
                                <p><span className="font-semibold w-20 inline-block">任务编号:</span> <span className="font-mono">{task.customTaskId}</span></p>
                                <p><span className="font-semibold w-20 inline-block">项目名称:</span> {task.projectName}</p>
                                <p><span className="font-semibold w-20 inline-block">任务类型:</span> {task.taskType}</p>
                            </div>
                        </header>
                        <div className="p-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
                            {availableActions.map(item => (<button key={item.label} onClick={item.action} className={`w-full flex items-center justify-center gap-3 px-3 py-2 text-sm rounded-md border ${item.className}`}>
                                {item.icon} <span>{item.label}</span>
                            </button>))}
                            {availableActions.length === 0 && <p className="text-center text-slate-500 col-span-2">在此状态下，您没有可执行的操作。</p>}
                        </div>
                        <footer className="p-2 flex justify-end bg-gray-50 dark:bg-slate-800/50 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">关闭</button>
                        </footer>
                    </div>
                </div>
            );
        };
        const ListHeader = ({ currentView, onSelectAll, numSelected, taskCount, currentUserProfile, columnDefinitions, columnWidthMap, viewColumnMap, availableRoles }) => {
            const checkboxRef = useRef(null);
            useEffect(() => { if (checkboxRef.current) { checkboxRef.current.indeterminate = numSelected > 0 && numSelected < taskCount; } }, [numSelected, taskCount]);
            const HeaderCell = ({ label }) => (<div className="flex items-center justify-center">{label}</div>);

            const { visibleColumns, gridTemplateColumns } = useMemo(() => {
                // 1. 安全地获取用户角色
                const userRoles = currentUserProfile?.permissions?.roles ?? [];
                const userRoleKeys = new Set(userRoles.map(r => r.role));

                // 2. 根据角色聚合出所有可见的列
                const columnsFromRoles = new Set();
                availableRoles.forEach(roleDef => {
                    if (userRoleKeys.has(roleDef.key)) {
                        const colsForRole = roleDef.default_columns || {};
                        // 检查当前视图是否有为该角色配置的列
                        if (colsForRole[currentView] && Array.isArray(colsForRole[currentView])) {
                            colsForRole[currentView].forEach(colKey => columnsFromRoles.add(colKey));
                        }
                    }
                });

                // 3. 应用用户特权（如果有）
                const overrides = currentUserProfile?.permissions?.overrides?.visibility_perms?.columns || {};
                const grantedCols = new Set(overrides.grant || []);
                const deniedCols = new Set(overrides.deny || []);

                const finalVisibleColKeys = new Set([...columnsFromRoles, ...grantedCols]);
                deniedCols.forEach(colKey => finalVisibleColKeys.delete(colKey));

                // 4. 构建最终用于渲染的列对象和样式
                const baseColumnsForView = viewColumnMap[currentView] || [];
                const finalVisibleCols = columnDefinitions.filter(colDef =>
                    baseColumnsForView.includes(colDef.key) && finalVisibleColKeys.has(colDef.key)
                );

                const widths = [];
                if (currentView !== 'overview') widths.push(columnWidthMap.checkbox);
                finalVisibleCols.forEach(col => widths.push(columnWidthMap[col.key] || '1fr'));
                if (currentView !== 'overview') widths.push(columnWidthMap.actions);

                return { visibleColumns: finalVisibleCols, gridTemplateColumns: widths.join(' ') };
            }, [currentView, currentUserProfile, columnDefinitions, columnWidthMap, availableRoles]); // 注意依赖项也更新了

            return (
                <div style={{ gridTemplateColumns }} className={`task-grid-header grid gap-4 px-4 py-3 bg-slate-100 dark:bg-slate-800 text-sm font-bold text-slate-700 dark:text-slate-300 sticky top-0 z-10 text-center border-b-2 border-slate-200 dark:border-slate-700`}>
                    {currentView !== 'overview' && <div className="flex items-center justify-center"><input type="checkbox" ref={checkboxRef} onChange={onSelectAll} checked={taskCount > 0 && numSelected === taskCount} className="form-checkbox h-4 w-4 text-emerald-600" /></div>}
                    {visibleColumns.map(col => <HeaderCell key={col.key} label={col.label} />)}
                    {currentView !== 'overview' && <HeaderCell label="操作" />}
                </div>
            );
        };
        // --- 【更新版】TaskRow ---
        const TaskRow = ({ task, onActionConfirm, currentView, index, onSelect, isSelected, currentUserProfile, columnDefinitions, columnWidthMap, viewColumnMap, availableActions, userMap, statusLabelMap, availableRoles, onOpenFlowModal }) => {
            let timeRemaining = { status: '', time: '' };
            let timeRemainingColorClass = 'text-slate-700 dark:text-slate-300';
            let funTooltip = '';
            let borderColorClass = 'border-l-4 border-transparent'; // 默认透明边框

            if (task.contractualDueDate && !['done', 'void'].includes(task.status)) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0);
                const diffTime = dueDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                timeRemaining = formatDuration(diffDays);

                if (diffDays < 0) {
                    timeRemainingColorClass = 'text-rose-600 dark:text-rose-400';
                    funTooltip = '火烧眉毛啦！再不干活就要被老板KO了！🔥';
                    borderColorClass = 'border-l-4 border-red-400 dark:border-red-600';
                } else if (diffDays <= 7) {
                    timeRemainingColorClass = 'text-amber-600 dark:text-amber-400';
                    funTooltip = '最后冲刺阶段，胜利就在眼前！🏆';
                    borderColorClass = 'border-l-4 border-yellow-400 dark:border-yellow-600';
                } else {
                    // 对于7天以上的任务，我们给一个通用提示，并用绿色边框
                    timeRemainingColorClass = 'text-green-600 dark:text-green-400';
                    funTooltip = '稳住，我们能赢！😎';
                    borderColorClass = 'border-l-4 border-green-400 dark:border-green-600';
                }
            } else if (task.status === 'done') {
                borderColorClass = 'border-l-4 border-slate-300 dark:border-slate-600';
                funTooltip = '已完成的任务，干得漂亮！🎉'; // <-- 新增
            } else if (task.status === 'void') {
                borderColorClass = 'border-l-4 border-slate-300 dark:border-slate-600';
                funTooltip = '任务已经作废，从此了无牵挂。'; // <-- 新增
            }
            let rowBgColor;
            if (task.status !== 'done' && task.status !== 'void' && task.contractualDueDate) { const today = new Date(); today.setHours(0, 0, 0, 0); const dueDate = new Date(task.contractualDueDate); dueDate.setHours(0, 0, 0, 0); const diffTime = dueDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); timeRemaining = formatDuration(diffDays); if (diffDays < 0) { timeRemainingColorClass = 'text-rose-600 dark:text-rose-400'; rowBgColor = 'bg-rose-50 dark:bg-rose-900/20'; } else if (diffDays <= 7) { timeRemainingColorClass = 'text-amber-600 dark:text-amber-400'; rowBgColor = 'bg-amber-50 dark:bg-amber-900/20'; } else { rowBgColor = 'bg-emerald-50 dark:bg-emerald-900/20'; } } else { rowBgColor = index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50'; }
            if (isSelected) { rowBgColor = 'bg-sky-200 dark:bg-sky-800/50'; }
            const latestProgress = useMemo(() => { if (!task.progressDetails || task.progressDetails.length === 0) return '暂无进展'; return [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0].text; }, [task.progressDetails]);
            const { visibleColumns, gridTemplateColumns } = useMemo(() => {
                // 1. 安全地获取用户角色
                const userRoles = currentUserProfile?.permissions?.roles ?? [];
                const userRoleKeys = new Set(userRoles.map(r => r.role));

                // 2. 根据角色聚合出所有可见的列
                const columnsFromRoles = new Set();
                availableRoles.forEach(roleDef => {
                    if (userRoleKeys.has(roleDef.key)) {
                        const colsForRole = roleDef.default_columns || {};
                        if (colsForRole[currentView] && Array.isArray(colsForRole[currentView])) {
                            colsForRole[currentView].forEach(colKey => columnsFromRoles.add(colKey));
                        }
                    }
                });

                // 3. 应用用户特权（如果有）
                const overrides = currentUserProfile?.permissions?.overrides?.visibility_perms?.columns || {};
                const grantedCols = new Set(overrides.grant || []);
                const deniedCols = new Set(overrides.deny || []);

                const finalVisibleColKeys = new Set([...columnsFromRoles, ...grantedCols]);
                deniedCols.forEach(colKey => finalVisibleColKeys.delete(colKey));

                // 4. 构建最终用于渲染的列对象和样式
                const baseColumnsForView = viewColumnMap[currentView] || [];
                const finalVisibleCols = columnDefinitions.filter(colDef =>
                    baseColumnsForView.includes(colDef.key) && finalVisibleColKeys.has(colDef.key)
                );

                const widths = [];
                if (currentView !== 'overview') widths.push(columnWidthMap.checkbox);
                finalVisibleCols.forEach(col => widths.push(columnWidthMap[col.key] || '1fr'));
                if (currentView !== 'overview') widths.push(columnWidthMap.actions);

                return { visibleColumns: finalVisibleCols, gridTemplateColumns: widths.join(' ') };
            }, [currentView, currentUserProfile, columnDefinitions, columnWidthMap, availableRoles]); // 注意依赖项也更新了
            // --- 【更新版】renderCell 函数 ---
            const renderCellContent = (colKey) => {
                switch (colKey) {
                    case 'status': { // 使用大括号包裹以创建独立作用域
                        const style = STATUS_STYLES[task.status]?.base || STATUS_STYLES.default.base;
                        return (
                            <div className="flex justify-center items-center">
                                <span className={`px-3 py-1 text-xs font-semibold rounded-full ${style}`}>
                                    {statusLabelMap[task.status] || task.status}
                                </span>
                            </div>
                        );
                    }
                    case 'createdAt': return <div>{formatDate(task.createdAt)}</div>;
                    case 'customTaskId': return (
                        <button
                            onClick={onOpenFlowModal}
                            className="font-mono text-sm text-blue-600 dark:text-blue-400 hover:underline w-full break-all text-center"
                            title={task.customTaskId}
                        >
                            {task.customTaskId}
                        </button>
                    );
                    case 'projectName': return <div className="text-slate-800 dark:text-slate-200 whitespace-normal break-words" title={task.projectName}>{task.projectName}</div>;
                    case 'taskType': return <div className="whitespace-normal break-words" title={task.taskType}>{task.taskType}</div>;
                    case 'region': return <div>{task.region}</div>;
                    case 'contractAmount':
                        // 如果金额不存在，则显示 N/A 且不可点击
                        if (task.contractAmount === null || task.contractAmount === undefined) {
                            return <div>N/A</div>;
                        }
                        // 如果金额存在，则渲染为一个可点击的按钮
                        return (
                            <button
                                onClick={() => onActionConfirm('openContractDetails', task)}
                                className="text-blue-600 dark:text-blue-400 hover:underline hover:text-blue-800 dark:hover:text-blue-300 transition-colors duration-200"
                                title="查看合同详情"
                            >
                                {formatAmount(task.contractAmount)}
                            </button>
                        );
                    case 'salesPerson': return <div>{userMap.get(task.salesPerson) || 'N/A'}</div>;
                    case 'projectManager': return <div>{userMap.get(task.projectManager) || 'N/A'}</div>;
                    case 'auditor_name': return <div>{userMap.get(task.auditorName) || 'N/A'}</div>;
                    case 'rechecker_name': return <div>{userMap.get(task.recheckerName) || 'N/A'}</div>;
                    case 'issuer_name': return <div>{userMap.get(task.issuerName) || 'N/A'}</div>;
                    case 'sourcing_department': return <div className="whitespace-normal break-words" title={task.sourcing_department}>{task.sourcing_department}</div>;
                    case 'execution_department': return <div className="whitespace-normal break-words" title={task.execution_department}>{task.execution_department}</div>;
                    case 'contractualDueDate': return <div>{formatDate(task.contractualDueDate)}</div>;
                    case 'actualCompletionDate': return <div>{formatDate(task.actualCompletionDate)}</div>;
                    case 'timeRemaining': return <div className={`flex flex-col items-center justify-center font-medium ${timeRemainingColorClass}`}>{timeRemaining.time ? (<><span>{timeRemaining.status}</span><span>{timeRemaining.time}</span></>) : <span>-</span>}</div>;
                    case 'progressDetails': return <div onClick={() => onActionConfirm('progress', task)} className="text-gray-500 dark:text-gray-400 cursor-pointer hover:text-emerald-600 dark:hover:text-emerald-400 flex items-center justify-center gap-2" title={latestProgress}><MessageSquare size={16} className="flex-shrink-0" /><span className="text-left line-clamp-2">{latestProgress}</span></div>;
                    case 'isArchived':
                        // 1. 如果任务已存档，直接显示“已存档”状态
                        if (task.isArchived) {
                            return <div className="flex items-center justify-center"><span className="flex items-center text-green-600 dark:text-green-400"><CheckCircle size={16} className="mr-1" /> 已存档</span></div>;
                        }

                        // 2. 如果任务未存档，并且处在“已完成”视图
                        if (currentView === 'done') {
                            // 2a. 如果用户有存档权限，显示可点击的彩色图标
                            if (availableActions.includes('archive')) {
                                return (
                                    <button
                                        onClick={() => onActionConfirm('archive', task)}
                                        className="p-2 text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 rounded-full"
                                        title="存档此任务"
                                    >
                                        <Archive size={16} />
                                    </button>
                                );
                            } else {
                                // 2b. 如果用户没有权限，显示灰色的、不可点击的图标
                                return (
                                    <div className="p-2 text-slate-300 dark:text-slate-600 cursor-not-allowed" title="无存档权限">
                                        <Archive size={16} />
                                    </div>
                                );
                            }
                        }

                        // 3. 对于所有其他情况（例如在“进行中”视图查看该字段），显示'否'
                        return '否';
                    default: return null;
                }
            };
            const renderCell = (colKey, label) => (
                <div className="task-cell" data-label={label}>
                    {renderCellContent(colKey)}
                </div>
            );

            // --- 新的、正确的 TaskRow return 语句 ---
            return (
                <div
                    title={funTooltip}
                    // --- 桌面端样式 ---
                    style={{ gridTemplateColumns }}
                    className={`task-row-card md:grid md:gap-4 md:px-4 md:py-2 md:items-center ${rowBgColor} md:border-b dark:md:border-slate-700 text-sm text-slate-700 dark:text-slate-300 md:text-center hover:bg-sky-100 dark:hover:bg-sky-900/50 transition-colors duration-200 ${borderColorClass} ${task.is_urgent ? 'task-pulse' : ''}`}
                >
                    {/* --- 移动端卡片式布局 --- */}
                    <div className="md:hidden">
                        {/* 卡片头部：包含多选框、任务编号和操作按钮 */}
                        <div className="flex justify-between items-center p-2 bg-slate-50 dark:bg-slate-800">
                            <div className="flex items-center gap-3">
                                {currentView !== 'overview' && <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600" checked={isSelected} onChange={() => onSelect(task.id)} />}
                                {renderCellContent('customTaskId')}
                            </div>
                            {currentView !== 'overview' && (
                                <button
                                    onClick={() => onActionConfirm('openActionModal', task)}
                                    className="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700"
                                    title="更多操作">
                                    <MoreHorizontal size={20} />
                                </button>
                            )}
                        </div>
                        {/* 卡片主体：显示所有可见列的数据 */}
                        <div className="p-2">
                            {visibleColumns.filter(c => c.key !== 'customTaskId').map(col => (
                                <React.Fragment key={col.key}>
                                    {renderCell(col.key, col.label)}
                                </React.Fragment>
                            ))}
                        </div>
                    </div>

                    {/* --- 桌面端表格行布局 (只在 md 及以上屏幕显示) --- */}
                    <div className="hidden md:contents">
                        {currentView !== 'overview' &&
                            <div className="flex items-center justify-center"><input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600" checked={isSelected} onChange={() => onSelect(task.id)} /></div>}
                        {visibleColumns.map(col => <div key={col.key} className="h-full w-full flex items-center justify-center">{renderCellContent(col.key)}</div>)}
                        {currentView !== 'overview' && <div className="flex items-center justify-center action-column">
                            <button
                                onClick={() => onActionConfirm('openActionModal', task)}
                                className="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 disabled:cursor-not-allowed disabled:text-gray-300 dark:disabled:text-gray-600"
                                title={availableActions.length > 0 ? "更多操作" : "无可用操作"}
                                disabled={availableActions.length === 0}
                            >
                                <MoreHorizontal size={20} />
                            </button>
                        </div>}
                    </div>
                </div>
            );
        };
        const DeletedTaskRow = ({ task, onPermanentDelete, index, onSelect, isSelected, currentUserProfile, columnDefinitions, columnWidthMap, viewColumnMap, onOpenFlowModal }) => {
            const bgColor = isSelected ? 'bg-sky-200 dark:bg-sky-800/50' : (index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50');
            const latestProgress = useMemo(() => { if (!task.progressDetails || task.progressDetails.length === 0) return '无'; return [...task.progressDetails].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0].text; }, [task.progressDetails]);

            const { visibleColumns, gridTemplateColumns } = useMemo(() => {
                const baseColumnsForView = viewColumnMap['deleted'] || [];
                const permittedColumns = new Set(currentUserProfile?.visible_columns || []);
                const finalVisibleCols = columnDefinitions.filter(colDef => baseColumnsForView.includes(colDef.key) && permittedColumns.has(colDef.key));
                const widths = [columnWidthMap.checkbox];
                finalVisibleCols.forEach(col => widths.push(columnWidthMap[col.key] || '1fr'));
                widths.push(columnWidthMap.actions);
                return { visibleColumns: finalVisibleCols, gridTemplateColumns: widths.join(' ') };
            }, [currentUserProfile, columnDefinitions, columnWidthMap]);

            const renderCell = (colKey) => {
                switch (colKey) {
                    case 'createdAt': return <div>{formatDate(task.createdAt)}</div>;
                    case 'customTaskId': return (
                        <button onClick={onOpenFlowModal} className="font-mono text-sm text-blue-600 dark:text-blue-400 hover:underline">
                            {task.customTaskId}
                        </button>
                    ); case 'projectName': return <div className="text-slate-800 dark:text-slate-200 whitespace-normal break-words" title={task.projectName}>{task.projectName}</div>;
                    case 'taskType': return <div className="whitespace-normal break-words" title={task.taskType}>{task.taskType}</div>;
                    case 'region': return <div>{task.region}</div>;
                    case 'contractAmount': return <div>{formatAmount(task.contractAmount)}</div>;
                    case 'salesPerson': return <div>{task.salesPerson || 'N/A'}</div>;
                    case 'sourcing_department': return <div className="whitespace-normal break-words" title={task.sourcing_department}>{task.sourcing_department}</div>; // <-- 新增
                    case 'projectManager': return <div>{task.projectManager}</div>;
                    case 'execution_department': return <div className="whitespace-normal break-words" title={task.execution_department}>{task.execution_department}</div>; // <-- 新增
                    case 'contractualDueDate': return <div>{formatDate(task.contractualDueDate)}</div>;
                    case 'progressDetails': return <div className="text-gray-500 dark:text-gray-400 text-left line-clamp-2" title={latestProgress}>{latestProgress}</div>;
                    default: return null;
                }
            };

            return (
                <div style={{ gridTemplateColumns }} className={`grid gap-4 px-4 py-2 items-center ${bgColor} border-b border-gray-200 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-300 text-center hover:bg-sky-100 dark:hover:bg-sky-900/50 transition-colors`}>
                    <div className="flex items-center justify-center"><input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600" checked={isSelected} onChange={() => onSelect(task.id)} /></div>
                    {visibleColumns.map(col => <div key={col.key}>{renderCell(col.key)}</div>)}
                    <div className="flex items-center justify-center action-column"><button onClick={() => onPermanentDelete(task)} className="p-2 text-red-600 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full" title="永久删除"><Trash2 size={16} /></button></div>
                </div>
            );
        };
        const BulkActionBar = ({ selectedCount, onBulkAction, currentView }) => {
            // 定义不同操作对应的视图
            const submitViews = ['reviewing', 'inprogress', 'auditing', 'rechecking', 'issuing'];
            const returnViews = ['assigning', 'inprogress', 'auditing', 'rechecking', 'issuing'];

            return (
                <div className="flex items-center gap-x-3 gap-y-2 p-1.5 bg-emerald-100/50 dark:bg-emerald-900/30 rounded-lg border border-emerald-200 dark:border-emerald-800 flex-wrap">
                    <span className="text-sm font-semibold text-emerald-800 dark:text-emerald-300 px-2">已选择 {selectedCount} 项</span>
                    <div className="h-6 w-px bg-emerald-200 dark:bg-emerald-700"></div>

                    {/* 提交类按钮 */}
                    {submitViews.includes(currentView) &&
                        <button onClick={() => onBulkAction('bulkSubmit')} className="flex items-center gap-2 text-sm text-sky-600 hover:text-sky-800 dark:text-sky-400 dark:hover:text-sky-300 font-semibold">
                            <CheckCircle size={16} />批量提交
                        </button>
                    }

                    {/* 分配/转交类按钮 */}
                    {currentView === 'assigning' &&
                        <button onClick={() => onBulkAction('bulkAssign')} className="flex items-center gap-2 text-sm text-teal-600 hover:text-teal-800 dark:text-teal-400 dark:hover:text-teal-300 font-semibold">
                            <Users size={16} />批量分配
                        </button>
                    }
                    {['inprogress', 'auditing', 'rechecking', 'issuing'].includes(currentView) &&
                        <button onClick={() => onBulkAction('bulkTransfer')} className="flex items-center gap-2 text-sm text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 font-semibold">
                            <Users size={16} />批量转交
                        </button>
                    }

                    {/* 退回按钮 */}
                    {returnViews.includes(currentView) &&
                        <button onClick={() => onBulkAction('bulkReturn')} className="flex items-center gap-2 text-sm text-amber-600 hover:text-amber-800 dark:text-amber-400 dark:hover:text-amber-300 font-semibold">
                            <RotateCcw size={16} />批量退回
                        </button>
                    }
                    {/* 通用危险操作按钮 */}
                    <div className="h-6 w-px bg-emerald-200 dark:bg-emerald-700"></div>
                    <button onClick={() => onBulkAction('bulkVoid')} className="flex items-center gap-2 text-sm text-orange-600 hover:text-orange-800 dark:text-orange-400 dark:hover:text-orange-300 font-semibold"><Ban size={16} />作废</button>
                    <button onClick={() => onBulkAction('bulkDelete')} className="flex items-center gap-2 text-sm text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold"><Trash2 size={16} />删除</button>
                    <div className="h-6 w-px bg-emerald-200 dark:bg-emerald-700"></div>
                    <button onClick={() => onBulkAction('clearSelection')} className="p-1 rounded-full hover:bg-emerald-200 dark:hover:bg-emerald-700"><X size={18} className="text-emerald-700 dark:text-emerald-300" /></button>
                </div>
            );
        };
        // --- 【更新版】TabButton ---
        const TabButton = ({ title, count, isActive, onClick, isUrgent, viewKey }) => {
            // 从全局配置中根据视图key获取对应的颜色样式
            const styles = STATUS_STYLES[viewKey] || STATUS_STYLES.default;

            // 根据是否激活，选择不同的样式
            const activeClass = isActive ? styles.active : styles.base;

            // 为激活状态下的数字角标设置更高对比度的颜色
            const countClass = isActive
                ? 'bg-white/25 text-white'
                : 'bg-slate-200 dark:bg-slate-700';

            return (
                <button
                    onClick={onClick}
                    className={`px-3 py-1.5 text-sm font-semibold rounded-full transition-all duration-200 relative flex items-center gap-2 transform active:scale-95 ${activeClass} ${isUrgent && !isActive ? 'ring-2 ring-offset-2 ring-red-500 dark:ring-offset-slate-900' : ''}`}
                >
                    <span>{title}</span>
                    {count > 0 && <span className={`px-2 py-0.5 rounded-full text-xs font-bold ${countClass}`}>{count}</span>}
                </button>
            );
        };
        // 新增：用于显示“已读”通知的组件
        const ReadNotificationsList = ({ notifications }) => {
            return (
                <ul className="space-y-2">
                    {notifications.map(item => (
                        <li key={item.id} className="p-3 flex items-start gap-4 rounded-lg bg-gray-50 dark:bg-slate-800">
                            <div className="flex-shrink-0 mt-1"><NotificationIcon type={item.type} /></div>
                            <div className="flex-grow">
                                <p className="text-sm text-gray-700 dark:text-gray-300">{item.message}</p>
                                <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">{formatDateTime(item.timestamp || item.created_at)}</p>
                            </div>
                        </li>
                    ))}
                </ul>
            );
        };

        // 新增：用于显示“已暂缓”通知的组件
        // 修改后的正确代码
        const SnoozedNotificationsList = ({ notifications, selectedIds, onToggleSelect }) => {
            return (
                <ul className="space-y-2">
                    {notifications.map(item => (
                        <li key={item.id} className="p-3 flex items-start gap-4 rounded-lg bg-gray-50 dark:bg-slate-800">
                            <div className="flex-shrink-0 flex items-center h-full">
                                <input
                                    type="checkbox"
                                    className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400"
                                    checked={selectedIds.has(item.id)}
                                    onChange={() => onToggleSelect(item.id)}
                                />
                            </div>
                            <div className="flex-shrink-0 mt-1"><NotificationIcon type={item.type} /></div>
                            <div className="flex-grow">
                                <p className="text-sm text-gray-700 dark:text-gray-300">{item.message}</p>
                                <div className="text-xs text-gray-500 dark:text-gray-400 mt-1 space-y-1">
                                    <p>通知于: {formatDateTime(item.timestamp || item.created_at)}</p>
                                    <p className="font-semibold text-amber-600 dark:text-amber-400">将在 {formatDateTime(item.snoozed_until)} 重新提醒</p>
                                </div>
                            </div>
                        </li>
                    ))}
                </ul>
            );
        };
        const getNotificationCategoryTitle = (type) => {
            const titles = {
                'urgent_task': '紧急任务',
                'backup_reminder': '系统提醒'
                // 未来可以添加更多翻译
            };
            return titles[type] || type; // 如果找不到翻译，则显示原始名称
        };
        // 【第5步】完整替换 NotificationModal 组件
        const NotificationModal = ({ isOpen, onClose, activeNotifications, unreadCount, readNotifications, snoozedNotifications, onClearAllClick, onToggleCategory, selectedIds, onToggleSelect, onToggleSelectAllInCategory, onBulkMarkAsRead, onBulkDeleteClick, onBulkSnooze, onClearSelection, handleBulkCancelSnooze }) => {
            // --- 步骤1：所有 Hooks 都必须在组件顶部声明 ---
            const [isSnoozeModalOpen, setIsSnoozeModalOpen] = useState(false);
            const [view, setView] = useState('active');
            const [expandedCategory, setExpandedCategory] = useState(null);
            const [readCurrentPage, setReadCurrentPage] = useState(1);
            const [snoozedCurrentPage, setSnoozedCurrentPage] = useState(1);
            const itemsPerPage = 5;

            // 分组逻辑 useMemo
            const groupedNotifications = useMemo(() => {
                return activeNotifications.reduce((acc, notification) => {
                    const type = notification.type || 'general';
                    if (!acc[type]) acc[type] = [];
                    acc[type].push(notification);
                    return acc;
                }, {});
            }, [activeNotifications]);

            // 其他派生状态
            const notificationTypes = Object.keys(groupedNotifications);
            const areAllSnoozedSelected = snoozedNotifications.length > 0 && snoozedNotifications.every(n => selectedIds.has(n.id));

            // “智能展开”逻辑 useEffect
            useEffect(() => {
                if (isOpen && view === 'active' && activeNotifications.length > 0) {
                    const mostRecentNotification = [...activeNotifications].sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
                    setExpandedCategory(mostRecentNotification.type);
                } else if (!isOpen) {
                    setExpandedCategory(null);
                }
            }, [isOpen, view, activeNotifications]);

            // 分页计算逻辑
            const indexOfLastReadItem = readCurrentPage * itemsPerPage;
            const indexOfFirstReadItem = indexOfLastReadItem - itemsPerPage;
            const currentReadItems = readNotifications.slice(indexOfFirstReadItem, indexOfLastReadItem);

            const indexOfLastSnoozedItem = snoozedCurrentPage * itemsPerPage;
            const indexOfFirstSnoozedItem = indexOfLastSnoozedItem - itemsPerPage;
            const currentSnoozedItems = snoozedNotifications.slice(indexOfFirstSnoozedItem, indexOfLastSnoozedItem);

            // --- 步骤2：所有 Hooks 声明完毕后，才可以进行提前退出 ---
            if (!isOpen) return null;

            // --- 步骤3：Handlers 和 JSX 渲染 ---
            const handleViewChange = (newView) => {
                setView(newView);
                onClearSelection();
                setReadCurrentPage(1);
                setSnoozedCurrentPage(1);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200">
                        <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl flex-shrink-0">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">通知中心</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button>
                        </header>
                        <div className="flex border-b border-gray-200 dark:border-slate-700 px-2 flex-shrink-0">
                            <TabButton title="当前通知" count={unreadCount} isActive={view === 'active'} onClick={() => handleViewChange('active')} />
                            <TabButton title="已读消息" count={readNotifications.length} isActive={view === 'read'} onClick={() => handleViewChange('read')} />
                            <TabButton title="已暂缓" count={snoozedNotifications.length} isActive={view === 'snoozed'} onClick={() => handleViewChange('snoozed')} />
                        </div>
                        <div className="p-4 flex-grow overflow-y-auto space-y-4 min-h-0">
                            {view === 'active' && (activeNotifications.length > 0 ? (notificationTypes.map(type => {
                                const categoryNotifications = groupedNotifications[type];
                                const isExpanded = expandedCategory === type;
                                return (
                                    <div key={type} className="border dark:border-slate-700 rounded-lg overflow-hidden">
                                        <button onClick={() => setExpandedCategory(isExpanded ? null : type)} className="w-full flex justify-between items-center p-3 bg-gray-50 dark:bg-slate-800 hover:bg-gray-100 dark:hover:bg-slate-700 transition">
                                            <h3 className="font-semibold text-gray-700 dark:text-gray-300">{getNotificationCategoryTitle(type)} (共 {categoryNotifications.length} 条)</h3>
                                            <ChevronDown size={20} className={`transition-transform ${isExpanded ? 'rotate-180' : ''}`} />
                                        </button>
                                        {isExpanded && (
                                            <div className="p-3">
                                                <PaginatedNotificationList notifications={categoryNotifications} selectedIds={selectedIds} onToggleSelect={onToggleSelect} onToggleSelectAll={() => onToggleSelectAllInCategory(categoryNotifications)} />
                                            </div>
                                        )}
                                    </div>
                                );
                            })) : (<div className="text-center text-gray-500 dark:text-gray-400 py-16"> <Bell size={48} className="mx-auto text-gray-300 dark:text-gray-600" /> <p className="mt-4">当前没有通知。</p> </div>))}
                            {view === 'read' && (readNotifications.length > 0 ? (<div className="space-y-4"> <ReadNotificationsList notifications={currentReadItems} /> {readNotifications.length > itemsPerPage && (<Pagination currentPage={readCurrentPage} totalUsers={readNotifications.length} usersPerPage={itemsPerPage} paginate={setReadCurrentPage} />)} </div>) : (<div className="text-center text-gray-500 dark:text-gray-400 py-16"> <CheckCircle size={48} className="mx-auto text-gray-300 dark:text-gray-600" /> <p className="mt-4">已读消息为空。</p> </div>))}
                            {view === 'snoozed' && (snoozedNotifications.length > 0 ? (<div className="space-y-4"> <div className="p-2 border-b dark:border-slate-700"> <label className="flex items-center space-x-2 text-sm text-gray-600 dark:text-gray-300"> <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded bg-gray-200 dark:bg-slate-500 dark:border-slate-400" checked={areAllSnoozedSelected} onChange={() => onToggleSelectAllInCategory(snoozedNotifications)} /> <span>{areAllSnoozedSelected ? '取消全选' : '全选'}</span> </label> </div> <SnoozedNotificationsList notifications={currentSnoozedItems} selectedIds={selectedIds} onToggleSelect={onToggleSelect} /> {snoozedNotifications.length > itemsPerPage && (<Pagination currentPage={snoozedCurrentPage} totalUsers={snoozedNotifications.length} usersPerPage={itemsPerPage} paginate={setSnoozedCurrentPage} />)} </div>) : (<div className="text-center text-gray-500 dark:text-gray-400 py-16"> <ClockIcon size={48} className="mx-auto text-gray-300 dark:text-gray-600" /> <p className="mt-4">没有已暂缓的通知。</p> </div>))}
                        </div>
                        <footer className="p-3 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700 flex-shrink-0">
                            {selectedIds.size > 0 ? (
                                <div className="flex justify-between items-center animate-fade-in">
                                    <span className="text-sm font-semibold text-slate-700 dark:text-slate-300">{selectedIds.size} 项已选择</span>
                                    {view === 'active' && (
                                        <div className="flex items-center gap-2">
                                            <button onClick={onBulkMarkAsRead} className="px-3 py-1 text-sm font-semibold text-white bg-emerald-500 rounded-md hover:bg-emerald-600">标记已读</button>
                                            <button onClick={() => setIsSnoozeModalOpen(true)} className="px-3 py-1 text-sm font-semibold text-white bg-amber-500 rounded-md hover:bg-amber-600">稍后提醒</button>
                                            <button onClick={onBulkDeleteClick} className="px-3 py-1 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600">删除</button>
                                        </div>
                                    )}
                                    {view === 'snoozed' && (
                                        <div className="flex items-center gap-2">
                                            <button onClick={handleBulkCancelSnooze} className="px-3 py-1 text-sm font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600">取消暂缓</button>
                                            <button onClick={onBulkDeleteClick} className="px-3 py-1 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600">删除</button>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex justify-between items-center h-[34px]">
                                    {(view === 'read' && readNotifications.length > 0) && (<button onClick={() => onClearAllClick(view)} className="text-sm font-semibold text-red-500 hover:text-red-700">清除所有已读</button>)}
                                    {(view === 'snoozed' && snoozedNotifications.length > 0) && (<button onClick={() => onClearAllClick(view)} className="text-sm font-semibold text-red-500 hover:text-red-700">取消所有暂缓</button>)}
                                    <div className="ml-auto"></div>
                                </div>
                            )}
                        </footer>
                        {isSnoozeModalOpen && (<SnoozeModal onClose={() => setIsSnoozeModalOpen(false)} onSnoozeSelect={(snoozeUntil) => { onBulkSnooze(snoozeUntil); setIsSnoozeModalOpen(false); }} />)}
                    </div>
                </div>
            );
        };
        const ImportModal = ({ isOpen, onClose, onDownloadTemplate, onImportClick }) => { if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4"> <div className="bg-white text-gray-800 dark:bg-slate-900 dark:text-gray-200 rounded-xl shadow-2xl w-full max-w-md"> <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl"><h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">导入任务</h2><button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button></header> <div className="p-6 space-y-4"> <p className="text-gray-600 dark:text-gray-300">请先下载模板文件，按照格式填写任务信息后，再上传文件进行批量导入。</p> <button onClick={onDownloadTemplate} className="w-full px-6 py-3 rounded-md text-white bg-blue-600 hover:bg-blue-700 font-semibold flex items-center justify-center gap-2"><Download size={16} />下载模板</button> <button onClick={onImportClick} className="w-full px-6 py-3 rounded-md text-white bg-teal-600 hover:bg-teal-700 font-semibold flex items-center justify-center gap-2"><Upload size={16} />上传文件</button> </div> </div> </div>); };
        const BackupManagementModal = ({ isOpen, onClose, onBackup, history, onClearHistory, userMap }) => {
            if (!isOpen) return null; return (<div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4"> <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200"> <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 dark:border-slate-700 dark:bg-slate-800 rounded-t-xl"> <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">备份管理</h2> <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button> </header> <div className="p-6 overflow-y-auto space-y-6"> <div> <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">我要备份</h3> <div className="p-4 bg-gray-50 dark:bg-slate-800 rounded-lg border dark:border-slate-700"> <p className="text-sm text-gray-600 dark:text-gray-400 mb-4"> 点击下方按钮，将系统中所有任务（包括回收站）及其完整的历史与进展记录，备份到一个Excel文件中。 此操作将被视为一次正式备份，并重置备份提醒计时。 </p> <button onClick={onBackup} className="w-full px-6 py-3 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold flex items-center justify-center gap-2"> <Database size={16} /> 立即执行全量备份 </button> </div> </div> <div> <h3 className="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">备份记录</h3> <div className="p-4 bg-gray-50 dark:bg-slate-800 rounded-lg border dark:border-slate-700"> {history.length > 0 ? (<div className="space-y-3 max-h-48 overflow-y-auto pr-2">
                {history.map((item, index) => (
                    <div key={index} className="p-3 text-sm rounded-md bg-white dark:bg-slate-700 flex justify-between items-center">
                        <div>
                            <p className="font-medium text-gray-800 dark:text-gray-200">
                                <span className="font-bold text-blue-500">{userMap.get(item.user_id) || '未知用户'}</span>
                                <span className="mx-1 text-gray-400">|</span>
                                备份了 <span className="text-emerald-500">{item.record_count}</span> 条记录
                            </p>
                            <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">{formatDateTime(item.backup_timestamp)}</p>
                        </div>
                        <CheckCircle size={16} className="text-green-500" />
                    </div>
                ))} </div>) : (<p className="text-center text-sm text-gray-500 dark:text-gray-400 py-4">暂无正式的备份记录。</p>)} </div> </div> </div> <footer className="p-4 flex justify-between items-center gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700"> <button onClick={onClearHistory} disabled={history.length === 0} className="px-4 py-2 rounded-md text-white bg-red-600 hover:bg-red-700 disabled:bg-red-400 disabled:cursor-not-allowed font-semibold flex items-center gap-2"> <Trash2 size={16} /> 清空历史 </button> <button onClick={onClose} className="px-6 py-2 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold ml-auto">关闭</button> </footer> </div> </div>);
        };
        const Clock = ({ onClick }) => { const [time, setTime] = useState(new Date()); useEffect(() => { const timerId = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timerId); }, []); const formatTime = (date) => { const year = date.getFullYear(); const month = (date.getMonth() + 1).toString().padStart(2, '0'); const day = date.getDate().toString().padStart(2, '0'); const week = ['日', '一', '二', '三', '四', '五', '六'][date.getDay()]; const hours = date.getHours().toString().padStart(2, '0'); const minutes = date.getMinutes().toString().padStart(2, '0'); const seconds = date.getSeconds().toString().padStart(2, '0'); return `${year}-${month}-${day} 星期${week} ${hours}:${minutes}:${seconds}`; }; return (<div onClick={onClick} className="flex items-center gap-2 cursor-pointer p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="每日一语"> <Calendar size={20} /> <span className="text-sm font-mono whitespace-nowrap hidden md:inline">{formatTime(time)}</span> </div>); };
        // ================== 【全新】滚动名言组件 ==================
        const ScrollingQuote = ({ isOpen, onClose, quote }) => {
            if (!isOpen) return null;
            const handleAnimationEnd = () => { onClose(); };
            return (
                <div className="scrolling-quote-banner" onClick={onClose} onAnimationEnd={handleAnimationEnd}>
                    <p>
                        {quote.text}
                        <span className="source-text ml-8">- {quote.source}</span>
                    </p>
                </div>
            );
        };
        // ================== 【全新】庆祝动画组件 ==================
        const ConfettiAnimation = () => {
            const confettiCount = 150;
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4caf50', '#8bc34a', '#cddc39', '#ffeb3b', '#ffc107', '#ff9800'];

            return (
                <div className="confetti-container">
                    {Array.from({ length: confettiCount }).map((_, index) => {
                        const style = {
                            left: `${Math.random() * 100}vw`,
                            backgroundColor: colors[Math.floor(Math.random() * colors.length)],
                            animationDelay: `${Math.random() * 4}s`,
                            transform: `rotate(${Math.random() * 360}deg)`
                        };
                        return <div key={index} className="confetti" style={style}></div>;
                    })}
                </div>
            );
        };
        // --- 【全新】具备收缩功能的翻页组件 ---
        const Pagination = ({ usersPerPage, totalUsers, paginate, currentPage }) => {
            const totalPages = Math.ceil(totalUsers / usersPerPage);

            if (totalPages <= 1) return null;

            let pages = [];
            // --- 智能生成页码的核心逻辑 ---
            if (totalPages <= 7) {
                // 如果总页数不多（小于等于7页），则全部显示
                pages = Array.from({ length: totalPages }, (_, i) => i + 1);
            } else {
                // 如果总页数很多，则进行收缩
                if (currentPage <= 4) {
                    // 当处于前面几页时，显示前5页 + ... + 最后一页
                    pages = [1, 2, 3, 4, 5, '...', totalPages];
                } else if (currentPage >= totalPages - 3) {
                    // 当处于后面几页时，显示第一页 + ... + 后5页
                    pages = [1, '...', totalPages - 4, totalPages - 3, totalPages - 2, totalPages - 1, totalPages];
                } else {
                    // 当处于中间页时，显示第一页 + ... + 当前页前后各一页 + ... + 最后一页
                    pages = [1, '...', currentPage - 1, currentPage, currentPage + 1, '...', totalPages];
                }
            }

            const buttonBaseClasses = "px-4 py-2 text-sm font-semibold rounded-md transition-colors";
            const activeButtonClasses = "bg-emerald-500 text-white";
            const inactiveButtonClasses = "bg-gray-200 hover:bg-gray-300 dark:bg-slate-700 dark:hover:bg-slate-600";
            const disabledButtonClasses = "bg-gray-100 dark:bg-slate-800 text-gray-400 dark:text-slate-500 cursor-not-allowed";

            return (
                <nav className="flex justify-center items-center gap-2">
                    {/* 上一页按钮 */}
                    <button
                        onClick={() => paginate(currentPage - 1)}
                        disabled={currentPage === 1}
                        className={`${buttonBaseClasses} ${currentPage === 1 ? disabledButtonClasses : inactiveButtonClasses}`}
                        aria-label="上一页"
                    >
                        «
                    </button>

                    {/* 页码按钮 */}
                    {pages.map((page, index) =>
                        typeof page === 'number' ? (
                            <button
                                key={index}
                                onClick={() => paginate(page)}
                                className={`${buttonBaseClasses} ${currentPage === page ? activeButtonClasses : inactiveButtonClasses}`}
                            >
                                {page}
                            </button>
                        ) : (
                            <span key={index} className="px-4 py-2 text-sm text-gray-500 dark:text-gray-400">
                                {page}
                            </span>
                        )
                    )}

                    {/* 下一页按钮 */}
                    <button
                        onClick={() => paginate(currentPage + 1)}
                        disabled={currentPage === totalPages}
                        className={`${buttonBaseClasses} ${currentPage === totalPages ? disabledButtonClasses : inactiveButtonClasses}`}
                        aria-label="下一页"
                    >
                        »
                    </button>
                </nav>
            );
        };
        // 【新增的全新组件】
        // 这个弹窗专门负责处理用户的“特权”设置
        // --- 这是修复了所有 BUG 的最终版 PermissionOverrideModal 组件 ---
        const PermissionOverrideModal = ({
            isOpen,
            onClose,
            onSave,
            type, // 'functional', 'process', or 'visibility'
            user, // 包含 id 的对象
            userMap,
            currentUserPermsDetail,
            // --- 全局配置 ---
            rolePermissions,
            actionPermissions,
            availableRoles,
            ACTION_DEFINITIONS,
            viewConfig,
            columnDefinitions,
            viewKeyMap,
            columnKeyMap,
            viewColumnMap
        }) => {
            const [overrides, setOverrides] = useState({});

            const inheritedPermissions = useMemo(() => {
                const userRoleKeys = (currentUserPermsDetail.roles || []).map(p => p.role);
                const inherited = {
                    functional: {},
                    process: {},
                    visibility: { views: {}, columns: {} }
                };
                const functionalPermsList = [
                    { key: 'can_create_task' }, { key: 'can_import_data' }, { key: 'can_export_data' },
                    { key: 'can_view_statistics' }, { key: 'can_manage_config' }, { key: 'can_manage_teams' }
                ];
                functionalPermsList.forEach(perm => {
                    inherited.functional[perm.key] = userRoleKeys.some(roleKey => {
                        const rolePerm = rolePermissions.find(p => p.role_key === roleKey);
                        return rolePerm && rolePerm[perm.key];
                    });
                });
                viewConfig.filter(v => v.key && v.key !== 'overview').forEach(view => {
                    ACTION_DEFINITIONS.forEach(action => {
                        const permKey = `${view.key}|${action.key}`;
                        inherited.process[permKey] = actionPermissions.some(p =>
                            p.is_enabled &&
                            userRoleKeys.includes(p.role_key) &&
                            p.view_key === view.key &&
                            p.action_key === action.key
                        );
                    });
                });
                viewConfig.filter(v => v.key).forEach(view => {
                    inherited.visibility.views[view.key] = userRoleKeys.some(roleKey => {
                        const roleData = availableRoles.find(r => r.key === roleKey);
                        return (roleData?.default_views || []).includes(view.key);
                    });
                });
                columnDefinitions.forEach(col => {
                    inherited.visibility.columns[col.key] = userRoleKeys.some(roleKey => {
                        const roleData = availableRoles.find(r => r.key === roleKey);
                        const colsObject = roleData?.default_columns || {};
                        // 检查该列是否存在于对象内任何一个视图的数组中
                        return Object.values(colsObject).some(colsArray => (colsArray || []).includes(col.key));
                    });
                });
                return inherited;
            }, [currentUserPermsDetail.roles, rolePermissions, actionPermissions, availableRoles]);

            useEffect(() => {
                if (isOpen) {
                    setOverrides(currentUserPermsDetail.overrides || {});
                }
            }, [isOpen, currentUserPermsDetail]);

            const getOverrideValue = (key, permType, subType = null) => {
                let overrideCategory;
                if (permType === 'functional') overrideCategory = 'functional_perms';
                else if (permType === 'process') overrideCategory = 'process_perms';
                else if (permType === 'visibility') overrideCategory = 'visibility_perms';

                if (permType === 'visibility' && subType) {
                    const grantList = overrides[overrideCategory]?.[subType]?.grant || [];
                    const denyList = overrides[overrideCategory]?.[subType]?.deny || [];
                    if (grantList.includes(key)) return 'grant';
                    if (denyList.includes(key)) return 'deny';
                } else if (permType !== 'visibility') {
                    const keyString = JSON.stringify(key);
                    if (overrides[overrideCategory]?.grant?.some(p => JSON.stringify(p) === keyString)) return 'grant';
                    if (overrides[overrideCategory]?.deny?.some(p => JSON.stringify(p) === keyString)) return 'deny';
                }
                return 'default';
            };

            const handlePermissionToggle = (key, permType, context, newChoice, subType = null) => {
                // *** BUG FIX 1: 使用正确的参数名 'newChoice' ***
                console.log("--- 用户点击切换权限 ---");
                console.log(`操作对象: ${key}, 类型: ${subType}, 选择: ${newChoice}`);

                const newOverrides = JSON.parse(JSON.stringify(overrides));
                let overrideCategory, isInheritedAllowed, keyForOverride = key;

                if (permType === 'functional') {
                    overrideCategory = 'functional_perms';
                    isInheritedAllowed = inheritedPermissions.functional[key];
                } else if (permType === 'process') {
                    overrideCategory = 'process_perms';
                    keyForOverride = context;
                    isInheritedAllowed = inheritedPermissions.process[`${context.view_key}|${context.action_key}`];
                } else if (permType === 'visibility' && subType) {
                    overrideCategory = 'visibility_perms';
                    isInheritedAllowed = inheritedPermissions.visibility[subType][key];
                    if (!newOverrides[overrideCategory]) newOverrides[overrideCategory] = {};
                    if (!newOverrides[overrideCategory][subType]) newOverrides[overrideCategory][subType] = { grant: [], deny: [] };
                    newOverrides[overrideCategory][subType].grant = (newOverrides[overrideCategory][subType].grant || []).filter(k => k !== key);
                    newOverrides[overrideCategory][subType].deny = (newOverrides[overrideCategory][subType].deny || []).filter(k => k !== key);
                    if (newChoice === 'allow' && !isInheritedAllowed) {
                        newOverrides[overrideCategory][subType].grant.push(key);
                    } else if (newChoice === 'deny' && isInheritedAllowed) {
                        newOverrides[overrideCategory][subType].deny.push(key);
                    }
                } else { return; }

                if (permType !== 'visibility') {
                    if (!newOverrides[overrideCategory]) newOverrides[overrideCategory] = { grant: [], deny: [] };
                    newOverrides[overrideCategory].grant = (newOverrides[overrideCategory].grant || []).filter(p => JSON.stringify(p) !== JSON.stringify(keyForOverride));
                    newOverrides[overrideCategory].deny = (newOverrides[overrideCategory].deny || []).filter(p => JSON.stringify(p) !== JSON.stringify(keyForOverride));
                    if (newChoice === 'allow' && !isInheritedAllowed) {
                        newOverrides[overrideCategory].grant.push(keyForOverride);
                    } else if (newChoice === 'deny' && isInheritedAllowed) {
                        newOverrides[overrideCategory].deny.push(keyForOverride);
                    }
                }
                setOverrides(newOverrides);
            };

            if (!isOpen) return null;

            const titles = { functional: "应用功能", process: "任务操作 (流程权限)", visibility: "任务可见 (视图与列)" };
            const functionalPermsList = [
                { key: 'can_create_task', label: '创建任务' }, { key: 'can_import_data', label: '导入数据' },
                { key: 'can_export_data', label: '导出数据' }, { key: 'can_view_statistics', label: '查看统计' },
                { key: 'can_manage_config', label: '管理配置' }, { key: 'can_manage_teams', label: '团队管理' },
            ];

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-[60] flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-4xl max-h-[80vh] flex flex-col">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">权限调整</h2>
                            <p className="text-sm text-gray-500">正在为 <span className="font-semibold text-emerald-500">{userMap.get(user.id)}</span> 调整 <span className="font-semibold text-emerald-500">{titles[type]}</span></p>
                        </header>
                        <div className="p-6 flex-grow overflow-y-auto space-y-4">
                            {type === 'functional' && functionalPermsList.map(perm => {
                                const isInheritedAllowed = inheritedPermissions.functional[perm.key];
                                const overrideStatus = getOverrideValue(perm.key, 'functional');
                                const isEffectivelyAllowed = overrideStatus === 'grant' || (overrideStatus === 'default' && isInheritedAllowed);
                                return (
                                    <div key={perm.key} className="p-3 border dark:border-slate-700 rounded-lg">
                                        <p className="font-semibold">{perm.label}</p>
                                        <div className="flex items-center space-x-4 mt-2 text-sm">
                                            <label className="flex items-center space-x-1 cursor-pointer">
                                                <input type="radio" name={perm.key} checked={isEffectivelyAllowed} onChange={() => handlePermissionToggle(perm.key, 'functional', null, 'allow')} />
                                                <span className={isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>允许 {isInheritedAllowed ? '(默认)' : ''}</span>
                                            </label>
                                            <label className="flex items-center space-x-1 cursor-pointer">
                                                <input type="radio" name={perm.key} checked={!isEffectivelyAllowed} onChange={() => handlePermissionToggle(perm.key, 'functional', null, 'deny')} />
                                                <span className={!isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>禁止 {!isInheritedAllowed ? '(默认)' : ''}</span>
                                            </label>
                                        </div>
                                    </div>
                                );
                            })}
                            {type === 'process' && (
                                <div className="space-y-2">
                                    {viewConfig.filter(v => v.key && v.key !== 'overview').map(view => (
                                        <div key={view.key} className="p-3 border dark:border-slate-700 rounded-lg">
                                            <p className="font-bold text-emerald-600 dark:text-emerald-400">{view.label}</p>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-2">
                                                {ACTION_DEFINITIONS.map(action => {
                                                    return (
                                                        <div key={action.key} className="p-2 bg-slate-50 dark:bg-slate-800 rounded">
                                                            <p className="font-semibold text-sm">{action.label}</p>
                                                            <div className="flex items-center space-x-3 mt-1 text-xs">
                                                                {(() => {
                                                                    const permContext = { view_key: view.key, action_key: action.key };
                                                                    const isInheritedAllowed = inheritedPermissions.process[`${view.key}|${action.key}`];
                                                                    const overrideStatus = getOverrideValue(permContext, 'process');
                                                                    const isEffectivelyAllowed = overrideStatus === 'grant' || (overrideStatus === 'default' && isInheritedAllowed);
                                                                    return (<>
                                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                                            <input type="radio" name={`${view.key}-${action.key}`} checked={isEffectivelyAllowed} onChange={() => handlePermissionToggle(null, 'process', permContext, 'allow')} />
                                                                            <span className={isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>允许 {isInheritedAllowed ? '(默认)' : ''}</span>
                                                                        </label>
                                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                                            <input type="radio" name={`${view.key}-${action.key}`} checked={!isEffectivelyAllowed} onChange={() => handlePermissionToggle(null, 'process', permContext, 'deny')} />
                                                                            <span className={!isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>禁止 {!isInheritedAllowed ? '(默认)' : ''}</span>
                                                                        </label>
                                                                    </>);
                                                                })()}
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {type === 'visibility' && (
                                <div className="space-y-4">
                                    <div className="space-y-2">
                                        <h5 className="font-semibold">可见视图</h5>
                                        {viewConfig.map(view => {
                                            const permKey = view.key;
                                            const isInheritedAllowed = inheritedPermissions.visibility.views[permKey];
                                            const overrideStatus = getOverrideValue(permKey, 'visibility', 'views');
                                            const isEffectivelyAllowed = overrideStatus === 'grant' || (overrideStatus === 'default' && isInheritedAllowed);
                                            return (
                                                <div key={permKey} className="flex items-center justify-between p-2 bg-slate-50 dark:bg-slate-800 rounded">
                                                    <p className="font-semibold text-sm">{view.label}</p>
                                                    <div className="flex items-center space-x-3 text-xs">
                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                            <input type="radio" name={permKey} checked={isEffectivelyAllowed} onChange={() => handlePermissionToggle(permKey, 'visibility', null, 'allow', 'views')} />
                                                            <span className={isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>允许 {isInheritedAllowed ? '(默认)' : ''}</span>
                                                        </label>
                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                            <input type="radio" name={permKey} checked={!isEffectivelyAllowed} onChange={() => handlePermissionToggle(permKey, 'visibility', null, 'deny', 'views')} />
                                                            <span className={!isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>禁止 {!isInheritedAllowed ? '(默认)' : ''}</span>
                                                        </label>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    <div className="space-y-2">
                                        <h5 className="font-semibold">可见列</h5>
                                        <div className="p-3 border dark:border-slate-700 rounded-lg space-y-3 bg-slate-50/50 dark:bg-slate-800/20">
                                            {viewConfig.map(view => {
                                                const availableColsInView = (viewColumnMap[view.key] || [])
                                                    .map(colKey => columnDefinitions.find(c => c.key === colKey))
                                                    .filter(Boolean);
                                                if (availableColsInView.length === 0) return null;
                                                return (
                                                    <div key={view.key} className="pt-2 border-t first:pt-0 first:border-t-0 dark:border-slate-600">
                                                        <h6 className="font-semibold text-xs text-emerald-700 dark:text-emerald-400 mb-1 underline">
                                                            {view.label} 视图下的列:
                                                        </h6>
                                                        {availableColsInView.map(col => {
                                                            const permKey = col.key;
                                                            // *** BUG FIX 2: 使用独特的 name 属性 ***
                                                            const radioName = `${view.key}-${permKey}`;
                                                            const isInheritedAllowed = inheritedPermissions.visibility.columns[permKey];
                                                            const overrideStatus = getOverrideValue(permKey, 'visibility', 'columns');
                                                            const isEffectivelyAllowed = overrideStatus === 'grant' || (overrideStatus === 'default' && isInheritedAllowed);
                                                            return (
                                                                <div key={permKey} className="flex items-center justify-between p-1.5 pl-2">
                                                                    <p className="text-sm">{col.label}</p>
                                                                    <div className="flex items-center space-x-3 text-xs">
                                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                                            <input type="radio" name={radioName} checked={isEffectivelyAllowed} onChange={() => handlePermissionToggle(permKey, 'visibility', null, 'allow', 'columns')} />
                                                                            <span className={isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>允许 {isInheritedAllowed ? '(默认)' : ''}</span>
                                                                        </label>
                                                                        <label className="flex items-center space-x-1 cursor-pointer">
                                                                            <input type="radio" name={radioName} checked={!isEffectivelyAllowed} onChange={() => handlePermissionToggle(permKey, 'visibility', null, 'deny', 'columns')} />
                                                                            <span className={!isInheritedAllowed ? 'font-bold text-emerald-600 dark:text-emerald-400' : ''}>禁止 {!isInheritedAllowed ? '(默认)' : ''}</span>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                            <button type="button" onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button>
                            <button type="button" onClick={() => onSave(overrides)} className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">保存特权设置</button>
                        </footer>
                    </div>
                </div>
            );
        };
        const TeamManagementModal = ({ isOpen, onClose, onProfilesChange, showNotification, setConfirmationState, confirmationState, closeConfirmationModal, handleConfirm, profiles, viewConfig, availableRoles, columnDefinitions, setProfiles, viewColumnMap, userMap, managementData, rolePermissions, actionPermissions, ACTION_DEFINITIONS, onSaveManagementData }) => {
            const [users, setUsers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [inviteEmail, setInviteEmail] = useState('');
            const [selectedUsers, setSelectedUsers] = useState(new Set());
            const [currentPage, setCurrentPage] = useState(1);
            const [usersPerPage] = useState(5); // 每页显示5个用户，您可以根据需要调整
            const [activeView, setActiveView] = useState('member_management');
            const [permissionSearchTerm, setPermissionSearchTerm] = useState('');
            const [permissionTargetUsers, setPermissionTargetUsers] = useState(new Set());
            const [permissionFormData, setPermissionFormData] = useState(null);
            const [previewView, setPreviewView] = useState('overview'); // 默认预览“总览”视图

            // ================== 新代码粘贴结束 ==================

            const [isRoleEditorOpen, setIsRoleEditorOpen] = useState(false);
            const [editingRole, setEditingRole] = useState(null);
            const [roleSearchTerm, setRoleSearchTerm] = useState('');
            const [roleEditorError, setRoleEditorError] = useState(null);
            const [editingRoleKey, setEditingRoleKey] = useState(''); // 新增: 当前正在编辑权限的角色key
            const [editMode, setEditMode] = useState('single'); // 新增: 'single' 或 'bulk'
            const [singleSelectedViewKey, setSingleSelectedViewKey] = useState(''); // 新增: 单点模式下选中的视图
            const [editingFuncPermsForRole, setEditingFuncPermsForRole] = useState(''); // 新增: 功能权限模块中，正在编辑的角色
            const [currentFuncPerms, setCurrentFuncPerms] = useState({ // 新增: 当前角色的功能权限状态
                can_create_task: false,
                can_import_data: false,       // 分离出“导入”
                can_export_data: false,       // 分离出“导出”
                can_view_statistics: false,
                can_manage_config: false,     // 新增“管理配置”
                can_manage_teams: false,      // 新增“团队管理”
            });
            // 新增: “任务权限”模块中，正在编辑的角色
            const [editingVisPermsForRole, setEditingVisPermsForRole] = useState('');
            // 新增: 当前角色的可见性权限表单状态
            const [currentVisPerms, setCurrentVisPerms] = useState({
                default_views: [],
                default_columns: [],
            });
            // 新增: “权限配置”模块中，正在编辑的用户ID
            const [editingUserId, setEditingUserId] = useState('');
            // 新增: 所选用户的详细权限数据（角色+特权）
            const [currentUserPermsDetail, setCurrentUserPermsDetail] = useState({ roles: [], overrides: {} });
            // 新增: “权限调整”弹窗的状态
            const [isOverrideModalOpen, setIsOverrideModalOpen] = useState(false);
            // 新增: 正在调整的权限类型 (functional, process, visibility)
            const [overrideType, setOverrideType] = useState('');
            const [editingView, setEditingView] = useState(null);

            // 当选择的角色变化时，重置所有状态
            useEffect(() => {
                const roleData = availableRoles.find(r => r.key === editingVisPermsForRole);
                if (roleData) {
                    // 从数据库加载已保存的配置
                    setCurrentVisPerms({
                        default_views: roleData.default_views || [],
                        default_columns: roleData.default_columns || {}, // 现在这是一个对象
                    });
                } else {
                    setCurrentVisPerms({ default_views: [], default_columns: {} });
                }
                setEditingView(null);
            }, [editingVisPermsForRole, availableRoles]);

            // 【新增代码】
            // 为“任务权限”模块提供视图和列的名称与Key的映射关系
            // 这些 useMemo 钩子确保了映射关系只在必要时才重新计算，以优化性能
            const viewLabelMap = useMemo(() => Object.fromEntries((viewConfig || []).filter(v => v.key).map(v => [v.label, v.key])), [viewConfig]);
            const viewKeyMap = useMemo(() => Object.fromEntries((viewConfig || []).filter(v => v.key).map(v => [v.key, v.label])), [viewConfig]);
            const columnLabelMap = useMemo(() => Object.fromEntries((columnDefinitions || []).map(c => [c.label, c.key])), [columnDefinitions]);
            const columnKeyMap = useMemo(() => Object.fromEntries((columnDefinitions || []).map(c => [c.key, c.label])), [columnDefinitions]);
            // 【新增代码】
            // --- 【最终整合版】 effectivePermissionsDetails useMemo 钩子 ---
            const effectivePermissionsDetails = useMemo(() => {
                const details = {
                    functional: new Set(),
                    process: new Set(),
                    visibility: { views: new Set(), columns: new Set() }
                };

                const roles = currentUserPermsDetail?.roles;
                const overrides = currentUserPermsDetail?.overrides;

                if (!editingUserId) {
                    return details;
                }

                const userRoleKeys = (roles || []).map(p => p.role);

                const functionalPermsMap = {
                    can_create_task: '创建任务',
                    can_import_data: '导入数据',
                    can_export_data: '导出数据',
                    can_view_statistics: '查看统计',
                    can_manage_config: '管理配置',
                    can_manage_teams: '团队管理'
                };

                // --- 第 1 步: 根据角色计算基础权限 ---
                userRoleKeys.forEach(roleKey => {
                    // 计算功能权限
                    const rolePerm = rolePermissions.find(p => p.role_key === roleKey);
                    if (rolePerm) {
                        Object.keys(functionalPermsMap).forEach(permKey => {
                            if (rolePerm[permKey] === true) {
                                details.functional.add(functionalPermsMap[permKey]);
                            }
                        });
                    }

                    // 计算可见性权限
                    const roleData = availableRoles.find(r => r.key === roleKey);
                    if (roleData) {
                        (roleData.default_views || []).forEach(viewKey => {
                            if (viewKeyMap[viewKey]) details.visibility.views.add(viewKeyMap[viewKey]);
                        });
                        // 正确处理 JSONB 格式的列数据
                        const colsObject = roleData.default_columns || {};
                        Object.values(colsObject).forEach(colsArray => {
                            (colsArray || []).forEach(colKey => {
                                if (columnKeyMap[colKey]) details.visibility.columns.add(columnKeyMap[colKey]);
                            });
                        });
                    }
                });

                // 计算流程权限 (独立于上面的循环)
                actionPermissions.forEach(perm => {
                    if (perm.is_enabled && userRoleKeys.includes(perm.role_key)) {
                        const actionLabel = ACTION_DEFINITIONS.find(a => a.key === perm.action_key)?.label;
                        if (actionLabel) details.process.add(actionLabel);
                    }
                });

                // --- 第 2 步: 应用特权/覆盖规则 ---
                if (overrides) {
                    const functionalOverrides = overrides.functional_perms || {};
                    (functionalOverrides.grant || []).forEach(permKey => {
                        if (functionalPermsMap[permKey]) details.functional.add(functionalPermsMap[permKey]);
                    });
                    (functionalOverrides.deny || []).forEach(permKey => {
                        if (functionalPermsMap[permKey]) details.functional.delete(functionalPermsMap[permKey]);
                    });

                    const processOverrides = overrides.process_perms || {};
                    (processOverrides.grant || []).forEach(perm => {
                        const actionLabel = ACTION_DEFINITIONS.find(a => a.key === perm.action_key)?.label;
                        if (actionLabel) details.process.add(actionLabel);
                    });
                    (processOverrides.deny || []).forEach(perm => {
                        const actionLabel = ACTION_DEFINITIONS.find(a => a.key === perm.action_key)?.label;
                        if (actionLabel) details.process.delete(actionLabel);
                    });

                    const visibilityOverrides = overrides.visibility_perms || {};
                    const grantViewCols = { views: visibilityOverrides.views?.grant || [], columns: visibilityOverrides.columns?.grant || [] };
                    const denyViewCols = { views: visibilityOverrides.views?.deny || [], columns: visibilityOverrides.columns?.deny || [] };

                    grantViewCols.views.forEach(key => { if (viewKeyMap[key]) details.visibility.views.add(viewKeyMap[key]); });
                    grantViewCols.columns.forEach(key => { if (columnKeyMap[key]) details.visibility.columns.add(columnKeyMap[key]); });
                    denyViewCols.views.forEach(key => { if (viewKeyMap[key]) details.visibility.views.delete(viewKeyMap[key]); });
                    denyViewCols.columns.forEach(key => { if (columnKeyMap[key]) details.visibility.columns.delete(columnKeyMap[key]); });
                }

                return details;
            }, [editingUserId, currentUserPermsDetail, rolePermissions, actionPermissions, availableRoles, ACTION_DEFINITIONS, viewKeyMap, columnKeyMap]);
            // --- 【最终修正版】permissionsScopeForCurrentUser useMemo 钩子 ---
            const permissionsScopeForCurrentUser = useMemo(() => {
                const scope = { views: new Set(), columns: new Set() };
                if (!editingUserId || !currentUserPermsDetail.roles) {
                    return { views: [], columns: [] };
                }
                const userRoleKeys = currentUserPermsDetail.roles.map(p => p.role);

                // 第 1 步: 根据用户角色，计算出他能看到的所有视图的集合
                userRoleKeys.forEach(roleKey => {
                    const roleData = availableRoles.find(r => r.key === roleKey);
                    if (roleData) {
                        (roleData.default_views || []).forEach(viewKey => scope.views.add(viewKey));
                    }
                });

                // 第 2 步: 【关键修复】根据上面得出的可见视图，从 VIEW_COLUMN_MAP 中找出所有可能涉及的列
                // 这样做可以确保即使用户的角色默认没有配置某个列，只要那个列属于他可见的视图，也会被包含进来，从而可以在弹窗中显示为“禁止(默认)”
                scope.views.forEach(viewKey => {
                    (viewColumnMap[viewKey] || []).forEach(colKey => scope.columns.add(colKey));
                });

                return {
                    views: viewConfig.filter(v => scope.views.has(v.key)),
                    columns: columnDefinitions.filter(c => scope.columns.has(c.key))
                };
            }, [editingUserId, currentUserPermsDetail.roles, availableRoles, viewConfig, columnDefinitions, viewColumnMap]);
            const selectAllCheckboxRef = useRef(null);

            useEffect(() => {
                if (selectAllCheckboxRef.current) {
                    const numSelected = currentUsers.filter(u => selectedUsers.has(u.id)).length;
                    selectAllCheckboxRef.current.checked = numSelected === currentUsers.length && currentUsers.length > 0;
                    selectAllCheckboxRef.current.indeterminate = numSelected > 0 && numSelected < currentUsers.length;
                }
            }, [selectedUsers, currentUsers]);
            // --- “流程管理”标签页所需的新 State ---
            const [selectedViewKeys, setSelectedViewKeys] = useState(new Set());
            const [processPermissions, setProcessPermissions] = useState({});

            // 将 ACTION_DEFINITIONS 转换为更易于使用的 Map，用于快速查找标签
            const actionKeyLabelMap = useMemo(() =>
                Object.fromEntries(ACTION_DEFINITIONS.map(a => [a.key, a.label])),
                [ACTION_DEFINITIONS]
            );
            // --- 在这里添加新的 useMemo 钩子 ---
            const viewsForProcessManagement = useMemo(() => {
                if (!editingRoleKey) {
                    return []; // 如果没有选择角色，则不显示任何视图
                }
                const roleData = availableRoles.find(r => r.key === editingRoleKey);
                const visibleViewKeys = new Set(roleData?.default_views || []);

                // 只返回在角色权限中被设为可见的那些视图
                return viewConfig.filter(v => v.key && v.key !== 'overview' && visibleViewKeys.has(v.key));
            }, [editingRoleKey, availableRoles, viewConfig]);
            // 当 activeView 变化时，如果切换到“流程管理”，则初始化权限状态
            // 【修改后】的 useEffect，增加了对 editMode 的处理
            useEffect(() => {
                if (activeView === 'process_management' && editingRoleKey) {
                    // --- 权限数据加载逻辑 (保持不变) ---
                    const initialPermissions = (actionPermissions || [])
                        .filter(perm => perm.role_key === editingRoleKey)
                        .reduce((acc, perm) => {
                            if (perm.is_enabled) {
                                if (!acc[perm.view_key]) {
                                    acc[perm.view_key] = new Set();
                                }
                                acc[perm.view_key].add(perm.action_key);
                            }
                            return acc;
                        }, {});
                    setProcessPermissions(initialPermissions);

                    // --- 根据编辑模式，重置勾选和选择状态 ---
                    if (editMode === 'bulk') {
                        // 在批量模式下，智能勾选已配置的
                        const viewsWithPermissions = Object.keys(initialPermissions).filter(
                            viewKey => initialPermissions[viewKey] && initialPermissions[viewKey].size > 0
                        );
                        setSelectedViewKeys(new Set(viewsWithPermissions));
                        setSingleSelectedViewKey(''); // 清空单点模式的选择
                    } else {
                        // 在单点模式下，默认不选中任何视图，等待用户点击
                        setSelectedViewKeys(new Set());
                        setSingleSelectedViewKey('');
                    }
                }
            }, [activeView, actionPermissions, editingRoleKey, editMode]); // <-- 依赖项增加了 editMode
            // 处理左侧视图列表的勾选/取消勾选
            const handleViewSelectionChange = (viewKey) => {
                const newSelection = new Set(selectedViewKeys);
                if (newSelection.has(viewKey)) {
                    newSelection.delete(viewKey);
                } else {
                    newSelection.add(viewKey);
                }
                setSelectedViewKeys(newSelection);
            };

            // 处理左侧“全选”框的逻辑
            const handleSelectAllViews = (e) => {
                if (e.target.checked) {
                    const allViewKeys = viewConfig.filter(v => v.key && v.key !== 'overview' && v.key !== 'deleted').map(v => v.key);
                    setSelectedViewKeys(new Set(allViewKeys));
                } else {
                    setSelectedViewKeys(new Set());
                }
            };

            // 【修改后】的 handleProcessPermissionChange
            const handleProcessPermissionChange = (actionKey) => {
                const newProcessPermissions = { ...processPermissions };

                // 决定要操作的视图 keys
                const viewsToModify = editMode === 'single' ? [singleSelectedViewKey] : Array.from(selectedViewKeys);
                if (viewsToModify.length === 0) return;

                // 判断是新增还是删除权限
                const allSelectedHaveAction = viewsToModify.every(
                    viewKey => newProcessPermissions[viewKey]?.has(actionKey)
                );
                const isAdding = !allSelectedHaveAction;

                // 批量为所有选中的视图添加或删除此操作权限
                viewsToModify.forEach(viewKey => {
                    if (!newProcessPermissions[viewKey]) {
                        newProcessPermissions[viewKey] = new Set();
                    }
                    if (isAdding) {
                        newProcessPermissions[viewKey].add(actionKey);
                    } else {
                        newProcessPermissions[viewKey].delete(actionKey);
                    }
                });

                setProcessPermissions(newProcessPermissions);
            };
            const handleSaveProcessPermissions = async () => {
                // 增加一个保护，如果没选角色则不执行任何操作
                if (!editingRoleKey) {
                    showNotification('请先选择一个角色', 'error');
                    return;
                }

                // 1. 将前端的 state 格式转换为适合存入数据库的格式
                const permissionsToSave = [];
                const allPossibleViewActions = viewConfig
                    .filter(v => v.key)
                    .flatMap(v => ACTION_DEFINITIONS.map(a => ({ view_key: v.key, action_key: a.key })));

                allPossibleViewActions.forEach(({ view_key, action_key }) => {
                    const isEnabled = processPermissions[view_key]?.has(action_key) || false;
                    permissionsToSave.push({
                        role_key: editingRoleKey, // <-- 关键：为每条记录都加上角色key
                        view_key,
                        action_key,
                        is_enabled: isEnabled
                    });
                });

                try {
                    // 2. 使用 upsert 将这个角色的所有配置一次性写入数据库
                    //    onConflict 会智能地处理新增和更新
                    const { error } = await supabase
                        .from('action_permissions')
                        .upsert(permissionsToSave, { onConflict: 'role_key, view_key, action_key' }); // <-- 更新 onConflict 约束

                    if (error) throw error;

                    showNotification(`角色 "${availableRoles.find(r => r.key === editingRoleKey)?.label}" 的流程权限已成功保存！`, 'success');
                    // 通知 App 组件刷新总的权限数据
                    onSaveManagementData(null, true);

                } catch (error) {
                    showNotification(`保存失败: ${error.message}`, 'error');
                    console.error('Save process permissions error:', error);
                }
            };
            // --- 新增 useEffect ---
            // 当用户在“功能权限”模块选择一个角色时，加载该角色的权限数据
            useEffect(() => {
                if (activeView === 'function_permission' && editingFuncPermsForRole) {
                    const rolePerm = rolePermissions.find(p => p.role_key === editingFuncPermsForRole);

                    // 统一使用最新的、正确的权限字段结构
                    const defaultPerms = {
                        can_create_task: false,
                        can_import_data: false,
                        can_export_data: false,
                        can_view_statistics: false,
                        can_manage_config: false,
                        can_manage_teams: false,
                    };

                    if (rolePerm) {
                        // 如果角色已有配置，就用数据库的值覆盖默认值
                        setCurrentFuncPerms({
                            can_create_task: rolePerm.can_create_task || false,
                            can_import_data: rolePerm.can_import_data || false,
                            can_export_data: rolePerm.can_export_data || false,
                            can_view_statistics: rolePerm.can_view_statistics || false,
                            can_manage_config: rolePerm.can_manage_config || false,
                            can_manage_teams: rolePerm.can_manage_teams || false,
                        });
                    } else {
                        // 如果角色是第一次配置，直接使用全新的、正确的默认值
                        setCurrentFuncPerms(defaultPerms);
                    }
                }
            }, [activeView, editingFuncPermsForRole, rolePermissions]);

            // --- 新增 保存功能权限 的函数 ---
            const handleSaveFuncPermissions = async () => {
                if (!editingFuncPermsForRole) {
                    showNotification('请先选择一个角色', 'error');
                    return;
                }

                const dataToSave = {
                    role_key: editingFuncPermsForRole,
                    ...currentFuncPerms
                };

                try {
                    const { error } = await supabase
                        .from('role_permissions')
                        .upsert(dataToSave, { onConflict: 'role_key' }); // <-- 修正拼写

                    if (error) throw error;
                    showNotification(`角色 "${availableRoles.find(r => r.key === editingFuncPermsForRole)?.label}" 的功能权限已保存！`, 'success');
                    onSaveManagementData(null, true); // 强制刷新App的总权限数据
                } catch (error) {
                    showNotification(`保存失败: ${error.message}`, 'error');
                }
            };
            // --- 新增 useEffect ---
            // 当用户在“任务权限”模块选择一个角色时，加载该角色的可见性数据
            useEffect(() => {
                if (activeView === 'task_permission' && editingVisPermsForRole) {
                    const roleData = availableRoles.find(r => r.key === editingVisPermsForRole);
                    if (roleData) {
                        setCurrentVisPerms({
                            default_views: roleData.default_views || [],
                            default_columns: roleData.default_columns || [],
                        });
                    } else {
                        // 如果没找到角色数据，则重置
                        setCurrentVisPerms({ default_views: [], default_columns: [] });
                    }
                }
            }, [activeView, editingVisPermsForRole, availableRoles]);
            // --- 新增 useEffect ---
            // 当用户在“权限配置”模块选择一个用户时，加载该用户的权限数据
            useEffect(() => {
                if (activeView === 'permission_config' && editingUserId) {
                    const userProfile = profiles.find(p => p.id === editingUserId);
                    if (userProfile && userProfile.permissions) {
                        setCurrentUserPermsDetail(userProfile.permissions);
                    } else {
                        // 如果用户没有配置过，则提供一个空的默认结构
                        setCurrentUserPermsDetail({ roles: [], overrides: {} });
                    }
                }
            }, [activeView, editingUserId, profiles]);

            // --- 新增 打开“权限调整”弹窗 的函数 ---
            const handleOpenOverrideModal = (type) => {
                setOverrideType(type);
                setIsOverrideModalOpen(true);
            };

            // --- 新增 保存用户特权 的函数 ---
            const handleSaveUserOverrides = async (newOverrides) => {
                if (!editingUserId) {
                    showNotification('未选择用户', 'error');
                    return;
                }

                const dataToSave = {
                    ...currentUserPermsDetail, // 保留已有的角色分配
                    overrides: newOverrides, // 更新特权设置
                };

                try {
                    const { error } = await supabase
                        .from('profiles')
                        .update({ permissions: dataToSave })
                        .eq('id', editingUserId);

                    if (error) throw error;

                    // --- 核心修复开始 ---

                    // 1. 立即更新当前正在编辑的用户状态。
                    //    这将即时刷新“只读总览”（解决问题一），并确保后续操作基于最新数据。
                    setCurrentUserPermsDetail(dataToSave);

                    // 2. 在后台同步更新总的用户列表状态。
                    setProfiles(prevProfiles =>
                        prevProfiles.map(p =>
                            p.id === editingUserId ? { ...p, permissions: dataToSave } : p
                        )
                    );

                    // --- 核心修复结束 ---

                    showNotification('用户特权已成功保存！', 'success');
                    setIsOverrideModalOpen(false); // 关闭弹窗
                } catch (error) {
                    showNotification(`保存失败: ${error.message}`, 'error');
                }
            };
            // 【新增代码】
            // 保存用户的角色分配
            const handleSaveRoleAssignments = async () => {
                if (!editingUserId) {
                    showNotification('未选择用户', 'error');
                    return;
                }

                // 从原始的 user profile 中获取最新的 overrides，防止被覆盖
                const userProfile = profiles.find(p => p.id === editingUserId);
                const existingOverrides = userProfile?.permissions?.overrides || {};

                // 构造新的 permissions 对象，合并新角色和已有的特权
                const dataToSave = {
                    roles: currentUserPermsDetail.roles || [],
                    overrides: existingOverrides,
                };

                try {
                    const { error } = await supabase
                        .from('profiles')
                        .update({ permissions: dataToSave })
                        .eq('id', editingUserId);

                    if (error) throw error;

                    // 更新前端的 profiles 状态以立即生效
                    setProfiles(prevProfiles =>
                        prevProfiles.map(p =>
                            p.id === editingUserId ? { ...p, permissions: dataToSave } : p
                        )
                    );

                    showNotification('用户的角色分配已成功保存！', 'success');
                } catch (error) {
                    showNotification(`保存失败: ${error.message}`, 'error');
                }
            };
            // --- 新增 保存可见性权限 的函数 ---
            const handleSaveVisPermissions = async () => {
                if (!editingVisPermsForRole) {
                    showNotification('请先选择一个角色', 'error');
                    return;
                }
                const roleToUpdate = availableRoles.find(r => r.key === editingVisPermsForRole);
                if (!roleToUpdate) {
                    showNotification('找不到要更新的角色', 'error');
                    return;
                }
                // 现在我们保存的是包含完整视图-列映射的 currentVisPerms 对象
                const dataToSave = {
                    ...roleToUpdate,
                    default_views: currentVisPerms.default_views,
                    default_columns: currentVisPerms.default_columns, // 这现在是一个 JSONB 对象
                };
                try {
                    const { error } = await supabase
                        .from('roles')
                        .upsert(dataToSave, { onConflict: 'key' });
                    if (error) throw error;
                    showNotification(`角色 "${dataToSave.label}" 的可见性权限已保存！`, 'success');
                    onSaveManagementData(null, true);
                } catch (error) {
                    showNotification(`保存失败: ${error.message}`, 'error');
                }
            };
            const filteredRoles = useMemo(() => {
                if (!roleSearchTerm.trim()) {
                    return availableRoles;
                }
                const lowercasedFilter = roleSearchTerm.toLowerCase();
                return (availableRoles || []).filter(role =>
                    role.label.toLowerCase().includes(lowercasedFilter) ||
                    role.key.toLowerCase().includes(lowercasedFilter)
                );
            }, [availableRoles, roleSearchTerm]);
            const handleOpenRoleEditor = (role = null) => {
                setRoleEditorError(null); // <-- 新增这一行
                setEditingRole(role); // 如果传入 role 则为编辑，否则为新增
                setIsRoleEditorOpen(true);
            };

            const handleCloseRoleEditor = () => {
                setRoleEditorError(null); // <-- 新增这一行
                setIsRoleEditorOpen(false);
                setEditingRole(null);
            };
            // 这是修正后的 handleSaveRole 函数
            const handleSaveRole = async (roleData) => {
                setRoleEditorError(null);
                try {
                    if (!roleData.id && availableRoles.some(r => r.key === roleData.key.trim())) {
                        setRoleEditorError(`角色 Key "${roleData.key.trim()}" 已存在，请使用其他标识。`);
                        return;
                    }

                    // 准备要保存到 `roles` 表的数据，只包含弹窗中有的字段
                    const coreRoleData = {
                        id: roleData.id || undefined,
                        key: roleData.key,
                        label: roleData.label,
                        default_views: roleData.default_views,
                        default_columns: roleData.default_columns,
                    };

                    // 保存核心数据
                    const { data: savedRole, error: roleError } = await supabase
                        .from('roles')
                        .upsert(coreRoleData, { onConflict: 'key' })
                        .select()
                        .single();

                    if (roleError) throw roleError;

                    // 注意：不再有保存 appPermissionData 的第二步

                    showNotification(`角色 "${savedRole.label}" 已成功保存！`, 'success');
                    handleCloseRoleEditor();
                    onSaveManagementData(null, true);

                } catch (error) {
                    setRoleEditorError(`保存失败: ${error.message}`);
                    console.error('Role save error:', error);
                }
            };
            // 这是修正后的 handleDeleteRole 函数
            const handleDeleteRole = (role) => {
                setConfirmationState({
                    isOpen: true,
                    title: '删除角色',
                    children: (
                        <div>
                            <p>您确定要永久删除角色 <span className="font-bold text-red-500">{role.label}</span> 吗？</p>
                            <p className="text-sm text-gray-500 mt-2">此操作无法撤销，且拥有此角色的用户将失去相应权限。</p>
                        </div>
                    ),
                    confirmVariant: 'danger',
                    onConfirm: async () => {
                        try {
                            // 1. 从数据库删除角色
                            const { error } = await supabase.from('roles').delete().eq('id', role.id);
                            if (error) throw error;

                            showNotification(`角色 "${role.label}" 已被删除。`, 'success');

                            // --- 核心修正 ---
                            // 2. 调用 onSaveManagementData (在您的代码中实际是 onSave)，
                            //    并传入 true 来强制刷新整个应用的角色和权限数据。
                            //    在您的代码中，这个函数作为 onSave 属性传入。
                            onSaveManagementData(null, true);
                            // --- 修正结束 ---

                        } catch (error) {
                            showNotification(`删除角色失败: ${error.message}`, 'error');
                        } finally {
                            closeConfirmationModal();
                        }
                    }
                });
            };

            // --- 在此添加新代码 ---
            const allDepartments = useMemo(() => {
                if (!managementData?.department_structure) return [];
                // 将层级结构的数据 { marketing: { label: '市场', sub_departments: [...] } }
                // 转换为更易于渲染的扁平数组 [{ typeKey: 'marketing', typeLabel: '市场', dept: '市场一部' }, ...]
                return Object.entries(managementData.department_structure).flatMap(([typeKey, typeInfo]) =>
                    (typeInfo.sub_departments || []).map(dept => ({
                        typeKey,
                        typeLabel: typeInfo.label,
                        dept
                    }))
                );
            }, [managementData]);

            const departmentGroups = useMemo(() => {
                return allDepartments.reduce((acc, dept) => {
                    if (!acc[dept.typeLabel]) {
                        acc[dept.typeLabel] = [];
                    }
                    acc[dept.typeLabel].push(dept);
                    return acc;
                }, {});
            }, [allDepartments]);
            // --- 添加结束 ---
            // --- 2. 新增：用于批量操作的逻辑 ---
            // 获取被选中用户的完整信息
            const selectedUserIds = Array.from(selectedUsers);
            const selectedUserDetails = users.filter(user => selectedUserIds.includes(user.id));

            // 根据选中用户的角色，判断应该显示哪些批量操作按钮
            const canBulkApprove = selectedUserDetails.length > 0 && selectedUserDetails.every(user => user.role === 'pending');
            const canBulkRevoke = selectedUserDetails.length > 0 && selectedUserDetails.every(user => user.role === 'approved');
            const canBulkDelete = selectedUserIds.length > 0;

            // --- 4. 新增：翻页函数 ---
            const paginate = (pageNumber) => setCurrentPage(pageNumber);

            // 角色状态中文映射
            const roleMap = {
                admin: '管理员',
                approved: '正式用户',
                pending: '待审批'
            };
            // --- 【最终修复版】fetchUsers 函数 ---
            // --- 【调试版】fetchUsers 函数 ---
            const fetchUsers = useCallback(async () => {
                if (!isOpen) return;
                setLoading(true);
                setError('');
                try {
                    // 第1步: 获取所有用户的登录信息
                    const { data: authUsers, error: authError } = await supabase.functions.invoke('get-users');
                    if (authError) throw authError;
                    console.log("1. 从 Edge Function 获取的 Auth Users:", authUsers); // <-- 侦探代码

                    // 第2步: 获取所有用户的档案信息 (受 RLS 策略影响)
                    const { data: profilesData, error: profilesError } = await supabase.from('profiles').select('*');
                    if (profilesError) throw profilesError;
                    console.log("2. 从 profiles 表获取的数据 (受RLS影响):", profilesData); // <-- 侦探代码

                    // 第3步: 合并信息
                    const enrichedUsers = authUsers.map(authUser => {
                        const profile = profilesData.find(p => p.id === authUser.id);
                        return {
                            ...authUser,
                            role: authUser.role || 'pending',
                            department: profile?.department || null,
                        };
                    });

                    // 第4步: 过滤掉当前登录的用户
                    const { data: { session } } = await supabase.auth.getSession();
                    const currentUserId = session.user.id;
                    const finalUserData = enrichedUsers.filter(user => user.id !== currentUserId);
                    console.log("3. 最终处理后准备显示的用户:", finalUserData); // <-- 侦探代码

                    setUsers(finalUserData);
                } catch (e) {
                    setError('获取用户列表失败: ' + e.message);
                } finally {
                    setLoading(false);
                }
            }, [isOpen]);

            // 这个 useEffect 的作用是：当弹窗被打开(isOpen变为true)时，调用一次我们上面定义的 fetchUsers 函数          
            useEffect(() => {
                if (isOpen) {
                    fetchUsers();
                }
            }, [isOpen, fetchUsers]);
            const [departmentFilter, setDepartmentFilter] = useState('技术部门');
            const filteredUsers = useMemo(() => {
                // 先按部门筛选，再按搜索词筛选
                return users.filter(user => {
                    const matchesDept = user.department === departmentFilter;
                    if (!matchesDept) return false;

                    if (!searchTerm) return true;
                    return user.email.toLowerCase().includes(searchTerm.toLowerCase());
                });
            }, [users, searchTerm, departmentFilter]);
            // --- 在此添加新代码 ---
            const filteredPermissionUsers = useMemo(() => {
                if (!permissionSearchTerm) return users;
                return users.filter(user => user.email.toLowerCase().includes(permissionSearchTerm.toLowerCase()));
            }, [users, permissionSearchTerm]);
            const previewViewOptions = useMemo(() => {
                if (!permissionFormData) return [];

                // 步骤1：从新的 permissions 数组中，提取出所有不重复的角色key
                const allRoleKeys = [...new Set(permissionFormData.permissions.map(p => p.role))];

                // 步骤2：根据角色key，从角色定义(availableRoles)中找出所有对应的默认视图
                let visibleViews = new Set();
                availableRoles.forEach(roleDef => {
                    if (allRoleKeys.includes(roleDef.key)) {
                        (roleDef.default_views || []).forEach(view => visibleViews.add(view));
                    }
                });

                // 步骤3：返回最终的视图列表
                return viewConfig
                    .filter(v => visibleViews.has(v.key))
                    .map(v => ({ label: v.label, value: v.key }));
            }, [permissionFormData, availableRoles, viewConfig]);
            // --- 在此添加新代码 ---
            useEffect(() => {
                if (permissionFormData && previewViewOptions.length > 0) {
                    const currentPreviewIsValid = previewViewOptions.some(opt => opt.value === previewView);
                    // 如果当前预览的视图已不再可选，则自动切换到第一个可选的视图
                    if (!currentPreviewIsValid) {
                        setPreviewView(previewViewOptions[0].value);
                    }
                } else if (permissionFormData && previewViewOptions.length === 0) {
                    // 如果一个可选的预览视图都没有，就清空预览状态
                    setPreviewView(null);
                }
            }, [previewViewOptions, previewView, permissionFormData]);
            // --- 添加结束 ---
            // --- 添加结束 ---
            // --- 【修正】计算当前页应该显示的用户 (移动到此处) ---
            const indexOfLastUser = currentPage * usersPerPage;
            const indexOfFirstUser = indexOfLastUser - usersPerPage;
            // 【修正】现在 filteredUsers 已经定义，可以安全使用
            const currentUsers = filteredUsers.slice(indexOfFirstUser, indexOfLastUser);

            // 点击“批准”按钮时调用的函数
            // --- 【优化版】handleApproveUser ---
            // --- 【最终版】handleApproveUser ---
            const handleApproveUser = async (userId) => {
                console.log("点击了【批准】按钮，传递过来的 userId 是：", userId); 

    if (!userId) {
        showNotification("操作失败：未能获取到用户ID。", 'error');
        return; 
    }
                try {
                    const { error } = await supabase.functions.invoke('approve-user', { body: { userId } });
                    if (error) throw error;
                    showNotification('用户批准成功！');

                    // 手动更新本地UI状态以立即反映变化，避免数据延迟问题
                    setUsers(current => current.map(u => u.id === userId ? { ...u, role: 'approved' } : u));

                    // onProfilesChange 用于刷新主应用的状态，我们依然保留它
                    onProfilesChange();
                } catch (e) {
                    showNotification('批准用户失败: ' + e.message, 'error');
                }
            };

            // --- 【最终版】handleRevokeUser (逻辑原先已正确, 保持统一) ---
            const handleRevokeUser = async (userId) => {
                console.log("点击了【撤销】按钮，传递过来的 userId 是：", userId);

    if (!userId) {
        showNotification("操作失败：未能获取到用户ID。", 'error');
        return; 
    }
                try {
                    const { error } = await supabase.functions.invoke('revoke-user', { body: { userId } });
                    if (error) throw error;
                    showNotification('用户权限已撤销！');
                    setUsers(current => current.map(u => u.id === userId ? { ...u, role: 'pending' } : u));
                    onProfilesChange();
                } catch (e) { showNotification('撤销用户权限失败: ' + e.message, 'error'); }
            };

            // 点击“删除”按钮时调用的函数
            // 更新 handleDeleteClick
            const handleDeleteClick = (userId, userEmail) => {
                setConfirmationState({
                    isOpen: true,
                    title: '永久删除用户',
                    children: `你确定要永久删除用户 ${userEmail} 吗？此操作无法撤销！`,
                    // 【修正】让 onConfirm 调用我们新加的函数，并在执行后关闭弹窗
                    onConfirm: () => {
                        confirmAndDelete(userId, userEmail);
                        closeConfirmationModal(); // 调用一个辅助函数来关闭
                    },
                    confirmVariant: 'danger'
                });
            };

            // 更新 handleBulkDeleteClick
            const handleBulkDeleteClick = () => {
                setConfirmationState({
                    isOpen: true,
                    title: '批量永久删除用户',
                    children: `你确定要永久删除选中的 ${selectedUserIds.length} 个用户吗？此操作无法撤销！`,
                    // 【修正】同上
                    onConfirm: () => {
                        confirmAndBulkDelete();
                        closeConfirmationModal();
                    },
                    confirmVariant: 'danger'
                });
            };
            // --- 【新】批量转移部门函数 ---
            const handleBulkTransfer = () => {
                const selectedUserDetails = users.filter(u => selectedUsers.has(u.id));

                // --- 步骤1：增加严谨的逻辑校验 ---
                if (selectedUserDetails.length === 0) return;

                const firstDept = selectedUserDetails[0]?.department;
                if (!firstDept) {
                    showNotification('选中的用户中存在未分配部门的人员，无法批量转移。', 'error');
                    return;
                }

                const allInSameDept = selectedUserDetails.every(u => u.department === firstDept);
                if (!allInSameDept) {
                    showNotification('请确保所有选中的用户都在同一个部门内才能进行批量转移。', 'error');
                    return;
                }
                // --- 校验结束 ---

                const newDepartment = firstDept === '技术部门' ? '市场部门' : '技术部门';

                setConfirmationState({
                    isOpen: true, title: '批量转移部门',
                    children: `您确定要将选中的 ${selectedUsers.size} 个用户从 "${firstDept}" 转移到 "${newDepartment}" 吗？`,
                    onConfirm: async () => {
                        const userIds = Array.from(selectedUsers);

                        // 【关键修正】只发送数据库 `profiles` 表认识的 id 和 department 字段。
                        // 不再使用 ...profile 展开，避免发送多余的、无效的字段。
                        const updates = userIds.map(userId => ({
                            id: userId,
                            department: newDepartment
                        }));

                        const { error } = await supabase.from('profiles').upsert(updates);

                        if (error) {
                            showNotification('批量转移失败: ' + error.message, 'error');
                        } else {
                            showNotification('批量转移成功！');

                            // --- 步骤2：增加更新本地界面的代码 ---
                            setUsers(currentUsers =>
                                currentUsers.map(user =>
                                    selectedUsers.has(user.id) ? { ...user, department: newDepartment } : user
                                )
                            );

                            onProfilesChange();
                            setSelectedUsers(new Set());
                        }
                        closeConfirmationModal();
                    }
                });
            };
            // ... 放在 handleDeleteClick 和 handleBulkDeleteClick 函数附近

            const handleBulkApprove = () => {
                setConfirmationState({
                    isOpen: true,
                    title: '批量批准用户',
                    children: `你确定要批准选中的 ${selectedUserIds.length} 个待审批用户吗？`,
                    onConfirm: confirmAndBulkApprove,
                    confirmVariant: 'primary' // 使用主色调
                });
            };

            const confirmAndBulkApprove = async () => {
                // 使用 Promise.all 并行处理所有请求
                const approvePromises = selectedUserIds.map(userId =>
                    supabase.functions.invoke('approve-user', { body: { userId } })
                );
                try {
                    await Promise.all(approvePromises);
                    // 成功后更新本地UI
                    setUsers(currentUsers =>
                        currentUsers.map(user =>
                            selectedUserIds.includes(user.id) ? { ...user, role: 'approved' } : user
                        )
                    );
                    setSelectedUsers(new Set()); // 清空选择
                    showNotification('批量批准成功！');
                } catch (e) {
                    showNotification('批量批准失败: ' + e.message, 'error');
                }
            };

            const handleBulkRevoke = () => {
                setConfirmationState({
                    isOpen: true,
                    title: '批量撤销用户权限',
                    children: `你确定要撤销选中的 ${selectedUserIds.length} 个正式用户的权限吗？`,
                    onConfirm: confirmAndBulkRevoke,
                    confirmVariant: 'warning' // 使用警告色
                });
            };

            const confirmAndBulkRevoke = async () => {
                const revokePromises = selectedUserIds.map(userId =>
                    supabase.functions.invoke('revoke-user', { body: { userId } })
                );
                try {
                    await Promise.all(revokePromises);
                    setUsers(currentUsers =>
                        currentUsers.map(user =>
                            selectedUserIds.includes(user.id) ? { ...user, role: 'pending' } : user
                        )
                    );
                    setSelectedUsers(new Set());
                    showNotification('批量撤销成功！');
                } catch (e) {
                    showNotification('批量撤销失败: ' + e.message, 'error');
                }
            };
            // --- 【新增代码】从这里开始 ---

            const confirmAndDelete = async (userId, userEmail) => {
                try {
                    const { error } = await supabase.functions.invoke('delete-user', {
                        body: { userId }
                    });
                    if (error) throw error;

                    setUsers(currentUsers => currentUsers.filter(user => user.id !== userId));
                    showNotification(`用户 ${userEmail} 已被永久删除。`);
                    onProfilesChange(); // <-- 新增此行，通知主应用刷新
                } catch (e) {
                    showNotification('删除用户失败: ' + e.message, 'error');
                }
            };

            const confirmAndBulkDelete = async () => {
                const userIds = Array.from(selectedUsers);
                try {
                    const deletePromises = userIds.map(userId =>
                        supabase.functions.invoke('delete-user', { body: { userId } })
                    );
                    await Promise.all(deletePromises);

                    setUsers(currentUsers => currentUsers.filter(user => !userIds.includes(user.id)));
                    setSelectedUsers(new Set());
                    showNotification(`已成功批量删除 ${userIds.length} 个用户。`);
                    onProfilesChange(); // <-- 新增此行，通知主应用刷新
                } catch (e) {
                    showNotification('批量删除失败: ' + e.message, 'error');
                }
            };

            const handleSelectUser = (userId) => {
                setSelectedUsers(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(userId)) { newSet.delete(userId); }
                    else { newSet.add(userId); }
                    return newSet;
                });
            };

            const handleSelectAll = (e) => {
                if (e.target.checked) {
                    setSelectedUsers(new Set(currentUsers.map(u => u.id)));
                } else {
                    setSelectedUsers(new Set());
                }
            };
            // 点击“邀请”按钮时调用的函数
            const handleInviteUser = async () => {
                if (!inviteEmail) {
                    showNotification('请输入要邀请的邮箱地址。', 'error');
                    return;
                }
                try {
                    // 调用我们刚刚创建的 invite-user 云函数
                    const { data, error } = await supabase.functions.invoke('invite-user', {
                        body: { email: inviteEmail },
                    });
                    if (error) throw error;

                    showNotification(data.message || '邀请成功！');
                    setInviteEmail(''); // 清空输入框
                    fetchUsers(); // 重新加载用户列表，以显示新邀请的用户

                } catch (e) {
                    showNotification('邀请用户失败: ' + e.message, 'error');
                }
            };
            // --- 【新】处理部门转移的函数 ---
            // --- 【最终版】handleTransferDepartment ---
            const handleTransferDepartment = (user) => {
                if (!user.department) { showNotification('该用户尚未分配初始部门。', 'error'); return; }
                const newDepartment = user.department === '技术部门' ? '市场部门' : '技术部门';
                setConfirmationState({
                    isOpen: true, title: '转移用户部门',
                    children: `您确定要将用户 "${userMap.get(user.id)}" 从 "${user.department}" 转移到 "${newDepartment}" 吗？`,
                    onConfirm: async () => {
                        try {
                            const { error } = await supabase.from('profiles').update({ department: newDepartment }).eq('id', user.id);
                            if (error) throw error;
                            showNotification('用户部门转移成功！');
                            // 修复：更新用户的部门，而不是从列表中删除
                            setUsers(current => current.map(u => u.id === user.id ? { ...u, department: newDepartment } : u));
                            onProfilesChange();
                        } catch (e) { showNotification('转移失败: ' + e.message, 'error'); }
                        finally { closeConfirmationModal(); }
                    }
                });
            };
            // --- 在此添加新代码 ---
            const handleSelectPermissionUser = (userId) => {
                setPermissionTargetUsers(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(userId)) {
                        newSet.delete(userId);
                    } else {
                        newSet.add(userId);
                    }
                    return newSet;
                });
            };
            // --- 添加结束 ---
            // --- 在此添加新代码 ---
            useEffect(() => {
                // 当左侧选择的用户变化时，更新右侧的表单数据
                const targetIds = Array.from(permissionTargetUsers);

                if (targetIds.length === 0) {
                    // 如果没有选中任何用户，清空表单
                    setPermissionFormData(null);
                } else if (targetIds.length === 1) {
                    // 如果只选中一个用户，加载他当前的权限
                    const singleUserProfile = profiles.find(p => p.id === targetIds[0]);
                    if (singleUserProfile) {
                        setPermissionFormData({
                            // 关键修正：直接从统一的 permissions 字段读取，不再区分
                            permissions: singleUserProfile.permissions || [],
                            visible_views: singleUserProfile.visible_views || [],
                            visible_columns: singleUserProfile.visible_columns || [],
                        });
                    }
                } else {
                    // 如果选中了多个用户，显示一个空白待填的表单，用于批量覆盖
                    setPermissionFormData({
                        permissions: [], // <-- 修正：使用新的 'permissions' 结构
                        visible_views: [],
                        visible_columns: [],
                    });
                }
            }, [permissionTargetUsers, profiles]);
            // --- 添加结束 ---
            // --- 在此添加新代码 ---
            // --- 全新的“全能”权限变更处理函数 ---
            const handlePermissionChange = (type, payload) => {
                if (!permissionFormData) return;

                let newFormData = { ...permissionFormData };

                // 内部辅助函数：根据当前分配的角色，智能更新视图和列权限
                const updateLinkedPermissions = (currentPermissions) => {
                    const viewSet = new Set();
                    const colSet = new Set();
                    const assignedRoleKeys = new Set(currentPermissions.map(p => p.role));

                    availableRoles.forEach(roleDef => {
                        if (assignedRoleKeys.has(roleDef.key)) {
                            (roleDef.default_views || []).forEach(v => viewSet.add(v));
                            (roleDef.default_columns || []).forEach(c => colSet.add(c));
                        }
                    });

                    return {
                        permissions: currentPermissions,
                        visible_views: Array.from(viewSet),
                        visible_columns: Array.from(colSet),
                    };
                };

                let currentPermissions = [...(newFormData.permissions || [])];

                if (type === 'simple_role') {
                    const roleKey = payload;
                    const index = currentPermissions.findIndex(p => p.role === roleKey);
                    if (index === -1) { currentPermissions.push({ role: roleKey }); }
                    else { currentPermissions.splice(index, 1); }
                } else if (type === 'department') {
                    const { dept, typeKey } = payload;
                    const index = currentPermissions.findIndex(p => p.role === 'department_head' && p.department === dept);
                    if (index === -1) { currentPermissions.push({ role: 'department_head', department: dept, department_type: typeKey }); }
                    else { currentPermissions.splice(index, 1); }
                } else if (type === 'toggle_all_departments') {
                    const shouldSelectAll = payload;
                    currentPermissions = currentPermissions.filter(p => p.role !== 'department_head');
                    if (shouldSelectAll) {
                        const allDeptPerms = allDepartments.map(d => ({ role: 'department_head', department: d.dept, department_type: d.typeKey }));
                        currentPermissions.push(...allDeptPerms);
                    }
                } else if (type === 'visible_views' || type === 'visible_columns') {
                    const key = payload;
                    const currentSet = new Set(newFormData[type]);
                    if (currentSet.has(key)) { currentSet.delete(key); }
                    else { currentSet.add(key); }
                    newFormData[type] = Array.from(currentSet);
                    setPermissionFormData(newFormData);
                    return; // 对于视图和列的直接修改，不需要联动，直接返回
                }

                // 对于所有角色和部门的修改，都在最后统一调用联动函数
                const finalPermissions = updateLinkedPermissions(currentPermissions);
                setPermissionFormData(prev => ({ ...prev, ...finalPermissions }));
            };

            const handleApplyPermissions = async () => {
                if (!permissionFormData) {
                    showNotification('没有可应用的权限变更。', 'error');
                    return;
                }
                const targetIds = Array.from(permissionTargetUsers);
                if (targetIds.length === 0) {
                    showNotification('请至少选择一个用户。', 'error');
                    return;
                }

                try {
                    // 关键修正：不再分离 roles 和 department_head_assignments
                    // 我们直接将包含了所有权限的 permissions 数组，以及最新的视图和列权限打包
                    const updates = targetIds.map(userId => ({
                        id: userId,
                        permissions: permissionFormData.permissions, // 直接使用包含所有权限的 permissions 数组
                        visible_views: permissionFormData.visible_views,
                        visible_columns: permissionFormData.visible_columns,
                        updated_at: new Date().toISOString(),
                    }));

                    const { error } = await supabase.from('profiles').upsert(updates, { onConflict: 'id' });

                    if (error) {
                        // 抛出更详细的 Supabase 错误
                        throw new Error(error.message || 'An unknown database error occurred.');
                    }

                    showNotification(`已成功为 ${targetIds.length} 位用户更新权限！`, 'success');

                    setProfiles(currentProfiles =>
                        currentProfiles.map(p => {
                            const updatedData = updates.find(u => u.id === p.id);
                            return updatedData ? { ...p, ...updatedData } : p;
                        })
                    );
                    setPermissionTargetUsers(new Set());

                } catch (error) {
                    showNotification(`权限更新失败: ${error.message}`, 'error');
                    console.error('Permission update error:', error);
                }
            };

            // --- 在此添加新代码 ---
            const handleSelectAllPermissions = (type, context = null) => {
                if (!permissionFormData) return;

                let allKeysForType;
                let currentKeys = new Set(permissionFormData[type]);

                if (type === 'visible_columns') {
                    // 如果是处理“列权限”，则“所有可选列”指的是当前预览视图下的列
                    allKeysForType = columnDefinitions.filter(c => (viewColumnMap[context] || []).includes(c.key)).map(c => c.key);
                } else {
                    // 其他类型（角色、视图）的全选逻辑不变
                    const allKeysMap = {
                        roles: availableRoles.map(r => r.key),
                        visible_views: viewConfig.filter(v => v.key).map(v => v.key),
                    };
                    allKeysForType = allKeysMap[type];
                }

                const areAllSelected = allKeysForType.every(key => currentKeys.has(key));

                if (areAllSelected) {
                    // 如果已全选，则从当前权限中“减去”这些key
                    allKeysForType.forEach(key => currentKeys.delete(key));
                } else {
                    // 如果未全选，则向当前权限中“加入”这些key
                    allKeysForType.forEach(key => currentKeys.add(key));
                }

                setPermissionFormData(prev => ({ ...prev, [type]: Array.from(currentKeys) }));
            };
            // --- 添加结束 ---
            // --- 在此添加新代码 ---
            const getSelectedUsersText = () => {
                const targetIds = Array.from(permissionTargetUsers);
                if (targetIds.length === 0) {
                    return '';
                }

                // 使用我们之前创建好的 userMap 来高效地获取用户名
                const selectedNames = targetIds.map(id => userMap.get(id) || '未知用户');

                if (targetIds.length === 1) {
                    return selectedNames[0];
                }

                // 当选择多个用户时，列出他们的名字，并附上总数
                return `${selectedNames.join(', ')} (共 ${targetIds.length} 位)`;
            };
            // --- 添加结束 ---
            // --- 添加结束 ---
            if (!isOpen) return null;
            // --- 在您的 TeamManagementModal 组件内部，使用这个 return 语句 ---
            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    {/* --- 【修改点】为弹窗根元素添加响应式宽度 --- */}
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-full md:max-w-4xl lg:max-w-6xl max-h-[90vh] flex flex-col text-gray-800 dark:text-gray-200">
                        <header className="flex justify-between items-center p-5 border-b border-gray-200 dark:border-slate-700 flex-shrink-0">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">团队管理</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X /></button>
                        </header>

                        <div className="flex flex-grow min-h-0 flex-col md:flex-row"> {/* 【修改点】主布局在移动端垂直堆叠 */}
                            {/* --- 【修改点】左侧导航区适应移动端 --- */}
                            <div className="w-full md:w-48 flex-shrink-0 bg-slate-50 dark:bg-slate-800/50 p-2 md:p-4 border-b md:border-b-0 md:border-r dark:border-slate-700">
                                <nav className="flex flex-row md:flex-col gap-2 overflow-x-auto md:overflow-x-visible">
                                    <button onClick={() => setActiveView('member_management')} className={`px-3 py-2 text-left rounded-md font-semibold text-sm flex-shrink-0 ${activeView === 'member_management' ? 'bg-emerald-500 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}`}>成员管理</button>
                                    <button onClick={() => setActiveView('role_management')} className={`px-3 py-2 text-left rounded-md font-semibold text-sm flex-shrink-0 ${activeView === 'role_management' ? 'bg-emerald-500 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}`}>角色管理</button>
                                    <button onClick={() => setActiveView('process_management')} className={`px-3 py-2 text-left rounded-md font-semibold text-sm flex-shrink-0 ${activeView === 'process_management' ? 'bg-emerald-500 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}`}>流程管理</button>
                                    <button onClick={() => setActiveView('function_permission')} className={`px-3 py-2 text-left rounded-md font-semibold text-sm flex-shrink-0 ${activeView === 'function_permission' ? 'bg-emerald-500 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}`}>功能权限</button>
                                    <button onClick={() => setActiveView('task_permission')} className={`px-3 py-2 text-left rounded-md font-semibold text-sm flex-shrink-0 ${activeView === 'task_permission' ? 'bg-emerald-500 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}`}>任务权限</button>
                                    <button onClick={() => setActiveView('permission_config')} className={`px-3 py-2 text-left rounded-md font-semibold text-sm flex-shrink-0 ${activeView === 'permission_config' ? 'bg-emerald-500 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}`}>权限配置</button>
                                </nav>
                            </div>

                            <div className="flex-grow flex flex-col min-h-0">
                                {activeView === 'member_management' && (
                                    <div className="p-4 md:p-6 flex-grow overflow-y-auto flex flex-col gap-4">
                                        <div className="p-4 bg-slate-50 dark:bg-slate-800 rounded-lg border dark:border-slate-700">
                                            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">邀请新成员</label>
                                            <div className="flex flex-col sm:flex-row gap-2">
                                                <input type="email" value={inviteEmail} onChange={(e) => setInviteEmail(e.target.value)} placeholder="输入新成员的邮箱地址" className="flex-grow pl-4 pr-4 py-2 w-full border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" />
                                                <button onClick={handleInviteUser} className="px-5 py-2 font-semibold text-white bg-emerald-500 rounded-md hover:bg-emerald-600 flex-shrink-0">发送邀请</button>
                                            </div>
                                        </div>

                                        {/* 顶部操作区 */}
                                        <div className="flex flex-col md:flex-row justify-between items-center gap-4 flex-wrap">
                                            <div className="flex items-center gap-4 flex-wrap">
                                                <div className="flex items-center gap-1 p-1 bg-slate-100 dark:bg-slate-800 rounded-lg">
                                                    <button onClick={() => setDepartmentFilter('技术部门')} className={`px-3 py-1.5 text-sm font-semibold rounded-md transition-colors ${departmentFilter === '技术部门' ? 'bg-white dark:bg-slate-700 shadow' : 'hover:bg-slate-200 dark:hover:bg-slate-700/50'}`}>技术部门</button>
                                                    <button onClick={() => setDepartmentFilter('市场部门')} className={`px-3 py-1.5 text-sm font-semibold rounded-md transition-colors ${departmentFilter === '市场部门' ? 'bg-white dark:bg-slate-700 shadow' : 'hover:bg-slate-200 dark:hover:bg-slate-700/50'}`}>业务部门</button>
                                                </div>
                                                {selectedUsers.size > 0 && (() => {
                                                    const selectedUserDetails = users.filter(u => selectedUsers.has(u.id));
                                                    const canBulkApprove = selectedUserDetails.length > 0 && selectedUserDetails.every(u => u.role === 'pending');
                                                    const canBulkRevokeOrTransfer = selectedUserDetails.length > 0 && selectedUserDetails.every(u => u.role === 'approved');
                                                    return (
                                                        <div className="flex items-center gap-2 p-1 border-l dark:border-slate-700 ml-2">
                                                            <span className="text-sm font-semibold text-sky-800 dark:text-sky-200 pl-1">已选 {selectedUsers.size}:</span>
                                                            {canBulkApprove && <button onClick={handleBulkApprove} className="px-3 py-1 text-sm font-semibold text-white bg-emerald-500 rounded-md hover:bg-emerald-600">批准</button>}
                                                            {canBulkRevokeOrTransfer && <>
                                                                <button onClick={handleBulkRevoke} className="px-3 py-1 text-sm font-semibold text-white bg-amber-500 rounded-md hover:bg-amber-600">撤销</button>
                                                                <button onClick={handleBulkTransfer} className="px-3 py-1 text-sm font-semibold text-white bg-blue-500 rounded-md hover:bg-blue-600">转移部门</button>
                                                            </>}
                                                            <button onClick={handleBulkDeleteClick} className="px-3 py-1 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600">删除</button>
                                                        </div>
                                                    )
                                                })()}
                                            </div>
                                            <div className="relative w-full md:max-w-xs">
                                                <Search size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                                                <input type="text" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="按邮箱搜索..." className="pl-11 pr-4 py-2 w-full border rounded-lg bg-slate-50 dark:bg-slate-700" />
                                            </div>
                                        </div>

                                        {/* 表格 */}
                                        <div className="overflow-x-auto border rounded-lg dark:border-slate-700">
                                            <table className="w-full text-sm">
                                                <thead className="text-left text-slate-500 dark:text-slate-400 bg-slate-50 dark:bg-slate-800">
                                                    <tr>
                                                        <th className="px-4 py-3 w-10"><input type="checkbox" ref={selectAllCheckboxRef} onChange={handleSelectAll} /></th>
                                                        <th className="px-4 py-3">用户名</th>
                                                        <th className="px-4 py-3">邮箱地址</th>
                                                        <th className="px-4 py-3">角色状态</th>
                                                        <th className="px-4 py-3">创建时间</th>
                                                        <th className="px-4 py-3">最后登录</th>
                                                        <th className="px-4 py-3 text-center">操作</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-200 dark:divide-slate-700">
                                                    {currentUsers.map(user => (
                                                        <tr key={user.id}>
                                                            <td className="px-4 py-4"><input type="checkbox" checked={selectedUsers.has(user.id)} onChange={() => handleSelectUser(user.id)} /></td>
                                                            <td className="px-4 py-4 font-semibold">{userMap.get(user.id) || user.email}</td>
                                                            <td className="px-4 py-4">{user.email}</td>
                                                            <td className="px-4 py-4"><span className={`px-2 py-1 text-xs font-semibold rounded-full ${user.role === 'approved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>{roleMap[user.role] || user.role}</span></td>
                                                            <td className="px-4 py-4">{new Date(user.created_at).toLocaleString()}</td>
                                                            <td className="px-4 py-4">{user.last_sign_in_at ? new Date(user.last_sign_in_at).toLocaleString() : '从未'}</td>
                                                            <td className="px-4 py-4 text-center">
                                                                <div className="flex justify-center items-center gap-4">
                                                                    {user.role === 'pending' && <button onClick={() => handleApproveUser(user.id)} className="font-semibold text-emerald-500">批准</button>}
                                                                    {user.role === 'approved' && <>
                                                                        <button onClick={() => handleRevokeUser(user.id)} className="font-semibold text-amber-500">撤销</button>
                                                                        <button onClick={() => handleTransferDepartment(user)} className="font-semibold text-blue-500">转移部门</button>
                                                                    </>}
                                                                    <button onClick={() => handleDeleteClick(user.id, user.email)} className="font-semibold text-red-500">删除</button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        {filteredUsers.length === 0 && <div className="text-center py-16">没有找到用户。</div>}
                                    </div>
                                )}
                                {activeView === 'role_management' && (
                                    <>
                                        <div className="p-6 flex-grow overflow-y-auto">
                                            <div className="flex justify-between items-center gap-4 mb-4">
                                                <div className="relative w-full max-w-xs">
                                                    <Search size={18} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400" />
                                                    <input
                                                        type="text"
                                                        value={roleSearchTerm}
                                                        onChange={(e) => setRoleSearchTerm(e.target.value)}
                                                        className="w-full bg-white border border-gray-300 rounded-lg pl-11 pr-4 py-3 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-800 dark:border-slate-600 dark:text-slate-200"
                                                        placeholder="按角色名称或Key搜索..."
                                                    />
                                                </div>
                                                <button
                                                    onClick={() => handleOpenRoleEditor()}
                                                    className="px-4 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold flex items-center gap-2 text-sm flex-shrink-0"
                                                >
                                                    <Plus size={16} /> 新增角色
                                                </button>
                                            </div>
                                            <div className="space-y-2 border-t dark:border-slate-700 pt-4">
                                                {(filteredRoles || []).map(role => (
                                                    <div key={role.key} className="flex justify-between items-center bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border dark:border-slate-700">
                                                        <div>
                                                            <p className="font-semibold text-gray-800 dark:text-gray-200">{role.label}</p>
                                                            <p className="text-xs text-slate-500 dark:text-slate-400 font-mono mt-1">{role.key}</p>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={() => handleOpenRoleEditor(role)} className="p-2 text-blue-600 hover:bg-blue-100 dark:text-blue-400 dark:hover:bg-blue-900/50 rounded-full" title="编辑">
                                                                <Edit size={16} />
                                                            </button>
                                                            <button onClick={() => handleDeleteRole(role)} className="p-2 text-red-500 hover:bg-red-100 dark:text-red-400 dark:hover:bg-red-900/50 rounded-full" title="删除">
                                                                <Trash2 size={16} />
                                                            </button>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <RoleEditorModal
                                            isOpen={isRoleEditorOpen}
                                            onClose={handleCloseRoleEditor}
                                            onSave={handleSaveRole} // 恢复简单的 onSave
                                            modalError={roleEditorError} // <-- 将错误状态传递进去
                                            role={editingRole}
                                            viewConfig={viewConfig}
                                            columnDefinitions={columnDefinitions}
                                        />
                                    </>
                                )}

                                {activeView === 'process_management' && (
                                    <div className="flex flex-col flex-grow min-h-0">
                                        {/* --- 顶部角色选择区域 --- */}
                                        <div className="p-4 border-b dark:border-slate-700 flex-shrink-0 bg-slate-50 dark:bg-slate-800/50">
                                            <h3 className="font-semibold text-gray-800 dark:text-gray-200">角色权限流程配置</h3>
                                            <p className="text-xs text-slate-500 mt-1">请先选择一个角色，然后为其配置在不同任务状态下的具体操作权限。</p>
                                            <div className="mt-3 max-w-xs">
                                                <SingleSelectDropdown
                                                    options={availableRoles.map(r => ({ label: r.label, value: r.key }))}
                                                    value={editingRoleKey}
                                                    onChange={(val) => setEditingRoleKey(val)}
                                                    placeholder="请选择一个角色以编辑其权限..."
                                                />
                                            </div>
                                        </div>

                                        {/* --- 主配置区域 --- */}
                                        {editingRoleKey ? (
                                            <div className="flex-grow p-4 grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto">                {/* --- 左侧卡片: 视图/状态选择区 --- */}
                                                <div className="lg:col-span-1 bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 shadow-sm p-4 flex flex-col ">
                                                    <div className="pb-3 border-b dark:border-slate-600 flex justify-between items-center">
                                                        <div>
                                                            <h4 className="font-semibold text-gray-800 dark:text-gray-200">选择视图/状态</h4>
                                                            <p className="text-xs text-slate-500 mt-1">为 <span className="font-bold text-emerald-500">{availableRoles.find(r => r.key === editingRoleKey)?.label}</span> 配置</p>
                                                        </div>
                                                        <button
                                                            onClick={() => setEditMode(prev => prev === 'single' ? 'bulk' : 'single')}
                                                            className="text-xs font-semibold text-emerald-600 hover:text-emerald-800 dark:text-emerald-400 dark:hover:text-emerald-300 px-2 py-1 rounded-md bg-emerald-50 hover:bg-emerald-100 dark:bg-emerald-900/50 dark:hover:bg-emerald-900"
                                                        >
                                                            {editMode === 'single' ? '批量模式' : '单点模式'}
                                                        </button>
                                                    </div>

                                                    {/* --- 根据模式显示不同列表 --- */}
                                                    {editMode === 'bulk' ? (
                                                        /* --- 批量模式 --- */
                                                        <>
                                                            <div className="py-3">
                                                                <label className="flex items-center space-x-3 cursor-pointer px-2 py-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md">
                                                                    <input ref={selectAllCheckboxRef} type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600" onChange={handleSelectAllViews} checked={selectedViewKeys.size > 0 && selectedViewKeys.size === viewConfig.filter(v => v.key && v.key !== 'overview' && v.key !== 'deleted').length} />
                                                                    <span className="font-semibold text-sm">全选</span>
                                                                </label>
                                                            </div>
                                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
                                                                {viewsForProcessManagement.map(view => {
                                                                    <label key={view.key} className="flex items-center p-2 gap-3 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-md cursor-pointer">
                                                                        <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600" checked={selectedViewKeys.has(view.key)} onChange={() => handleViewSelectionChange(view.key)} />
                                                                        <span className="text-sm">{view.label}</span>
                                                                    </label>
                                                                })}
                                                            </div>
                                                        </>
                                                    ) : (
                                                        /* --- 单点导航模式 --- */
                                                        <div className="grid grid-cols-2 gap-x-4 gap-y-1">
                                                            {viewsForProcessManagement.map(view => {
                                                                const hasPermissions = processPermissions[view.key] && processPermissions[view.key].size > 0;
                                                                return (
                                                                    <button
                                                                        key={view.key}
                                                                        onClick={() => setSingleSelectedViewKey(view.key)}
                                                                        className={`w-full flex items-center p-2 gap-3 text-left rounded-md transition-colors ${singleSelectedViewKey === view.key ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}
                                                                    >
                                                                        <span className={`h-2 w-2 rounded-full ${hasPermissions ? 'bg-emerald-500' : 'bg-slate-300 dark:bg-slate-600'}`}></span>
                                                                        <span className={`text-sm ${singleSelectedViewKey === view.key ? 'font-semibold text-emerald-800 dark:text-emerald-300' : ''}`}>{view.label}</span>
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    )}
                                                </div>

                                                {/* --- 右侧卡片: 权限编辑区 --- */}
                                                <div className="lg:col-span-2 bg-white dark:bg-slate-800 rounded-xl border dark:border-slate-700 shadow-sm p-4 ">
                                                    <h4 className="font-semibold text-gray-800 dark:text-gray-200 pb-3 border-b dark:border-slate-600">
                                                        可用操作配置
                                                    </h4>

                                                    {(editMode === 'bulk' && selectedViewKeys.size === 0) || (editMode === 'single' && !singleSelectedViewKey) ? (
                                                        <div className="text-center text-slate-500 dark:text-slate-400 py-16">
                                                            <Settings size={40} className="mx-auto text-gray-300 dark:text-gray-600" />
                                                            <p className="mt-4 text-sm">
                                                                {editMode === 'bulk' ? '请从左侧选择一个或多个视图' : '请从左侧选择一个视图进行配置'}
                                                            </p>
                                                        </div>
                                                    ) : (
                                                        <div className="space-y-5 pt-4">
                                                            {/* --- 常规操作 分组 --- */}
                                                            <div>
                                                                <h5 className="font-semibold text-sm text-slate-600 dark:text-slate-300 mb-3">常规操作</h5>
                                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                                                    {ACTION_DEFINITIONS.filter(a => ['edit', 'archive'].includes(a.key)).map(action => (
                                                                        <label key={action.key} className="flex items-center space-x-2 cursor-pointer p-1">
                                                                            <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600" checked={
                                                                                editMode === 'single' ?
                                                                                    (processPermissions[singleSelectedViewKey]?.has(action.key) || false) :
                                                                                    (selectedViewKeys.size > 0 && Array.from(selectedViewKeys).every(v => processPermissions[v]?.has(action.key)))
                                                                            } onChange={() => handleProcessPermissionChange(action.key)} />
                                                                            <span className="text-sm">{action.label}</span>
                                                                        </label>
                                                                    ))}
                                                                </div>
                                                            </div>

                                                            {/* --- 流程操作 分组 --- */}
                                                            <div>
                                                                <h5 className="font-semibold text-sm text-slate-600 dark:text-slate-300 mb-3">流程操作</h5>
                                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                                                    {ACTION_DEFINITIONS.filter(a => ['assign', 'submit', 'return', 'transfer', 'emergency'].includes(a.key)).map(action => (
                                                                        <label key={action.key} className="flex items-center space-x-2 cursor-pointer p-1">
                                                                            <input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600" checked={
                                                                                editMode === 'single' ?
                                                                                    (processPermissions[singleSelectedViewKey]?.has(action.key) || false) :
                                                                                    (selectedViewKeys.size > 0 && Array.from(selectedViewKeys).every(v => processPermissions[v]?.has(action.key)))
                                                                            } onChange={() => handleProcessPermissionChange(action.key)} />
                                                                            <span className="text-sm">{action.label}</span>
                                                                        </label>
                                                                    ))}
                                                                </div>
                                                            </div>

                                                            {/* --- 危险操作 分组 --- */}
                                                            <div className="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/50 rounded-lg">
                                                                <h5 className="font-semibold text-sm text-red-700 dark:text-red-300 mb-3 flex items-center gap-2"><AlertTriangle size={14} />危险操作</h5>
                                                                <div className="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                                                    {ACTION_DEFINITIONS.filter(a => ['void', 'delete'].includes(a.key)).map(action => (
                                                                        <label key={action.key} className="flex items-center space-x-2 cursor-pointer p-1">
                                                                            <input type="checkbox" className="form-checkbox h-4 w-4 text-red-600" checked={
                                                                                editMode === 'single' ?
                                                                                    (processPermissions[singleSelectedViewKey]?.has(action.key) || false) :
                                                                                    (selectedViewKeys.size > 0 && Array.from(selectedViewKeys).every(v => processPermissions[v]?.has(action.key)))
                                                                            } onChange={() => handleProcessPermissionChange(action.key)} />
                                                                            <span className="text-sm">{action.label}</span>
                                                                        </label>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="flex-grow flex items-center justify-center">
                                                <div className="text-center text-slate-500">
                                                    <Users size={48} className="mx-auto text-gray-300 dark:text-gray-600" />
                                                    <p className="mt-4">请从上方选择一个角色开始配置权限</p>
                                                </div>
                                            </div>
                                        )}
                                        {/* --- 脚部操作区 --- */}
                                        <div className="p-4 border-t dark:border-slate-700 flex-shrink-0 flex justify-end bg-slate-50 dark:bg-slate-800/50">
                                            <button
                                                onClick={handleSaveProcessPermissions}
                                                disabled={!editingRoleKey}
                                                className="px-6 py-2 font-semibold text-white bg-emerald-600 rounded-md hover:bg-emerald-700 disabled:bg-slate-400 disabled:cursor-not-allowed"
                                            >
                                                保存对此角色的设置
                                            </button>
                                        </div>
                                    </div>
                                )}

                                {/* --- 新增的“功能权限”面板 --- */}
                                {activeView === 'function_permission' && (
                                    <div className="flex flex-col flex-grow min-h-0">
                                        <div className="p-4 border-b dark:border-slate-700 flex-shrink-0 bg-slate-50 dark:bg-slate-800/50">
                                            <h3 className="font-semibold text-gray-800 dark:text-gray-200">应用功能权限配置</h3>
                                            <p className="text-xs text-slate-500 mt-1">为不同角色开启或关闭创建任务、导入导出等全局性应用功能。</p>
                                        </div>
                                        <div className="flex flex-grow min-h-0">
                                            {/* --- 左侧角色选择列表 --- */}
                                            <div className="w-1/3 flex-shrink-0 border-r dark:border-slate-700 flex flex-col bg-white dark:bg-slate-800/50">
                                                <div className="p-2 flex-grow overflow-y-auto">
                                                    {availableRoles.map(role => (
                                                        <button
                                                            key={role.key}
                                                            onClick={() => setEditingFuncPermsForRole(role.key)}
                                                            className={`w-full text-left p-3 rounded-md transition-colors ${editingFuncPermsForRole === role.key ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}
                                                        >
                                                            <p className={`font-semibold ${editingFuncPermsForRole === role.key ? 'text-emerald-800 dark:text-emerald-300' : ''}`}>{role.label}</p>
                                                            <p className={`text-xs font-mono ${editingFuncPermsForRole === role.key ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400'}`}>{role.key}</p>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            {/* --- 这是修改后的右侧权限配置区 --- */}
                                            <div className="w-2/3 flex flex-col">
                                                {editingFuncPermsForRole ? (
                                                    <>
                                                        {/* 1. 主要内容区域：设置为可滚动 */}
                                                        <div className="flex-grow p-6 overflow-y-auto">
                                                            <div className="space-y-6">
                                                                <h4 className="font-semibold text-gray-800 dark:text-gray-200">
                                                                    正在为 <span className="text-emerald-500">【{availableRoles.find(r => r.key === editingFuncPermsForRole)?.label}】</span> 配置权限
                                                                </h4>
                                                                <div className="space-y-4">
                                                                    {/* ... 所有权限的 <label> 和 <input> 都在这里 (这部分内容不变) ... */}
                                                                    <label className="flex items-center justify-between p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
                                                                        <div>
                                                                            <p className="font-semibold">创建任务</p>
                                                                            <p className="text-xs text-slate-500">允许用户使用“创建任务”按钮和功能。</p>
                                                                        </div>
                                                                        <input type="checkbox" className="form-checkbox h-5 w-5 text-emerald-600" checked={!!currentFuncPerms.can_create_task} onChange={e => setCurrentFuncPerms(p => ({ ...p, can_create_task: e.target.checked }))} />
                                                                    </label>
                                                                    <label className="flex items-center justify-between p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
                                                                        <div>
                                                                            <p className="font-semibold">导入数据</p>
                                                                            <p className="text-xs text-slate-500">允许用户使用数据导入功能。</p>
                                                                        </div>
                                                                        <input type="checkbox" className="form-checkbox h-5 w-5 text-emerald-600" checked={!!currentFuncPerms.can_import_data} onChange={e => setCurrentFuncPerms(p => ({ ...p, can_import_data: e.target.checked }))} />
                                                                    </label>
                                                                    <label className="flex items-center justify-between p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
                                                                        <div>
                                                                            <p className="font-semibold">导出数据</p>
                                                                            <p className="text-xs text-slate-500">允许用户使用数据导出功能。</p>
                                                                        </div>
                                                                        <input type="checkbox" className="form-checkbox h-5 w-5 text-emerald-600" checked={!!currentFuncPerms.can_export_data} onChange={e => setCurrentFuncPerms(p => ({ ...p, can_export_data: e.target.checked }))} />
                                                                    </label>
                                                                    <label className="flex items-center justify-between p-4 rounded-lg bg-slate-50 dark:bg-slate-800/50 border dark:border-slate-700">
                                                                        <div>
                                                                            <p className="font-semibold">查看统计</p>
                                                                            <p className="text-xs text-slate-500">允许用户访问统计面板。</p>
                                                                        </div>
                                                                        <input type="checkbox" className="form-checkbox h-5 w-5 text-emerald-600" checked={!!currentFuncPerms.can_view_statistics} onChange={e => setCurrentFuncPerms(p => ({ ...p, can_view_statistics: e.target.checked }))} />
                                                                    </label>
                                                                    <label className="flex items-center justify-between p-4 rounded-lg bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-700/50">
                                                                        <div>
                                                                            <p className="font-semibold text-orange-800 dark:text-orange-300">管理配置</p>
                                                                            <p className="text-xs text-orange-600 dark:text-orange-400">允许用户访问“管理配置”模块。</p>
                                                                        </div>
                                                                        <input type="checkbox" className="form-checkbox h-5 w-5 text-orange-600" checked={!!currentFuncPerms.can_manage_config} onChange={e => setCurrentFuncPerms(p => ({ ...p, can_manage_config: e.target.checked }))} />
                                                                    </label>
                                                                    <label className="flex items-center justify-between p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700/50">
                                                                        <div>
                                                                            <p className="font-semibold text-red-800 dark:text-red-300">团队管理</p>
                                                                            <p className="text-xs text-red-600 dark:text-red-400">允许用户访问“团队管理”模块（最高权限）。</p>
                                                                        </div>
                                                                        <input type="checkbox" className="form-checkbox h-5 w-5 text-red-600" checked={!!currentFuncPerms.can_manage_teams} onChange={e => setCurrentFuncPerms(p => ({ ...p, can_manage_teams: e.target.checked }))} />
                                                                    </label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        {/* 2. 脚部区域：固定在底部，不再被挤走 */}
                                                        <div className="p-4 border-t dark:border-slate-700 flex-shrink-0 flex justify-end bg-slate-50 dark:bg-slate-800/50">
                                                            <button
                                                                onClick={handleSaveFuncPermissions}
                                                                className="px-6 py-2 font-semibold text-white bg-emerald-600 rounded-md hover:bg-emerald-700">
                                                                保存功能权限
                                                            </button>
                                                        </div>
                                                    </>
                                                ) : (
                                                    <div className="flex-grow flex items-center justify-center text-center text-slate-500">
                                                        <div>
                                                            <Users size={48} className="mx-auto text-gray-300 dark:text-gray-600" />
                                                            <p className="mt-4">请从左侧选择一个角色开始配置</p>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                )}
                                {/* --- 【最终版】“任务权限”标签页，实现了真正的分组配置 --- */}
                                {activeView === 'task_permission' && (() => {


                                    // 切换可见视图时的处理逻辑
                                    const handleViewToggle = (viewKey, isChecked) => {
                                        const newViews = new Set(currentVisPerms.default_views || []);
                                        const newCols = { ...(currentVisPerms.default_columns || {}) };

                                        if (isChecked) {
                                            newViews.add(viewKey);
                                            // 默认全选逻辑：如果这个视图之前没有配置过，就为它添加所有列
                                            if (!newCols[viewKey]) {
                                                newCols[viewKey] = viewColumnMap[viewKey] || [];
                                            }
                                        } else {
                                            newViews.delete(viewKey);
                                            // 删除视图的同时，也删除它对应的列配置
                                            delete newCols[viewKey];
                                            if (editingView === viewKey) {
                                                setEditingView(null);
                                            }
                                        }

                                        setCurrentVisPerms({
                                            default_views: Array.from(newViews).sort(),
                                            default_columns: newCols
                                        });
                                    };

                                    // 切换单个列的可见性
                                    const handleColumnToggle = (colKey, isChecked) => {
                                        const newColsForView = new Set(currentVisPerms.default_columns[editingView] || []);
                                        if (isChecked) {
                                            newColsForView.add(colKey);
                                        } else {
                                            newColsForView.delete(colKey);
                                        }
                                        setCurrentVisPerms(p => ({
                                            ...p,
                                            default_columns: {
                                                ...p.default_columns,
                                                [editingView]: Array.from(newColsForView)
                                            }
                                        }));
                                    };

                                    return (
                                        <div className="flex flex-col flex-grow min-h-0">
                                            <div className="p-4 border-b dark:border-slate-700 flex-shrink-0 bg-slate-50 dark:bg-slate-800/50">
                                                <h3 className="font-semibold text-gray-800 dark:text-gray-200">任务权限配置 (角色模板)</h3>
                                                <p className="text-xs text-slate-500 mt-1">为角色勾选可见视图，然后点击视图按钮，为其单独配置可见列。</p>
                                            </div>
                                            <div className="flex flex-grow min-h-0">
                                                <div className="w-1/3 flex-shrink-0 border-r dark:border-slate-700 flex flex-col bg-white dark:bg-slate-800/50">
                                                    {/* 角色列表... */}
                                                    <div className="p-2 flex-grow overflow-y-auto">
                                                        {availableRoles.map(role => (
                                                            <button key={role.key} onClick={() => setEditingVisPermsForRole(role.key)}
                                                                className={`w-full text-left p-3 rounded-md transition-colors ${editingVisPermsForRole === role.key ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}>
                                                                <p className={`font-semibold ${editingVisPermsForRole === role.key ? 'text-emerald-800 dark:text-emerald-300' : ''}`}>{role.label}</p>
                                                                <p className={`text-xs font-mono ${editingVisPermsForRole === role.key ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400'}`}>{role.key}</p>
                                                            </button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="w-2/3 flex flex-col">
                                                    <div className="flex-grow p-6 overflow-y-auto">
                                                        {editingVisPermsForRole ? (
                                                            <div className="space-y-6">
                                                                <h4 className="font-semibold text-gray-800 dark:text-gray-200">为 <span className="text-emerald-500">【{availableRoles.find(r => r.key === editingVisPermsForRole)?.label}】</span> 配置</h4>
                                                                <div className="space-y-3">
                                                                    <label className="block text-sm font-medium">1. 选择角色可访问的视图</label>
                                                                    <div className="p-4 border dark:border-slate-700 rounded-lg grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3 bg-slate-50/50 dark:bg-slate-800/20">
                                                                        {viewConfig.filter(v => v.key).map(view => (
                                                                            <label key={view.key} className="flex items-center space-x-2 cursor-pointer">
                                                                                <input type="checkbox" className="form-checkbox"
                                                                                    checked={(currentVisPerms.default_views || []).includes(view.key)}
                                                                                    onChange={(e) => handleViewToggle(view.key, e.target.checked)} />
                                                                                <span className="text-sm dark:text-slate-300">{view.label}</span>
                                                                            </label>
                                                                        ))}
                                                                    </div>
                                                                </div>
                                                                <div className="space-y-3">
                                                                    <label className="block text-sm font-medium">2. 点击已选视图，为其单独配置可见列</label>
                                                                    <div className="flex flex-wrap gap-2 p-2 border dark:border-slate-700 rounded-lg bg-slate-50/50 dark:bg-slate-800/20">
                                                                        {(currentVisPerms.default_views || []).map(viewKey => {
                                                                            const view = viewConfig.find(v => v.key === viewKey);
                                                                            return (
                                                                                <button key={viewKey} onClick={() => setEditingView(viewKey)}
                                                                                    className={`px-3 py-1 rounded-md text-sm font-semibold transition-colors ${editingView === viewKey ? 'bg-emerald-500 text-white shadow-md' : 'bg-white hover:bg-slate-100 dark:bg-slate-700 dark:hover:bg-slate-600'}`}>
                                                                                    {view.label}
                                                                                </button>
                                                                            );
                                                                        })}
                                                                    </div>
                                                                    {editingView && (
                                                                        <div className="p-4 border dark:border-slate-700 rounded-lg grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3 bg-white dark:bg-slate-800 animate-fade-in">
                                                                            {(viewColumnMap[editingView] || []).map(colKey => {
                                                                                const column = columnDefinitions.find(c => c.key === colKey);
                                                                                if (!column) return null;
                                                                                return (
                                                                                    <label key={colKey} className="flex items-center space-x-2 cursor-pointer">
                                                                                        <input type="checkbox" className="form-checkbox"
                                                                                            checked={(currentVisPerms.default_columns?.[editingView] || []).includes(colKey)}
                                                                                            onChange={(e) => handleColumnToggle(colKey, e.target.checked)} />
                                                                                        <span className="text-sm dark:text-slate-300">{column.label}</span>
                                                                                    </label>
                                                                                );
                                                                            })}
                                                                        </div>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex h-full items-center justify-center text-center text-slate-500">
                                                                <p>请从左侧选择一个角色开始配置</p>
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="p-4 border-t dark:border-slate-700 flex-shrink-0 flex justify-end">
                                                        <button onClick={handleSaveVisPermissions} disabled={!editingVisPermsForRole}
                                                            className="px-6 py-2 font-semibold text-white bg-green-600 rounded-md hover:bg-green-700 disabled:bg-slate-400 disabled:cursor-not-allowed">
                                                            保存任务权限
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                                {activeView === 'permission_config' && (
                                    <div className="flex flex-col flex-grow min-h-0">
                                        <div className="p-4 border-b dark:border-slate-700 flex-shrink-0 bg-slate-50 dark:bg-slate-800/50">
                                            <h3 className="font-semibold text-gray-800 dark:text-gray-200">用户权限分配</h3>
                                            <p className="text-xs text-slate-500 mt-1">为具体用户分配角色，并可选择性地微调其权限（设置特权）。</p>
                                        </div>
                                        <div className="flex flex-grow min-h-0">
                                            {/* --- 左侧用户选择列表 --- */}
                                            <div className="w-1/3 flex-shrink-0 border-r dark:border-slate-700 flex flex-col bg-white dark:bg-slate-800/50">
                                                <div className="p-2 flex-grow overflow-y-auto">
                                                    {users.map(user => (
                                                        <button
                                                            key={user.id}
                                                            onClick={() => setEditingUserId(user.id)}
                                                            className={`w-full text-left p-3 rounded-md transition-colors ${editingUserId === user.id ? 'bg-emerald-100 dark:bg-emerald-900/50' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}
                                                        >
                                                            <p className={`font-semibold ${editingUserId === user.id ? 'text-emerald-800 dark:text-emerald-300' : ''}`}>{userMap.get(user.id) || user.email}</p>
                                                            <p className={`text-xs ${editingUserId === user.id ? 'text-emerald-600 dark:text-emerald-400' : 'text-slate-400'}`}>{user.email}</p>
                                                        </button>
                                                    ))}
                                                </div>
                                            </div>
                                            {/* --- 右侧配置区 --- */}
                                            <div className="w-2/3 flex flex-col">
                                                <div className="flex-grow p-6 overflow-y-auto">
                                                    {editingUserId ? (
                                                        <div className="space-y-6">
                                                            <h4 className="font-semibold text-gray-800 dark:text-gray-200">
                                                                正在为 <span className="text-emerald-500">【{userMap.get(editingUserId)}】</span> 配置权限
                                                            </h4>
                                                            {/* --- 角色分配 (改为多列复选框) --- */}
                                                            <div className="space-y-3">
                                                                <label className="block text-sm font-medium text-gray-700 dark:text-gray-400">角色分配</label>
                                                                <div className="p-4 border dark:border-slate-700 rounded-lg bg-slate-50/50 dark:bg-slate-800/20 space-y-4">
                                                                    {/* --- 基础角色 --- */}
                                                                    <div className="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                                                        {availableRoles.filter(r => r.key !== 'department_head').map(role => (
                                                                            <label key={role.key} className="flex items-center space-x-2 cursor-pointer">
                                                                                <input
                                                                                    type="checkbox"
                                                                                    className="form-checkbox h-4 w-4 text-emerald-600"
                                                                                    checked={(currentUserPermsDetail.roles || []).some(p => p.role === role.key)}
                                                                                    onChange={(e) => {
                                                                                        const newPerms = [...(currentUserPermsDetail.roles || [])];
                                                                                        if (e.target.checked) {
                                                                                            newPerms.push({ role: role.key });
                                                                                        } else {
                                                                                            const index = newPerms.findIndex(p => p.role === role.key);
                                                                                            if (index > -1) newPerms.splice(index, 1);
                                                                                        }
                                                                                        setCurrentUserPermsDetail(p => ({ ...p, roles: newPerms }));
                                                                                    }}
                                                                                />
                                                                                <span className="text-sm dark:text-slate-300">{role.label}</span>
                                                                            </label>
                                                                        ))}
                                                                    </div>

                                                                    {/* --- 部门负责人 (细化) --- */}
                                                                    <div className="pt-4 border-t dark:border-slate-600">
                                                                        <h5 className="text-sm font-semibold mb-3">部门负责人</h5>
                                                                        <div className="grid grid-cols-2 md:grid-cols-3 gap-x-6 gap-y-3">
                                                                            {allDepartments.map(deptInfo => (
                                                                                <label key={deptInfo.dept} className="flex items-center space-x-2 cursor-pointer">
                                                                                    <input
                                                                                        type="checkbox"
                                                                                        className="form-checkbox h-4 w-4 text-emerald-600"
                                                                                        checked={(currentUserPermsDetail.roles || []).some(p => p.role === 'department_head' && p.department === deptInfo.dept)}
                                                                                        onChange={(e) => {
                                                                                            const newPerms = [...(currentUserPermsDetail.roles || [])];
                                                                                            const permIndex = newPerms.findIndex(p => p.role === 'department_head' && p.department === deptInfo.dept);

                                                                                            if (e.target.checked) {
                                                                                                if (permIndex === -1) {
                                                                                                    newPerms.push({ role: 'department_head', department: deptInfo.dept, department_type: deptInfo.typeKey });
                                                                                                }
                                                                                            } else {
                                                                                                if (permIndex > -1) {
                                                                                                    newPerms.splice(permIndex, 1);
                                                                                                }
                                                                                            }
                                                                                            setCurrentUserPermsDetail(p => ({ ...p, roles: newPerms }));
                                                                                        }}
                                                                                    />
                                                                                    <span className="text-xs dark:text-slate-300">{deptInfo.dept}</span>
                                                                                </label>
                                                                            ))}
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {/* --- 最终生效权限 (只读总览，带明细和滚动条) --- */}
                                                            <div className="space-y-4 pt-4 border-t dark:border-slate-700">
                                                                <h5 className="text-base font-semibold">最终生效权限 (只读总览)</h5>

                                                                {/* --- 新增的外部滚动容器 --- */}
                                                                <div className="space-y-4 max-h-48 overflow-y-auto pr-2">
                                                                    {/* 应用功能 */}
                                                                    <div className="p-4 border dark:border-slate-700 rounded-lg">
                                                                        <div className="flex justify-between items-center mb-2">
                                                                            <p className="font-semibold text-sm">应用功能</p>
                                                                            <button onClick={() => handleOpenOverrideModal('functional')} className="text-xs font-semibold text-emerald-600 hover:underline">权限调整</button>
                                                                        </div>
                                                                        {/* 改为横向标签布局 */}
                                                                        <div className="text-xs text-slate-500 flex flex-wrap gap-2">
                                                                            {Array.from(effectivePermissionsDetails.functional).length > 0 ?
                                                                                Array.from(effectivePermissionsDetails.functional).map(p => <span key={p} className="bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded">{p}</span>) :
                                                                                <p className="text-xs text-slate-400">无</p>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                    {/* 任务操作 */}
                                                                    <div className="p-4 border dark:border-slate-700 rounded-lg">
                                                                        <div className="flex justify-between items-center mb-2">
                                                                            <p className="font-semibold text-sm">任务操作 (流程权限)</p>
                                                                            <button onClick={() => handleOpenOverrideModal('process')} className="text-xs font-semibold text-emerald-600 hover:underline">权限调整</button>
                                                                        </div>
                                                                        <div className="text-xs text-slate-500 flex flex-wrap gap-2">
                                                                            {Array.from(effectivePermissionsDetails.process).length > 0 ?
                                                                                Array.from(effectivePermissionsDetails.process).map(p => <span key={p} className="bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded">{p}</span>) :
                                                                                <p className="text-xs text-slate-400">无</p>
                                                                            }
                                                                        </div>
                                                                    </div>
                                                                    {/* 任务可见 */}
                                                                    <div className="p-4 border dark:border-slate-700 rounded-lg">
                                                                        <div className="flex justify-between items-center mb-2">
                                                                            <p className="font-semibold text-sm">任务可见 (视图与列)</p>
                                                                            <button onClick={() => handleOpenOverrideModal('visibility')} className="text-xs font-semibold text-emerald-600 hover:underline">权限调整</button>
                                                                        </div>
                                                                        <div className="text-xs text-slate-500 space-y-2">
                                                                            {/* 视图和列改为同行显示 */}
                                                                            <div className="flex items-baseline gap-2">
                                                                                <p className="font-medium dark:text-slate-400 flex-shrink-0">视图:</p>
                                                                                <div className="flex flex-wrap gap-1">
                                                                                    {Array.from(effectivePermissionsDetails.visibility.views).length > 0 ? Array.from(effectivePermissionsDetails.visibility.views).map(p => <span key={p} className="bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded">{p}</span>) : <span className="text-xs text-slate-400">无</span>}
                                                                                </div>
                                                                            </div>
                                                                            <div className="flex items-baseline gap-2">
                                                                                <p className="font-medium dark:text-slate-400 flex-shrink-0">列:</p>
                                                                                <div className="flex flex-wrap gap-1">
                                                                                    {Array.from(effectivePermissionsDetails.visibility.columns).length > 0 ? Array.from(effectivePermissionsDetails.visibility.columns).map(p => <span key={p} className="bg-slate-200 dark:bg-slate-700 px-1.5 py-0.5 rounded">{p}</span>) : <span className="text-xs text-slate-400">无</span>}
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="flex h-full items-center justify-center text-center text-slate-500">
                                                            {/* ... 占位符 ... */}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="p-4 border-t dark:border-slate-700 flex-shrink-0 flex justify-end">
                                                    <button
                                                        onClick={handleSaveRoleAssignments}
                                                        disabled={!editingUserId}
                                                        className="px-6 py-2 font-semibold text-white bg-emerald-600 rounded-md hover:bg-emerald-700 disabled:bg-slate-400 disabled:cursor-not-allowed">
                                                        保存角色分配
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <footer className="p-4 flex justify-between items-center bg-gray-50 dark:bg-slate-800/50 border-t dark:border-slate-700 flex-shrink-0">
                                    <div>{filteredUsers.length > 0 && (<p className="text-sm text-slate-500 dark:text-slate-400">正在显示 {indexOfFirstUser + 1}-{Math.min(indexOfLastUser, filteredUsers.length)} 项，共 {filteredUsers.length} 项</p>)}</div>
                                    <div className="flex items-center gap-4">
                                        <Pagination usersPerPage={usersPerPage} totalUsers={filteredUsers.length} paginate={paginate} currentPage={currentPage} />
                                        <button onClick={onClose} className="px-6 py-2 rounded-md bg-gray-200 hover:bg-gray-300 dark:bg-slate-700 dark:hover:bg-slate-600 dark:text-slate-200 font-semibold">关闭</button>
                                    </div>
                                </footer>
                            </div>
                        </div>
                        <ConfirmationModal isOpen={confirmationState.isOpen} onClose={closeConfirmationModal} onConfirm={handleConfirm} title={confirmationState.title} confirmVariant={confirmationState.confirmVariant}>{confirmationState.children}</ConfirmationModal>
                        <PermissionOverrideModal
                            isOpen={isOverrideModalOpen}
                            onClose={() => setIsOverrideModalOpen(false)}
                            onSave={handleSaveUserOverrides}
                            type={overrideType}
                            user={{ id: editingUserId }}
                            userMap={userMap}
                            currentUserPermsDetail={currentUserPermsDetail}
                            rolePermissions={rolePermissions}
                            actionPermissions={actionPermissions}
                            availableRoles={availableRoles}
                            ACTION_DEFINITIONS={ACTION_DEFINITIONS}
                            viewConfig={permissionsScopeForCurrentUser.views}
                            columnDefinitions={permissionsScopeForCurrentUser.columns}
                            viewKeyMap={viewKeyMap}
                            columnKeyMap={columnKeyMap}
                            viewColumnMap={viewColumnMap}
                        />
                    </div>
                </div>
            )
        };
        // ================== 在此处粘贴以下新组件的完整代码 ==================
        const DeptHeadAssignModal = ({ isOpen, onClose, onSave, managementData, currentAssignments, userEmail }) => {
            // 使用一个内部状态来管理弹窗中的修改，只有点击保存时才传递出去
            const [assignments, setAssignments] = useState([]);

            // 当弹窗打开时，用传入的当前指派信息初始化内部状态
            useEffect(() => {
                if (isOpen) {
                    setAssignments(currentAssignments || []);
                }
            }, [isOpen, currentAssignments]);

            if (!isOpen) return null;

            // 添加一个新的指派
            const handleAddAssignment = () => {
                // 默认添加第一个类别的第一个部门
                const firstType = Object.keys(managementData.department_structure)[0];
                const firstDept = managementData.department_structure[firstType].sub_departments[0];

                const newAssignment = {
                    department_type: firstType,
                    department: firstDept,
                };

                // 避免添加重复的指派
                if (!assignments.some(a => a.department === newAssignment.department && a.department_type === newAssignment.department_type)) {
                    setAssignments([...assignments, newAssignment]);
                }
            };

            // 删除一个已有的指派
            const handleRemoveAssignment = (indexToRemove) => {
                setAssignments(assignments.filter((_, index) => index !== indexToRemove));
            };

            // 当下拉框选项变化时，更新对应的指派信息
            const handleAssignmentChange = (index, field, value) => {
                const newAssignments = [...assignments];
                const currentAssignment = { ...newAssignments[index], [field]: value };

                // 如果修改了部门类别，则自动选择该类别下的第一个具体部门
                if (field === 'department_type') {
                    currentAssignment.department = managementData.department_structure[value].sub_departments[0];
                }

                newAssignments[index] = currentAssignment;
                setAssignments(newAssignments);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-[60] flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">部门负责人指派</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">正在为用户: <span className="font-semibold">{userEmail}</span></p>
                        </header>
                        <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                            <h3 className="font-semibold text-gray-700 dark:text-gray-300">当前已指派的部门：</h3>
                            {assignments.length > 0 ? (
                                assignments.map((assign, index) => (
                                    <div key={index} className="grid grid-cols-3 gap-2 items-center p-2 bg-slate-50 dark:bg-slate-800 rounded-md">
                                        <SingleSelectDropdown
                                            options={Object.keys(managementData.department_structure).map(key => ({ label: managementData.department_structure[key].label, value: key }))}
                                            value={assign.department_type}
                                            onChange={(newType) => handleAssignmentChange(index, 'department_type', newType)}
                                        />
                                        <SingleSelectDropdown
                                            options={managementData.department_structure[assign.department_type]?.sub_departments || []}
                                            value={assign.department}
                                            onChange={(newDept) => handleAssignmentChange(index, 'department', newDept)}
                                        />
                                        <button onClick={() => handleRemoveAssignment(index)} className="p-2 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full justify-self-center">
                                            <Trash2 size={16} />
                                        </button>
                                    </div>
                                ))
                            ) : (
                                <p className="text-sm text-gray-500 dark:text-gray-400 text-center py-4">暂未指派任何部门</p>
                            )}
                            <button onClick={handleAddAssignment} className="mt-2 flex items-center gap-2 text-sm text-emerald-600 hover:text-emerald-800 font-semibold">
                                <Plus size={16} /> 添加指派
                            </button>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                            <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button>
                            <button onClick={() => onSave(assignments)} className="px-6 py-2 rounded-md text-white bg-green-600 hover:bg-green-700 font-semibold">确认保存</button>
                        </footer>
                    </div>
                </div>
            );
        };
        // ================== 新组件代码结束 ==================
        const SetPassword = ({ onPasswordSet }) => {
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [message, setMessage] = useState('欢迎！请设置您的初始密码。');

            const handleSetPassword = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                try {
                    const { error } = await supabase.auth.updateUser({ password: password });
                    if (error) throw error;
                    setMessage('密码设置成功！正在带您进入系统...');
                    // 延迟一小会，然后通知父组件密码已设置成功
                    setTimeout(() => {
                        onPasswordSet();
                    }, 1500);
                } catch (error) {
                    setError(error.message);
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-900 flex flex-col justify-center items-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-slate-800 dark:text-slate-100">设置密码</h1>
                        </div>
                        <div className="bg-white dark:bg-slate-800 shadow-xl rounded-xl p-8">
                            <form onSubmit={handleSetPassword}>
                                <p className="text-center text-slate-500 dark:text-slate-400 mb-4">{message}</p>
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">新密码</label>
                                    <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required />
                                </div>
                                {error && <p className="mt-4 text-sm text-center text-red-500">{error}</p>}
                                <div className="mt-8">
                                    <button type="submit" disabled={loading} className="w-full px-6 py-3 rounded-md text-white font-semibold bg-emerald-500 hover:bg-emerald-600 disabled:bg-emerald-300">
                                        {loading ? '设置中...' : '确认并登录'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };
        const ProfileModal = ({ isOpen, onClose, session, showNotification, onProfileUpdate }) => {
            const [displayName, setDisplayName] = useState(session.user.user_metadata?.display_name || '');
            const [newPassword, setNewPassword] = useState('');
            const [loading, setLoading] = useState(false);

            const handleUpdateProfile = async (e) => {
                e.preventDefault();
                setLoading(true);

                const { data: authData, error: authError } = await supabase.auth.updateUser({
                    data: { display_name: displayName } // 这里的 display_name 是我们假设的字段名
                });
                if (authError) {
                    showNotification('更新认证信息失败: ' + authError.message, 'error');
                    setLoading(false);
                    return;
                }

                const { error: profileError } = await supabase
                    .from('profiles')
                    .update({ username: displayName }) // 这里的 username 也是假设的
                    .eq('id', session.user.id);

                if (profileError) {
                    showNotification('同步用户信息失败: ' + profileError.message, 'error');
                    setLoading(false);
                    return;
                }

                // 更新成功！
                showNotification('用户名更新成功！');
                // 调用父组件传来的函数，实现无刷新更新UI
                onProfileUpdate({ id: session.user.id, display_name: displayName });
                setLoading(false);
                onClose(); // 关闭弹窗     
            };

            const handleUpdatePassword = async (e) => {
                e.preventDefault();
                if (newPassword.length < 6) {
                    showNotification('密码长度至少需要6位。', 'error');
                    return;
                }
                setLoading(true);
                const { data, error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                if (error) {
                    showNotification('更新密码失败: ' + error.message, 'error');
                } else {
                    showNotification('密码更新成功！');
                    setNewPassword('');
                    onClose(); // 密码更新成功后自动关闭弹窗
                }
                setLoading(false);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg">
                        <header className="flex justify-between items-center p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">个人资料</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X /></button>
                        </header>
                        <div className="p-6 space-y-6">
                            <form onSubmit={handleUpdateProfile} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">显示名称</label>
                                    <input type="text" value={displayName} onChange={(e) => setDisplayName(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" />
                                </div>
                                <button type="submit" disabled={loading} className="px-4 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold disabled:bg-emerald-300">
                                    {loading ? '保存中...' : '保存名称'}
                                </button>
                            </form>
                            <div className="border-t dark:border-slate-700"></div>
                            <form onSubmit={handleUpdatePassword} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">新密码</label>
                                    <input type="password" value={newPassword} onChange={(e) => setNewPassword(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" placeholder="留空则不修改" />
                                </div>
                                <button type="submit" disabled={loading} className="px-4 py-2 rounded-md text-white bg-blue-500 hover:bg-blue-600 font-semibold disabled:bg-blue-300">
                                    {loading ? '更新中...' : '更新密码'}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };
        // 为了让 closeConfirmationModal 生效，请在组件中添加这个辅助函数
        const closeConfirmationModal = () => {
            setConfirmationState(prev => ({ ...prev, isOpen: false }));
        };
        // --- 【全新可靠版】AssignTaskModal ---
        const AssignTaskModal = ({ isOpen, onClose, onSave, task, title, profiles, userMap }) => {
            const [assignments, setAssignments] = useState({});

            const personnelOptions = useMemo(() => {
                if (!profiles) return { sales: [], tech: [] };

                // 正确：直接从所有用户中筛选出“市场部门”的成员
                const salesOptions = profiles
                    .filter(p => p.department === '市场部门')
                    .map(p => ({ label: userMap.get(p.id) || p.id, value: p.id }));

                // 正确：直接从所有用户中筛选出“技术部门”的成员
                const techOptions = profiles
                    .filter(p => p.department === '技术部门')
                    .map(p => ({ label: userMap.get(p.id) || p.id, value: p.id }));

                return { sales: salesOptions, tech: techOptions };
            }, [profiles, userMap]); // 依赖项不再需要 task

            useEffect(() => {
                if (isOpen && task) {
                    setAssignments({
                        sales_person: task.salesPerson || null,
                        project_manager: task.projectManager || null,
                        auditor_name: task.auditorName || null,
                        rechecker_name: task.recheckerName || null,
                        issuer_name: task.issuerName || null,
                    });
                }
            }, [isOpen, task]);

            if (!isOpen) return null;

            const handleSelect = (roleField, value) => {
                setAssignments(prev => ({ ...prev, [roleField]: value }));
            };
            const handleSubmit = () => {
                if (!assignments.project_manager) {
                    alert('项目负责人不能为空。');
                    return;
                }
                onSave(task, assignments);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold">{title}</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">任务: {generateTaskSummary(task)}</p>                        </header>
                        <div className="p-6 space-y-4 max-h-[60vh] overflow-y-auto">
                            <div><label className="block text-sm font-medium mb-1">项目负责人 (来自: {task?.execution_department || '未知'})</label><SingleSelectDropdown options={personnelOptions.tech} value={assignments.project_manager} onChange={(val) => handleSelect('project_manager', val)} placeholder="选择项目负责人" /></div>
                            <div><label className="block text-sm font-medium mb-1">审核人 (来自: {task?.execution_department || '未知'})</label><SingleSelectDropdown options={personnelOptions.tech} value={assignments.auditor_name} onChange={(val) => handleSelect('auditor_name', val)} placeholder="选择审核人" /></div>
                            <div><label className="block text-sm font-medium mb-1">复核人 (来自: {task?.execution_department || '未知'})</label><SingleSelectDropdown options={personnelOptions.tech} value={assignments.rechecker_name} onChange={(val) => handleSelect('rechecker_name', val)} placeholder="选择复核人" /></div>
                            <div><label className="block text-sm font-medium mb-1">签发人 (来自: {task?.execution_department || '未知'})</label><SingleSelectDropdown options={personnelOptions.tech} value={assignments.issuer_name} onChange={(val) => handleSelect('issuer_name', val)} placeholder="选择签发人" /></div>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl"><button onClick={onClose} className="px-4 py-2 rounded-md font-semibold">取消</button><button onClick={handleSubmit} className="px-6 py-2 rounded-md text-white bg-green-600 font-semibold">确认</button></footer>
                    </div>
                </div>
            );
        };
        // ================== 【新】批量分配弹窗组件 ==================
        const BulkAssignModal = ({ isOpen, onClose, onSave, tasks, profiles, userMap }) => {
            const [assignments, setAssignments] = useState({});

            // 准备“技术部门”的人员选项
            const techOptions = useMemo(() => {
                if (!profiles) return [];
                return profiles
                    .filter(p => p.department === '技术部门')
                    .map(p => ({ label: userMap.get(p.id) || p.id, value: p.id }));
            }, [profiles, userMap]);

            // 弹窗打开时，清空旧数据
            useEffect(() => {
                // 弹窗打开且有选中的任务时，执行预加载逻辑
                if (isOpen && tasks && tasks.length > 0) {
                    const initialAssignments = {};
                    // 定义需要预加载的角色
                    // 键(key)是表单字段名，值(value)是任务对象中的属性名
                    const roleMap = {
                        project_manager: 'projectManager',
                        auditor_name: 'auditorName',
                        rechecker_name: 'recheckerName',
                        issuer_name: 'issuerName'
                    };

                    Object.keys(roleMap).forEach(formKey => {
                        const taskKey = roleMap[formKey];

                        // 以第一个被选中的任务为基准
                        const firstPersonId = tasks[0][taskKey];

                        // 检查其他所有任务的这个角色是否与基准任务相同
                        const allSame = tasks.slice(1).every(task => task[taskKey] === firstPersonId);

                        if (firstPersonId && allSame) {
                            // 如果所有任务都相同且有值，则在下拉框中默认选中这个人
                            initialAssignments[formKey] = firstPersonId;
                        } else {
                            // 如果有任何一个不同，或者第一个就没有值，则下拉框留空
                            initialAssignments[formKey] = null;
                        }
                    });
                    setAssignments(initialAssignments);

                } else if (isOpen) {
                    setAssignments({}); // 如果没有选中任务，则清空
                }
            }, [isOpen, tasks]);

            if (!isOpen) return null;

            const handleSelect = (roleField, value) => {
                setAssignments(prev => ({ ...prev, [roleField]: value }));
            };

            const handleSubmit = () => {
                // 项目负责人是必填项
                if (!assignments.project_manager) {
                    alert('项目负责人不能为空。');
                    return;
                }
                onSave(assignments);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold">批量分配任务</h2>
                            <p className="text-sm text-gray-500 mt-1">
                                为选中的 <span className="font-semibold text-emerald-500">{tasks.length}</span> 个任务统一指派负责人，留空则表示不修改该项。
                            </p>
                        </header>
                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 max-h-[60vh] overflow-y-auto">
                            <div className="md:col-span-2 text-xs text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 p-2 rounded-md">
                                注意：这里的指派将覆盖任务已有的对应人员信息。
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">项目负责人 (必填)</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.project_manager} onChange={(val) => handleSelect('project_manager', val)} placeholder="选择项目负责人" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">审核人</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.auditor_name} onChange={(val) => handleSelect('auditor_name', val)} placeholder="选择审核人" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">复核人</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.rechecker_name} onChange={(val) => handleSelect('rechecker_name', val)} placeholder="选择复核人" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">签发人</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.issuer_name} onChange={(val) => handleSelect('issuer_name', val)} placeholder="选择签发人" />
                            </div>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 rounded-md font-semibold">取消</button>
                            <button onClick={handleSubmit} className="px-6 py-2 rounded-md text-white bg-green-600 font-semibold">确认分配</button>
                        </footer>
                    </div>
                </div>
            );
        };
        // ================== 【新】批量转交弹窗组件 ==================
        const BulkTransferModal = ({ isOpen, onClose, onSave, tasks, profiles, userMap }) => {
            const [assignments, setAssignments] = useState({});

            const techOptions = useMemo(() => {
                if (!profiles) return [];
                return profiles
                    .filter(p => p.department === '技术部门')
                    .map(p => ({ label: userMap.get(p.id) || p.id, value: p.id }));
            }, [profiles, userMap]);

            useEffect(() => {
                if (isOpen && tasks && tasks.length > 0) {
                    const initialAssignments = {};
                    // 定义需要预加载的角色
                    // 键(key)是表单字段名，值(value)是任务对象中的属性名
                    const roleMap = {
                        project_manager: 'projectManager', // 这个是驼峰式
                        auditor_name: 'auditor_name',
                        rechecker_name: 'rechecker_name',
                        issuer_name: 'issuer_name'
                    };

                    Object.keys(roleMap).forEach(formKey => {
                        const taskKey = roleMap[formKey];

                        // 以第一个被选中的任务为基准
                        const firstPersonId = tasks[0][taskKey];

                        // 如果基准任务的这个角色是空的，则无需比较，直接设为空
                        if (!firstPersonId) {
                            initialAssignments[formKey] = null;
                            return;
                        }

                        // 检查其他所有任务的这个角色是否与基准任务相同
                        const allSame = tasks.slice(1).every(task => task[taskKey] === firstPersonId);

                        if (allSame) {
                            // 如果所有任务都相同，则在下拉框中默认选中这个人
                            initialAssignments[formKey] = firstPersonId;
                        } else {
                            // 如果有任何一个不同，则下拉框留空，等待用户统一指定
                            initialAssignments[formKey] = null;
                        }
                    });
                    setAssignments(initialAssignments);

                } else if (isOpen) {
                    setAssignments({}); // 如果没有选中任务，则清空
                }
            }, [isOpen, tasks]); // 依赖项增加了tasks，确保在选中任务变化时能重新计算

            if (!isOpen) return null;

            const handleSelect = (roleField, value) => {
                setAssignments(prev => ({ ...prev, [roleField]: value }));
            };

            const handleSubmit = () => {
                onSave(assignments);
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-2xl">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold">批量转交任务</h2>
                            <p className="text-sm text-gray-500 mt-1">
                                为选中的 <span className="font-semibold text-emerald-500">{tasks.length}</span> 个任务统一指派新的负责人，留空则不修改。
                            </p>
                        </header>
                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 max-h-[60vh] overflow-y-auto">
                            <div className="md:col-span-2 text-xs text-amber-600 dark:text-amber-400 bg-amber-50 dark:bg-amber-900/20 p-2 rounded-md">
                                注意：这里的指派将覆盖任务已有的对应人员信息。
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">新项目负责人</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.project_manager} onChange={(val) => handleSelect('project_manager', val)} placeholder="选择新的项目负责人" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">新审核人</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.auditor_name} onChange={(val) => handleSelect('auditor_name', val)} placeholder="选择新的审核人" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">新复核人</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.rechecker_name} onChange={(val) => handleSelect('rechecker_name', val)} placeholder="选择新的复核人" />
                            </div>
                            <div>
                                <label className="block text-sm font-medium mb-1">新签发人</label>
                                <SingleSelectDropdown options={techOptions} value={assignments.issuer_name} onChange={(val) => handleSelect('issuer_name', val)} placeholder="选择新的签发人" />
                            </div>
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl">
                            <button onClick={onClose} className="px-4 py-2 rounded-md font-semibold">取消</button>
                            <button onClick={handleSubmit} className="px-6 py-2 rounded-md text-white bg-green-600 font-semibold">确认转交</button>
                        </footer>
                    </div>
                </div>
            );
        };
        // ================== 【全新】合同详情侧滑面板 ==================
        const ContractDetailsModal = ({ isOpen, onClose, task }) => {
            if (!isOpen || !task) return null;
            const wrapperRef = useRef(null);
            useOutsideAlerter(wrapperRef, onClose);
            // 辅助组件，用于显示每一条信息，避免重复代码
            const DetailItem = ({ label, children }) => (
                <div>
                    <dt className="text-sm font-medium text-slate-500 dark:text-slate-400">{label}</dt>
                    <dd className="mt-1 text-base text-slate-900 dark:text-slate-100 whitespace-pre-wrap break-words">
                        {children || '--'}
                    </dd>
                </div>
            );

            const details = task.contractDetails || {};

            return (
                <div
                    ref={wrapperRef}
                    className={`absolute top-0 right-0 bottom-0 bg-white dark:bg-slate-900 shadow-2xl z-40 transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : 'translate-x-full'}`}
                    style={{ width: 'clamp(400px, 30vw, 500px)' }} // 使用一个较窄的宽度
                >
                    <div className="flex flex-col h-full">
                        <header className="flex-shrink-0 p-4 border-b border-slate-200 dark:border-slate-700">
                            <div className="flex justify-between items-start">
                                <div className="space-y-1">
                                    <h2 className="text-xl font-bold text-slate-900 dark:text-slate-100">合同详情</h2>
                                    <p className="text-sm text-slate-500 dark:text-slate-400">
                                        任务: <span className="font-mono">{task.customTaskId}</span>
                                    </p>
                                </div>
                                <button onClick={onClose} className="p-2 text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 rounded-full">
                                    <X size={20} />
                                </button>
                            </div>
                        </header>

                        <main className="flex-grow p-6 overflow-y-auto">
                            <dl className="space-y-4">
                                <div className="grid grid-cols-2 gap-4">
                                    <DetailItem label="签订日期">{formatDate(details.signingDate)}</DetailItem>
                                    <DetailItem label="签订单位">{details.signingEntity}</DetailItem>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <DetailItem label="发票类型">{details.invoiceType}</DetailItem>
                                    <DetailItem label="合同管理员">{details.contractAdmin}</DetailItem>
                                </div>
                                <div className="pt-4 border-t dark:border-slate-700">
                                    <DetailItem label="委托单位">{details.clientCompany}</DetailItem>
                                </div>
                                <DetailItem label="委托单位地址">{details.clientAddress}</DetailItem>
                                <div className="grid grid-cols-2 gap-4">
                                    <DetailItem label="委托单位联系人">{details.clientContact}</DetailItem>
                                    <DetailItem label="委托人联系电话">{details.clientPhone}</DetailItem>
                                </div>
                                <div className="pt-4 border-t dark:border-slate-700">
                                    <DetailItem label="服务单位">{details.serviceCompany}</DetailItem>
                                </div>
                                <DetailItem label="服务单位地址">{details.serviceAddress}</DetailItem>
                                <div className="grid grid-cols-2 gap-4">
                                    <DetailItem label="服务单位联系人">{details.serviceContact}</DetailItem>
                                    <DetailItem label="服务人联系电话">{details.servicePhone}</DetailItem>
                                </div>
                                <div className="pt-4 border-t dark:border-slate-700">
                                    <DetailItem label="其他附加内容">{details.additionalInfo}</DetailItem>
                                </div>
                            </dl>
                        </main>
                    </div>
                </div>
            );
        };
        const TaskFlowModal = ({ isOpen, onClose, task, userMap, WORKFLOW_CONFIG, statusLabelMap, session }) => {
            if (!isOpen || !task) return null;
            const wrapperRef = useRef(null);
            useOutsideAlerter(wrapperRef, onClose);
            const { flowEvents, modificationLog, creationEvent } = useMemo(() => {
                if (!task.history) return { flowEvents: [], modificationLog: [], creationEvent: null };
                const allHistory = [...task.history].sort((a, b) => new Date(a.timestamp) - new Date(a.timestamp));
                let creation = null; const mods = []; const flows = new Map();

                allHistory.forEach(event => {
                    const actor = event.actor || userMap.get(session?.user?.id) || '系统';
                    if (event.action.includes('创建了任务')) { creation = { ...event, actor }; }
                    else if (event.action.startsWith('编辑:') || event.action.includes('退回至') || event.action.includes('作废') || event.action.includes('被删除') || event.action.includes('被转交') || event.action.includes('被分配') || event.action.includes('加急')) {
                        mods.push({ ...event, actor });
                    }
                    const statusChangeMatch = event.action.match(/进入 \[([^\]]+)\]|退回至 \[([^\]]+)\]|被分配|被转交|标记为已完成/);
                    if (statusChangeMatch) {
                        let statusName = statusChangeMatch[1] || statusChangeMatch[2];
                        let statusKey;
                        if (statusName) { statusKey = Object.keys(statusLabelMap).find(key => statusLabelMap[key] === statusName); }
                        else if (event.action.includes('被分配')) { statusKey = 'inprogress'; }
                        else if (event.action.includes('被转交')) { statusKey = 'inprogress'; }
                        else if (event.action.includes('标记为已完成')) { statusKey = 'done'; }
                        if (statusKey) {
                            flows.set(statusKey, {
                                timestamp: event.timestamp,
                                actor: actor,
                                comment: event.action.match(/原因: (.+)/)?.[1] || null
                            });
                        }
                    }
                });

                // --- 逻辑补充：如果任务已完成，但历史记录里没有明确的'进入[已完成]'，则使用任务的完成日期 ---
                if (task.status === 'done' && task.actualCompletionDate && !flows.has('done')) {
                    const lastHistoryEvent = allHistory[allHistory.length - 1];
                    const finalActor = lastHistoryEvent?.actor || userMap.get(session?.user?.id) || '系统';
                    flows.set('done', {
                        timestamp: task.actualCompletionDate,
                        actor: finalActor,
                        comment: '任务被标记为已完成'
                    });
                }

                const finalFlowEvents = Object.keys(WORKFLOW_CONFIG).map(key => ({ stageKey: key, ...WORKFLOW_CONFIG[key], ...(flows.get(key) || {}) }));
                return {
                    flowEvents: finalFlowEvents,
                    modificationLog: mods.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)),
                    creationEvent: creation
                };
            }, [task, userMap, WORKFLOW_CONFIG, statusLabelMap, session]);

            const currentStageIndex = useMemo(() => {
                return flowEvents.findIndex(event => event.stageKey === task.status);
            }, [task.status, flowEvents]);

            return (
                <div
                    ref={wrapperRef}
                    className={`absolute top-0 right-0 bottom-0 bg-white dark:bg-slate-900 shadow-2xl z-40 transition-transform duration-300 ease-in-out ${isOpen ? 'translate-x-0' : 'translate-x-full'} w-full max-w-lg md:max-w-3xl lg:max-w-5xl`}
                >
                    <div className="flex flex-col h-full">
                        <header className="flex-shrink-0 p-4 border-b border-slate-200 dark:border-slate-700">
                            <div className="flex justify-between items-start">
                                <div className="space-y-2">
                                    <span className="font-mono text-sm bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-400 px-2 py-1 rounded">{task.customTaskId}</span>
                                    <h2 className="text-xl font-bold text-slate-900 dark:text-slate-100">{task.projectName}</h2>
                                    {creationEvent && (
                                        <p className="text-xs text-slate-500 dark:text-slate-400">
                                            由 <span className="font-semibold">{creationEvent.actor}</span> 于 {formatDateTime(creationEvent.timestamp)} 创建
                                        </p>
                                    )}
                                </div>
                                <button onClick={onClose} className="p-2 text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-700 rounded-full">
                                    <X size={20} />
                                </button>
                            </div>
                        </header>

                        <main className="flex-grow min-h-0 overflow-y-auto"> {/* <-- 【修改点】在这里添加了 overflow-y-auto */}
                            <div className="flex-shrink-0"> {/* <-- 【修改点】用一个 div 包裹非滚动内容 */}
                                <h4 className="px-4 pt-4 pb-2 text-base font-semibold text-slate-800 dark:text-slate-100">流程时间轴</h4>
                            </div>
                            <section className="flex-shrink-0 p-6 md:hidden">
                                <div className="relative border-l-2 border-slate-200 dark:border-slate-600 ml-2">
                                    {flowEvents.map((event, index) => {
                                        const isPast = index < currentStageIndex;
                                        const isCurrent = index === currentStageIndex;
                                        const nodeColorClass = isCurrent ? 'bg-blue-500 ring-4 ring-blue-200 dark:ring-blue-800/50' : isPast ? 'bg-green-500' : 'bg-slate-300 dark:bg-slate-500';

                                        let statusText = event.label;
                                        let timeText = '未开始';
                                        let actorText = '';
                                        const responsiblePersonField = WORKFLOW_CONFIG[event.stageKey]?.responsible;
                                        const responsiblePersonName = responsiblePersonField ? userMap.get(task[responsiblePersonField]) || '待分配' : '';
                                        if (responsiblePersonName) {
                                            actorText = `负责人: ${responsiblePersonName}`;
                                        }
                                        if (isCurrent) {
                                            timeText = `开始于 ${formatDateTime(event.timestamp)}`;
                                        } else if (isPast) {
                                            statusText = event.pastTenseLabel;
                                            timeText = `完成于 ${formatDateTime(event.timestamp)}`;
                                            if (event.actor && event.actor !== responsiblePersonName) {
                                                actorText += ` (由 ${event.actor} 完成)`;
                                            }
                                        }
                                        if (event.stageKey === 'done') {
                                            statusText = task.isArchived ? "已归档" : "已完成";
                                            actorText = task.isArchived ? `存档于 ${formatDateTime((task.history || []).find(h => h.action === '存档了任务')?.timestamp)}` : '未存档';
                                            timeText = `完成于 ${formatDateTime(event.timestamp)}`;
                                        }

                                        return (
                                            <div key={event.stageKey} className="mb-8 pl-8 relative">
                                                <div className={`absolute -left-[7px] top-1 w-3 h-3 rounded-full z-10 ${nodeColorClass}`}></div>
                                                <div className="p-3 bg-slate-50 dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-sm">
                                                    <p className={`font-bold text-sm ${isCurrent ? 'text-blue-600 dark:text-blue-400' : 'text-slate-800 dark:text-slate-200'}`}>{statusText}</p>
                                                    <div className="text-xs text-slate-500 dark:text-slate-400 mt-1.5 space-y-1">
                                                        <p className="truncate" title={actorText}>{actorText || ' '}</p>
                                                        <p className="font-mono text-slate-400 dark:text-slate-500">{timeText}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </section>
                            <section className="flex-shrink-0 px-6 pb-28 pt-20 hidden md:block">
                                <div className="relative w-full">
                                    <div className="absolute top-1.5 left-6 right-6 h-0.5 bg-slate-200 dark:bg-slate-600"></div>
                                    <div className="relative flex justify-center gap-x-24">
                                        {flowEvents.map((event, index) => {
                                            const isPast = index < currentStageIndex;
                                            const isCurrent = index === currentStageIndex;

                                            // --- 核心修改：统一获取并显示负责人 ---
                                            let statusText = event.label;
                                            let timeText = '未开始';
                                            let actorText = '';

                                            // 1. 无论什么阶段，都先尝试获取该阶段预设的负责人
                                            const responsiblePersonField = WORKFLOW_CONFIG[event.stageKey]?.responsible;
                                            // 使用修正后的驼峰式字段名来查找负责人
                                            const responsiblePersonName = responsiblePersonField ? userMap.get(task[responsiblePersonField]) || '待分配' : '';
                                            if (responsiblePersonName) {
                                                actorText = `负责人: ${responsiblePersonName}`;
                                            }

                                            // 2. 根据阶段（过去/现在/未来）来决定时间的显示方式
                                            if (isCurrent) {
                                                timeText = `开始于 ${formatDateTime(event.timestamp)}`;
                                            } else if (isPast) {
                                                statusText = event.pastTenseLabel;
                                                timeText = `完成于 ${formatDateTime(event.timestamp)}`;
                                                // 对于已完成的阶段，我们可以补充说明实际操作人
                                                if (event.actor && event.actor !== responsiblePersonName) {
                                                    actorText += ` (由 ${event.actor} 完成)`;
                                                }
                                            }

                                            // 3. 特殊处理“已完成”卡片
                                            if (event.stageKey === 'done') {
                                                statusText = task.isArchived ? "已归档" : "已完成";
                                                actorText = task.isArchived ? `存档于 ${formatDateTime((task.history || []).find(h => h.action === '存档了任务')?.timestamp)}` : '未存档';
                                                timeText = `完成于 ${formatDateTime(event.timestamp)}`;
                                            }
                                            // --- 修改结束 ---

                                            const nodeColorClass = isCurrent ? 'bg-blue-500 ring-4 ring-blue-200 dark:ring-blue-800/50' : isPast ? 'bg-green-500' : 'bg-slate-300 dark:bg-slate-500';
                                            const cardPositionClass = index % 2 === 0 ? 'top-full mt-2' : 'bottom-full mb-2';

                                            return (
                                                <div key={event.stageKey} className="relative flex flex-col items-center">
                                                    <div className={`w-3 h-3 rounded-full z-10 transition-all ${nodeColorClass}`}></div>
                                                    <div className={`absolute ${cardPositionClass} w-48 p-2 bg-white dark:bg-slate-800 border dark:border-slate-700 rounded-lg shadow-xl text-center`}>
                                                        <p className={`font-bold text-sm ${isCurrent ? 'text-blue-600 dark:text-blue-400' : 'text-slate-800 dark:text-slate-200'}`}>{statusText}</p>
                                                        <div className="text-xs text-slate-500 dark:text-slate-400 mt-1.5 space-y-1">
                                                            <p className="truncate" title={actorText}>{actorText || ' '}</p>
                                                            <p className="font-mono text-slate-400 dark:text-slate-500">{timeText}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </section>

                            <div className="flex-shrink-0"> {/* <-- 【修改点】用一个 div 包裹非滚动内容 */}
                                <div className="border-t border-slate-200 dark:border-slate-700 mx-4"></div>
                                <h4 className="px-4 pt-4 pb-2 text-base font-semibold text-slate-800 dark:text-slate-100">信息修改日志</h4>
                            </div>
                            <section className="flex-grow p-4 overflow-y-auto">
                                {modificationLog.length > 0 ? (
                                    <ul className="space-y-2 text-sm">
                                        {modificationLog.map((log, index) => (
                                            <li key={index} className="flex justify-between items-start p-2 bg-slate-50 dark:bg-slate-800/50 rounded-md">
                                                <p className="text-slate-700 dark:text-slate-300 break-all pr-4">{log.action.replace('编辑: ', '')}</p>
                                                <div className="text-right flex-shrink-0">
                                                    <p className="font-medium text-slate-600 dark:text-slate-400">{log.actor}</p>
                                                    <p className="text-xs text-slate-400 dark:text-slate-500 mt-1">{formatDateTime(log.timestamp)}</p>
                                                </div>
                                            </li>
                                        ))}
                                    </ul>
                                ) : (<p className="text-sm text-center text-slate-400 py-8">无信息修改记录。</p>)}
                            </section>
                        </main>
                    </div>
                </div>
            );
        };
        const ReturnTaskModal = ({ isOpen, onClose, onConfirm, task }) => {
            const [reason, setReason] = useState('');

            useEffect(() => {
                if (isOpen) setReason('');
            }, [isOpen]);

            if (!isOpen) return null;

            const handleConfirm = () => {
                if (!reason.trim()) {
                    alert('退回原因不能为空。');
                    return;
                }
                onConfirm(task, reason.trim());
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">退回任务</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">任务: {generateTaskSummary(task)}</p>
                        </header>
                        <div className="p-6">
                            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">请输入退回原因 (必填)</label>
                            <textarea
                                value={reason}
                                onChange={(e) => setReason(e.target.value)}
                                rows="4"
                                className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200"
                                placeholder="例如：资料不全，需要补充..."
                            />
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                            <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button>
                            <button onClick={handleConfirm} className="px-6 py-2 rounded-md text-white bg-orange-500 hover:bg-orange-600 font-semibold">确认退回</button>
                        </footer>
                    </div>
                </div>
            );
        };
        const WorkbenchModal = ({ isOpen, onClose, onDateSelect, session, workSummaries, onSummariesChange, userMap }) => {
    const [activeFeature, setActiveFeature] = useState('work_summary');
    const [summaryToExport, setSummaryToExport] = useState(null);

    useEffect(() => {
        if (isOpen && session) {
            const fetchSummaries = async () => {
                const { data, error } = await supabase.from('work_summaries').select('*'); // 读取所有总结
                if (error) { console.error('获取工作总结失败:', error); } 
                else { onSummariesChange(data || []); }
            };
            fetchSummaries();
        }
    }, [isOpen, session]);

    if (!isOpen) return null;
    const features = [ { key: 'work_summary', label: '工作总结' } ];

    return (
        <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4">
            <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-5xl h-[90vh] flex flex-col">
                <header className="flex justify-between items-center p-4 border-b dark:border-slate-700 flex-shrink-0">
                    <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">我的工作台</h2>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X /></button>
                </header>
                <main className="flex-grow flex min-h-0">
                    <nav className="w-48 flex-shrink-0 bg-slate-50 dark:bg-slate-800/50 p-4 border-r dark:border-slate-700">
                       <ul className="space-y-2">{features.map(f => <li key={f.key}><button onClick={() => setActiveFeature(f.key)} className={`w-full text-left px-3 py-2 rounded-md font-semibold text-sm ${activeFeature === f.key ? 'bg-emerald-500 text-white' : 'hover:bg-slate-200 dark:hover:bg-slate-700'}`}>{f.label}</button></li>)}</ul>
                    </nav>
                    <div className="flex-grow p-6 overflow-y-auto">
                        {activeFeature === 'work_summary' && (
                            <WorkSummaryCalendar 
                                onDateSelect={onDateSelect} 
                                summaries={workSummaries}
                                onExportClick={(summary) => setSummaryToExport(summary)}
                            />
                        )}
                    </div>
                </main>
                <SummaryImageExport summary={summaryToExport} onDone={() => setSummaryToExport(null)} userMap={userMap} />
            </div>
        </div>
    );
};

        const SummarySection = ({ title, value, onChange, placeholder, children, rows = "4" }) => (
            <div className="space-y-2">
                <label className="text-base font-semibold text-slate-800 dark:text-slate-200">{title}</label>
                <div className="bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border dark:border-slate-200 dark:border-slate-700">
                    <textarea
                        value={value}
                        onChange={onChange}
                        placeholder={placeholder}
                        rows={rows} // <-- 修改点：使用传入的rows属性
                        className="w-full bg-transparent focus:outline-none text-sm"
                    />
                    {children}
                </div>
            </div>
        );

       const WorkSummaryCalendar = ({ onDateSelect, summaries, onExportClick }) => {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [selectedDate, setSelectedDate] = useState(null);
    const [jumpDate, setJumpDate] = useState('');

    const summarizedDates = useMemo(() => {
        const dateMap = new Map();
        (summaries || []).forEach(summary => {
            const localDate = new Date(`${summary.summary_date}T00:00:00`);
            dateMap.set(localDate.toDateString(), summary);
        });
        return dateMap;
    }, [summaries]);

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
    const prevMonthEndDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 0);

    const startDayOfWeek = startOfMonth.getDay();
    const daysInMonth = endOfMonth.getDate();
    const weekdays = ['日', '一', '二', '三', '四', '五', '六'];

    const calendarDays = [];

    // 1. 填充上个月末尾的日子
    for (let i = startDayOfWeek; i > 0; i--) {
        const day = prevMonthEndDate.getDate() - i + 1;
        calendarDays.push(<div key={`prev-${day}`} className="p-2 text-left text-slate-400 dark:text-slate-600 border-t border-l dark:border-slate-700">
            <span className="w-8 h-8 flex items-center justify-center rounded-full text-sm">{day}</span>
        </div>);
    }

    // 2. 填充当月的日期
    for (let day = 1; day <= daysInMonth; day++) {
        const dateObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
        const dateString = dateObj.toDateString();
        const summaryForDay = summarizedDates.get(dateString);
        const hasSummary = !!summaryForDay;
        const isToday = today.toDateString() === dateString;
        const isSelected = selectedDate && selectedDate.toDateString() === dateString;
        const isFuture = dateObj > today;

        calendarDays.push(
            <div 
                key={day} 
                className={`p-2 text-left border-t border-l dark:border-slate-700 group relative 
                    ${isFuture 
                        ? 'bg-slate-50 dark:bg-slate-800/50 cursor-not-allowed' 
                        : 'cursor-pointer hover:bg-emerald-50 dark:hover:bg-emerald-900/50 transition-colors'
                    }`
                }
                onClick={() => {
                    if (isFuture) return;
                    setSelectedDate(dateObj);
                    onDateSelect(dateObj);
                }}
            >
                <span className={`w-8 h-8 flex items-center justify-center rounded-full text-sm font-medium
                    ${isSelected ? 'ring-2 ring-emerald-500' : ''}
                    ${isToday ? 'bg-emerald-500 text-white' : (isFuture ? 'text-slate-400 dark:text-slate-600' : 'text-slate-700 dark:text-slate-200')}
                    ${!isFuture && 'group-hover:text-emerald-600 dark:group-hover:text-emerald-300'}
                `}>
                    {day}
                </span>
                {hasSummary && (
                    <div className="absolute bottom-1 right-1 flex items-center gap-1">
                        <div title="已填写总结" className="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>
                        <button 
                            title="生成总结图片"
                            onClick={(e) => { e.stopPropagation(); onExportClick(summaryForDay); }}
                            className="p-1 rounded opacity-0 group-hover:opacity-100 transition-opacity text-slate-500 hover:bg-slate-200 dark:text-slate-400 dark:hover:bg-slate-700"
                        >
                            <ImageIcon size={14}/>
                        </button>
                    </div>
                )}
            </div>
        );
    }

    // 3. 填充下个月开头的日子
    const remainingCells = 42 - calendarDays.length;
    for (let i = 1; i <= remainingCells; i++) {
         calendarDays.push(<div key={`next-${i}`} className="p-2 text-left text-slate-400 dark:text-slate-600 border-t border-l dark:border-slate-700">
            <span className="w-8 h-8 flex items-center justify-center rounded-full text-sm">{i}</span>
        </div>);
    }

    const handlePrevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
    const handleNextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
    const handleJumpToDate = () => {
        if (jumpDate) {
            const newDate = new Date(jumpDate);
            newDate.setMinutes(newDate.getMinutes() + newDate.getTimezoneOffset());
            if (!isNaN(newDate.getTime()) && newDate <= today) {
                setCurrentDate(newDate);
            } else {
                alert('不能选择一个未来的日期。');
            }
        }
    };

    const todayStringForInput = today.toISOString().split('T')[0];

    return (
        <div className="h-full flex flex-col">
            <header className="flex flex-wrap justify-between items-center mb-4 flex-shrink-0 gap-y-2">
                <h3 className="text-lg font-bold text-slate-800 dark:text-slate-200">
                    {`${currentDate.getFullYear()}年 ${currentDate.getMonth() + 1}月`}
                </h3>
                <div className="flex items-center gap-2 flex-wrap">
                    <input 
                        type="date" 
                        value={jumpDate} 
                        onChange={(e) => setJumpDate(e.target.value)}
                        max={todayStringForInput}
                        className="px-2 py-1 text-sm border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500 dark:bg-slate-700 dark:border-slate-600"
                    />
                    <button onClick={handleJumpToDate} className="px-3 py-1 text-sm font-semibold rounded-md bg-slate-200 hover:bg-slate-300 dark:bg-slate-700 dark:hover:bg-slate-600">跳转</button>
                    <div className="h-4 w-px bg-slate-300 dark:bg-slate-600 mx-1"></div>
                    <button onClick={handlePrevMonth} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&lt;</button>
                    <button onClick={() => setCurrentDate(new Date())} className="px-3 py-1 text-sm font-semibold rounded-md hover:bg-slate-200 dark:hover:bg-slate-700">今天</button>
                    <button onClick={handleNextMonth} className="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&gt;</button>
                </div>
            </header>
            <div className="grid grid-cols-7 text-center font-semibold text-sm flex-grow bg-white dark:bg-slate-900 rounded-lg shadow border dark:border-slate-700">
                {weekdays.map(day => (
                    <div key={day} className="py-2 border-b dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50">{day}</div>
                ))}
                {calendarDays}
            </div>
        </div>
    );
};

        const SummaryEditorModal = ({ isOpen, onClose, onSave, date, tasks, session, summaries }) => {
            const [tasksReceivedCount, setTasksReceivedCount] = useState('');
            const [tasksResponsibleCount, setTasksResponsibleCount] = useState('');
            const [reportedTasks, setReportedTasks] = useState([]);
            const [todaysWork, setTodaysWork] = useState('');
            const [problems, setProblems] = useState('');
            const [other, setOther] = useState('');
            const [tomorrowsPlan, setTomorrowsPlan] = useState('');

            useEffect(() => {
                if (isOpen && tasks && session && date) {
                    // --- 【修改点】加载逻辑 ---
                    const dateString = date.toISOString().split('T')[0];
                    const existingSummary = (summaries || []).find(s => s.summary_date === dateString);

                    if (existingSummary && existingSummary.content) {
                        // 如果有已保存的总结，则加载数据
                        const { content } = existingSummary;
                        setTasksReceivedCount(content.tasksReceivedCount || '');
                        setTasksResponsibleCount(content.tasksResponsibleCount || '');
                        setReportedTasks(content.reportedTasks || []);
                        setTodaysWork(content.todaysWork || '');
                        setProblems(content.problems || '');
                        setOther(content.other || '');
                        setTomorrowsPlan(content.tomorrowsPlan || '');
                    } else {
                        // 如果是新总结，则自动填充任务列表并清空其他字段
                        const myUnfinishedTasks = tasks.filter(task =>
                            task.projectManager === session.user.id &&
                            task.status !== 'done' &&
                            task.status !== 'void'
                        );
                        setReportedTasks(myUnfinishedTasks.map(task => ({
                            id: task.id,
                            customTaskId: task.customTaskId,
                            projectName: task.projectName,
                            taskType: task.taskType,
                        })));
                        setTasksReceivedCount('');
                        setTasksResponsibleCount('');
                        setTodaysWork('');
                        setProblems('');
                        setOther('');
                        setTomorrowsPlan('');
                    }
                }
            }, [isOpen, date, tasks, session, summaries]);

            if (!isOpen) return null;

            const formattedDate = date ? `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日` : '';

            const handleTaskChange = (index, field, value) => {
                const newTasks = [...reportedTasks];
                newTasks[index][field] = value;
                setReportedTasks(newTasks);
            };

            const handleRemoveTask = (index) => {
                const newTasks = reportedTasks.filter((_, i) => i !== index);
                setReportedTasks(newTasks);
            };

            const handleAddTask = () => {
                setReportedTasks([...reportedTasks, {
                    id: `new-${Date.now()}`,
                    customTaskId: '',
                    projectName: '',
                    taskType: ''
                }]);
            };

            const handleSave = () => {
                const summaryData = {
                    user_id: session.user.id,
                    summary_date: date.toISOString().split('T')[0], // YYYY-MM-DD 格式
                    content: { // 将所有内容打包成一个 JSON 对象
                        tasksReceivedCount,
                        tasksResponsibleCount,
                        reportedTasks,
                        todaysWork,
                        problems,
                        other,
                        tomorrowsPlan
                    }
                };
                onSave(summaryData); // 调用 App 组件的 onSave
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-[60] flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-3xl h-[90vh] flex flex-col">
                        <header className="flex justify-between items-center p-4 border-b dark:border-slate-700 flex-shrink-0">
                            <div>
                                <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">工作总结</h2>
                                <p className="text-sm text-slate-500 dark:text-slate-400">{formattedDate}</p>
                            </div>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X /></button>
                        </header>
                        <main className="flex-grow p-6 space-y-6 overflow-y-auto">
                            <div className="space-y-2">
                                <label className="text-base font-semibold text-slate-800 dark:text-slate-200">1. 工作汇报</label>
                                <div className="flex items-center gap-2 flex-wrap bg-slate-50 dark:bg-slate-800/50 p-3 rounded-lg border dark:border-slate-200 dark:border-slate-700 text-sm">
                                    <span>今日接收任务</span>
                                    <input
                                        type="number"
                                        value={tasksReceivedCount}
                                        onChange={(e) => setTasksReceivedCount(e.target.value)}
                                        className="w-12 px-1 py-0.5 text-center border rounded-md dark:bg-slate-700 dark:border-slate-600"
                                    />
                                    <span>份，共负责任务</span>
                                    <input
                                        type="number"
                                        value={tasksResponsibleCount}
                                        onChange={(e) => setTasksResponsibleCount(e.target.value)}
                                        className="w-12 px-1 py-0.5 text-center border rounded-md dark:bg-slate-700 dark:border-slate-600"
                                    />
                                    <span>份。</span>
                                </div>

                                <div className="space-y-2 pt-2">
                                    {reportedTasks.map((task, index) => (
                                        <div key={task.id} className="grid grid-cols-[1fr_2fr_1fr_auto] gap-2 items-center">
                                            <input type="text" value={task.customTaskId} onChange={(e) => handleTaskChange(index, 'customTaskId', e.target.value)} placeholder="任务编号" className="px-2 py-1 text-sm border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600" />
                                            <input type="text" value={task.projectName} onChange={(e) => handleTaskChange(index, 'projectName', e.target.value)} placeholder="项目名称" className="px-2 py-1 text-sm border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600" />
                                            <input type="text" value={task.taskType} onChange={(e) => handleTaskChange(index, 'taskType', e.target.value)} placeholder="任务类型" className="px-2 py-1 text-sm border-gray-300 rounded-md dark:bg-slate-700 dark:border-slate-600" />
                                            <button onClick={() => handleRemoveTask(index)} className="px-2 py-1 text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-md font-bold text-lg">-</button>
                                        </div>
                                    ))}
                                    <button onClick={handleAddTask} className="w-full mt-2 px-2 py-1 text-sm text-emerald-600 bg-emerald-50 hover:bg-emerald-100 dark:bg-emerald-900/50 dark:hover:bg-emerald-900 rounded-md font-semibold">+</button>
                                </div>
                            </div>

                            <SummarySection title="2. 今日工作" value={todaysWork} onChange={(e) => setTodaysWork(e.target.value)} rows="2">
                                <div className="flex justify-end items-center mt-2">
                                    <span className="text-xs text-slate-400">{todaysWork.length} 字</span>
                                </div>
                            </SummarySection>

                            {/* --- 【修改点】为下面三项设置 rows="1" --- */}
                            <SummarySection title="3. 遇到的问题及计划解决办法" value={problems} onChange={(e) => setProblems(e.target.value)} rows="1" />
                            <SummarySection title="4. 其他" value={other} onChange={(e) => setOther(e.target.value)} rows="1" />
                            <SummarySection title="5. 明日计划" value={tomorrowsPlan} onChange={(e) => setTomorrowsPlan(e.target.value)} rows="1" />
                        </main>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700 flex-shrink-0">
                            <button onClick={onClose} className="px-4 py-2 rounded-md font-semibold">取消</button>
                            <button onClick={handleSave} className="px-6 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold">保存总结</button>
                        </footer>
                    </div>
                </div>
            );
        };
        const SummaryImageExport = ({ summary, onDone, userMap }) => {
    const exportRef = useRef(null);

    useEffect(() => {
        if (summary && exportRef.current) {
            setTimeout(() => {
                window.html2canvas(exportRef.current, { scale: 2, useCORS: true }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `工作总结-${summary.summary_date}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    onDone();
                }).catch(err => {
                    console.error("图片生成失败:", err);
                    alert("图片生成失败，详情请查看控制台。");
                    onDone();
                });
            }, 100);
        }
    }, [summary, onDone]);

    if (!summary) return null;

    const { content = {}, summary_date, user_id } = summary; // 安全地解构 content
    const userName = userMap.get(user_id) || '未知用户';

    const ReportSection = ({ title, children }) => (
        <div className="mb-4">
            <h3 className="text-lg font-bold border-b-2 border-emerald-500 pb-1 mb-2 text-emerald-700">{title}</h3>
            <div className="text-sm text-gray-800 whitespace-pre-wrap">{children}</div>
        </div>
    );

    return (
        <div style={{ position: 'absolute', left: '-9999px', top: 0, zIndex: -1 }}>
            <div ref={exportRef} className="p-8 bg-white" style={{ width: '800px' }}>
                <header className="text-center mb-8">
                    <h1 className="text-3xl font-extrabold text-gray-900">工作总结</h1>
                    <p className="text-lg text-gray-500 mt-2">{`${summary_date} (报告人: ${userName})`}</p>
                </header>
                <main>
                    <ReportSection title="1. 工作汇报">
                        <p className="mb-2">{`今日接收任务 ${content.tasksReceivedCount || 0} 份，共负责任务 ${content.tasksResponsibleCount || 0} 份。`}</p>
                        {(content.reportedTasks || []).length > 0 && (
                            <table className="w-full text-left border-collapse mt-2 text-xs">
                                <thead><tr className="bg-slate-100"><th className="border p-1">任务编号</th><th className="border p-1">项目名称</th><th className="border p-1">任务类型</th></tr></thead>
                                <tbody>
                                    {(content.reportedTasks || []).map((task, index) => (
                                        <tr key={task.id || index}><td className="border p-1">{task.customTaskId}</td><td className="border p-1">{task.projectName}</td><td className="border p-1">{task.taskType}</td></tr>
                                    ))}
                                </tbody>
                            </table>
                        )}
                    </ReportSection>
                    <ReportSection title="2. 今日工作">{content.todaysWork || '无'}</ReportSection>
                    <ReportSection title="3. 遇到的问题及计划解决办法">{content.problems || '无'}</ReportSection>
                    <ReportSection title="4. 其他">{content.other || '无'}</ReportSection>
                    <ReportSection title="5. 明日计划">{content.tomorrowsPlan || '无'}</ReportSection>
                </main>
            </div>
        </div>
    );
};
        const BulkReturnModal = ({ isOpen, onClose, onConfirm, taskCount }) => {
            const [reason, setReason] = useState('');

            useEffect(() => {
                if (isOpen) setReason('');
            }, [isOpen]);

            if (!isOpen) return null;

            const handleConfirm = () => {
                if (!reason.trim()) {
                    alert('退回原因不能为空。');
                    return;
                }
                onConfirm(reason.trim());
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-lg">
                        <header className="p-4 border-b dark:border-slate-700">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">批量退回任务</h2>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                将为选中的 <span className="font-semibold text-orange-500">{taskCount}</span> 个任务统一填写退回原因。
                            </p>
                        </header>
                        <div className="p-6">
                            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-2">请输入退回原因 (必填)</label>
                            <textarea
                                value={reason}
                                onChange={(e) => setReason(e.target.value)}
                                rows="4"
                                className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200"
                                placeholder="例如：资料不全，需要补充..."
                            />
                        </div>
                        <footer className="p-4 flex justify-end gap-4 bg-gray-100 dark:bg-slate-800 rounded-b-xl border-t dark:border-slate-700">
                            <button onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button>
                            <button onClick={handleConfirm} className="px-6 py-2 rounded-md text-white bg-orange-500 hover:bg-orange-600 font-semibold">确认退回</button>
                        </footer>
                    </div>
                </div>
            );
        };
        // --- 登录组件 ---
        // --- 【全新简化版】Login 组件 ---
        const Login = ({ authError }) => {
            const [view, setView] = useState('sign_in');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [displayName, setDisplayName] = useState('');
            // 【核心修改】部门状态，并默认选中“技术部门”
            const [department, setDepartment] = useState('技术部门');
            const [error, setError] = useState(null);
            const [message, setMessage] = useState(null);
            const [loading, setLoading] = useState(false);
            const isMounted = useRef(true);

            useEffect(() => {
                isMounted.current = true;
                return () => { isMounted.current = false; };
            }, []);

            // 【核心修改】删除了之前用来加载部门列表的 useEffect 代码块

            const emailSuffixes = ['@qq.com', '@163.com', '@outlook.com', '@gmail.com', '@sina.com', '@189.cn'];
            const showEmailSuggestions = useMemo(() => email.length > 0 && !email.includes('@'), [email]);
            useEffect(() => { if (authError) { setError(authError); } }, [authError]);
            const getPasswordStrength = (pw) => { let score = 0; if (pw.length >= 8) score++; if (/[A-Z]/.test(pw)) score++; if (/[0-9]/.test(pw)) score++; if (/[^A-Za-z0-9]/.test(pw)) score++; return score; };
            const passwordStrength = useMemo(() => getPasswordStrength(password), [password]);
            const strengthColors = ['bg-gray-300', 'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500'];
            const strengthLabels = ['很弱', '较弱', '中等', '良好', '很强'];
            // --- 辅助函数：翻译常见的认证错误信息 ---
            const translateAuthError = (message) => {
                if (message.includes("Email not confirmed")) return "您的邮箱尚未验证，请检查收件箱并点击验证链接。";
                if (message.includes("User already registered")) return "此邮箱地址已被注册，请直接登录或找回密码。";
                // --- 新增：专门翻译“is invalid”错误 ---
                if (message.includes("is invalid")) {
                    return "您输入的邮箱地址格式无效，请检查后重试。";
                }
                if (message.includes("Invalid login credentials")) return "邮箱或密码错误，请检查后重试。";
                if (message.includes("Password should be at least 6 characters")) return "密码长度至少需要6位。";
                if (message.includes("Unable to validate email address: invalid format")) return "请输入有效的邮箱地址。";
                return message; // 如果没有匹配的翻译，则返回原始信息
            };
            const handlePasswordReset = async (e) => {
                e.preventDefault(); setLoading(true); setError(null); setMessage(null);
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: 'https://guoliang396382608-cloud.github.io/my-task-app/set-password.html'
                    });
                    if (error) throw error;
                    if (isMounted.current) setMessage('密码重置链接已发送，请检查您的邮箱。');
                }
                catch (error) {
                    if (isMounted.current) setError(error.message);
                }
                finally { if (isMounted.current) setLoading(false); }
            };
            const handleAuth = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError(null);
                setMessage(null);
                try {
                    let response;
                    if (view === 'sign_up') {
                        if (password !== confirmPassword) {
                            throw new Error("两次输入的密码不一致，请检查。");
                        }
                        if (!department) {
                            throw new Error("请选择一个部门。");
                        }
                        response = await supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                emailRedirectTo: 'https://guoliang396382608-cloud.github.io/my-task-app/index.html',
                                app_metadata: {
                                    display_name: displayName,
                                    department: department,
                                    invited_by_admin: false,
                                    role: 'pending'
                                }
                            }
                        });
                        if (response.error) {
                            throw response.error;
                        }

                        // --- 核心修复：检查返回数据，判断是否为重复注册 ---
                        if (response.data.user && response.data.user.identities && response.data.user.identities.length === 0) {
                            throw new Error("User already registered"); // 手动抛出一个可识别的错误
                        }

                        if (isMounted.current) {
                            setMessage('注册成功！请检查您的邮箱以完成验证。');
                        }
                    } else {
    // 1. 先尝试正常登录
    response = await supabase.auth.signInWithPassword({ email, password });

    // 2. 如果登录失败，并且错误是关于邮箱未验证的
    if (response.error && response.error.message.includes('Email not confirmed')) {
        // 3. 强制从服务器刷新用户最新的状态
        await supabase.auth.refreshSession();
        
        // 4. 再次尝试登录，这次客户端会带着最新的用户信息
        response = await supabase.auth.signInWithPassword({ email, password });
    }
}
                    if (response.error) {
                        throw response.error;
                    }
                } catch (error) {
                    if (isMounted.current) setError(translateAuthError(error.message));
                } finally {
                    if (isMounted.current) setLoading(false);
                }
            };

            const formSubmitHandler = view === 'forgot_password' ? handlePasswordReset : handleAuth;

            return (
                <div className="min-h-screen bg-gray-100 dark:bg-slate-900 flex items-center justify-center p-4" style={{ background: 'linear-gradient(135deg, #1e3a8a 0%, #34d399 100%)' }}>
                    <div className="w-full max-w-4xl mx-auto bg-white dark:bg-slate-800 rounded-2xl shadow-2xl flex overflow-hidden">
                        <div className="w-1/2 hidden md:block bg-emerald-500 dark:bg-emerald-600 p-12 text-white flex flex-col justify-center">
                            <h1 className="text-4xl font-bold mb-4">咨询任务管理系统</h1>
                            <p className="text-emerald-100">高效、协作、安全。我们帮助您管理每一个项目细节，确保团队目标顺利达成。</p>
                        </div>
                        <div className="w-full md:w/2 p-8 md:p-12">
                            <h2 className="text-2xl font-bold text-slate-800 dark:text-slate-100">{view === 'sign_in' && '欢迎回来'}{view === 'sign_up' && '创建新账户'}{view === 'forgot_password' && '重置密码'}</h2>
                            <p className="text-slate-500 dark:text-slate-400 mt-2 mb-6">{view === 'forgot_password' ? '请输入您的邮箱以接收重置链接' : '请填写您的账户信息'}</p>
                            <form onSubmit={formSubmitHandler}>
                                <div className="space-y-5">
                                    {view === 'sign_up' && (<>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">姓名 (显示名称)</label>
                                            <input type="text" value={displayName} onChange={(e) => setDisplayName(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required />
                                        </div>
                                        {/* --- 【核心修改】将下拉框替换为单选按钮 --- */}
                                        <div>
                                            <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">所属部门</label>
                                            <div className="flex items-center space-x-6 mt-2">
                                                <label className="flex items-center space-x-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="department"
                                                        value="技术部门"
                                                        checked={department === '技术部门'}
                                                        onChange={(e) => setDepartment(e.target.value)}
                                                        className="form-radio h-4 w-4 text-emerald-600"
                                                    />
                                                    <span className="dark:text-gray-200">技术部门</span>
                                                </label>
                                                <label className="flex items-center space-x-2 cursor-pointer">
                                                    <input
                                                        type="radio"
                                                        name="department"
                                                        value="市场部门"
                                                        checked={department === '市场部门'}
                                                        onChange={(e) => setDepartment(e.target.value)}
                                                        className="form-radio h-4 w-4 text-emerald-600"
                                                    />
                                                    <span className="dark:text-gray-200">市场部门</span>
                                                </label>
                                            </div>
                                        </div>
                                    </>)}
                                    <div className="relative">
                                        <label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">邮箱</label>
                                        <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required />
                                        {showEmailSuggestions && (
                                            <div className="absolute z-10 w-full mt-1 bg-white dark:bg-slate-600 border border-gray-300 dark:border-slate-500 rounded-md shadow-lg">
                                                <ul className="py-1">{emailSuffixes.map(suffix => (<li key={suffix}><button type="button" onMouseDown={(e) => e.preventDefault()} onClick={() => setEmail(email + suffix)} className="w-full text-left px-3 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-slate-500">{email + suffix}</button></li>))}</ul>
                                            </div>
                                        )}
                                    </div>
                                    {view !== 'forgot_password' && (<>
                                        <div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">密码</label><input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required /></div>
                                        {view === 'sign_up' && (<div><label className="block text-sm font-medium text-gray-600 dark:text-gray-400 mb-1">确认密码</label><input type="password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} className="w-full bg-gray-50 border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-emerald-500 dark:bg-slate-700 dark:border-slate-600 dark:text-gray-200" required />{password && (<div className="mt-2"><div className="flex justify-between text-xs text-gray-500 dark:text-gray-400 mb-1"><span>密码强度</span><span>{strengthLabels[passwordStrength]}</span></div><div className="w-full bg-gray-200 dark:bg-slate-600 rounded-full h-1.5"><div className={`h-1.5 rounded-full ${strengthColors[passwordStrength]}`} style={{ width: `${passwordStrength * 25}%`, transition: 'width 0.3s' }}></div></div></div>)}</div>)}
                                    </>)}
                                </div>
                                {view === 'sign_in' && (<div className="flex justify-between items-center mt-4"><label className="flex items-center text-sm"><input type="checkbox" className="form-checkbox h-4 w-4 text-emerald-600 border-gray-300 rounded" /><span className="ml-2 text-gray-600 dark:text-gray-300">记住我</span></label><button type="button" onClick={() => { setView('forgot_password'); setError(null); setMessage(null); }} className="text-sm text-emerald-600 hover:underline dark:text-emerald-400">忘记密码？</button></div>)}
                                {(error || authError) && <p className="mt-4 text-sm text-center text-red-500">{error || authError}</p>}
                                {message && <p className="mt-4 text-sm text-center text-green-500">{message}</p>}
                                <div className="mt-6"><button type="submit" disabled={loading} className="w-full px-6 py-3 rounded-md text-white font-semibold bg-emerald-500 hover:bg-emerald-600 disabled:bg-emerald-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">{loading ? '处理中...' : { sign_in: '登录', sign_up: '注册', forgot_password: '发送重置链接' }[view]}</button></div>
                                <div className="mt-6 text-center text-sm">
                                    {view === 'sign_in' && <><span className="text-gray-600 dark:text-gray-400">没有账户？</span><button type="button" onClick={() => { setView('sign_up'); setError(null); setMessage(null); }} className="font-semibold text-emerald-600 hover:underline dark:text-emerald-400">点击注册</button></>}
                                    {view === 'sign_up' && <><span className="text-gray-600 dark:text-gray-400">已有账户？</span><button type="button" onClick={() => { setView('sign_in'); setError(null); setMessage(null); }} className="font-semibold text-emerald-600 hover:underline dark:text-emerald-400">点击登录</button></>}
                                    {view === 'forgot_password' && <><span className="text-gray-600 dark:text-gray-400">记起密码了？</span><button type="button" onClick={() => { setView('sign_in'); setError(null); setMessage(null); }} className="font-semibold text-emerald-600 hover:underline dark:text-emerald-400">返回登录</button></>}
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        const Notification = ({ notification, onClose }) => {
            if (!notification.show) return null;

            useEffect(() => {
                const timer = setTimeout(() => {
                    onClose();
                }, 2000); // 2秒后自动关闭
                return () => clearTimeout(timer);
            }, [notification]);

            const baseClasses = "fixed top-5 left-1/2 -translate-x-1/2 transform z-[100] px-6 py-3 rounded-lg shadow-lg text-white font-semibold transition-all duration-300";
            const typeClasses = {
                success: "bg-green-500",
                error: "bg-red-500",
            };

            return (
                <div className={`${baseClasses} ${typeClasses[notification.type]}`}>
                    {notification.message}
                </div>
            );
        };

        // --- 验证包装器 ---
        const AuthWrapper = () => {
            const [session, setSession] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            useEffect(() => {
                // 首次加载时获取 session
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    setLoading(false);
                });

                // 监听后续状态变化
                const { data: { subscription } } = supabase.auth.onAuthStateChange(async (_event, session) => {
                    if (session && session.user.app_metadata?.role === 'pending') {
                        await supabase.auth.signOut();
                        setAuthError("您的账户正在等待管理员批准。请联系管理员激活账号。");
                        setSession(null);
                    } else {
                        setAuthError(null);
                        setSession(session);
                    }
                    setLoading(false);
                });

                return () => subscription.unsubscribe();
            }, []);

            if (loading) {
                return (
                    <div className="flex justify-center items-center h-screen bg-slate-50 dark:bg-slate-900">
                        <p className="text-lg text-slate-500">正在初始化...</p>
                    </div>
                );
            }

            // 只有当 session 存在且用户角色不是 'pending' 时，才渲染 App
            if (session && session.user.user_metadata?.role !== 'pending') {
                return <App session={session} />;
            } else {
                // 其他所有情况（未登录，或用户角色为 'pending'）都渲染 Login 组件
                return <Login authError={authError} />;
            }
        };

        // --- Main App Component ---
        function App({ session }) {
            // “状态声明区域”就是指下面这片区域
            const [tasks, setTasks] = useState([]);
            const [deletedTasks, setDeletedTasks] = useState([]);
            const [managementData, setManagementData] = useState({
                regions: [], taskTypes: [], department_structure: {},
                signingEntities: [], invoiceTypes: [], contractAdmins: []
            });
            const [backupHistory, setBackupHistory] = useState([]);
            const [isDarkMode, setIsDarkMode] = useState(() => { try { const item = window.localStorage.getItem('task_manager_isDarkMode_v4.2.3'); return item ? JSON.parse(item) : false; } catch (error) { return false; } });
            const [dailyQuote, setDailyQuote] = useState({ text: '正在获取今日箴言...', source: '网络' });
            const [isQuoteModalOpen, setIsQuoteModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [modalError, setModalError] = useState(null);
            const [isTaskModalOpen, setIsTaskModalOpen] = useState(false);
            const [editingTask, setEditingTask] = useState(null);
            const [isHistoryModalOpen, setIsHistoryModalOpen] = useState(false);
            const [historyTask, setHistoryTask] = useState(null);
            const [isStatsModalOpen, setIsStatsModalOpen] = useState(false);
            const [isExportModalOpen, setIsExportModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [isManagementModalOpen, setIsManagementModalOpen] = useState(false);
            const [isNotificationModalOpen, setIsNotificationModalOpen] = useState(false);
            const [isBackupModalOpen, setIsBackupModalOpen] = useState(false);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [confirmationState, setConfirmationState] = useState({ isOpen: false, title: '', message: '', onConfirm: () => { }, confirmVariant: 'primary' });
            const [currentView, setCurrentView] = useState('overview');
            const [activeFilters, setActiveFilters] = useState({ department: null });
            const [searchTerm, setSearchTerm] = useState('');
            const debouncedSearchTerm = useDebounce(searchTerm, 300);
            const [selectedTasks, setSelectedTasks] = useState(new Set());
            const [showBackupReminder, setShowBackupReminder] = useState(false);
            const [actionModalState, setActionModalState] = useState({ isOpen: false, task: null });
            const [importReport, setImportReport] = useState({ isOpen: false, successful: 0, failed: 0, errors: [], originalData: [] });
            const appRef = useRef(null);
            const [notification, setNotification] = useState({ show: false, message: '', type: 'success' });
            const [isTeamModalOpen, setIsTeamModalOpen] = useState(false);
            const [isProfileModalOpen, setIsProfileModalOpen] = useState(false);
            const [userMap, setUserMap] = useState(new Map());
            const [profiles, setProfiles] = useState([]);
            const [currentUserProfile, setCurrentUserProfile] = useState(null);
            const [availableRoles, setAvailableRoles] = useState([]);
            const [rolePermissions, setRolePermissions] = useState([]);
            const [actionPermissions, setActionPermissions] = useState([]);
            // --- 在状态声明区追加 ---
            const [isAssignModalOpen, setIsAssignModalOpen] = useState(false);
            const [isReturnModalOpen, setIsReturnModalOpen] = useState(false);
            const [actionableTask, setActionableTask] = useState(null); // 用于传递任务给新弹窗// 【新增代码】
            const [flowTask, setFlowTask] = useState(null); // 用于控制流程详情面板的显示和任务数据
            const [isBulkAssignModalOpen, setIsBulkAssignModalOpen] = useState(false);
            const [isBulkTransferModalOpen, setIsBulkTransferModalOpen] = useState(false);
            const [isBulkReturnModalOpen, setIsBulkReturnModalOpen] = useState(false);
            const [contractInfoTask, setContractInfoTask] = useState(null); // <-- 在这里添加新状态
            const [showConfetti, setShowConfetti] = useState(false);
            const [isWorkbenchModalOpen, setIsWorkbenchModalOpen] = useState(false);
            const [editingSummaryDate, setEditingSummaryDate] = useState(null);
            const [workSummaries, setWorkSummaries] = useState([]);
            const salesPersonOptions = useMemo(() =>
                profiles
                    .filter(p => p.department === '市场部门')
                    .map(p => ({
                        label: String(userMap.get(p.id) || p.email || ''), // <-- 核心修复：确保label始终为字符串
                        value: p.id
                    }))
                    .sort((a, b) => a.label.localeCompare(b.label, 'zh-CN')),
                [profiles, userMap]
            );

            const reviewerOptions = useMemo(() =>
                profiles
                    .filter(p => p.department === '市场部门')
                    .map(p => ({
                        label: String(userMap.get(p.id) || p.email || ''), // <-- 核心修复：确保label始终为字符串
                        value: p.id
                    }))
                    .sort((a, b) => a.label.localeCompare(b.label, 'zh-CN')),
                [profiles, userMap]
            );

            const projectManagerOptions = useMemo(() =>
                profiles
                    .filter(p => p.department === '技术部门')
                    .map(p => ({
                        label: String(userMap.get(p.id) || p.email || ''), // <-- 核心修复：确保label始终为字符串
                        value: p.id
                    }))
                    .sort((a, b) => a.label.localeCompare(b.label, 'zh-CN')),
                [profiles, userMap]
            );
            // --- 【新】用于刷新用户列表的函数 ---
            const refreshProfiles = useCallback(async () => {
                try {
                    const { data: profilesData, error: profilesError } = await supabase.from('profiles').select('*');
                    if (profilesError) throw profilesError;

                    const { data: allUsersData, error: allUsersError } = await supabase.functions.invoke('get-users');
                    if (allUsersError) throw allUsersError;

                    const users = new Map();
                    if (allUsersData) {
                        allUsersData.forEach(user => {
                            const profile = (profilesData || []).find(p => p.id === user.id);
                            const displayName = profile?.username || user.email;
                            users.set(user.id, displayName);
                        });
                    }

                    setProfiles(profilesData || []);
                    setUserMap(users);
                    console.log("用户数据已刷新！");
                } catch (error) {
                    showNotification("刷新用户数据失败: " + error.message, 'error');
                }
            }, []); // 空依赖数组确保函数本身稳定
            // 这个 useMemo 钩子会根据当前用户的角色，实时计算出他最终拥有的所有功能权限
            const currentUserEffectivePermissions = useMemo(() => {
                const allPermissions = {
                    canCreateTask: true, canImportData: true, canExportData: true,
                    canViewStatistics: true, canManageConfig: true, canManageTeams: true,
                };

                // --- 终极保障：如果当前登录用户的邮箱是指定的管理员邮箱，则直接授予所有权限 ---
                if (session?.user?.email === '396382608@qq.com') {
                    return allPermissions;
                }

                // --- 对非指定管理员的用户，执行常规的权限计算 ---
                if (!currentUserProfile || !rolePermissions) {
                    return { // 返回一个全为false的对象
                        canCreateTask: false, canImportData: false, canExportData: false,
                        canViewStatistics: false, canManageConfig: false, canManageTeams: false,
                    };
                }

                // 默认权限
                const permissions = {
                    canCreateTask: false, canImportData: false, canExportData: false,
                    canViewStatistics: false, canManageConfig: false, canManageTeams: false,
                };

                const userRoleKeys = currentUserProfile.permissions?.roles || [];

                // 计算角色的“基础权限”并集
                userRoleKeys.forEach(roleKey => {
                    const rolePerm = rolePermissions.find(p => p.role_key === roleKey.role); // <-- 修正：从对象中取出 .role 字符串进行比较
                    if (rolePerm) {
                        if (rolePerm.can_create_task) permissions.canCreateTask = true;
                        if (rolePerm.can_import_data) permissions.canImportData = true;
                        if (rolePerm.can_export_data) permissions.canExportData = true;
                        if (rolePerm.can_view_statistics) permissions.canViewStatistics = true;
                        if (rolePerm.can_manage_config) permissions.canManageConfig = true;
                        if (rolePerm.can_manage_teams) permissions.canManageTeams = true;
                    }
                });

                // 获取并应用用户的“特权”设置
                const overrides = currentUserProfile.permissions?.overrides || {};
                const grantPerms = overrides.grant || [];
                const denyPerms = overrides.deny || [];

                grantPerms.forEach(permKey => {
                    if (permissions.hasOwnProperty(permKey)) permissions[permKey] = true;
                });

                denyPerms.forEach(permKey => {
                    if (permissions.hasOwnProperty(permKey)) permissions[permKey] = false;
                });

                return permissions;
            }, [currentUserProfile, rolePermissions, session]); // <-- 将 session 加入依赖项
            // ================= 最终修正版通知系统核心代码块 (开始) =================

            // 1. 通知系统自身的状态
            // 【第1步】用这段新代码进行替换

            const [selectedNotifications, setSelectedNotifications] = useState(new Set());

            // --- 以下是我们新的、分类的状态 ---
            // 为三个分类分别创建独立的 State
            const [activeNotifications, setActiveNotifications] = useState([]);
            const [snoozedNotifications, setSnoozedNotifications] = useState([]);
            const [readNotifications, setReadNotifications] = useState([]);
            // 为从云端加载数据添加一个“加载中”的状态
            const [notificationsLoading, setNotificationsLoading] = useState(true);
            // 【第2步】请将这段新代码粘贴到第1步修改的代码下方

            useEffect(() => {
                const fetchNotifications = async () => {
                    setNotificationsLoading(true);
                    try {
                        // --- 核心修复：只获取属于当前登录用户的通知 ---
                        const { data, error } = await supabase
                            .from('notifications')
                            .select('*')
                            .eq('user_id', session.user.id); // <-- 添加此行

                        if (error) {
                            throw error;
                        }
                        if (data) {
                            const now = new Date();

                            // 使用与之前完全相同的逻辑，对从云端获取的数据进行分类
                            const initialActive = data.filter(n => !n.is_read && (!n.snoozed_until || new Date(n.snoozed_until) <= now))
                                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at)); const initialSnoozed = data.filter(n => !n.is_read && n.snoozed_until && new Date(n.snoozed_until) > now);
                            const initialRead = data.filter(n => n.is_read);

                            // 将分类好的数据存入对应的 State
                            setActiveNotifications(initialActive);
                            setSnoozedNotifications(initialSnoozed);
                            setReadNotifications(initialRead);
                        }
                    } catch (error) {
                        console.error("从云端加载通知失败:", error);
                    } finally {
                        setNotificationsLoading(false); // 无论成功与否，最后都结束加载状态
                    }
                };

                fetchNotifications();
            }, []); // 这个 effect 只在组件首次加载时运行一次
            // 【请将这段“实时监听器”代码粘贴到 fetchNotifications 的 useEffect 下方】
            useEffect(() => {
                const channel = supabase
                    .channel('public:notifications')
                    .on('postgres_changes', { event: '*', schema: 'public', table: 'notifications' },
                        (payload) => {
                            console.log('接收到数据库实时变更:', payload);
                            const { eventType, new: newRecord, old: oldRecord } = payload;
                            const now = new Date();

                            // 定义一个统一的分类函数
                            const categorize = (notification) => {
                                if (notification.is_read) return 'read';
                                if (notification.snoozed_until && new Date(notification.snoozed_until) > now) return 'snoozed';
                                return 'active';
                            };

                            // 从所有列表中移除旧记录（针对 UPDATE 和 DELETE）
                            const recordId = eventType === 'DELETE' ? oldRecord.id : newRecord.id;
                            setActiveNotifications(prev => prev.filter(n => n.id !== recordId));
                            setSnoozedNotifications(prev => prev.filter(n => n.id !== recordId));
                            setReadNotifications(prev => prev.filter(n => n.id !== recordId));

                            // 如果是 INSERT 或 UPDATE，则将新记录添加到正确的列表中
                            if (eventType === 'INSERT' || eventType === 'UPDATE') {
                                const category = categorize(newRecord);
                                if (category === 'active') {
                                    setActiveNotifications(prev => [...prev, newRecord].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                } else if (category === 'snoozed') {
                                    setSnoozedNotifications(prev => [...prev, newRecord].sort((a, b) => new Date(a.snoozed_until) - new Date(b.snoozed_until)));
                                } else if (category === 'read') {
                                    // 修正：使用正确的 'created_at' 字段进行排序
                                    setReadNotifications(prev => [...prev, newRecord].sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
                                }
                            }
                        }
                    )
                    .subscribe();

                // 组件卸载时，取消订阅
                return () => {
                    supabase.removeChannel(channel);
                };
            }, []); // 依赖项为空，确保只订阅一次
            useEffect(() => {
                if (isLoading || !currentUserProfile || !session) return;

                const reconcileAutoNotifications = async () => {
                    try {
                        // --- 核心修正：在此处统一声明一个数组 ---
                        const notificationsToUpsert = [];
                        const now = new Date();
                        now.setHours(0, 0, 0, 0); // 标准化时间，以便于日期比较

                        // --- 1. 升级版“备份提醒”逻辑 ---
                        const { data: existingBackupNotification, error: fetchBackupError } = await supabase
                            .from('notifications').select('id').eq('user_id', session.user.id).eq('type', 'backup_reminder')
                            .limit(1).maybeSingle();
                        if (fetchBackupError) throw fetchBackupError;

                        let shouldRemindBackup = false;
                        if (backupHistory.length === 0) {
                            // 如果从未备份过，从用户注册日开始算
                            const userCreationDate = new Date(session.user.created_at);
                            const daysSinceCreation = Math.floor((now - userCreationDate) / (1000 * 60 * 60 * 24));
                            if (daysSinceCreation > 30) {
                                shouldRemindBackup = true;
                            }
                        } else {
                            // 如果有备份记录，从上次备份日开始算
                            const lastBackupDate = new Date(backupHistory[0].backup_timestamp);
                            const daysSinceLastBackup = Math.floor((now - lastBackupDate) / (1000 * 60 * 60 * 24));
                            if (daysSinceLastBackup > 30) {
                                shouldRemindBackup = true;
                            }
                        }

                        // 只有在需要提醒且当前不存在提醒时，才添加
                        if (shouldRemindBackup && !existingBackupNotification) {
                            // --- 核心修正：使用统一的数组 ---
                            notificationsToUpsert.push({
                                user_id: session.user.id,
                                type: 'backup_reminder',
                                message: '数据备份提醒：您已超过30天未执行全量备份（或自注册以来），建议及时处理。',
                                is_read: false,
                            });
                        }

                        // --- 2. 修复版“紧急任务提醒”逻辑 ---
                        const activeTasks = tasksVisibleToUser.filter(t => t.status !== 'done' && t.status !== 'void');

                        // --- 替换为下面这段修正后的代码 ---
                        const urgentTasks = activeTasks.filter(t => {
                            if (!t.contractualDueDate) return false;

                            // 在筛选阶段就对截止日期进行标准化处理
                            const dueDate = new Date(t.contractualDueDate);
                            dueDate.setHours(0, 0, 0, 0);

                            // 使用与消息生成器完全相同的 Math.ceil 逻辑来确保一致性
                            const diffDays = Math.ceil((dueDate - now) / (1000 * 60 * 60 * 24));

                            // 返回正确的比较结果
                            return diffDays <= 7;
                        });

                        if (urgentTasks.length > 0) {
                            const { data: existingUrgentNotifications, error: fetchUrgentError } = await supabase
                                .from('notifications').select('notification_id, message').eq('user_id', session.user.id).eq('type', 'urgent_task');
                            if (fetchUrgentError) throw fetchUrgentError;

                            const existingMap = new Map((existingUrgentNotifications || []).map(n => [n.notification_id, n.message]));

                            urgentTasks.forEach(task => {
                                const notificationId = `urgent-${task.id}`;
                                const dueDate = new Date(task.contractualDueDate);
                                dueDate.setHours(0, 0, 0, 0);
                                const diffDays = Math.ceil((dueDate - now) / (1000 * 3600 * 24));
                                const duration = formatDuration(diffDays);
                                const newMessage = `任务 ${generateTaskSummary(task)} ${duration.status} (${duration.time})。`;
                                if (!existingMap.has(notificationId) || existingMap.get(notificationId) !== newMessage) {
                                    // --- 核心修正：使用统一的数组 ---
                                    notificationsToUpsert.push({
                                        user_id: session.user.id,
                                        notification_id: notificationId,
                                        type: 'urgent_task',
                                        message: newMessage,
                                        is_read: false,
                                    });
                                }
                            });
                        }

                        // --- 3. 统一执行数据库操作 ---
                        // --- 核心修正：判断统一的数组 ---
                        if (notificationsToUpsert.length > 0) {
                            const { error } = await supabase.from('notifications').upsert(notificationsToUpsert, { onConflict: 'user_id, notification_id' });
                            if (error) throw error;
                        }

                    } catch (error) {
                        console.error('自动生成新通知失败:', error);
                    }
                };

                reconcileAutoNotifications();
            }, [tasks, backupHistory, isLoading, session, currentUserProfile, tasksVisibleToUser]);
            const addNotification = useCallback((notification) => {
                setNotifications(prev => {
                    if (!notification || !notification.message) { return prev; }
                    const existingIndex = prev.findIndex(n => n.id === notification.id);
                    if (existingIndex !== -1) {
                        const updatedNotifications = [...prev];
                        const existingNotification = updatedNotifications[existingIndex];
                        updatedNotifications[existingIndex] = {
                            ...existingNotification,
                            message: notification.message,
                            timestamp: new Date().toISOString(),
                        };
                        return updatedNotifications;
                    } else {
                        return [{ isRead: false, snoozeUntil: null, timestamp: new Date().toISOString(), ...notification }, ...prev];
                    }
                });
            }, []);

            const handleToggleNotificationSelect = (notificationId) => {
                setSelectedNotifications(prev => {
                    const newSet = new Set(prev);
                    if (newSet.has(notificationId)) newSet.delete(notificationId); else newSet.add(notificationId);
                    return newSet;
                });
            };

            const handleToggleSelectAllInCategory = (categoryNotifications) => {
                const categoryIds = categoryNotifications.map(n => n.id);
                const areAllSelected = categoryIds.length > 0 && categoryIds.every(id => selectedNotifications.has(id));
                setSelectedNotifications(prev => {
                    const newSet = new Set(prev);
                    if (areAllSelected) { categoryIds.forEach(id => newSet.delete(id)); }
                    else { categoryIds.forEach(id => newSet.add(id)); }
                    return newSet;
                });
            };

            // 【第7步.1】用这段新代码替换
            const handleBulkMarkAsRead = async () => {
                const idsToUpdate = Array.from(selectedNotifications);
                if (idsToUpdate.length === 0) return;

                try {
                    // 向云端发送命令：将这些通知标记为已读，并清除暂缓日期
                    const { error } = await supabase
                        .from('notifications')
                        .update({
                            is_read: true,
                            snoozed_until: null
                        })
                        .in('id', idsToUpdate);

                    if (error) throw error;

                    setSelectedNotifications(new Set()); // 清空选择
                    showNotification('成功标记为已读！');
                } catch (error) {
                    console.error('标记已读失败:', error);
                    showNotification('标记已读失败: ' + error.message, 'error');
                }
            };

            // 【第7步.2】用这段新代码替换
            const handleBulkDelete = async () => {
                const idsToDelete = Array.from(selectedNotifications);
                if (idsToDelete.length === 0) return;

                try {
                    // 向云端发送删除命令
                    const { error } = await supabase
                        .from('notifications')
                        .delete()
                        .in('id', idsToDelete);

                    if (error) throw error;

                    setSelectedNotifications(new Set()); // 清空选择
                    showNotification('通知已成功删除！');
                } catch (error) {
                    console.error('删除通知失败:', error);
                    showNotification('删除通知失败: ' + error.message, 'error');
                }
            };

            // 【第4步.2】用这段新代码替换
            const handleBulkSnooze = async (snoozedUntil) => {
                const idsToSnooze = Array.from(selectedNotifications);
                if (idsToSnooze.length === 0) return;

                try {
                    const { error } = await supabase
                        .from('notifications')
                        .update({ is_read: false, snoozed_until: snoozedUntil })
                        .in('id', idsToSnooze);
                    if (error) throw error;
                    setSelectedNotifications(new Set());
                    showNotification('成功将通知设置为稍后提醒！'); // <-- 新增成功提示
                } catch (error) {
                    console.error('批量暂缓通知失败:', error);
                    showNotification('设置稍后提醒失败: ' + error.message, 'error'); // <-- 修改失败提示
                }
            };
            // 【第3步】添加这个新函数
            const handleBulkCancelSnooze = () => {
                const idsToUpdate = Array.from(selectedNotifications);
                if (idsToUpdate.length === 0) return;

                setConfirmationState({
                    isOpen: true,
                    title: '批量取消暂缓',
                    children: `您确定要将选中的 ${idsToUpdate.length} 条通知移回“当前通知”列表吗？`,
                    confirmVariant: 'primary',
                    onConfirm: async () => {
                        try {
                            const { error } = await supabase
                                .from('notifications')
                                .update({ snoozed_until: null })
                                .in('id', idsToUpdate);
                            if (error) throw error;
                            setSelectedNotifications(new Set());
                            showNotification('成功取消暂缓！'); // <-- 新增成功提示
                        } catch (err) {
                            console.error('批量取消暂缓失败:', err);
                            showNotification('批量取消暂缓失败: ' + err.message, 'error'); // <-- 修改失败提示
                        } finally {
                            closeConfirmationModal();
                        }
                    }
                });
            };
            // 【第1步】请将这个新函数添加到 App 组件的其他 handler 函数旁边
            const onClearAllClick = (view) => {
                const isReadView = view === 'read';
                const title = isReadView ? '清除所有已读消息' : '取消所有暂缓';
                const children = isReadView
                    ? '您确定要永久删除所有已读的消息吗？此操作无法撤销。'
                    : '您确定要将所有已暂缓的消息移回“当前通知”列表吗？';

                const handleConfirm = async () => {
                    try {
                        let error;
                        if (isReadView) {
                            ({ error } = await supabase.from('notifications').delete().eq('is_read', true));
                            if (error) throw error;
                            showNotification('所有已读消息已清除！'); // <-- 新增成功提示
                        } else {
                            ({ error } = await supabase.from('notifications').update({ snoozed_until: null }).gt('snoozed_until', new Date().toISOString()));
                            if (error) throw error;
                            showNotification('所有暂缓的通知已取消！'); // <-- 新增成功提示
                        }
                    } catch (err) {
                        console.error(`处理 ${view} 失败:`, err);
                        showNotification(`操作失败: ${err.message}`, 'error'); // <-- 修改失败提示
                    } finally {
                        closeConfirmationModal();
                    }
                };

                setConfirmationState({
                    isOpen: true,
                    title: title,
                    children: children,
                    onConfirm: handleConfirm,
                    confirmVariant: 'danger'
                });
            };
            // 4. 派生状态（用于UI渲染的列表）
            // 【第3步.1】用这行新代码替换
            const unreadCount = useMemo(() => activeNotifications.length, [activeNotifications]);

            // 【第3步.2】用这段新代码替换
            const groupedNotifications = useMemo(() => {
                return activeNotifications.reduce((acc, notification) => {
                    const type = notification.type || 'general';
                    if (!acc[type]) acc[type] = [];
                    acc[type].push(notification);
                    return acc;
                }, {});
            }, [activeNotifications]); // 注意依赖已变为 activeNotifications

            // ================= 最终修正版通知系统核心代码块 (结束) =================
            // --- 第一阶段，步骤 1：定义视图配置 ---
            const VIEW_CONFIG = [
                { key: 'overview', label: '总览' }, { type: 'divider' }, { key: 'reviewing', label: '评审中' },
                { key: 'assigning', label: '待分配' }, { key: 'inprogress', label: '进行中' }, { key: 'auditing', label: '审核中' },
                { key: 'rechecking', label: '复核中' }, { key: 'issuing', label: '签发中' }, { type: 'divider' },
                { key: 'done', label: '已完成' }, { type: 'divider' }, { key: 'void', label: '已作废' },
                { key: 'deleted', label: '回收站' },
            ];
            const WORKFLOW_STATUSES = [
                { value: 'reviewing', label: '评审中' }, { value: 'assigning', label: '待分配' }, { value: 'inprogress', label: '进行中' },
                { value: 'auditing', label: '审核中' }, { value: 'rechecking', label: '复核中' }, { value: 'issuing', label: '签发中' },
                { value: 'done', label: '已完成' }, { value: 'void', label: '已作废' },
            ];
            const statusLabelMap = { reviewing: '评审中', assigning: '待分配', inprogress: '进行中', auditing: '审核中', rechecking: '复核中', issuing: '签发中', done: '已完成', void: '已作废' };
            // --- 【新】工作流地图核心配置 ---
            const WORKFLOW_CONFIG = {
                'reviewing': {
                    label: '评审中',
                    pastTenseLabel: '已评审', // <-- 新增
                    responsible: 'reviewerId',
                    actions: ['submit', 'edit', 'void', 'delete'],
                    next_status: 'assigning'
                },
                'assigning': {
                    label: '待分配',
                    pastTenseLabel: '已分配', // <-- 新增
                    responsible: 'salesPerson', // <-- 新增：分配任务一般由业务员或其主管操作
                    actions: ['assign', 'emergency', 'edit', 'void', 'delete'],
                    prev_statuses: [{ key: 'reviewing', label: '退回至评审' }],
                    next_status: 'inprogress'
                },
                'inprogress': {
                    label: '进行中',
                    pastTenseLabel: '已处理', // <-- 新增
                    responsible: 'projectManager', // <-- 新增
                    actions: ['submit', 'return', 'transfer', 'emergency', 'edit', 'void', 'delete'],
                    prev_statuses: [{ key: 'assigning', label: '退回至待分配' }],
                    next_status: 'auditing'
                },
                'auditing': {
                    label: '审核中',
                    pastTenseLabel: '已审核', // <-- 新增
                    responsible: 'auditorName', // <-- 新增
                    actions: ['submit', 'return', 'transfer', 'emergency', 'edit', 'void', 'delete'],
                    prev_statuses: [{ key: 'inprogress', label: '退回至进行中' }],
                    next_status: 'rechecking'
                },
                'rechecking': {
                    label: '复核中',
                    pastTenseLabel: '已复核', // <-- 新增
                    responsible: 'recheckerName', // <-- 新增
                    actions: ['submit', 'return', 'transfer', 'emergency', 'edit', 'void', 'delete'],
                    prev_statuses: [{ key: 'auditing', label: '退回至审核中' }],
                    next_status: 'issuing'
                },
                'issuing': {
                    label: '签发中',
                    pastTenseLabel: '已签发', // <-- 新增
                    responsible: 'issuerName', // <-- 新增
                    actions: ['submit', 'return', 'transfer', 'emergency', 'edit', 'void', 'delete'],
                    prev_statuses: [{ key: 'rechecking', label: '退回至复核中' }],
                    next_status: 'done'
                },
                'done': {
                    label: '已完成',
                    // --- 核心修改：列出所有可能的操作 ---
                    actions: ['archive', 'edit', 'delete', 'void',],
                },
            };

            const ACTION_DEFINITIONS = [
                { key: 'edit', label: '编辑任务' },
                { key: 'delete', label: '删除任务' },
                { key: 'void', label: '作废任务' },
                { key: 'assign', label: '分配任务' },
                { key: 'submit', label: '提交任务' },
                { key: 'return', label: '退回任务' },
                { key: 'transfer', label: '转交任务' },
                { key: 'emergency', label: '加急任务' },
                { key: 'archive', label: '存档任务' },
            ];

            const COLUMN_DEFINITIONS = [
                { key: 'status', label: '任务状态' }, { key: 'createdAt', label: '任务下达日期' }, { key: 'customTaskId', label: '任务编号' },
                { key: 'projectName', label: '项目名称' }, { key: 'taskType', label: '任务类型' }, { key: 'region', label: '所属地区' },
                { key: 'contractAmount', label: '合同金额' }, { key: 'salesPerson', label: '业务人员' },
                { key: 'sourcing_department', label: '所属市场部门' }, // <-- 新增
                { key: 'projectManager', label: '项目负责人' },
                { key: 'execution_department', label: '所属技术部门' }, // <-- 新增
                { key: 'contractualDueDate', label: '合同规定日期' }, { key: 'actualCompletionDate', label: '实际完成日期' },
                { key: 'timeRemaining', label: '剩余/完成时间' }, { key: 'progressDetails', label: '项目进展情况' }, { key: 'isArchived', label: '存档' }
            ];

            const VIEW_COLUMN_MAP = {
                overview: ['status', 'createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'timeRemaining', 'progressDetails', 'isArchived'],
                reviewing: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'execution_department', 'contractualDueDate'],
                assigning: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'execution_department', 'contractualDueDate'],
                inprogress: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'timeRemaining', 'progressDetails'],
                auditing: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'timeRemaining', 'progressDetails'],
                rechecking: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'timeRemaining', 'progressDetails'],
                issuing: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'timeRemaining', 'progressDetails'],
                done: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'actualCompletionDate', 'progressDetails', 'isArchived'],
                void: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'progressDetails'],
                deleted: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'contractAmount', 'salesPerson', 'sourcing_department', 'projectManager', 'execution_department', 'contractualDueDate', 'progressDetails']
            };
            // --- 全新、完整的权限蓝图 ---
            const ALL_VIEWS = VIEW_CONFIG.filter(v => v.key).map(v => v.key);
            const ALL_COLUMNS = [ // 用于“全选”的列表
                'status', 'createdAt', 'customTaskId', 'projectName', 'taskType', 'region',
                'department', 'contractAmount', 'salesPerson', 'projectManager',
                'contractualDueDate', 'actualCompletionDate', 'timeRemaining', 'progressDetails', 'isArchived'
            ];

            const ROLE_DEFINITIONS = [
                {
                    key: 'manager',
                    label: '经理',
                    defaultViews: ['overview', 'reviewing', 'void', 'deleted'],
                    defaultColumns: [...ALL_COLUMNS]
                },
                {
                    key: 'issuer',
                    label: '签发人',
                    defaultViews: ['overview', 'reviewing', 'void', 'deleted'],
                    defaultColumns: [...ALL_COLUMNS]
                },
                {
                    key: 'office',
                    label: '办公室',
                    defaultViews: ['overview', 'reviewing', 'void', 'deleted'],
                    defaultColumns: [...ALL_COLUMNS]
                },
                {
                    key: 'customer_service', // 新增角色
                    label: '前台客服',
                    defaultViews: ['overview', 'reviewing', 'void', 'deleted'],
                    defaultColumns: [...ALL_COLUMNS]
                },
                {
                    key: 'department_head',
                    label: '部门负责人',
                    defaultViews: ['overview', 'assigning', 'inprogress', 'auditing', 'rechecking', 'issuing', 'done', 'void'],
                    defaultColumns: [...ALL_COLUMNS]
                },
                {
                    key: 'project_manager',
                    label: '项目负责人',
                    defaultViews: ['inprogress', 'auditing', 'rechecking', 'done', 'void'],
                    defaultColumns: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'department', 'salesPerson', 'contractualDueDate', 'actualCompletionDate', 'timeRemaining', 'progressDetails', 'isArchived']
                },
                {
                    key: 'auditor',
                    label: '审核人',
                    defaultViews: ['inprogress', 'auditing', 'rechecking', 'done', 'void'],
                    defaultColumns: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'department', 'salesPerson', 'contractualDueDate', 'actualCompletionDate', 'timeRemaining', 'progressDetails', 'isArchived']
                },
                {
                    key: 'rechecker',
                    label: '复核人',
                    defaultViews: ['inprogress', 'auditing', 'rechecking', 'done', 'void'],
                    defaultColumns: ['createdAt', 'customTaskId', 'projectName', 'taskType', 'region', 'department', 'salesPerson', 'contractualDueDate', 'actualCompletionDate', 'timeRemaining', 'progressDetails', 'isArchived']
                }
            ];

            // --- 在此添加新代码 ---
            const COLUMN_WIDTH_MAP = {
                checkbox: 'auto',
                status: '0.8fr',
                createdAt: '1.1fr',
                customTaskId: '1.2fr',
                projectName: '2fr',
                taskType: '1.5fr',
                region: '0.8fr',
                // department: '1.2fr', // <-- 删除这一行
                sourcing_department: '1.2fr', // <-- 新增
                execution_department: '1.8fr', // <-- 新增
                contractAmount: '1fr',
                salesPerson: '1fr',
                projectManager: '1fr',
                contractualDueDate: '1.2fr',
                actualCompletionDate: '1.2fr',
                timeRemaining: '1.2fr',
                progressDetails: '2.5fr',
                isArchived: '0.8fr',
                actions: '0.5fr'
            };
            const tasksForCount = useMemo(() => { if (!activeFilters.department) return tasks; return tasks.filter(task => task.department === activeFilters.department); }, [tasks, activeFilters.department]);
            const viewCounts = useMemo(() => {
                // 1. 首先，获取对当前用户可见的所有任务（这是之前 filteredAndSortedTasks 的核心逻辑）
                const tasksVisibleToUser = tasks.filter(task => {
                    if (!currentUserProfile) return false;
                    const roles = currentUserProfile.permissions?.roles ?? [];
                    const isAdmin = roles.some(p => p.role === 'admin') || session.user.email === '396382608@qq.com';

                    if (isAdmin) return true; // 管理员能看到所有任务

                    // 对普通用户，执行精细的权限过滤
                    const assignedDepts = new Set(roles.filter(p => p.role === 'department_head').map(p => p.department));

                    let isVisible = false;
                    if (assignedDepts.has(task.sourcing_department) || assignedDepts.has(task.execution_department)) {
                        isVisible = true;
                    }
                    if (!isVisible) {
                        const participants = [task.salesPerson, task.projectManager, task.auditor_name, task.rechecker_name, task.issuer_name];
                        if (participants.includes(session.user.id)) {
                            isVisible = true;
                        }
                    }
                    return isVisible;
                });

                // 2. 基于这个被权限过滤后的任务列表来计算计数
                const counts = {};
                VIEW_CONFIG.forEach(view => {
                    if (view.key) counts[view.key] = 0;
                });

                tasksVisibleToUser.forEach(task => {
                    if (counts[task.status] !== undefined) {
                        counts[task.status]++;
                    }
                });

                // 3. 单独计算特殊视图的计数
                counts.deleted = deletedTasks.length; // 回收站对所有人都一样
                counts.overview = tasksVisibleToUser.length; // 总览计数 = 用户可见的任务总数

                return counts;
            }, [tasks, deletedTasks, currentUserProfile, session]); // 更新依赖项
            const visibleViews = useMemo(() => {
                // 如果用户档案或其角色配置不存在，则返回空数组
                if (!currentUserProfile?.permissions?.roles) {
                    return [];
                }

                // --- 【核心修复】检查是否为管理员 ---
                const roles = currentUserProfile.permissions.roles;
                const isAdmin = roles.some(r => r.role === 'admin') || session.user.email === '396382608@qq.com';

                if (isAdmin) {
                    // 如果是管理员，直接返回所有预设的视图，绕过所有权限检查
                    return VIEW_CONFIG;
                }

                // --- 如果不是管理员，则执行原有的、精细的权限计算 ---
                const userRoleKeys = new Set(roles.map(r => r.role));
                const viewsFromRoles = new Set();
                availableRoles.forEach(roleDef => {
                    if (userRoleKeys.has(roleDef.key)) {
                        (roleDef.default_views || []).forEach(viewKey => viewsFromRoles.add(viewKey));
                    }
                });

                const overrides = currentUserProfile.permissions.overrides?.visibility_perms?.views || {};
                const grantedViews = new Set(overrides.grant || []);
                const deniedViews = new Set(overrides.deny || []);

                const finalVisibleViewKeys = new Set([...viewsFromRoles, ...grantedViews]);
                deniedViews.forEach(viewKey => finalVisibleViewKeys.delete(viewKey));

                const result = [];
                VIEW_CONFIG.forEach((view, index) => {
                    if (view.key && finalVisibleViewKeys.has(view.key)) {
                        result.push(view);
                    } else if (view.type === 'divider') {
                        const prevView = VIEW_CONFIG[index - 1];
                        const nextView = VIEW_CONFIG[index + 1];
                        if (prevView && finalVisibleViewKeys.has(prevView.key) && nextView && finalVisibleViewKeys.has(nextView.key)) {
                            if (result.length > 0 && result[result.length - 1].type !== 'divider') {
                                result.push(view);
                            }
                        }
                    }
                });

                return result;
            }, [currentUserProfile, availableRoles, session]); // 依赖项需要加入 session
            // --- 添加结束 ---
            // --- 从 Supabase 拉取初始数据 ---
            useEffect(() => {
                let isMounted = true;
                const fetchData = async () => {
                    if (isMounted) { setIsLoading(true); }
                    try {
                        const [
                            { data: tasksData, error: tasksError },
                            { data: deletedData, error: deletedError },
                            { data: historyData, error: historyError },
                            { data: mgmtData, error: mgmtError },
                            { data: profilesData, error: profilesError },
                            { data: rolesData, error: rolesError },
                            { data: rolePermsData, error: rolePermsError },
                            { data: actionPermsData, error: actionPermsError },
                            { data: allUsersData, error: allUsersError }
                        ] = await Promise.all([
                            supabase.from('tasks').select('*'),
                            supabase.from('deleted_tasks').select('*'),
                            supabase.from('backup_history').select('*').eq('user_id', session.user.id).order('backup_timestamp', { ascending: false }),
                            supabase.from('management_data').select('*').eq('id', 1).single(),
                            supabase.from('profiles').select('*'),
                            supabase.from('roles').select('*').order('label'),
                            supabase.from('role_permissions').select('*'),
                            supabase.from('action_permissions').select('*'),
                            supabase.functions.invoke('get-users')
                        ]);

                        if (tasksError) throw tasksError;
                        if (deletedError) throw deletedError;
                        if (historyError) throw historyError;
                        if (mgmtError && mgmtError.code !== 'PGRST116') throw mgmtError;
                        if (profilesError) throw profilesError;
                        if (rolesError) throw rolesError;
                        if (allUsersError) throw allUsersError;

                        const users = new Map();
                        if (allUsersData) {
                            allUsersData.forEach(user => {
                                const displayName = user.display_name || user.email;
                                users.set(user.id, displayName);
                            });
                        }

                        if (isMounted) {
                            setTasks((tasksData || []).map(fromSnakeCase));
                            setDeletedTasks(deletedData.map(item => ({ ...fromSnakeCase(item.data), id: item.id, deletedAt: item.deleted_at })) || []);
                            setBackupHistory(historyData || []);

                            // --- 核心修复：在这里加载所有新字段 ---
                            if (mgmtData) {
                                setManagementData({
                                    id: mgmtData.id,
                                    regions: mgmtData.regions || [],
                                    taskTypes: mgmtData.task_types || [],
                                    department_structure: mgmtData.department_structure || {},
                                    signingEntities: mgmtData.signing_entities || [], // <-- 读取签订单位
                                    invoiceTypes: mgmtData.invoice_types || [],     // <-- 读取发票类型
                                    contractAdmins: mgmtData.contract_admins || [],   // <-- 读取合同管理员
                                });
                            }

                            setProfiles(profilesData || []);
                            setUserMap(users);
                            const userProfile = (profilesData || []).find(p => p.id === session.user.id);
                            setCurrentUserProfile(userProfile || null);
                            setAvailableRoles(rolesData || []);
                            await refreshPermissionData();
                        }
                    } catch (error) {
                        console.error("从云端加载数据失败:", error);
                        alert("从云端加载数据失败: " + error.message);
                    } finally {
                        if (isMounted) { setIsLoading(false); }
                    }
                };
                fetchData();
                return () => { isMounted = false; };
            }, []);

            // --- 实时同步 ---
            useEffect(() => {
                const channel = supabase.channel('public-db-changes');
                const handleDbChange = (payload) => {
                    console.log('数据库发生变更:', payload);
                    const { eventType, table, new: newRecord, old: oldRecord } = payload;
                    if (table === 'tasks') {
                        if (eventType === 'INSERT') {
                            const newTask = fromSnakeCase(newRecord);
                            setTasks(currentTasks => {
                                if (currentTasks.some(t => t.id === newTask.id)) return currentTasks;
                                return [...currentTasks, newTask];
                            });
                        }
                        if (eventType === 'UPDATE') {
                            const updatedTask = fromSnakeCase(newRecord);
                            setTasks(currentTasks => currentTasks.map(task => task.id === updatedTask.id ? updatedTask : task));
                        }
                        if (eventType === 'DELETE') {
                            setTasks(currentTasks => currentTasks.filter(task => task.id !== oldRecord.id));
                        }
                    } else if (table === 'deleted_tasks') {
                        if (eventType === 'INSERT') {
                            const newDeletedTask = { ...fromSnakeCase(newRecord.data), id: newRecord.id, deletedAt: newRecord.deleted_at };
                            setDeletedTasks(current => {
                                if (current.some(t => t.id === newDeletedTask.id)) return current;
                                return [...current, newDeletedTask];
                            });
                        }
                        if (eventType === 'DELETE') {
                            setDeletedTasks(current => current.filter(t => t.id !== oldRecord.id));
                        }
                    } else if (table === 'management_data' && eventType === 'UPDATE') {
                        setManagementData({
                            id: newRecord.id, departments: newRecord.departments || [], regions: newRecord.regions || [],
                            salesPersons: newRecord.sales_persons || [], projectManagers: newRecord.project_managers || [], taskTypes: newRecord.task_types || []
                        });
                    }
                };
                channel.on('postgres_changes', { event: '*', schema: 'public' }, handleDbChange).subscribe();
                return () => { supabase.removeChannel(channel); };
            }, []);

            useEffect(() => { const root = window.document.documentElement; if (isDarkMode) root.classList.add('dark'); else root.classList.remove('dark'); localStorage.setItem('task_manager_isDarkMode_v4.2.3', JSON.stringify(isDarkMode)); }, [isDarkMode]);
            useEffect(() => { const handleFullscreenChange = () => setIsFullscreen(!!document.fullscreenElement); document.addEventListener('fullscreenchange', handleFullscreenChange); document.addEventListener('webkitfullscreenchange', handleFullscreenChange); return () => { document.removeEventListener('fullscreenchange', handleFullscreenChange); document.removeEventListener('webkitfullscreenchange', handleFullscreenChange); }; }, []);

            useEffect(() => {
                try {
                    window.localStorage.setItem('task_manager_backupHistory', JSON.stringify(backupHistory));
                } catch (error) {
                    console.error("向localStorage保存备份历史失败", error);
                }
            }, [backupHistory]);

            // 【修改后】的 filteredAndSortedTasks，增加了 Admin 的数据豁免权
            const filteredAndSortedTasks = useMemo(() => {
                if (!currentUserProfile) return [];

                const roles = currentUserProfile.permissions?.roles ?? [];
                const isAdmin = roles.some(p => p.role === 'admin') || session.user.email === '396382608@qq.com';

                let sourceTasks;
                if (currentView === 'deleted') {
                    sourceTasks = [...deletedTasks];
                } else if (currentView === 'overview') {
                    sourceTasks = [...tasks];
                } else {
                    sourceTasks = tasks.filter(t => t.status === currentView);
                }

                let permittedTasks;
                if (isAdmin) {
                    permittedTasks = sourceTasks;
                } else {
                    const assignedDepts = new Set(roles.filter(p => p.role === 'department_head').map(p => p.department));
                    permittedTasks = sourceTasks.filter(task => {
                        let isVisible = false;
                        if (assignedDepts.has(task.sourcing_department) || assignedDepts.has(task.execution_department)) {
                            isVisible = true;
                        }
                        if (!isVisible) {
                            const participants = [task.salesPerson, task.projectManager, task.auditor_name, task.rechecker_name, task.issuer_name];
                            if (participants.includes(session.user.id)) {
                                isVisible = true;
                            }
                        }
                        return isVisible;
                    });
                }

                // 在已授权的任务范围内，再应用界面上的筛选和搜索
                return permittedTasks.filter(task => {
                    // --- 1. 部门筛选逻辑 ---
                    const { department } = activeFilters;
                    const departmentMatch = department === 'all' || !department || task.sourcing_department === department || task.execution_department === department;

                    // --- 2. 全新的多关键词搜索逻辑 ---
                    const searchKeywords = debouncedSearchTerm.trim().toLowerCase().split(/\s+/).filter(Boolean);
                    if (searchKeywords.length === 0) {
                        return departmentMatch; // 如果没有搜索词，只看部门匹配结果
                    }

                    // 将任务中所有可搜索的文本字段（包括转换后的人名）合并成一个字符串
                    const combinedSearchableText = [
                        task.customTaskId,
                        task.projectName,
                        task.region,
                        task.taskType,
                        userMap.get(task.salesPerson),      // 使用 userMap 将 ID 转换为可搜索的姓名
                        userMap.get(task.projectManager),   // 使用 userMap 将 ID 转换为可搜索的姓名
                        userMap.get(task.auditor_name),     // 补充其他人员字段
                        userMap.get(task.rechecker_name),
                        userMap.get(task.issuer_name)
                    ].filter(Boolean).join(' ').toLowerCase();

                    // 检查是否所有关键词都能在合并后的文本中找到 (AND 逻辑)
                    const searchTermMatch = searchKeywords.every(keyword =>
                        combinedSearchableText.includes(keyword)
                    );

                    // --- 3. 最终决定 ---
                    return departmentMatch && searchTermMatch;
                });

            }, [tasks, deletedTasks, currentView, activeFilters, debouncedSearchTerm, currentUserProfile, userMap, session]);
            const showNotification = (message, type = 'success') => {
                setNotification({ show: true, message, type });
            };

            const handleSaveTask = async (taskData, isEdit) => {
                setModalError(null);
                try {
                    const actorName = userMap.get(session.user.id) || session.user.email; // 统一获取操作人

                    if (isEdit) {
                        const originalTask = tasks.find(t => t.id === taskData.id);
                        const changes = generateChangeLog(originalTask, taskData, userMap);
                        let newHistory = originalTask.history || [];

                        if (changes.length > 0) {
                            // --- 核心修复：为“编辑”操作生成的每一条日志都添加操作人 ---
                            const changeLogs = changes.map(c => ({
                                action: c,
                                timestamp: new Date().toISOString(),
                                actor: actorName // <-- 补上缺失的操作人
                            }));
                            newHistory = [...newHistory, ...changeLogs];
                        }
                        const dataForSupabase = toSnakeCase({ ...taskData, history: newHistory });
                        const { error } = await supabase.from('tasks').update(dataForSupabase).eq('id', taskData.id);
                        if (error) throw error;

                    } else { // 创建新任务的逻辑 (保持不变，已是正确的)
                        const newHistory = [{
                            action: '创建了任务',
                            timestamp: new Date().toISOString(),
                            actor: actorName
                        }];
                        const dataForSupabase = toSnakeCase({ ...taskData, history: newHistory });
                        const { data: existing, error: checkError } = await supabase.from('tasks').select('id').eq('custom_task_id', taskData.customTaskId).maybeSingle();
                        if (checkError) throw checkError;
                        if (existing) {
                            throw new Error(`任务编号 "${taskData.customTaskId}" 已存在。`);
                        }
                        const { error } = await supabase.from('tasks').insert(dataForSupabase);
                        if (error) throw error;
                    }

                    handleCloseModal();
                    showNotification(isEdit ? '任务更新成功！' : '任务创建成功！');
                } catch (error) {
                    setModalError("保存失败: " + error.message);
                    showNotification("保存失败: " + error.message, 'error');
                }
            };

            const handleConfirmBulkSubmit = async () => {
                let isAnyTaskCompleted = false; // <-- 新增一个标记
                const actorName = userMap.get(session.user.id) || session.user.email;

                // 1. 筛选出可以被“提交”的任务
                const updates = Array.from(selectedTasks).map(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return null;

                    // 2. 从 WORKFLOW_CONFIG 中智能查找下一个状态
                    const nextStatus = WORKFLOW_CONFIG[task.status]?.next_status;

                    // 如果任务没有下一个状态（如已完成），则跳过
                    if (!nextStatus) {
                        console.warn(`任务 ${task.customTaskId} 在状态 ${task.status} 下没有可提交的下一阶段，已跳过。`);
                        return null;
                    }

                    // 3. 为每个任务生成标准化的日志
                    const actionText = `通过批量操作提交，进入 [${statusLabelMap[nextStatus]}] 阶段`;
                    const newHistory = [...(task.history || []), {
                        action: actionText,
                        timestamp: new Date().toISOString(),
                        actor: actorName // 确保记录操作人
                    }];

                    const updatedTaskObject = { ...task, status: nextStatus, history: newHistory };

                    return { id: taskId, ...toSnakeCase(updatedTaskObject) };
                }).filter(Boolean); // 过滤掉所有被跳过的无效任务

                if (updates.length === 0) {
                    showNotification("没有可提交的任务。", 'error');
                    return;
                }

                // 4. 一次性将所有更新推送到数据库
                const { error } = await supabase.from('tasks').upsert(updates);

                if (error) {
                    showNotification(`批量提交失败: ${error.message}`, 'error');
                } else {
                    setSelectedTasks(new Set());
                    showNotification(`成功提交 ${updates.length} 个任务！`);
                    // --- 【新增】如果批量操作中有任务完成，则触发动画 ---
                    if (isAnyTaskCompleted) {
                        setShowConfetti(true);
                        setTimeout(() => setShowConfetti(false), 5000);
                    }
                }
            };
            const handleConfirmBulkAssign = async (assignments) => {
                const actorName = userMap.get(session.user.id) || session.user.email;
                const nextStatus = 'inprogress';

                const camelCaseAssignments = {};
                for (const key in assignments) {
                    camelCaseAssignments[toCamelCase(key)] = assignments[key];
                }

                const updates = Array.from(selectedTasks).map(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return null;

                    // --- 核心修改：为批量分配也生成详细日志 ---
                    const changes = Object.keys(camelCaseAssignments)
                        .map(key => {
                            const fieldMap = { projectManager: '项目负责人', auditor_name: '审核人', rechecker_name: '复核人', issuer_name: '签发人' };
                            if (!fieldMap[key]) return null;
                            const newValue = userMap.get(camelCaseAssignments[key]) || '[空]';
                            return `${fieldMap[key]}被分配为"${newValue}"`;
                        })
                        .filter(Boolean)
                        .join('; ');

                    const actionText = `任务通过批量操作被分配，进入 [${statusLabelMap[nextStatus]}] 阶段: ${changes}`;
                    const newHistory = [...(task.history || []), {
                        action: actionText,
                        timestamp: new Date().toISOString(),
                        actor: actorName
                    }];

                    const updatedTaskObject = { ...task, ...camelCaseAssignments, status: nextStatus, history: newHistory };
                    return { id: taskId, ...toSnakeCase(updatedTaskObject) };
                }).filter(Boolean);

                if (updates.length === 0) return;

                const { error } = await supabase.from('tasks').upsert(updates);
                if (error) {
                    showNotification(`批量分配失败: ${error.message}`, 'error');
                } else {
                    setSelectedTasks(new Set());
                    setIsBulkAssignModalOpen(false);
                    showNotification(`成功分配 ${updates.length} 个任务！`);
                }
            };
            const handleConfirmBulkTransfer = async (assignments) => {
                if (Object.keys(assignments).length === 0) {
                    setIsBulkTransferModalOpen(false);
                    showNotification("您没有选择任何新的负责人。", 'error');
                    return;
                }
                const actorName = userMap.get(session.user.id) || session.user.email;

                // --- 核心修复：批量操作的逻辑与单个操作保持一致 ---
                const camelCaseAssignments = {};
                for (const key in assignments) {
                    camelCaseAssignments[toCamelCase(key)] = assignments[key];
                }

                const updates = Array.from(selectedTasks).map(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return null;

                    const changes = Object.keys(camelCaseAssignments)
                        .map(key => {
                            const fieldMap = { projectManager: '项目负责人', auditorName: '审核人', recheckerName: '复核人', issuerName: '签发人' };
                            if (!fieldMap[key]) return null;
                            const oldValue = userMap.get(task[key]) || '[空]';
                            const newValue = userMap.get(camelCaseAssignments[key]) || '[空]';
                            if (oldValue !== newValue) {
                                return `${fieldMap[key]}由"${oldValue}"转交给"${newValue}"`;
                            }
                            return null;
                        }).filter(Boolean).join('; ');

                    if (!changes) return null;

                    const actionText = `任务通过批量操作被转交: ${changes}`;
                    const newHistory = [...(task.history || []), {
                        action: actionText,
                        timestamp: new Date().toISOString(),
                        actor: actorName
                    }];

                    const updatedTaskObject = { ...task, ...camelCaseAssignments, history: newHistory };
                    return { id: taskId, ...toSnakeCase(updatedTaskObject) };
                }).filter(Boolean);

                if (updates.length === 0) {
                    setIsBulkTransferModalOpen(false);
                    showNotification("所有选中任务的负责人均未发生变化。", 'error');
                    return;
                }

                const { error } = await supabase.from('tasks').upsert(updates);
                if (error) {
                    showNotification(`批量转交失败: ${error.message}`, 'error');
                } else {
                    setSelectedTasks(new Set());
                    setIsBulkTransferModalOpen(false);
                    showNotification(`成功转交 ${updates.length} 个任务！`);
                }
            };
            const handleConfirmBulkReturn = async (reason) => {
                const actorName = userMap.get(session.user.id) || session.user.email;

                const updates = Array.from(selectedTasks).map(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    if (!task) return null;

                    // 智能查找可退回的上一个状态
                    const prevStatusConfig = WORKFLOW_CONFIG[task.status]?.prev_statuses?.[0];
                    if (!prevStatusConfig) return null; // 如果没有可退回的状态，则跳过

                    const actionText = `通过批量操作从 [${statusLabelMap[task.status]}] 退回至 [${statusLabelMap[prevStatusConfig.key]}]，原因: ${reason}`;
                    const newHistory = [...(task.history || []), {
                        action: actionText,
                        timestamp: new Date().toISOString(),
                        actor: actorName
                    }];

                    const updatedTaskObject = { ...task, status: prevStatusConfig.key, history: newHistory, is_urgent: false };
                    return { id: taskId, ...toSnakeCase(updatedTaskObject) };
                }).filter(Boolean);

                if (updates.length === 0) {
                    showNotification("没有可退回的任务。", 'error');
                    return;
                }

                const { error } = await supabase.from('tasks').upsert(updates);
                if (error) {
                    showNotification(`批量退回失败: ${error.message}`, 'error');
                } else {
                    setSelectedTasks(new Set());
                    showNotification(`成功退回 ${updates.length} 个任务！`);
                }
            };
            const handleDeleteTask = async (taskId) => {
                const taskToDelete = tasks.find(t => t.id === taskId);
                if (!taskToDelete) return;

                // --- 核心修改：在删除前，先为任务追加一条历史记录 ---
                const actorName = userMap.get(session.user.id) || session.user.email;
                const newHistory = [...(taskToDelete.history || []), {
                    action: '任务被删除 (移入回收站)', // 定义清晰的删除动作
                    timestamp: new Date().toISOString(),
                    actor: actorName
                }];

                // 更新任务对象，包含这条新的历史记录
                const taskWithDeleteRecord = { ...taskToDelete, history: newHistory };

                // 将包含删除记录的完整任务对象移入回收站
                const { error: insertError } = await supabase.from('deleted_tasks').insert({ original_id: taskToDelete.id, data: toSnakeCase(taskWithDeleteRecord) });
                if (insertError) { showNotification("移入回收站失败: " + insertError.message, 'error'); return; }

                // 从主任务表中删除
                const { error: deleteError } = await supabase.from('tasks').delete().eq('id', taskId);
                if (deleteError) { showNotification("删除原始任务失败: " + deleteError.message, 'error'); }
                else { showNotification("任务已移入回收站！"); }
            };

            const handleConfirmBulkDelete = async () => {
                const actorName = userMap.get(session.user.id) || session.user.email;
                const tasksToDelete = Array.from(selectedTasks).map(id => tasks.find(t => t.id === id)).filter(Boolean);

                // --- 核心修改：为每个任务添加删除日志 ---
                const deletedRecords = tasksToDelete.map(task => {
                    const newHistory = [...(task.history || []), {
                        action: '任务被删除 (移入回收站)',
                        timestamp: new Date().toISOString(),
                        actor: actorName
                    }];
                    const taskWithDeleteRecord = { ...task, history: newHistory };
                    return { original_id: task.id, data: toSnakeCase(taskWithDeleteRecord) };
                });

                const { error: insertError } = await supabase.from('deleted_tasks').insert(deletedRecords);
                if (insertError) { showNotification("批量移入回收站失败: " + insertError.message, 'error'); return; }

                const idsToDelete = tasksToDelete.map(t => t.id);
                const { error: deleteError } = await supabase.from('tasks').delete().in('id', idsToDelete);

                if (deleteError) {
                    showNotification("批量删除原始任务失败: " + deleteError.message, 'error');
                } else {
                    setSelectedTasks(new Set());
                    showNotification("批量删除操作成功！");
                }
            };

            const handleArchiveTask = async (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                const newHistory = [...(task.history || []), { action: '存档了任务', timestamp: new Date().toISOString() }];
                const { error } = await supabase.from('tasks').update({ is_archived: true, history: newHistory }).eq('id', taskId);
                if (error) { showNotification("存档失败: " + error.message, 'error'); }
                else { showNotification("任务已存档！"); }
            };

            const handleVoidTask = async (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                const actorName = userMap.get(session.user.id) || session.user.email;
                const newHistory = [...(task.history || []), { action: '标记为已作废', timestamp: new Date().toISOString(), actor: actorName }]; const { error } = await supabase.from('tasks').update({ status: 'void', history: newHistory }).eq('id', taskId);
                if (error) { showNotification("作废失败: " + error.message, 'error'); }
                else { showNotification("任务已作废！"); }
            };

            const handleConfirmBulkVoid = async () => {
                const actorName = userMap.get(session.user.id) || session.user.email;
                const updates = Array.from(selectedTasks).map(taskId => {
                    const task = tasks.find(t => t.id === taskId);
                    const newHistory = [...(task.history || []), {
                        action: '通过批量操作标记为已作废',
                        timestamp: new Date().toISOString(),
                        actor: actorName // <-- 修正：添加操作人
                    }];
                    const updatedTaskObject = { ...task, status: 'void', history: newHistory };
                    return { id: taskId, ...toSnakeCase(updatedTaskObject) };
                });
                const { error } = await supabase.from('tasks').upsert(updates);
                if (error) { showNotification("批量作废失败: " + error.message, 'error'); }
                else { setSelectedTasks(new Set()); showNotification("批量作废操作成功！"); }
            };

            const handleSaveProgress = async (taskId, newProgressText) => {
                const task = tasks.find(t => t.id === taskId);
                const newProgressDetails = [...(task.progressDetails || []), { text: newProgressText, timestamp: new Date().toISOString() }];
                const { error } = await supabase.from('tasks').update({ progress_details: newProgressDetails }).eq('id', taskId);
                if (error) { showNotification("保存进展失败: " + error.message, 'error'); }
                else { showNotification("项目进展已保存！"); }
            };

            const handlePermanentDelete = async (taskId) => {
                const { error } = await supabase.from('deleted_tasks').delete().eq('id', taskId);
                if (error) { showNotification("永久删除失败: " + error.message, 'error'); }
                else { showNotification("任务已永久删除！"); }
                closeConfirmationModal();
            };

            // --- 【新】所有新的任务处理函数 ---

            // 标记/取消加急
            const handleToggleUrgent = async (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    showNotification('操作失败：找不到任务。', 'error');
                    return;
                }

                const newUrgentStatus = !task.is_urgent;
                const actionText = newUrgentStatus ? '标记为加急' : '取消加急';
                const actorName = userMap.get(session.user.id) || session.user.email;
                const newHistory = [...(task.history || []), {
                    action: actionText,
                    timestamp: new Date().toISOString(),
                    actor: actorName
                }];
                const { error } = await supabase.from('tasks').update({ is_urgent: newUrgentStatus, history: newHistory }).eq('id', task.id);
                if (error) { showNotification(`${actionText}失败: ` + error.message, 'error'); }
                else { showNotification(`任务已${actionText}！`); }
            };

            // 确认分配/转交
            const handleConfirmAssignment = async (task, assignments) => {
                try {
                    // 1. 准备基础信息
                    const actorName = userMap.get(session.user.id) || session.user.email;
                    const isTransfer = task.status !== 'assigning';
                    const nextStatus = isTransfer ? task.status : WORKFLOW_CONFIG[task.status]?.next_status || task.status;

                    // 2. 将从弹窗收到的新指派人员信息的键名，从 snake_case 转为 camelCase
                    //    这是确保新旧数据能正确合并的关键
                    const camelCaseAssignments = {};
                    for (const key in assignments) {
                        camelCaseAssignments[toCamelCase(key)] = assignments[key];
                    }

                    // 3. 生成详细的、可供阅读的变更描述，用于日志
                    let changes = Object.keys(camelCaseAssignments) // <-- 注意这里是 camelCaseAssignments
                        .map(key => {
                            // 使用驼峰式的键来匹配
                            const fieldMap = { projectManager: '项目负责人', auditorName: '审核人', recheckerName: '复核人', issuerName: '签发人' };
                            if (!fieldMap[key]) return null;

                            const oldValue = userMap.get(task[key]) || '[空]'; // <-- 直接用 key
                            const newValue = userMap.get(camelCaseAssignments[key]) || '[空]';

                            if (oldValue !== newValue) {
                                return isTransfer ? `${fieldMap[key]}由"${oldValue}"转交给"${newValue}"` : `${fieldMap[key]}被分配为"${newValue}"`;
                            }
                            return null;
                        })
                        .filter(Boolean)
                        .join('; ');

                    // 4. 如果用户没有做出任何实际变更，则提示并提前退出
                    if (!changes) {
                        showNotification("负责人未发生任何变化。", 'error');
                        setIsAssignModalOpen(false);
                        return;
                    }

                    // 5. 创建标准化的日志条目
                    const actionText = isTransfer ? `任务被转交` : `任务被分配，进入 [${statusLabelMap[nextStatus]}] 阶段`;
                    const detailedLog = {
                        action: `${actionText}: ${changes}`,
                        timestamp: new Date().toISOString(),
                        actor: actorName
                    };
                    const newHistory = [...(task.history || []), detailedLog];

                    // 6. 合并数据，并转换为数据库可识别的 snake_case 格式
                    const updatedTaskObject = { ...task, ...camelCaseAssignments, status: nextStatus, history: newHistory };
                    const dataToUpdate = toSnakeCase(updatedTaskObject);

                    // 7. 执行数据库更新
                    const { error } = await supabase.from('tasks').update(dataToUpdate).eq('id', task.id);
                    if (error) throw error;

                    showNotification(`任务已成功${isTransfer ? '转交' : '分配'}！`);
                } catch (error) {
                    showNotification(`操作失败: ${error.message}`, 'error');
                } finally {
                    setIsAssignModalOpen(false);
                }
            };
            // 确认退回
            const handleConfirmReturn = async (task, reason) => {
                const prevStatusConfig = WORKFLOW_CONFIG[task.status]?.prev_statuses[0];
                if (!prevStatusConfig) {
                    showNotification('此状态无法退回。', 'error');
                    return;
                }

                const actionText = `从 [${statusLabelMap[task.status]}] 退回至 [${statusLabelMap[prevStatusConfig.key]}]，原因: ${reason}`;
                const actorName = userMap.get(session.user.id) || session.user.email;
                const newHistory = [...(task.history || []), { action: actionText, timestamp: new Date().toISOString(), actor: actorName }];
                const dataToUpdate = {
                    status: prevStatusConfig.key,
                    is_urgent: false, // 自动取消加急
                    history: newHistory
                };

                const { error } = await supabase.from('tasks').update(dataToUpdate).eq('id', task.id);
                if (error) { showNotification('退回失败: ' + error.message, 'error'); }
                else { showNotification('任务已成功退回！'); }
                setIsReturnModalOpen(false);
            };

            // 简化后的提交任务
            const handleSubmitTask = async (taskId) => {
                const task = tasks.find(t => t.id === taskId);
                if (!task) {
                    showNotification('操作失败：找不到任务。', 'error');
                    return;
                }

                const nextStatus = WORKFLOW_CONFIG[task.status]?.next_status;
                if (!nextStatus) {
                    showNotification('此状态无法提交。', 'error');
                    return;
                }

                const actorName = userMap.get(session.user.id) || session.user.email;
                const actionText = `任务提交，进入 [${statusLabelMap[nextStatus]}] 阶段`;
                const newHistory = [...(task.history || []), {
                    action: actionText,
                    timestamp: new Date().toISOString(),
                    actor: actorName
                }];

                const updates = {
                    status: nextStatus,
                    history: newHistory
                };

                if (nextStatus === 'done' && !task.actualCompletionDate) {
                    updates.actual_completion_date = new Date().toISOString();
                }

                const { error } = await supabase.from('tasks').update(updates).eq('id', task.id);
                if (error) {
                    showNotification('提交失败: ' + error.message, 'error');
                } else {
                    showNotification(`任务已成功提交！`);
                    // --- 【新增】如果任务完成，则触发动画 ---
                    if (nextStatus === 'done') {
                        setShowConfetti(true);
                        setTimeout(() => setShowConfetti(false), 5000); // 5秒后自动关闭动画
                    }
                }
            };
            // --- 新增：统一的权限刷新函数 ---
            const refreshPermissionData = async () => {
                try {
                    const [
                        { data: rolesData, error: rolesError },
                        { data: rolePermsData, error: rolePermsError },
                        { data: actionPermsData, error: actionPermsError }
                    ] = await Promise.all([
                        supabase.from('roles').select('*').order('label'),
                        supabase.from('role_permissions').select('*'),
                        supabase.from('action_permissions').select('*')
                    ]);

                    if (rolesError) throw rolesError;
                    if (rolePermsError) throw rolePermsError;
                    if (actionPermsError) throw actionPermsError;

                    setAvailableRoles(rolesData || []);
                    setRolePermissions(rolePermsData || []);
                    setActionPermissions(actionPermsData || []);
                    console.log("权限数据已刷新!");

                } catch (error) {
                    showNotification(`刷新权限数据失败: ${error.message}`, 'error');
                }
            };

            const handleSaveManagementData = async (newData, forceRefresh = false) => {
                if (newData) {
                    // 1. 更新要发送到数据库的对象，包含所有新字段
                    const dataForSupabase = {
                        regions: newData.regions,
                        task_types: newData.taskTypes,
                        department_structure: newData.department_structure,
                        signing_entities: newData.signingEntities,   // <-- 新增
                        invoice_types: newData.invoiceTypes,       // <-- 新增
                        contract_admins: newData.contractAdmins,     // <-- 新增
                    };
                    const { error } = await supabase.from('management_data').update(dataForSupabase).eq('id', 1);

                    if (error) {
                        showNotification("保存配置失败: " + error.message, 'error');
                    } else {
                        // 2. 成功后，同步更新前端的 managementData 状态
                        setManagementData(prev => ({ ...prev, ...newData }));
                        showNotification("配置已成功保存！");
                    }
                }
                if (forceRefresh) {
                    await refreshPermissionData();
                }
            };

            // --- 其他所有非数据库交互的 handler 函数 ---
            // --- 【更新版】handleTaskAction 事件分发器 ---
            const handleTaskAction = (actionType, data) => {
                setActionModalState({ isOpen: false, task: null }); // Close the action modal first

                const openConfirmation = (title, message, onConfirm, variant = 'primary') => {
                    setConfirmationState({ isOpen: true, title, children: message, onConfirm, confirmVariant: variant });
                };

                // 使用新函数生成标准摘要
                const taskSummary = generateTaskSummary(data);

                switch (actionType) {
                    case 'openActionModal': setActionModalState({ isOpen: true, task: data }); return;
                    case 'openContractDetails': setContractInfoTask(data); return;
                    case 'edit': handleOpenModal(data); return;
                    case 'progress': setHistoryTask(data); setIsHistoryModalOpen(true); return;

                    // 新的、带确认的流程
                    case 'submit': openConfirmation('提交任务', `您确定要提交任务 "${taskSummary}" 进入下一阶段吗？`, () => handleSubmitTask(data.id)); return;
                    case 'emergency': openConfirmation(data.is_urgent ? '取消加急' : '标记加急', `您确定要为任务 "${taskSummary}" ${data.is_urgent ? '取消加急' : '标记为加急'}吗？`, () => handleToggleUrgent(data.id)); return;
                    case 'assign': setActionableTask(data); setIsAssignModalOpen(true); return;
                    case 'transfer': setActionableTask(data); setIsAssignModalOpen(true); return; // Re-use the same modal
                    case 'return': setActionableTask(data); setIsReturnModalOpen(true); return;
                    case 'archive':
                        openConfirmation('存档任务', `您确定要存档任务 "${taskSummary}" 吗？`, () => handleArchiveTask(data.id));
                        return;
                    // 旧的、带确认的流程
                    case 'void': openConfirmation('作废任务', `您确定要作废任务 "${taskSummary}" 吗？`, () => handleVoidTask(data.id), 'danger'); return;
                    case 'delete': openConfirmation('删除任务', `您确定要将任务 "${taskSummary}" 移入回收站吗？`, () => handleDeleteTask(data.id), 'danger'); return;
                    case 'permanentDelete': openConfirmation('永久删除任务', `您确定要永久删除任务 "${taskSummary}" 吗？此操作无法撤销。`, () => handlePermanentDelete(data.id), 'danger'); return;
                    case 'clearBin': openConfirmation('清空回收站', `您确定要永久删除所有 ${deletedTasks.length} 个任务吗？`, () => handleClearRecycleBin(), 'danger'); return;
                    default: return;
                }
            };
            const handleBulkAction = (action) => {
                if (action === 'clearSelection') { setSelectedTasks(new Set()); return; }

                if (action === 'bulkAssign') {
                    setIsBulkAssignModalOpen(true);
                    return;
                }
                if (action === 'bulkTransfer') {
                    setIsBulkTransferModalOpen(true);
                    return;
                }
                if (action === 'bulkReturn') {
                    setIsBulkReturnModalOpen(true); // <-- 修改为此行
                    return;
                }

                // --- 以下是修改的核心区域 ---

                // 预先生成任务列表的通用 JSX 模块
                const taskListJsx = (
                    <div className="mt-4 max-h-48 overflow-y-auto bg-slate-100 dark:bg-slate-700 p-3 rounded-md text-sm text-left">
                        <ul className="list-disc pl-5 space-y-1">
                            {selectedTaskObjects.map(task => (
                                <li key={task.id}>{generateTaskSummary(task)}</li>
                            ))}
                        </ul>
                    </div>
                );

                let confirmationData;
                if (action === 'bulkSubmit') {
                    const viewToActionMap = { reviewing: '评审', assigning: '分配', inprogress: '提交', auditing: '提交审核', rechecking: '提交复核', issuing: '提交签发' };
                    const actionText = viewToActionMap[currentView] || '提交';
                    confirmationData = {
                        title: `批量${actionText}任务`,
                        onConfirm: () => handleConfirmBulkSubmit(),
                        children: (<div><p>您确定要将选中的 <span className="font-bold">{selectedTasks.size}</span> 个任务{actionText}到下一阶段吗？</p>{taskListJsx}</div>)
                    };
                } else if (action === 'bulkVoid') {
                    confirmationData = {
                        title: '批量作废任务',
                        confirmVariant: 'danger',
                        onConfirm: handleConfirmBulkVoid,
                        children: (<div><p>您确定要作废选中的 <span className="font-bold">{selectedTasks.size}</span> 个任务吗？</p>{taskListJsx}</div>)
                    };
                } else if (action === 'bulkDelete') {
                    confirmationData = {
                        title: '批量删除任务',
                        confirmVariant: 'danger',
                        onConfirm: handleConfirmBulkDelete,
                        children: (<div><p>您确定要删除选中的 <span className="font-bold">{selectedTasks.size}</span> 个任务吗？</p>{taskListJsx}</div>)
                    };
                }

                if (confirmationData) {
                    setConfirmationState({
                        isOpen: true,
                        confirmVariant: 'primary',
                        ...confirmationData,
                        onConfirm: () => {
                            confirmationData.onConfirm();
                            closeConfirmationModal();
                        },
                        children: confirmationData.children
                    });
                }
            };
            const handleClearRecycleBin = async () => { const idsToDelete = deletedTasks.map(t => t.id); if (idsToDelete.length === 0) return; const { error } = await supabase.from('deleted_tasks').delete().in('id', idsToDelete); if (error) { showNotification("清空回收站失败: " + error.message, 'error'); } else { showNotification("回收站已清空！"); } closeConfirmationModal(); };
            const toggleDarkMode = () => setIsDarkMode(prev => !prev);
            const toggleFullscreen = () => { const elem = appRef.current; if (!elem) return; if (!document.fullscreenElement) { if (elem.requestFullscreen) elem.requestFullscreen().catch(err => alert(`全屏失败: ${err.message}`)); else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen(); } else { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); } };
            const handleOpenModal = (task = null) => { setEditingTask(task); setIsTaskModalOpen(true); };
            const handleCloseModal = () => { setIsTaskModalOpen(false); setEditingTask(null); setModalError(null); };
            const closeConfirmationModal = () => setConfirmationState({ isOpen: false, title: '', message: '', onConfirm: () => { } });
            const handleConfirm = () => { if (typeof confirmationState.onConfirm === 'function') { confirmationState.onConfirm(); } closeConfirmationModal(); };
            const selectedTaskObjects = useMemo(() => { const selectedIds = Array.from(selectedTasks); return tasks.filter(task => selectedIds.includes(task.id)); }, [tasks, selectedTasks]);
            const handleSelectAll = (e) => { if (e.target.checked) { setSelectedTasks(new Set(filteredAndSortedTasks.map(t => t.id))); } else { setSelectedTasks(new Set()); } };
            const handleClearBackupHistory = () => {
                setConfirmationState({
                    isOpen: true,
                    title: '清空备份历史',
                    children: '您确定要清空您自己的所有备份历史记录吗？此操作无法撤销。',
                    confirmVariant: 'danger',
                    onConfirm: async () => {
                        closeConfirmationModal();
                        try {
                            // --- 核心修复：确保只删除当前用户的记录 ---
                            const { error } = await supabase
                                .from('backup_history')
                                .delete()
                                .eq('user_id', session.user.id);
                            if (error) throw error;

                            setBackupHistory([]);
                            showNotification("您的备份历史已清空！");
                        } catch (err) {
                            showNotification("清空失败: " + err.message, 'error');
                        }
                    }
                });
            };
            const handleDownloadTemplate = () => {
                // --- 1. 定义表头和下拉选项 ---
                const templateHeaders = [
                    "任务编号", "项目名称", "任务类型", "所属地区", "承接部门(市场)", "执行部门(技术)",
                    "合同金额(元)", "任务下达日期", "合同规定日期", "实际完成日期", "业务人员",
                    "评审人员", "项目负责人", "审核人", "复核人", "签发人", "状态", "项目进展情况", "是否存档"
                ];
                const statusOptions = ['评审中', '待分配', '进行中', '审核中', '复核中', '签发中', '已完成', '已作废'];
                const archiveOptions = ['是', '否'];

                // --- 2. 创建用户可见的主工作表 ---
                const ws = window.XLSX.utils.aoa_to_sheet([templateHeaders]);

                // --- 3. 创建一个隐藏的工作表，用于存放下拉菜单的选项 ---
                const dvSheetName = "下拉选项";
                const dvSheetData = [
                    ['状态列表', '存档列表'], // A列和B列的表头
                ];
                const maxRows = Math.max(statusOptions.length, archiveOptions.length);
                for (let i = 0; i < maxRows; i++) {
                    dvSheetData.push([statusOptions[i] || null, archiveOptions[i] || null]);
                }
                const dv_ws = window.XLSX.utils.aoa_to_sheet(dvSheetData);

                // --- 4. 在主工作表上设置数据验证规则，让其引用隐藏工作表的数据 ---
                if (!ws['!validations']) ws['!validations'] = [];
                ws['!validations'].push({
                    sqref: 'Q2:Q1001', // "状态"列 (Q列)
                    type: 'list',
                    formula1: `'${dvSheetName}'!$A$2:$A$${statusOptions.length + 1}`
                });
                ws['!validations'].push({
                    sqref: 'S2:S1001', // "是否存档"列 (S列)
                    type: 'list',
                    formula1: `'${dvSheetName}'!$B$2:$B$${archiveOptions.length + 1}`
                });

                // --- 5. 创建工作簿，添加两个工作表 ---
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "Tasks");
                window.XLSX.utils.book_append_sheet(wb, dv_ws, dvSheetName);

                // --- 6. 将存放选项的工作表设置为“隐藏” ---
                try {
                    // 这是最兼容的隐藏工作表的方法
                    wb.Workbook.Sheets.find(sheet => sheet.name === dvSheetName).Hidden = 1;
                } catch (e) {
                    console.error("隐藏工作表失败，但这不影响下拉菜单功能。", e);
                }


                // --- 7. 生成并下载文件 ---
                window.XLSX.writeFile(wb, "任务导入模板_v4.2.xlsx");
            };
            const handleFileUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = window.XLSX.read(data, { type: 'array' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const fullData = window.XLSX.utils.sheet_to_json(worksheet, { defval: "" });

                        // --- 1. 准备数据用于校验 ---
                        const { data: existingTasksData } = await supabase.from('tasks').select('custom_task_id');
                        const existingTaskIds = new Set((existingTasksData || []).map(t => t.custom_task_id));

                        // 创建一个“姓名 -> 用户ID”的反向映射表，用于将Excel中的姓名转为系统ID
                        const nameToUserMap = new Map();
                        userMap.forEach((name, id) => nameToUserMap.set(name, id));

                        const importFileTaskIds = new Set();
                        const validTasksToInsert = [];
                        const rejectedTasks = [];

                        // 中文状态到英文Key的映射表，现在包含所有工作流状态
                        const statusMap = {
                            '评审中': 'reviewing', '待分配': 'assigning', '进行中': 'inprogress',
                            '审核中': 'auditing', '复核中': 'rechecking', '签发中': 'issuing',
                            '已完成': 'done', '已作废': 'void'
                        };

                        // --- 2. 逐行解析Excel数据 ---
                        fullData.forEach((row, index) => {
                            const customTaskId = row["任务编号"] ? String(row["任务编号"]).trim() : '';
                            let errors = [];

                            // 基础校验
                            if (!customTaskId || !row["项目名称"] || !row["任务下达日期"]) {
                                errors.push('必需字段(任务编号, 项目名称, 任务下达日期)不能为空');
                            }
                            if (existingTaskIds.has(customTaskId)) errors.push('任务编号在系统中已存在');
                            if (importFileTaskIds.has(customTaskId)) errors.push('任务编号在文件中重复');

                            // 辅助函数：解析日期
                            const parseDate = (excelDate) => {
                                if (!excelDate) return null;
                                if (typeof excelDate === 'number') { return new Date(Math.round((excelDate - 25569) * 86400 * 1000)).toISOString(); }
                                if (typeof excelDate === 'string' && new Date(excelDate).toString() !== 'Invalid Date') { return new Date(excelDate).toISOString(); }
                                return null;
                            };

                            // 辅助函数：查找用户ID，如果找不到则记录错误
                            const findUserId = (name, role) => {
                                if (!name) return null;
                                const id = nameToUserMap.get(String(name).trim());
                                if (!id) errors.push(`${role} "${name}" 未在系统中找到`);
                                return id;
                            };

                            // 人员姓名转换
                            const salesPersonId = findUserId(row["业务人员"], "业务人员");
                            const reviewerId = findUserId(row["评审人员"], "评审人员");
                            const projectManagerId = findUserId(row["项目负责人"], "项目负责人");
                            const auditorId = findUserId(row["审核人"], "审核人");
                            const recheckerId = findUserId(row["复核人"], "复核人");
                            const issuerId = findUserId(row["签发人"], "签发人");

                            // 状态处理
                            let taskStatus = 'reviewing'; // 默认新导入的任务从“评审中”开始
                            const excelStatus = String(row["状态"] || "").trim();
                            if (excelStatus && statusMap[excelStatus]) {
                                taskStatus = statusMap[excelStatus];
                            } else if (row["实际完成日期"]) { // 如果有完成日期，则自动设为已完成
                                taskStatus = 'done';
                            }

                            // 如果有任何错误，则记录并跳过此行
                            if (errors.length > 0) {
                                rejectedTasks.push({ row: index + 2, id: customTaskId, reason: errors.join('; ') });
                                return;
                            }

                            // --- 3. 构建合法的任务对象 ---
                            const task = {
                                customTaskId: customTaskId,
                                projectName: row["项目名称"],
                                taskType: row["任务类型"] || '',
                                region: row["所属地区"] || '',
                                sourcing_department: row["承接部门(市场)"] || '',
                                execution_department: row["执行部门(技术)"] || '',
                                contractAmount: Number(row["合同金额(元)"]) || null,
                                createdAt: parseDate(row["任务下达日期"]),
                                contractualDueDate: parseDate(row["合同规定日期"]),
                                actualCompletionDate: parseDate(row["实际完成日期"]),
                                salesPerson: salesPersonId,
                                reviewerId: reviewerId,
                                projectManager: projectManagerId,
                                auditorName: auditorId,
                                recheckerName: recheckerId,
                                issuerName: issuerId,
                                status: taskStatus,
                                progressDetails: row["项目进展情况"] ? [{ text: row["项目进展情况"], timestamp: new Date().toISOString() }] : [],
                                isArchived: String(row["是否存档"]).trim().toLowerCase() === '是',
                                history: [{ action: `通过Excel导入创建，初始状态为 [${statusMap[taskStatus] || '评审中'}]`, timestamp: new Date().toISOString(), actor: '系统导入' }]
                            };
                            validTasksToInsert.push(toSnakeCase(task));
                            importFileTaskIds.add(customTaskId);
                        });

                        // --- 4. 执行数据库插入并报告结果 ---
                        if (validTasksToInsert.length > 0) {
                            const { error } = await supabase.from('tasks').insert(validTasksToInsert);
                            if (error) throw error;
                        }

                        if (rejectedTasks.length > 0) {
                            setImportReport({ isOpen: true, successful: validTasksToInsert.length, failed: rejectedTasks.length, errors: rejectedTasks, originalData: fullData });
                            showNotification(`导入完成，${validTasksToInsert.length}条成功，${rejectedTasks.length}条失败。`, 'success');
                        } else {
                            showNotification(`导入成功！共 ${validTasksToInsert.length} 条任务已添加。`, 'success');
                        }
                    } catch (err) {
                        console.error("File Read/Import error:", err);
                        showNotification("读取或导入文件失败: " + err.message, 'error');
                    } finally {
                        event.target.value = ''; // 清空文件选择，以便可以再次上传同名文件
                    }
                };
                reader.readAsArrayBuffer(file);
            };
            const exportErrorData = () => { const { errors, originalData } = importReport; const errorMap = new Map(); errors.forEach(err => errorMap.set(err.row, err.reason)); const errorRows = originalData.filter((_, index) => errorMap.has(index + 2)); const dataToExport = errorRows.map((row, index) => ({ ...row, '错误说明': errorMap.get(errors[index].row) })); const ws = window.XLSX.utils.json_to_sheet(dataToExport); const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "错误报告"); window.XLSX.writeFile(wb, "导入错误报告.xlsx"); };
            const handleBackupSuccess = async (count) => {
                const newBackupRecord = {
                    record_count: count,
                    backup_timestamp: new Date().toISOString()
                };

                try {
                    const { data: insertedRecord, error } = await supabase
                        .from('backup_history')
                        .insert(newBackupRecord)
                        .select()
                        .single();
                    if (error) throw error;

                    setBackupHistory(prev => [insertedRecord, ...prev]);
                    setIsBackupModalOpen(false);
                    showNotification(`全量备份成功！共 ${count} 条任务数据已完整备份。`);
                } catch (err) {
                    showNotification("保存备份记录失败: " + err.message, 'error');
                }
            };
            const exportFullBackup = () => {
                // 1. 【核心修复】首先，获取对当前用户可见的所有任务
                const tasksVisibleToUser = tasks.filter(task => {
                    if (!currentUserProfile) return false;
                    const roles = currentUserProfile.permissions?.roles ?? [];
                    const isAdmin = roles.some(p => p.role === 'admin') || session.user.email === '396382608@qq.com';
                    if (isAdmin) return true;

                    const assignedDepts = new Set(roles.filter(p => p.role === 'department_head').map(p => p.department));
                    let isVisible = false;
                    if (assignedDepts.has(task.sourcing_department) || assignedDepts.has(task.execution_department)) {
                        isVisible = true;
                    }
                    if (!isVisible) {
                        const participants = [task.salesPerson, task.projectManager, task.auditor_name, task.rechecker_name, task.issuer_name];
                        if (participants.includes(session.user.id)) {
                            isVisible = true;
                        }
                    }
                    return isVisible;
                });

                // 2. 对回收站的任务也应用同样的权限过滤
                const deletedTasksVisibleToUser = deletedTasks.filter(task => {
                    if (!currentUserProfile) return false;
                    const roles = currentUserProfile.permissions?.roles ?? [];
                    const isAdmin = roles.some(p => p.role === 'admin') || session.user.email === '396382608@qq.com';
                    if (isAdmin) return true;

                    const assignedDepts = new Set(roles.filter(p => p.role === 'department_head').map(p => p.department));
                    let isVisible = false;
                    if (assignedDepts.has(task.sourcing_department) || assignedDepts.has(task.execution_department)) {
                        isVisible = true;
                    }
                    if (!isVisible) {
                        const participants = [task.salesPerson, task.projectManager, task.auditor_name, task.rechecker_name, task.issuer_name];
                        if (participants.includes(session.user.id)) {
                            isVisible = true;
                        }
                    }
                    return isVisible;
                });

                // 3. 只备份用户可见的任务
                const allTasksWithData = [...tasksVisibleToUser, ...deletedTasksVisibleToUser];
                const statusMap = { inprogress: '进行中', done: '已完成', void: '作废' };

                if (allTasksWithData.length === 0) {
                    showNotification("您没有任何可备份的任务。", "error");
                    return;
                }
                const dataForExport = allTasksWithData.map(task => { const combinedHistory = [...(task.history || []).map(h => ({ ...h, type: '操作' })), ...(task.progressDetails || []).map(p => ({ timestamp: p.timestamp, action: `进展: ${p.text}`, type: '进展' }))].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp)); const historyString = combinedHistory.map(entry => `[${formatDateTime(entry.timestamp)}] ${entry.action}`).join('\n'); let statusText = statusMap[task.status] || task.status; if (deletedTasks.some(dt => dt.id === task.id)) { statusText = "回收站"; } return { "任务下达日期": formatDate(task.createdAt), "任务编号": task.customTaskId, "项目名称": task.projectName, "任务类型": task.taskType, "所属部门": task.department, "合同金额(元)": task.contractAmount, "业务人员": task.salesPerson, "项目负责人": task.projectManager, "合同规定日期": formatDate(task.contractualDueDate), "实际完成日期": formatDate(task.actualCompletionDate), "所属地区": task.region, "是否存档": task.isArchived ? "是" : "否", "状态": statusText, "项目进展与修改全记录": historyString, }; }); try { const ws = window.XLSX.utils.json_to_sheet(dataForExport); const cols = Object.keys(dataForExport[0] || {}).map(key => ({ wch: key === "项目进展与修改全记录" ? 80 : (key === "项目名称" ? 40 : 20) })); ws['!cols'] = cols; const wb = window.XLSX.utils.book_new(); window.XLSX.utils.book_append_sheet(wb, ws, "系统全量数据"); window.XLSX.writeFile(wb, `系统全量备份_${formatDate(new Date())}.xlsx`); handleBackupSuccess(allTasksWithData.length); } catch (e) { console.error("Full backup export failed:", e); showNotification("全量备份失败，详情请查看控制台。", "error"); }
            };
            const handleClockClick = async () => {
                const todayStr = new Date().toISOString().split('T')[0];
                const storedQuoteData = localStorage.getItem(`dailyQuote-${todayStr}`);

                if (storedQuoteData) {
                    setDailyQuote(JSON.parse(storedQuoteData));
                } else {
                    try {
                        // --- 核心修改：更换为“今日诗词”API ---
                        const response = await fetch('https://v2.jinrishici.com/one.json');
                        if (!response.ok) throw new Error('Network response was not ok');
                        const data = await response.json();

                        // --- 核心修改：按照新API的格式解析数据 ---
                        const poemData = data.data;
                        const newQuote = {
                            text: poemData.content,
                            source: `『${poemData.origin.title}』 - ${poemData.origin.author} (${poemData.origin.dynasty})`
                        };

                        setDailyQuote(newQuote);
                        localStorage.setItem(`dailyQuote-${todayStr}`, JSON.stringify(newQuote));
                    } catch (error) {
                        console.error("Failed to fetch daily quote:", error);
                        setDailyQuote({ text: '今日获取诗词失败，请检查网络连接。', source: '系统' });
                    }
                }
                setIsQuoteModalOpen(true);
            }; const handleToggleSelectTask = (taskId) => { setSelectedTasks(prev => { const newSet = new Set(prev); if (newSet.has(taskId)) { newSet.delete(taskId); } else { newSet.add(taskId); } return newSet; }); };
            const handleResetFilters = () => { setActiveFilters({ department: null }); setSearchTerm(''); };
            const handleProfileUpdate = (updatedUserData) => {
                // 更新当前登录用户的 Profile 状态
                setCurrentUserProfile(prevProfile => ({ ...prevProfile, username: updatedUserData.display_name, display_name: updatedUserData.display_name }));

                // 同步更新 userMap，让所有其他组件也能立即看到新名称
                setUserMap(prevMap => {
                    const newMap = new Map(prevMap);
                    newMap.set(updatedUserData.id, updatedUserData.display_name);
                    return newMap;
                });
            };
            const allNonDeletedTasks = useMemo(() => tasks.filter(t => t.status !== 'deleted'), [tasks]);
            const departmentFilterOptions = useMemo(() => {
                const techDepartments = (managementData.department_structure?.technical?.sub_departments || []).sort((a, b) => a.localeCompare(b, 'zh-CN'));
                const marketingDepartments = (managementData.department_structure?.marketing?.sub_departments || []).sort((a, b) => a.localeCompare(b, 'zh-CN'));

                const options = [{ label: '所有部门', value: 'all' }];
                if (techDepartments.length > 0) {
                    options.push({
                        isGroup: true,
                        label: '技术部门',
                        options: techDepartments.map(dep => ({ label: dep, value: dep }))
                    });
                }
                if (marketingDepartments.length > 0) {
                    options.push({
                        isGroup: true,
                        label: '市场部门',
                        options: marketingDepartments.map(dep => ({ label: dep, value: dep }))
                    });
                }
                return options;
            }, [managementData.department_structure]);
            const tasksVisibleToUser = useMemo(() => {
                if (!currentUserProfile) return []; // 如果用户信息未加载，返回空

                const roles = currentUserProfile.permissions?.roles ?? [];
                // 判断是否为管理员 (拥有所有数据权限)
                const isAdmin = roles.some(p => p.role === 'admin') || session.user.email === '396382608@qq.com';

                if (isAdmin) {
                    return tasks; // 管理员直接返回所有任务
                }

                // --- 对非管理员用户，执行严格的权限过滤 ---
                const assignedDepts = new Set(
                    roles
                        .filter(p => p.role === 'department_head')
                        .map(p => p.department)
                );

                return tasks.filter(task => {
                    let isVisible = false;
                    // 规则1：用户是任务所属部门的负责人
                    if (assignedDepts.has(task.sourcing_department) || assignedDepts.has(task.execution_department)) {
                        isVisible = true;
                    }
                    // 规则2：用户是任务的直接参与者
                    if (!isVisible) {
                        const participants = [task.salesPerson, task.projectManager, task.auditor_name, task.rechecker_name, task.issuer_name, task.reviewerId];
                        if (participants.includes(session.user.id)) {
                            isVisible = true;
                        }
                    }
                    return isVisible;
                });
            }, [tasks, currentUserProfile, session]);
            const urgentTasksByView = useMemo(() => {
                const urgentMap = new Set();
                tasks.forEach(task => {
                    if (task.is_urgent && task.status) {
                        urgentMap.add(task.status);
                    }
                });
                return urgentMap;
            }, [tasks]);
            return (
                <div ref={appRef} className="h-screen bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 p-4 lg:p-6 flex flex-col">
                    {showConfetti && <ConfettiAnimation />} {/* <-- 在这里添加新组件 */}
                    <Notification notification={notification} onClose={() => setNotification({ ...notification, show: false })} />
                    <TaskModal
                        isOpen={isTaskModalOpen}
                        onClose={handleCloseModal}
                        onSave={handleSaveTask}
                        task={editingTask}
                        error={modalError}
                        setModalError={setModalError}
                        managementData={managementData}
                        workflowStatuses={WORKFLOW_STATUSES}
                        salesPersonOptions={salesPersonOptions}      // <-- 新增此行
                        projectManagerOptions={projectManagerOptions}  // <-- 新增此行
                        reviewerOptions={reviewerOptions}
                    />
                    <HistoryModal isOpen={isHistoryModalOpen} onClose={() => setIsHistoryModalOpen(false)} onSave={handleSaveProgress} task={historyTask} />
                    <ConfirmationModal isOpen={confirmationState.isOpen} onClose={closeConfirmationModal} onConfirm={handleConfirm} title={confirmationState.title} confirmVariant={confirmationState.confirmVariant}>{confirmationState.children}</ConfirmationModal>
                    <StatisticsModal isOpen={isStatsModalOpen} onClose={() => setIsStatsModalOpen(false)} tasks={tasksVisibleToUser} userMap={userMap} />
                    <ExportModal isOpen={isExportModalOpen} onClose={() => setIsExportModalOpen(false)} allNonDeletedTasks={tasksVisibleToUser} userMap={userMap} />
                    <ImportModal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} onDownloadTemplate={handleDownloadTemplate} onImportClick={() => { document.getElementById('fileUploader').click(); setIsImportModalOpen(false); }} />
                    <ManagementModal isOpen={isManagementModalOpen} onClose={() => setIsManagementModalOpen(false)} managementData={managementData} onSave={handleSaveManagementData} availableRoles={availableRoles} viewConfig={VIEW_CONFIG} columnDefinitions={COLUMN_DEFINITIONS} showNotification={showNotification} setConfirmationState={setConfirmationState} closeConfirmationModal={closeConfirmationModal} />
                    <ActionModal
                        state={actionModalState}
                        onClose={() => setActionModalState({ isOpen: false, task: null })}
                        onActionSelect={handleTaskAction}
                        currentUserProfile={currentUserProfile}
                        actionPermissions={actionPermissions}
                        WORKFLOW_CONFIG={WORKFLOW_CONFIG} // <-- 新增这一行
                        session={session}
                    />
                    <ImportReportModal isOpen={importReport.isOpen} onClose={() => setImportReport(prev => ({ ...prev, isOpen: false }))} report={importReport} onExportErrors={exportErrorData} />
                    <NotificationModal
                        isOpen={isNotificationModalOpen}
                        onClose={() => setIsNotificationModalOpen(false)}
                        activeNotifications={activeNotifications}
                        unreadCount={unreadCount} // <-- 新增
                        readNotifications={readNotifications} // <-- 新增
                        snoozedNotifications={snoozedNotifications} // <-- 新增
                        // onClearAll 现在是确认后才执行的函数
                        // 【第3步.3】用这段新代码替换 onClearAllClick 属性
                        // 【第2步】用这行新代码替换
                        onClearAllClick={onClearAllClick}
                        selectedIds={selectedNotifications}
                        onToggleSelect={handleToggleNotificationSelect}
                        onToggleSelectAllInCategory={handleToggleSelectAllInCategory}
                        // --- 从这里开始，补上缺失的这三行 ---
                        onBulkMarkAsRead={handleBulkMarkAsRead}
                        onBulkDeleteClick={() => { // <-- 将 onBulkDelete 修改为 onBulkDeleteClick
                            setConfirmationState({
                                isOpen: true,
                                title: `删除 ${selectedNotifications.size} 条通知`,
                                children: `您确定要永久删除这些通知吗？此操作无法撤销。`,
                                onConfirm: () => {
                                    handleBulkDelete(); // 在确认后，再调用真正的删除函数
                                    closeConfirmationModal();
                                },
                                confirmVariant: 'danger'
                            });
                        }}
                        onBulkSnooze={handleBulkSnooze}
                        handleBulkCancelSnooze={handleBulkCancelSnooze}
                        onClearSelection={() => setSelectedNotifications(new Set())} // <-- 新增这一行
                    />
                    <BackupManagementModal isOpen={isBackupModalOpen} onClose={() => setIsBackupModalOpen(false)} history={backupHistory} onClearHistory={handleClearBackupHistory} onBackup={exportFullBackup} userMap={userMap} />
                    <ScrollingQuote isOpen={isQuoteModalOpen} onClose={() => setIsQuoteModalOpen(false)} quote={dailyQuote} />                    <TeamManagementModal
                        isOpen={isTeamModalOpen}
                        onClose={() => setIsTeamModalOpen(false)}
                        showNotification={showNotification}
                        setConfirmationState={setConfirmationState}
                        // --- 【请在这里添加下面三行】 ---
                        confirmationState={confirmationState}
                        closeConfirmationModal={closeConfirmationModal}
                        handleConfirm={handleConfirm}
                        profiles={profiles} // <-- 新增这一行
                        viewConfig={VIEW_CONFIG} // <-- 新增这一行
                        availableRoles={availableRoles} // <-- 修改为使用动态 state
                        columnDefinitions={COLUMN_DEFINITIONS} // <-- 新增这一行
                        setProfiles={setProfiles} // <-- 新增这一行
                        viewColumnMap={VIEW_COLUMN_MAP}
                        userMap={userMap}
                        managementData={managementData}
                        // --- 以下是新增的四行 ---
                        rolePermissions={rolePermissions}
                        actionPermissions={actionPermissions}
                        ACTION_DEFINITIONS={ACTION_DEFINITIONS}
                        onSaveManagementData={handleSaveManagementData}
                        onProfilesChange={refreshProfiles}
                    />
                    <ProfileModal
                        isOpen={isProfileModalOpen}
                        onClose={() => setIsProfileModalOpen(false)}
                        session={session}
                        showNotification={showNotification}
                        onProfileUpdate={handleProfileUpdate}
                    />
                    <AssignTaskModal
                        isOpen={isAssignModalOpen}
                        onClose={() => setIsAssignModalOpen(false)}
                        onSave={handleConfirmAssignment}
                        task={actionableTask}
                        title={actionableTask?.status !== 'assigning' ? '转交任务' : '分配任务'}
                        profiles={profiles} // <-- 确保这一行存在
                        userMap={userMap}
                    />
                    <ReturnTaskModal
                        isOpen={isReturnModalOpen}
                        onClose={() => setIsReturnModalOpen(false)}
                        onConfirm={handleConfirmReturn}
                        task={actionableTask}
                    />
                    <BulkAssignModal
                        isOpen={isBulkAssignModalOpen}
                        onClose={() => setIsBulkAssignModalOpen(false)}
                        onSave={handleConfirmBulkAssign} // 我们稍后会创建这个函数
                        tasks={selectedTaskObjects}
                        profiles={profiles}
                        userMap={userMap}
                    />
                    <BulkTransferModal
                        isOpen={isBulkTransferModalOpen}
                        onClose={() => setIsBulkTransferModalOpen(false)}
                        onSave={handleConfirmBulkTransfer} // 我们稍后会创建这个函数
                        tasks={selectedTaskObjects}
                        profiles={profiles}
                        userMap={userMap}
                    />
                    <BulkReturnModal
                        isOpen={isBulkReturnModalOpen}
                        onClose={() => setIsBulkReturnModalOpen(false)}
                        onConfirm={(reason) => {
                            handleConfirmBulkReturn(reason);
                            setIsBulkReturnModalOpen(false);
                        }}
                        taskCount={selectedTasks.size}
                    />
                    <WorkbenchModal
    isOpen={isWorkbenchModalOpen}
    onClose={() => setIsWorkbenchModalOpen(false)}
    onDateSelect={(date) => setEditingSummaryDate(date)}
    session={session}
    workSummaries={workSummaries}
    onSummariesChange={setWorkSummaries}
    userMap={userMap} // <-- 新增此行
/>
                    <SummaryEditorModal
                        isOpen={!!editingSummaryDate}
                        onClose={() => setEditingSummaryDate(null)}
                        onSave={async (summaryData) => {
                            try {
                                const { data, error } = await supabase
                                    .from('work_summaries')
                                    .upsert(summaryData, { onConflict: 'user_id, summary_date' })
                                    .select();

                                if (error) throw error;

                                // 更新本地的总结列表，让日历上的小圆点立即显示
                                setWorkSummaries(prev => {
                                    const index = prev.findIndex(s => s.summary_date === summaryData.summary_date);
                                    if (index > -1) {
                                        const newSummaries = [...prev];
                                        newSummaries[index] = data[0];
                                        return newSummaries;
                                    } else {
                                        return [...prev, data[0]];
                                    }
                                });

                                showNotification('工作总结已成功保存！', 'success');
                                setEditingSummaryDate(null); // 关闭弹窗
                            } catch (error) {
                                showNotification(`保存失败: ${error.message}`, 'error');
                            }
                        }}
                        date={editingSummaryDate}
                        tasks={tasks}      // <-- 新增此行
                        session={session}  // <-- 新增此行
                    />
                    <input type="file" id="fileUploader" accept=".xlsx, .xls, .csv" style={{ display: 'none' }} onChange={handleFileUpload} />

                    {/* --- 【修改点】让 header 可以在小屏幕上换行 --- */}
                    <header className="flex-shrink-0 flex flex-wrap items-center justify-between gap-y-4 gap-x-8 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                        <div>
                            <h1 className="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-slate-100">咨询任务管理系统</h1>
                            <p className="text-sm text-slate-500 dark:text-slate-400">版本 4.2.3 - 协作版</p>
                        </div>
                        {/* --- 【修改点】让右侧按钮组在需要时也能换行 --- */}
                        <div className="flex items-center gap-2 flex-wrap justify-end">
                            <span className="text-sm font-medium text-slate-600 dark:text-slate-300 hidden md:inline">
                                欢迎, {session.user.user_metadata.display_name || (currentUserProfile && currentUserProfile.username) || session.user.email}
                            </span>
                            <button onClick={() => setIsProfileModalOpen(true)} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="修改个人资料"><Users size={20} /></button>
                            <button onClick={() => supabase.auth.signOut()} className="flex items-center gap-2 px-3 py-2 bg-slate-200 text-slate-700 dark:bg-slate-700 dark:text-slate-200 rounded-lg font-semibold shadow-sm hover:bg-slate-300 dark:hover:bg-slate-600"><LogOut size={16} /><span>登出</span></button>
                        </div>
                    </header>
                    <div className="flex-shrink-0 mb-4 flex items-center gap-x-4 gap-y-2 flex-wrap">
                        <div className="flex gap-2 flex-wrap">
                            {currentUserEffectivePermissions.canCreateTask &&
                                <button onClick={() => handleOpenModal()} className="flex items-center gap-2 px-4 py-2 bg-emerald-500 text-white rounded-lg font-semibold shadow-sm hover:bg-emerald-600"><Plus size={18} />创建任务</button>
                            }
                            {currentUserEffectivePermissions.canImportData &&
                                <button onClick={() => setIsImportModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-sky-500 text-white rounded-lg font-semibold shadow-sm hover:bg-sky-600"><Upload size={16} />导入</button>
                            }
                            {currentUserEffectivePermissions.canExportData &&
                                <button onClick={() => setIsExportModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold shadow-sm hover:bg-blue-600"><Download size={16} />导出</button>
                            }
                            {currentUserEffectivePermissions.canViewStatistics &&
                                <button onClick={() => setIsStatsModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-violet-500 text-white rounded-lg font-semibold shadow-sm hover:bg-violet-600"><BarChart2 size={16} />统计</button>
                            }
                            {currentUserEffectivePermissions.canManageConfig &&
                                <button onClick={() => setIsManagementModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-slate-500 text-white rounded-lg font-semibold shadow-sm hover:bg-slate-600"><Settings size={16} />管理配置</button>
                            }
                            {currentUserEffectivePermissions.canManageTeams &&
                                <button onClick={() => setIsTeamModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold shadow-sm hover:bg-indigo-600"><Users size={16} />团队管理</button>
                            }
                            <button onClick={() => setIsWorkbenchModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-orange-500 text-white rounded-lg font-semibold shadow-sm hover:bg-orange-600"><Briefcase size={16} />我的工作台</button>
                        </div>
                        {showBackupReminder && (<div className="flex-grow mx-4 p-2 banner-pulse bg-amber-100 border-l-4 border-amber-500 text-amber-800 dark:bg-amber-900/20 dark:text-amber-300 dark:border-amber-500 rounded-lg flex items-center justify-between shadow-sm"> <div className="flex items-center"> <AlertTriangle size={20} className="mr-3 text-amber-600 dark:text-amber-400 flex-shrink-0" /> <p className="text-sm font-semibold">数据备份提醒：您已超过30天未执行全量备份，建议及时处理。</p> </div> <button onClick={() => setShowBackupReminder(false)} className="p-1 text-slate-600 dark:text-slate-300 hover:bg-amber-200 dark:hover:bg-amber-800/50 rounded-full" title="暂时忽略"> <X size={18} /> </button> </div>)}
                        <div className="flex items-center gap-2 ml-auto">
                            <button onClick={() => setIsBackupModalOpen(true)} className="relative p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="备份管理"> <Database size={20} /> {backupHistory.length > 0 && (
                                <span className="absolute -top-1 -right-1 w-5 h-5 bg-blue-500 text-white text-xs rounded-full flex items-center justify-center border-2 border-white dark:border-slate-900">
                                    {Math.floor((new Date() - new Date(backupHistory[0].backup_timestamp)) / (1000 * 60 * 60 * 24))}
                                </span>
                            )} </button>
                            <button onClick={() => setIsNotificationModalOpen(true)} className="relative p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="消息提醒">
                                <Bell size={20} />
                                {unreadCount > 0 && <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center border-2 border-white dark:border-slate-900">{unreadCount}</span>}
                            </button>                            <button onClick={toggleDarkMode} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="切换主题"> {isDarkMode ? <Sun size={20} /> : <Moon size={20} />} </button>
                            <button onClick={toggleFullscreen} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="全屏"> {isFullscreen ? <Minimize size={20} /> : <Maximize size={20} />} </button>
                            <Clock onClick={handleClockClick} />
                        </div>
                    </div>

                    <main className="relative bg-white dark:bg-slate-800/50 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 flex flex-col flex-grow min-h-0 overflow-hidden">
                        {/* --- 1. 顶部的标签页和搜索框区域 (保持不变) --- */}
                        <div className="flex-shrink-0 p-4 bg-slate-100/70 dark:bg-slate-800 rounded-t-xl border-b border-slate-200 dark:border-slate-700 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            {/* --- 【修改点】让标签组在移动端占据全部宽度 --- */}
                            <div className="flex items-center gap-2 border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 rounded-lg p-1 flex-wrap w-full md:w-auto">
                                {visibleViews.length > 0 ? (
                                    visibleViews.map(view => {
                                        if (view.type === 'divider') {
                                            return <div key={Math.random()} className="h-6 w-px bg-slate-200 dark:bg-slate-600"></div>;
                                        }
                                        const { key, label } = view;
                                        const count = viewCounts[key] || 0;
                                        return (
                                            <TabButton
                                                key={key}
                                                viewKey={key}
                                                title={label}
                                                count={count}
                                                isActive={currentView === key}
                                                onClick={() => { setCurrentView(key); setSelectedTasks(new Set()); }}
                                                isUrgent={urgentTasksByView.has(key)}
                                            />
                                        );
                                    })
                                ) : (
                                    <div className="px-4 py-1.5 text-sm text-slate-500">
                                        您暂无任何视图权限，请联系管理员。
                                    </div>
                                )}
                            </div>
                            {/* --- 【修改点】让搜索工具在移动端占据全部宽度，并移除 ml-auto --- */}
                            <div className="flex items-center gap-2 w-full md:w-auto md:ml-auto">
                                <div className="w-full md:w-64"><ComboBox options={departmentFilterOptions} value={activeFilters.department} onChange={(val) => setActiveFilters(prev => ({ ...prev, department: val }))} placeholder="所有部门" /></div>
                                <div className="relative w-full md:w-auto">
                                    <Search size={18} className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                    <input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="搜索..." className="pl-10 pr-4 py-2 w-full md:w-64 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 bg-white dark:bg-slate-700/80 dark:border-slate-600 dark:text-slate-200" />
                                </div>
                                <button onClick={handleResetFilters} className="p-2 text-slate-600 hover:bg-slate-200 dark:text-slate-300 dark:hover:bg-slate-700 rounded-full" title="清空筛选">
                                    <X size={20} />
                                </button>
                            </div>
                            {selectedTasks.size > 0 && currentView !== 'deleted' && (<BulkActionBar selectedCount={selectedTasks.size} onBulkAction={handleBulkAction} currentView={currentView} />)}
                            {currentView === 'deleted' && deletedTasks.length > 0 && (<button onClick={() => handleTaskAction('clearBin')} className="flex items-center gap-2 text-sm text-red-500 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300 font-semibold"><Trash2 size={16} />清空回收站</button>)}
                        </div>

                        <div className="flex-grow relative overflow-hidden">
                            <div className="absolute inset-0 overflow-y-auto"> {/* 【修改点】为移动端卡片添加内外边距 */}
                                <ListHeader
                                    currentView={currentView}
                                    onSelectAll={handleSelectAll}
                                    numSelected={selectedTasks.size}
                                    taskCount={filteredAndSortedTasks.length}
                                    currentUserProfile={currentUserProfile}
                                    columnDefinitions={COLUMN_DEFINITIONS}
                                    columnWidthMap={COLUMN_WIDTH_MAP}
                                    viewColumnMap={VIEW_COLUMN_MAP}
                                    availableRoles={availableRoles}
                                />
                                {isLoading ? (<div className="text-center py-16 text-slate-500 dark:text-slate-400">加载中...</div>) : filteredAndSortedTasks.length === 0 ? (<div className="text-center py-16 text-slate-500 dark:text-slate-400">此视图下没有任务。</div>) : (
                                    <div className="task-grid-container p-4 md:p-0">
                                        {
                                            filteredAndSortedTasks.map((task, index) => {
                                                const rowProps = { key: task.id, task: task, index: index, onSelect: handleToggleSelectTask, isSelected: selectedTasks.has(task.id), onActionConfirm: handleTaskAction, currentView: currentView, currentUserProfile: currentUserProfile, columnDefinitions: COLUMN_DEFINITIONS, columnWidthMap: COLUMN_WIDTH_MAP, viewColumnMap: VIEW_COLUMN_MAP, userMap: userMap, statusLabelMap: statusLabelMap };
                                                if (currentView === 'deleted') { return <DeletedTaskRow {...rowProps} onPermanentDelete={() => handleTaskAction('permanentDelete', task)} onOpenFlowModal={() => setFlowTask(task)} />; }
                                                const userRoles = currentUserProfile?.permissions?.roles ?? [];
                                                const isAdmin = userRoles.some(pm => pm.role === 'admin') || session.user.email === '396382608@qq.com';
                                                let availableActions = [];
                                                if (isAdmin) { availableActions = WORKFLOW_CONFIG[task.status]?.actions || []; }
                                                else { availableActions = (WORKFLOW_CONFIG[task.status]?.actions || []).filter(action => actionPermissions.some(p => { const hasRolePermission = userRoles.map(pm => pm.role).includes(p.role_key); return p.is_enabled && p.view_key === task.status && p.action_key === action && hasRolePermission; })); }
                                                return <TaskRow {...rowProps} availableActions={availableActions} availableRoles={availableRoles} onOpenFlowModal={() => setFlowTask(task)} />;;
                                            })}</div>
                                )}
                            </div>

                            {/* --- 2.2 侧滑弹窗现在是滚动区的“兄弟”，而不是“儿子” --- */}
                            <TaskFlowModal
                                isOpen={!!flowTask}
                                onClose={() => setFlowTask(null)}
                                task={flowTask}
                                userMap={userMap}
                                WORKFLOW_CONFIG={WORKFLOW_CONFIG}
                                statusLabelMap={statusLabelMap}
                                session={session}
                            />
                            <ContractDetailsModal
                                isOpen={!!contractInfoTask}
                                onClose={() => setContractInfoTask(null)}
                                task={contractInfoTask}
                            />
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<AuthWrapper />, document.getElementById('root'));
    </script>
</body>

</html>

