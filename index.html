<!DOCTYPE html>
<html lang="zh-CN">
<head>
    </head>
<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // ... 您所有的常量、辅助函数、UI组件定义都完整保留 ...
        const { useState, useEffect, useMemo, useCallback, useRef, useLayoutEffect } = React;
        const supabaseUrl = 'https://gpcsknsnwatqqcnywuiv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- 所有 Icon, Helper, Custom Hook, UI Component 定义... ---
        // ...
        
        // --- Auth Component ---
        const Auth = () => { /* ... 您的 Auth 组件完整代码 ... */ };
        
        // --- Main App Component ---
        function App() {
            // --- 状态管理 (与上一版相同) ---
            const [session, setSession] = useState(null);
            const [profile, setProfile] = useState(null);
            const [appIsLoading, setAppIsLoading] = useState(true);
            const [tasks, setTasks] = useState([]);
            // ... 您离线版的所有其他 useState 定义都保留 ...
            
            // --- Effects ---
            
            // Effect 1 & 2: 认证和初始数据加载 (与上一版相同)
            useEffect(() => { /* ... 认证逻辑 ... */ }, []);
            useEffect(() => { /* ... 加载 profile 和 tasks 的逻辑 ... */ }, [session]);

            // +++ [核心新增] Effect 3: 启用任务表的实时监听 +++
            useEffect(() => {
                // 确保用户已登录才开始监听
                if (!session) return;

                // 1. 设置实时监听器
                const tasksListener = supabase.channel('public:tasks')
                    .on('postgres_changes', 
                        { 
                            event: '*',       // 监听所有事件: INSERT, UPDATE, DELETE
                            schema: 'public', 
                            table: 'tasks'    // 只监听 'tasks' 这张表
                        }, 
                        (payload) => {
                            console.log('实时事件:', payload);
                            
                            if (payload.eventType === 'INSERT') {
                                // 当有新任务插入时，将其添加到状态中
                                setTasks(currentTasks => [payload.new, ...currentTasks]);
                            }
                            if (payload.eventType === 'UPDATE') {
                                // 当有任务更新时，替换掉旧的任务
                                setTasks(currentTasks => currentTasks.map(task => 
                                    task.id === payload.new.id ? payload.new : task
                                ));
                            }
                            if (payload.eventType === 'DELETE') {
                                // 当有任务被删除时，从状态中移除
                                // 注意：Supabase 的 DELETE 事件 payload.old 里包含被删除项的 id
                                setTasks(currentTasks => currentTasks.filter(task => 
                                    task.id !== payload.old.id
                                ));
                            }
                        }
                    )
                    .subscribe();

                console.log("已开启任务实时监听...");

                // 2. 组件卸载时，清理监听器
                return () => {
                    console.log("正在关闭任务实时监听...");
                    supabase.removeChannel(tasksListener);
                };

            }, [session]); // 这个 Effect 也依赖于 session，确保用户登录后才运行


            // ... 您其他的 Effect (如暗黑模式) ...

            // --- 事件处理函数改造 ---
            
            // [改造] handleSaveTask 函数，移除手动更新 state 的代码
            const handleSaveTask = async (taskData, isEdit) => {
                setModalError(null);
                if (isEdit) {
                    alert("更新功能待实现");
                } else {
                    const dataToInsert = { /* ... 准备插入的数据 ... */ };

                    const { error } = await supabase.from('tasks').insert(dataToInsert);

                    if (error) {
                        console.error("创建任务失败:", error);
                        setModalError(`创建失败: ${error.message}`);
                    } else {
                        // [重要] 创建成功后，我们不再需要手动 setTasks !
                        // 实时监听器会自动收到 INSERT 事件并为我们更新界面。
                        // 这样可以保证数据源的唯一性和一致性。
                        handleCloseModal();
                    }
                }
            };
            
            // ... 您的所有其他 handle 函数和计算属性 ...

            // --- 渲染逻辑 (与上一版完全相同) ---
            if (appIsLoading) { /* ... */ }
            if (!session) { return <Auth />; }
            if (!profile) { /* ... */ }
            
            return (
                <div /* ... 您的完整主界面 JSX ... */ >
                    {/* ... 您的所有 Modal 和 UI 组件调用 ... */ }
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
