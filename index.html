<!DOCTYPE html>
<html lang="zh-CN">
<head>
    </head>
<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        // ... 您所有的常量、辅助函数、UI组件定义都完整保留 ...
        const { useState, useEffect, useMemo, useCallback, useRef, useLayoutEffect } = React;
        const supabaseUrl = 'https://gpcsknsnwatqqcnywuiv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // --- Main App Component ---
        function App() {
            // --- 状态管理 (与上一版相同) ---
            const [session, setSession] = useState(null);
            const [profile, setProfile] = useState(null);
            const [appIsLoading, setAppIsLoading] = useState(true);
            const [tasks, setTasks] = useState([]);
            // ... 您离线版的所有其他 useState 定义都保留 ...
            
            // --- Effects (包含实时监听) ---
            useEffect(() => { /* ... 认证逻辑 ... */ }, []);
            useEffect(() => { /* ... 加载 profile 和 tasks 的逻辑 ... */ }, [session]);
            useEffect(() => { /* ... 实时监听 tasks 表变化的逻辑 ... */ }, [session]);
            
            // --- 事件处理函数 (Event Handlers) ---
            const handleCloseModal = () => { setIsTaskModalOpen(false); setEditingTask(null); setModalError(null); };
            const handleOpenModal = (task = null) => { setEditingTask(task); setIsTaskModalOpen(true); };

            // [核心改造] handleSaveTask 函数，现在支持更新
            const handleSaveTask = async (taskData, isEdit) => {
                setModalError(null);
                if (isEdit) {
                    // --- 更新任务的逻辑 ---
                    const dataToUpdate = { /* ... 从 taskData 中提取需要更新的字段 ... */ };
                    const { error } = await supabase
                        .from('tasks')
                        .update(dataToUpdate)
                        .eq('id', taskData.id);

                    if (error) {
                        console.error("更新任务失败:", error);
                        setModalError(`更新失败: ${error.message}`);
                    } else {
                        // 更新成功后，实时监听会自动刷新UI，我们只需关闭弹窗
                        handleCloseModal();
                    }
                } else {
                    // --- 创建新任务的逻辑 (不变) ---
                    const dataToInsert = { /* ... */ };
                    const { error } = await supabase.from('tasks').insert(dataToInsert);
                    if (error) { /* ... */ } 
                    else { handleCloseModal(); }
                }
            };
            
            // [核心新增] handleDeleteTask 函数
            const handleDeleteTask = async (taskId) => {
                const { error } = await supabase
                    .from('tasks')
                    .delete()
                    .eq('id', taskId);

                if (error) {
                    console.error("删除任务失败:", error);
                    alert(`删除失败: ${error.message}`);
                }
                // 删除成功后，实时监听会自动从UI中移除任务
            };
            
            // 将所有操作统一由 handleTaskAction 分发
            const handleTaskAction = (actionType, data) => {
                // ... (您离线版 ActionModal 的逻辑)
                // 我们在这里拦截删除操作
                if (actionType === 'delete') {
                    setConfirmationState({
                        isOpen: true,
                        title: '删除任务',
                        children: `您确定要删除任务 "${data.project_name}" 吗？此操作无法撤销。`,
                        onConfirm: () => handleDeleteTask(data.id),
                        confirmVariant: 'danger'
                    });
                }
                // 其他操作，如 'edit', 'complete' 等，也在这里处理
                else if (actionType === 'edit') {
                    handleOpenModal(data);
                }
                // ...
            };

            // --- 渲染逻辑 (Render Logic) ---
            if (appIsLoading) { /* ... */ }
            if (!session) { return <Auth />; }
            if (!profile) { /* ... */ }
            
            return (
                <div /* ... 您的完整主界面 JSX ... */ >
                    {/* 确保 ActionModal 和 TaskRow 的事件处理器已连接 */}
                    <ActionModal onActionSelect={handleTaskAction} /* ...其他 props... */ />
                    
                    {/* 在渲染任务列表时 */}
                    {tasks.map(task => 
                        <TaskRow 
                            key={task.id} 
                            task={task} 
                            onActionConfirm={handleTaskAction} 
                            /* ...其他 props... */ 
                        />
                    )}
                </div>
            );
        }
        
        // --- 您的所有其他组件定义，如 Auth, TaskModal, ListHeader, TaskRow 等都在这里 ---
        // ...

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
