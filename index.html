<!DOCTYPE html>
<html lang="zh-CN">
<head>
    </head>
<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef, useLayoutEffect } = React;
        
        // --- 全局 Supabase 客户端 ---
        const supabaseUrl = 'https://gpcsknsnwatqqcnywuiv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- 您所有的离线版组件和函数定义都完整保留在这里 ---
        // Icon Components, Helper Functions, Custom Hooks, UI Components etc.
        // ... (此处省略以保持简洁，但最终代码是完整的)
        
        // --- Auth Component (登录/注册组件) ---
        const Auth = () => { /* ... 您的 Auth 组件完整代码 ... */ };
        
        // --- Main App Component ---
        function App() {
            // --- 状态管理 ---
            const [session, setSession] = useState(null);
            const [profile, setProfile] = useState(null);
            const [appIsLoading, setAppIsLoading] = useState(true);
            const [tasks, setTasks] = useState([]);
            // ... 您离线版的所有其他 useState 定义都保留 ...
            
            // --- Effects ---
            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    // 重要：如果一开始就没有 session，我们就可以结束加载了
                    if (!session) {
                        setAppIsLoading(false);
                    }
                });

                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                    setSession(session);
                });
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                // 只在 session 存在时才去获取数据
                if (session) {
                    Promise.all([
                        supabase.from('profiles').select('*').eq('id', session.user.id).single(),
                        supabase.from('tasks').select('*').order('created_at', { ascending: false })
                    ]).then(([profileResponse, tasksResponse]) => {
                        if (profileResponse.error) {
                            console.error("获取用户资料失败", profileResponse.error);
                            // 如果获取资料失败，也要结束加载，Auth 组件会处理
                        } else {
                            setProfile(profileResponse.data);
                        }

                        if (tasksResponse.error) {
                            console.error("获取任务失败", tasksResponse.error);
                            alert('无法加载任务列表。');
                        } else {
                            setTasks(tasksResponse.data);
                        }
                        
                        setAppIsLoading(false); // 所有异步操作结束后，才算加载完毕
                    });
                } else {
                    // 如果用户退出了，清空 profile
                    setProfile(null);
                }
            }, [session]);

            // ... 您其他的 Effect (如暗黑模式) ...

            // --- 您的所有离线版函数(Handlers)和计算属性都保留在这里 ---
            // ... handleSaveTask, filteredAndSortedTasks 等 ...


            // --- 渲染逻辑 (Render Logic) ---
            if (appIsLoading) {
                return <div className="flex justify-center items-center h-screen text-2xl dark:bg-slate-900 dark:text-slate-200">正在加载应用...</div>;
            }

            if (!session) {
                return <Auth />;
            }

            // +++ [核心修复] +++
            // 确保在 profile 加载完成前不渲染主应用
            if (!profile) {
                return <div className="flex justify-center items-center h-screen text-2xl dark:bg-slate-900 dark:text-slate-200">正在加载用户资料...</div>;
            }
            
            // 只有当 appIsLoading 为 false, session 存在, 并且 profile 存在时，才渲染下面的主界面
            return (
                // 这里是您离线版完整的、功能丰富的主界面UI
                // 我将使用上一版中简化的UI作为示例，您替换时应使用您的完整UI代码
                <div className="p-8">
                    <h1 className="text-2xl font-bold">任务管理系统 (在线版)</h1>
                    <p className="mt-2">欢迎, {profile.full_name}!</p>
                    <p className="text-sm text-gray-500">已从云端成功加载 {tasks.length} 条任务。</p>
                    {/* 在这里，您可以安全地开始渲染您的 <TaskModal>, <ListHeader> 等所有组件了 */}
                </div>
            );
        }
        
        // --- 您的所有其他组件定义，如 Auth, TaskModal, 等都在这里 ---
        // ...

        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
