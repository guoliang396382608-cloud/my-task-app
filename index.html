<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咨询任务管理系统 (在线协作版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        #root:empty::before { content: "正在加载应用..."; display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; color: #6b7280; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .action-column {}
        @keyframes pulse-bg { 0%, 100% { background-color: #fef3c7; } 50% { background-color: #fde68a; } }
        .banner-pulse { animation: pulse-bg 4s infinite ease-in-out; }
        .dark .banner-pulse { animation-name: pulse-bg-dark; }
        @keyframes pulse-bg-dark { 0%, 100% { background-color: rgba(217, 119, 6, 0.2); } 50% { background-color: rgba(217, 119, 6, 0.3); } }
        input[type="date"] { position: relative; }
        input[type="date"]:not([value*="-"])::-webkit-datetime-edit { color: transparent; }
        input[type="date"]:not([value*="-"])::before { content: attr(placeholder); position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); width: 100%; color: #9ca3af; pointer-events: none; }
        .dark input[type="date"]:not([value*="-"])::before { color: #6b7280; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(10px); } }
        .quote-modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .quote-modal-exit { animation: fadeOut 0.3s ease-in forwards; }
        .quote-bubble { position: relative; background: linear-gradient(to right, #84fab0, #8fd3f4); }
        .dark .quote-bubble { background: linear-gradient(to right, #0f2027, #203a43, #2c5364); }
        .quote-bubble::after { content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 0; border: 12px solid transparent; border-top-color: #8fd3f4; border-bottom: 0; margin-left: -12px; margin-bottom: -12px; }
        .dark .quote-bubble::after { border-top-color: #2c5364; }
    </style>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef, useLayoutEffect } = React;
        
        const supabaseUrl = 'https://gpcsknsnwatqqcnywuiv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- 您离线版的所有组件、常量、辅助函数等都完整保留在这里 ---
        // Icon Components, Helper Functions, etc.
        const Icon = ({ children, size = 20, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const Plus = (props) => <Icon {...props}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></Icon>;
        // ... (此处省略了所有其他 Icon 组件的定义)
        const formatDate = (dateStr) => { if (!dateStr) return ''; try { const d = new Date(dateStr); return isNaN(d.getTime()) ? '' : d.toISOString().split('T')[0]; } catch (e) { return ''; } };
        // ... (此处省略了所有其他 Helper 函数的定义)
        
        // --- UI Components ---
        
        // [核心修复] TaskModal 组件
        const TaskModal = ({ isOpen, onClose, onSave, task, error, setError, managementData }) => {
            const [formData, setFormData] = useState({});
            const [isSaving, setIsSaving] = useState(false); // 新增：保存状态

            useEffect(() => {
                if (isOpen) {
                    setError(null);
                    const initialData = { customTaskId: 'HB', projectName: '', region: '', taskType: '', department: '', contractAmount: null, salesPerson: '', projectManager: '', isArchived: false, status: 'inprogress', contractualDueDate: '', actualCompletionDate: '', progressDetails: [], createdAt: new Date().toISOString() };
                    if (task) {
                        setFormData({ ...initialData, ...task, contractualDueDate: formatDate(task.contractualDueDate), actualCompletionDate: formatDate(task.actualCompletionDate) });
                    } else {
                        setFormData(initialData);
                    }
                }
            }, [task, isOpen, setError]);

            if (!isOpen) return null;

            const handleFormChange = (name, value) => { setFormData(prev => ({ ...prev, [name]: value })); };
            const handleInputChange = (e) => { const { name, value, type, checked } = e.target; setFormData(prev => ({ ...prev, [name]: type === 'checkbox' ? checked : value })); };

            const handleSubmit = async (e) => {
                e.preventDefault(); // 1. 阻止表单的默认刷新行为
                setIsSaving(true); // 2. 开始保存，禁用按钮

                try {
                    const finalData = { ...formData, contractAmount: formData.contractAmount ? Number(formData.contractAmount) : null };
                    await onSave(finalData, !!task); // 调用 App 组件传来的 onSave 函数
                } catch (err) {
                    // onSave 内部会处理错误，这里主要是为了确保无论成功失败都重置按钮
                } finally {
                    setIsSaving(false); // 3. 结束保存，恢复按钮
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4">
                    <div className="bg-white dark:bg-slate-900 rounded-xl shadow-2xl w-full max-w-3xl h-[70vh] flex flex-col text-gray-800 dark:text-gray-200">
                        <header className="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 rounded-t-xl dark:border-slate-700 dark:bg-slate-800 flex-shrink-0">
                            <h2 className="text-xl font-bold text-gray-900 dark:text-gray-100">{task ? '编辑任务详情' : '创建新任务'}</h2>
                            <button onClick={onClose} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-slate-700"><X className="text-gray-500 dark:text-gray-400" /></button>
                        </header>
                        <form onSubmit={handleSubmit} className="flex flex-col flex-grow min-h-0">
                            <div className="p-6 overflow-y-auto flex-grow">
                                {error && <div className="mb-4 bg-red-100 border border-red-300 text-red-800 px-4 py-2 rounded-lg text-center text-sm">{error}</div>}
                                {/* ... 您表单的所有 input 和 ComboBox ... */}
                            </div>
                            <footer className="p-4 border-t border-gray-200 dark:border-slate-700 flex justify-end gap-4 flex-shrink-0">
                                <button type="button" onClick={onClose} className="px-4 py-2 rounded-md text-slate-700 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 dark:text-slate-200 font-semibold">取消</button>
                                <button type="submit" disabled={isSaving} className="px-6 py-2 rounded-md text-white bg-emerald-500 hover:bg-emerald-600 font-semibold disabled:bg-emerald-300 disabled:cursor-wait">
                                    {isSaving ? '保存中...' : '保存'}
                                </button>
                            </footer>
                        </form>
                    </div>
                </div>
            );
        };
        // ... (此处省略了您离线版的所有其他UI组件定义)
        const Auth = () => { /* ... */ };
        const ListHeader = ({...}) => { /* ... */ };
        // etc.

        // --- Main App Component ---
        function App() {
            // ... (App 组件的所有 state 和 effects 保持不变)
            const [tasks, setTasks] = useState([]);
            const [session, setSession] = useState(null);
            // ... etc.

            useEffect(() => { /* 认证逻辑 */ }, []);
            useEffect(() => { /* 加载数据逻辑 */ }, [session]);

            // [改造] handleSaveTask 函数返回一个 Promise
            const handleSaveTask = (taskData, isEdit) => {
                return new Promise(async (resolve, reject) => {
                    setModalError(null);
                    if (isEdit) {
                        // 更新逻辑待实现
                        alert("更新功能待实现");
                        reject(new Error("Update not implemented"));
                    } else {
                        // 创建逻辑
                        const dataToInsert = {
                            custom_task_id: taskData.customTaskId,
                            project_name: taskData.projectName,
                            // ... 其他所有字段
                            creator_id: session.user.id,
                        };

                        const { data: newTask, error } = await supabase.from('tasks').insert(dataToInsert).select().single();

                        if (error) {
                            console.error("创建任务失败:", error);
                            setModalError(`创建失败: ${error.message}`);
                            reject(error);
                        } else {
                            setTasks(currentTasks => [newTask, ...currentTasks]);
                            handleCloseModal();
                            resolve(newTask);
                        }
                    }
                });
            };

            const handleCloseModal = () => { setIsTaskModalOpen(false); setEditingTask(null); setModalError(null); };
            const handleOpenModal = (task = null) => { setEditingTask(task); setIsTaskModalOpen(true); };
            
            // ... (您的所有其他 handler 函数和计算属性)

            // --- 渲染逻辑 (与上一版完全相同) ---
            if (appIsLoading) { /* ... */ }
            if (!session) { return <Auth />; }
            if (!profile) { /* ... */ }
            
            return (
                <div /* ... 您的完整主界面 JSX ... */ >
                    <TaskModal isOpen={isTaskModalOpen} onClose={handleCloseModal} onSave={handleSaveTask} task={editingTask} error={modalError} setError={setModalError} managementData={managementData} />
                    {/* ... 您的所有其他 Modal 和 UI 组件调用 ... */}
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));

    </script>
</body>
</html>
