<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咨询任务管理系统 (稳定在线版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* 您所有的 CSS 样式都完整保留 */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        #root:empty::before { content: "正在加载应用..."; display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; color: #6b7280; }
        /* ... 此处省略了您所有的样式代码 ... */
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const supabaseUrl = 'https://gpcsknsnwatqqcnywuiv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        
        // --- 1. 辅助组件、常量和函数 ---
        const Icon = ({ children, size = 20, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const MoreHorizontal = (props) => <Icon {...props}><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></Icon>;
        const ArrowUpDown = (props) => <Icon {...props}><path d="m21 16-4 4-4-4m-12-8 4-4 4 4"/></Icon>;

        const GRID_COLS = "grid-cols-[auto_repeat(13,_minmax(0,_1fr))]"; // 简化版 Grid
        const formatDate = (dateStr) => { if (!dateStr) return ''; try { const d = new Date(dateStr); return isNaN(d.getTime()) ? '' : d.toISOString().split('T')[0]; } catch (e) { return ''; } };
        const formatAmount = (amount) => { if (amount === null || amount === undefined || amount === '' || isNaN(Number(amount))) return 'N/A'; return `${Number(amount).toLocaleString('zh-CN')} 元`; };
        const formatDuration = (totalDays) => { if (totalDays === null || isNaN(totalDays)) return { status: '-', time: ''}; if (totalDays === 0) return { status: '今天截止', time: '' }; const status = totalDays < 0 ? '已逾期' : '剩余'; const absDays = Math.abs(totalDays); return { status, time: `${absDays}天` }; };
        
        const ListHeader = ({ sortConfig, onRequestSort }) => {
            const SortableHeader = ({ label, sortKey }) => {
                const isSorted = sortConfig.key === sortKey;
                const direction = isSorted ? sortConfig.direction : 'none';
                return (
                    <div className="flex items-center justify-center relative">
                        <button onClick={() => onRequestSort(sortKey)} className="flex items-center justify-center w-full whitespace-normal">
                            <span className="pr-5">{label}</span>
                            <span className="absolute right-1 top-1/2 -translate-y-1/2">
                                {isSorted ? (direction === 'ascending' ? <span className="text-emerald-500">▲</span> : <span className="text-emerald-500">▼</span>) : (<ArrowUpDown size={14} className="text-gray-400" />)}
                            </span>
                        </button>
                    </div>
                );
            };
            return (
                <div className={`grid ${GRID_COLS} gap-4 px-4 py-3 bg-slate-100 dark:bg-slate-800 text-sm font-bold text-slate-700 dark:text-slate-300 sticky top-0 z-10 text-center border-b-2 border-slate-200 dark:border-slate-700`}>
                    <div/>
                    <SortableHeader label="任务下达日期" sortKey="created_at" />
                    <SortableHeader label="任务编号" sortKey="custom_task_id" />
                    <div>项目名称</div>
                    <div>任务类型</div>
                    <div>所属部门</div>
                    <SortableHeader label="合同金额" sortKey="contract_amount" />
                    <div>业务人员</div>
                    <div>项目负责人</div>
                    <SortableHeader label="合同规定完成日期" sortKey="contractual_due_date" />
                    <div>项目进展情况</div>
                    <div>剩余时间</div>
                    <div>所属地区</div>
                    <div>操作</div>
                </div>
            );
        };

        const TaskRow = ({ task, index }) => {
            let timeRemaining = { status: '', time: '' };
            let timeRemainingColorClass = 'text-slate-700 dark:text-slate-300';
            
            if (task.status !== 'done' && task.contractual_due_date) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const dueDate = new Date(task.contractual_due_date); dueDate.setHours(0, 0, 0, 0);
                const diffTime = dueDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                timeRemaining = formatDuration(diffDays);
                if (diffDays < 0) { timeRemainingColorClass = 'text-rose-600 dark:text-rose-400'; }
                else if (diffDays <= 7) { timeRemainingColorClass = 'text-amber-600 dark:text-amber-400'; }
                else { timeRemainingColorClass = 'text-green-700 dark:text-green-400'; }
            }
            const rowBgColor = index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50';
            const latestProgress = (task.progress_details && task.progress_details.length > 0) ? task.progress_details[0].text : '暂无进展';

            return (
                 <div className={`grid ${GRID_COLS} gap-4 px-4 py-2 items-center ${rowBgColor} border-b border-gray-200 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-300 text-center hover:bg-sky-100 dark:hover:bg-sky-900/50`}>
                    <div/>
                    <div>{formatDate(task.created_at)}</div>
                    <div className="font-mono">{task.custom_task_id}</div>
                    <div className="text-left">{task.project_name}</div>
                    <div>{task.task_type}</div>
                    <div>{task.department}</div>
                    <div>{formatAmount(task.contract_amount)}</div>
                    <div>{task.sales_person}</div>
                    <div title={task.project_manager_id}>{task.project_manager_id ? task.project_manager_id.substring(0, 8) + '...' : ''}</div>
                    <div>{formatDate(task.contractual_due_date)}</div>
                    <div className="flex items-center justify-center gap-2" title={latestProgress}><MessageSquare size={16} /><span className="line-clamp-2 text-left">{latestProgress}</span></div>
                    <div className={`font-medium ${timeRemainingColorClass}`}>{timeRemaining.status} {timeRemaining.time}</div>
                    <div>{task.region}</div>
                    <div><button className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700"><MoreHorizontal size={20} /></button></div>
                </div>
            );
        };
        
        const Auth = ({...}) => { /* ... 您的 Auth 组件完整代码 ... */ };
        
        // --- 2. 主应用 (App) 组件 ---
        function App() {
            const [session, setSession] = useState(null);
            const [profile, setProfile] = useState(null);
            const [appIsLoading, setAppIsLoading] = useState(true);
            const [tasks, setTasks] = useState([]);
            const [sortConfig, setSortConfig] = useState({ key: 'created_at', direction: 'descending' });

            useEffect(() => {
                supabase.auth.getSession().then(({ data: { session } }) => {
                    setSession(session);
                    if (!session) setAppIsLoading(false);
                });
                const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => { setSession(session); });
                return () => subscription.unsubscribe();
            }, []);

            useEffect(() => {
                if (session) {
                    Promise.all([
                        supabase.from('profiles').select('*').eq('id', session.user.id).single(),
                        supabase.from('tasks').select('*').order(sortConfig.key, { ascending: sortConfig.direction === 'ascending' })
                    ]).then(([profileResponse, tasksResponse]) => {
                        if (profileResponse.error) { console.error("获取用户资料失败", profileResponse.error); }
                        else { setProfile(profileResponse.data); }
                        if (tasksResponse.error) {
                            console.error("获取任务失败", tasksResponse.error);
                            alert('无法加载任务列表。');
                        } else {
                            setTasks(tasksResponse.data);
                        }
                        setAppIsLoading(false);
                    });
                } else { 
                    setProfile(null);
                    setTasks([]);
                }
            }, [session, sortConfig]); // 当排序改变时也重新获取数据

            const handleAddTask = async () => { /* ... */ };
            
            const handleRequestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            if (appIsLoading) { return <div className="flex justify-center items-center h-screen text-2xl dark:bg-slate-900 dark:text-slate-200">正在加载应用...</div>; }
            if (!session) { return <Auth />; }
            if (!profile) { return <div className="flex justify-center items-center h-screen text-2xl dark:bg-slate-900 dark:text-slate-200">正在加载用户资料...</div>; }
            
            return (
                <div className="h-screen bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 p-4 lg:p-6 flex flex-col">
                    <header className="flex-shrink-0 flex items-center justify-between gap-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                        <div>
                            <h1 className="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-slate-100">咨询任务管理系统</h1>
                            <p className="text-sm text-slate-500 dark:text-slate-400">在线协作版 - {profile.full_name}</p>
                        </div>
                        <button onClick={() => supabase.auth.signOut()} className="px-4 py-2 bg-red-500 text-white rounded font-semibold">退出登录</button>
                    </header>
                    <div className="flex-shrink-0 mb-4">
                        <button onClick={()=>{/* TODO */}} className="px-4 py-2 bg-emerald-500 text-white rounded font-semibold">创建新任务</button>
                    </div>
                    <main className="bg-white dark:bg-slate-800/50 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 flex flex-col flex-grow min-h-0 overflow-hidden">
                        <div className="flex-grow overflow-y-auto">
                           <ListHeader sortConfig={sortConfig} onRequestSort={handleRequestSort} />
                           {tasks.length > 0 ? (
                                tasks.map((task, index) => <TaskRow key={task.id} task={task} index={index} />)
                            ) : (
                                <div className="text-center py-16 text-slate-500 dark:text-slate-400">云端还没有任务。</div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
