<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>咨询任务管理系统 (在线协作版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        #root:empty::before { content: "正在加载应用..."; display: flex; justify-content: center; align-items: center; height: 100vh; font-size: 1.5rem; color: #6b7280; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        .dark ::-webkit-scrollbar-track { background: #1e293b; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const supabaseUrl = 'https://gpcsknsnwatqqcnywuiv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // --- 1. 辅助组件、常量和函数 ---
        const Icon = ({ children, size = 20, ...props }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>{children}</svg>);
        const MoreHorizontal = (props) => <Icon {...props}><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></Icon>;
        const MessageSquare = (props) => <Icon {...props}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></Icon>;
        const ArrowUpDown = (props) => <Icon {...props}><path d="m21 16-4 4-4-4m-12-8 4-4 4 4"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></Icon>;
        const Archive = (props) => <Icon {...props}><polyline points="21 8 21 21 3 21 3 8"></polyline><rect x="1" y="3" width="22" height="5"></rect><line x1="10" y1="12" x2="14" y2="12"></line></Icon>;

        const GRID_COLS = {
            INPROGRESS: "grid-cols-[auto_0.9fr_0.9fr_2.25fr_1.5fr_1.45fr_1.2fr_0.8fr_0.8fr_0.9fr_3.5fr_1fr_0.65fr_0.45fr]",
            DONE: "grid-cols-[auto_0.9fr_0.9fr_2.25fr_1.5fr_1.45fr_1.2fr_0.8fr_0.8fr_0.9fr_0.9fr_3fr_0.8fr_0.65fr_0.45fr]"
        };

        const formatDate = (dateStr) => { if (!dateStr) return ''; try { const d = new Date(dateStr); return isNaN(d.getTime()) ? '' : d.toISOString().split('T')[0]; } catch (e) { return ''; } };
        const formatAmount = (amount) => { if (amount === null || amount === undefined || amount === '' || isNaN(Number(amount))) return 'N/A'; return `${Number(amount).toLocaleString('zh-CN')} 元`; };
        const formatDuration = (totalDays) => { if (totalDays === null || isNaN(totalDays)) return { status: '-', time: ''}; if (totalDays === 0) return { status: '今天截止', time: '' }; const status = totalDays < 0 ? '已逾期' : '剩余'; const absDays = Math.abs(totalDays); return { status, time: `${absDays}天` }; };
        
        const ListHeader = ({ currentView, sortConfig, onRequestSort }) => {
            const isDoneView = currentView === 'done';
            const gridColsClass = isDoneView ? GRID_COLS.DONE : GRID_COLS.INPROGRESS;
            const SortableHeader = ({ label, sortKey }) => {
                const isSorted = sortConfig.key === sortKey;
                const direction = isSorted ? sortConfig.direction : 'none';
                return (
                    <div className="flex items-center justify-center relative">
                        <button onClick={() => onRequestSort(sortKey)} className="flex items-center justify-center w-full whitespace-normal">
                            <span className="pr-5">{label}</span>
                            <span className="absolute right-1 top-1/2 -translate-y-1/2">
                                {isSorted ? (direction === 'ascending' ? <span className="text-emerald-500">▲</span> : <span className="text-emerald-500">▼</span>) : (<ArrowUpDown size={14} className="text-gray-400" />)}
                            </span>
                        </button>
                    </div>
                );
            };
            const HeaderCell = ({ label }) => (<div className="flex items-center justify-center">{label}</div>);
            return (
                <div className={`grid ${gridColsClass} gap-4 px-4 py-3 bg-slate-100 dark:bg-slate-800 text-sm font-bold text-slate-700 dark:text-slate-300 sticky top-0 z-10 text-center border-b-2 border-slate-200 dark:border-slate-700`}>
                    <div/>
                    <SortableHeader label="任务下达日期" sortKey="created_at" />
                    <SortableHeader label="任务编号" sortKey="custom_task_id" />
                    <HeaderCell label="项目名称" />
                    <HeaderCell label="任务类型" />
                    <HeaderCell label="所属部门" />
                    <SortableHeader label="合同金额" sortKey="contract_amount" />
                    <HeaderCell label="业务人员" />
                    <HeaderCell label="项目负责人" />
                    <SortableHeader label="合同规定完成日期" sortKey="contractual_due_date" />
                    {isDoneView && <SortableHeader label="实际完成日期" sortKey="actual_completion_date" />}
                    <HeaderCell label="项目进展情况" />
                    {!isDoneView && <HeaderCell label="剩余时间" />}
                    {isDoneView && <HeaderCell label="存档" />}
                    <HeaderCell label="所属地区" />
                    <HeaderCell label="操作" />
                </div>
            );
        };

        const TaskRow = ({ task, index, currentView }) => {
            let timeRemaining = { status: '', time: '' };
            let timeRemainingColorClass = 'text-slate-700 dark:text-slate-300';
            let rowBgColor = index % 2 === 0 ? 'bg-white dark:bg-slate-900' : 'bg-gray-50/50 dark:bg-slate-800/50';

            if (currentView === 'inprogress' && task.contractual_due_date) {
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const dueDate = new Date(task.contractual_due_date); dueDate.setHours(0, 0, 0, 0);
                const diffTime = dueDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                timeRemaining = formatDuration(diffDays);
                if (diffDays < 0) { timeRemainingColorClass = 'text-rose-600 dark:text-rose-400'; rowBgColor = 'bg-rose-50 dark:bg-rose-900/20'; }
                else if (diffDays <= 7) { timeRemainingColorClass = 'text-amber-600 dark:text-amber-400'; rowBgColor = 'bg-amber-50 dark:bg-amber-900/20'; }
                else { timeRemainingColorClass = 'text-green-700 dark:text-green-400'; rowBgColor = 'bg-emerald-50 dark:bg-emerald-900/20'; }
            }
            
            const gridColsClass = currentView === 'done' ? GRID_COLS.DONE : GRID_COLS.INPROGRESS;
            const latestProgress = (task.progress_details && task.progress_details.length > 0) ? task.progress_details.sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp))[0].text : '暂无进展';

            return (
                 <div className={`grid ${gridColsClass} gap-4 px-4 py-2 items-center ${rowBgColor} border-b border-gray-200 dark:border-slate-700 text-sm text-slate-700 dark:text-slate-300 text-center hover:bg-sky-100 dark:hover:bg-sky-900/50`}>
                    <div/>
                    <div>{formatDate(task.created_at)}</div>
                    <div className="font-mono">{task.custom_task_id}</div>
                    <div className="text-left whitespace-normal break-words">{task.project_name}</div>
                    <div className="whitespace-normal break-words">{task.task_type}</div>
                    <div className="whitespace-normal break-words">{task.department}</div>
                    <div>{formatAmount(task.contract_amount)}</div>
                    <div>{task.sales_person}</div>
                    <div title={task.project_manager_id}>{task.project_manager_id ? task.project_manager_id.substring(0, 8) + '...' : ''}</div>
                    <div>{formatDate(task.contractual_due_date)}</div>
                    {currentView === 'done' && <div>{formatDate(task.actual_completion_date)}</div>}
                    <div className="flex items-center justify-center gap-2" title={latestProgress}><MessageSquare size={16} /><span className="line-clamp-2 text-left">{latestProgress}</span></div>
                    {currentView !== 'done' && <div className={`font-medium ${timeRemainingColorClass}`}>{timeRemaining.status} {timeRemaining.time}</div>}
                    {currentView === 'done' && <div>{task.is_archived ? <CheckCircle size={16}/> : <Archive size={16}/>}</div>}
                    <div>{task.region}</div>
                    <div><button className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700"><MoreHorizontal size={20} /></button></div>
                </div>
            );
        };
        
        const Auth = () => { /* ... 您的 Auth 组件完整代码 ... */ };

        // --- 2. 主应用 (App) 组件 ---
        function App() {
            const [session, setSession] = useState(null);
            const [profile, setProfile] = useState(null);
            const [appIsLoading, setAppIsLoading] = useState(true);
            const [tasks, setTasks] = useState([]);
            const [sortConfig, setSortConfig] = useState({ key: 'created_at', direction: 'descending' });
            const [currentView, setCurrentView] = useState('inprogress'); // 恢复此状态
            // 恢复您离线版的所有其他UI状态...
            
            useEffect(() => { /* ... 认证逻辑 ... */ }, []);

            useEffect(() => {
                if (session) {
                    setAppIsLoading(true); // 开始加载时设置
                    const fetchAllData = async () => {
                        const { data: profileData, error: profileError } = await supabase.from('profiles').select('*').eq('id', session.user.id).single();
                        if (profileError) console.error("获取用户资料失败", profileError);
                        else setProfile(profileData);

                        const { data: tasksData, error: tasksError } = await supabase.from('tasks').select('*').order(sortConfig.key, { ascending: sortConfig.direction === 'ascending' });
                        if (tasksError) console.error("获取任务失败", tasksError);
                        else setTasks(tasksData);
                        
                        setAppIsLoading(false); // 所有数据获取完成后设置
                    };
                    fetchAllData();
                } else { 
                    setProfile(null);
                    setTasks([]);
                }
            }, [session, sortConfig]);

            const handleRequestSort = (key) => {
                let direction = 'ascending';
                if (sortConfig.key === key && sortConfig.direction === 'ascending') {
                    direction = 'descending';
                }
                setSortConfig({ key, direction });
            };

            const filteredTasks = useMemo(() => {
                // 简单实现，后续可以加入您复杂的筛选逻辑
                return tasks.filter(task => {
                    if (currentView === 'inprogress') return task.status === 'inprogress' || task.status === 'review' || task.status === 'audit' || task.status === 'recheck' || task.status === 'issuing';
                    return task.status === currentView;
                });
            }, [tasks, currentView]);

            if (appIsLoading) { return <div className="flex justify-center items-center h-screen text-2xl dark:bg-slate-900 dark:text-slate-200">正在加载应用...</div>; }
            if (!session) { return <Auth />; }
            if (!profile) { return <div className="flex justify-center items-center h-screen text-2xl dark:bg-slate-900 dark:text-slate-200">正在加载用户资料...</div>; }
            
            return (
                <div className="h-screen bg-slate-50 text-slate-800 dark:bg-slate-900 dark:text-slate-200 p-4 lg:p-6 flex flex-col">
                    <header className="flex-shrink-0 flex items-center justify-between gap-4 mb-4 pb-4 border-b border-slate-200 dark:border-slate-700">
                        <div>
                            <h1 className="text-2xl lg:text-3xl font-bold text-slate-900 dark:text-slate-100">咨询任务管理系统</h1>
                            <p className="text-sm text-slate-500 dark:text-slate-400">在线协作版 - {profile.full_name}</p>
                        </div>
                        <button onClick={() => supabase.auth.signOut()} className="px-4 py-2 bg-red-500 text-white rounded font-semibold">退出登录</button>
                    </header>
                    <div className="flex-shrink-0 mb-4">
                        <button className="px-4 py-2 bg-emerald-500 text-white rounded font-semibold">创建新任务</button>
                    </div>
                    <main className="bg-white dark:bg-slate-800/50 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 flex flex-col flex-grow min-h-0 overflow-hidden">
                         <div className="flex-shrink-0 p-2 bg-slate-100/70 dark:bg-slate-800 rounded-t-xl border-b border-slate-200 dark:border-slate-700 flex items-center gap-1">
                            {['inprogress', 'done', 'void', 'deleted'].map(view => {
                                const viewMap = { inprogress: '进行中', done: '已完成', void: '已作废', deleted: '回收站' };
                                const count = tasks.filter(t => (view === 'inprogress' ? ['review', 'in_progress', 'audit', 'recheck', 'issuing'].includes(t.status) : t.status === view)).length;
                                return (
                                    <button key={view} onClick={() => setCurrentView(view)} className={`px-4 py-1.5 rounded-md text-sm font-semibold transition-colors ${currentView === view ? 'bg-emerald-500 text-white shadow' : 'text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'}`}>
                                        {viewMap[view]}
                                        <span className={`ml-1 px-1.5 py-0.5 rounded-full text-xs ${currentView === view ? 'bg-white/20' : 'bg-slate-200 dark:bg-slate-700'}`}>{count}</span>
                                    </button>
                                );
                            })}
                        </div>
                        <div className="flex-grow overflow-y-auto">
                           <ListHeader sortConfig={sortConfig} onRequestSort={handleRequestSort} currentView={currentView}/>
                           {filteredTasks.length > 0 ? (
                                filteredTasks.map((task, index) => <TaskRow key={task.id} task={task} index={index} currentView={currentView} />)
                            ) : (
                                <div className="text-center py-16 text-slate-500 dark:text-slate-400">此视图下没有任务。</div>
                            )}
                        </div>
                    </main>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
