<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>咨询任务管理系统</title>
  <!-- 外部资源 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Tailwind配置（严格匹配原系统色调） -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E50B3', // 原系统主色调
            secondary: '#3694DB',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#F5222D',
            'system-gray': {
              100: '#F5F7FA',
              200: '#E4E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
            }
          },
          fontFamily: {
            sans: ['Microsoft YaHei', 'SimHei', 'sans-serif'],
          },
        },
      }
    }
  </script>

  <style type="text/tailwindcss">
    @layer utilities {
      /* 原系统样式还原 */
      .system-btn {
        @apply px-3 py-1.5 rounded text-sm border transition-all duration-200;
      }
      .system-btn-primary {
        @apply bg-primary text-white border-primary hover:bg-primary/90;
      }
      .system-btn-secondary {
        @apply bg-white text-system-gray-600 border-system-gray-300 hover:bg-system-gray-100;
      }
      .table-header {
        @apply bg-system-gray-100 text-system-gray-600 font-medium;
      }
      .table-row {
        @apply border-b border-system-gray-200 hover:bg-system-gray-50;
      }
      .status-tag {
        @apply px-2 py-0.5 rounded text-xs font-medium;
      }
      .page-container {
        @apply container mx-auto px-4 py-5;
      }
      .card-container {
        @apply bg-white border border-system-gray-200 rounded-md shadow-sm;
      }
    }
  </style>
</head>
<body class="bg-system-gray-100 text-system-gray-600 min-h-screen">
  <!-- 登录页面（还原原系统登录样式） -->
  <div id="login-page" class="min-h-screen flex items-center justify-center bg-system-gray-100 p-4">
    <div class="w-full max-w-md bg-white border border-system-gray-200 rounded-md shadow-md overflow-hidden">
      <div class="bg-primary px-6 py-4 text-white">
        <h2 class="text-xl font-bold">咨询任务管理系统</h2>
        <p class="text-sm opacity-90 mt-1">专业的任务流程管理平台</p>
      </div>
      
      <div class="p-6">
        <div class="mb-4">
          <label class="block text-system-gray-600 mb-1.5 text-sm">邮箱地址</label>
          <input type="email" id="login-email" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
        </div>
        
        <div class="mb-6">
          <label class="block text-system-gray-600 mb-1.5 text-sm">密码</label>
          <input type="password" id="login-password" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
        </div>
        
        <button onclick="handleLogin()" class="w-full system-btn system-btn-primary">
          登录系统
        </button>
        
        <div id="login-error" class="mt-3 text-danger text-sm text-center hidden"></div>
      </div>
    </div>
  </div>

  <!-- 主应用界面 -->
  <div id="app" class="hidden">
    <!-- 顶部导航栏（严格还原原系统布局） -->
    <header class="bg-white border-b border-system-gray-200">
      <div class="page-container py-3">
        <div class="flex justify-between items-center">
          <div>
            <h1 class="text-lg font-bold text-system-gray-800">咨询任务管理系统</h1>
            <p class="text-xs text-system-gray-500 mt-0.5">v2.0 | 企业版</p>
          </div>
          
          <div class="flex items-center gap-6">
            <div class="text-sm">
              <span id="current-date" class="text-system-gray-600"></span>
            </div>
            
            <div class="relative">
              <input type="text" placeholder="搜索..." class="pl-7 pr-3 py-1.5 border border-system-gray-300 rounded-md text-sm w-48 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
              <i class="fa fa-search absolute left-3 top-1/2 -translate-y-1/2 text-system-gray-400 text-sm"></i>
            </div>
            
            <div class="flex items-center gap-3">
              <!-- 通知图标 -->
              <div class="relative cursor-pointer">
                <i class="fa fa-bell-o text-system-gray-600"></i>
                <span class="absolute -top-1 -right-1 w-4 h-4 bg-danger text-white text-xs rounded-full flex items-center justify-center hidden">3</span>
              </div>
              
              <!-- 用户信息 -->
              <div class="flex items-center gap-2">
                <span id="current-user" class="text-sm"></span>
                <button onclick="handleLogout()" class="text-system-gray-500 hover:text-danger text-sm">
                  <i class="fa fa-sign-out"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- 数据备份提醒条（原系统样式） -->
    <div id="backup-alert" class="bg-warning/10 border-l-4 border-warning text-warning px-4 py-2.5 text-sm flex items-center">
      <i class="fa fa-exclamation-circle mr-2"></i>
      <span>数据备份提醒：已超过30天未执行全量备份，请及时处理</span>
      <button onclick="hideBackupAlert()" class="ml-4 text-warning hover:text-warning/80">
        <i class="fa fa-times"></i>
      </button>
    </div>

    <!-- 主内容区 -->
    <main class="page-container">
      <!-- 功能按钮区（严格按原系统顺序排列） -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="btn-team-management" class="system-btn system-btn-secondary flex items-center">
          <i class="fa fa-users mr-1.5"></i> 团队管理
        </button>
        <button id="btn-create-task" class="system-btn system-btn-primary flex items-center">
          <i class="fa fa-plus mr-1.5"></i> 创建任务
        </button>
        <button onclick="exportTasks()" class="system-btn system-btn-secondary flex items-center">
          <i class="fa fa-download mr-1.5"></i> 导出任务
        </button>
        <label class="system-btn system-btn-secondary flex items-center cursor-pointer">
          <i class="fa fa-upload mr-1.5"></i> 导入任务
          <input type="file" id="import-file" accept=".xlsx,.csv" class="hidden" onchange="importTasks(event)">
        </label>
        <button id="btn-statistics" class="system-btn system-btn-secondary flex items-center">
          <i class="fa fa-bar-chart mr-1.5"></i> 统计
        </button>
        <button id="btn-settings" class="system-btn system-btn-secondary flex items-center">
          <i class="fa fa-cog mr-1.5"></i> 管理配置
        </button>
      </div>

      <!-- 任务列表卡片 -->
      <div class="card-container">
        <!-- 表格头部 -->
        <table class="w-full text-sm" cellspacing="0">
          <thead>
            <tr class="table-header">
              <th class="py-3 px-4 text-left w-12">序号</th>
              <th class="py-3 px-4 text-left w-24">任务下达日期</th>
              <th class="py-3 px-4 text-left w-20">任务编号</th>
              <th class="py-3 px-4 text-left">项目名称</th>
              <th class="py-3 px-4 text-left w-24">咨询类型</th>
              <th class="py-3 px-4 text-left w-24">咨询金额</th>
              <th class="py-3 px-4 text-left w-24">咨询人</th>
              <th class="py-3 px-4 text-left w-24">状态</th>
              <th class="py-3 px-4 text-left w-32">操作</th>
            </tr>
          </thead>
          <tbody id="task-table-body">
            <!-- 加载状态 -->
            <tr>
              <td colspan="9" class="py-12 text-center">
                <div class="inline-flex items-center text-system-gray-500">
                  <i class="fa fa-spinner fa-spin mr-2"></i>
                  <span>加载任务数据中...</span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- 分页控件（原系统样式） -->
        <div class="border-t border-system-gray-200 py-3 px-4 flex justify-between items-center">
          <div class="text-sm text-system-gray-500">
            共 <span id="total-tasks">0</span> 条记录
          </div>
          <div class="flex items-center gap-2">
            <button onclick="prevPage()" class="system-btn system-btn-secondary w-8 h-8 p-0 flex items-center justify-center disabled:opacity-50" disabled>
              <i class="fa fa-angle-left"></i>
            </button>
            <div class="flex items-center gap-1">
              <button class="w-8 h-8 flex items-center justify-center rounded bg-primary text-white text-sm">1</button>
              <button class="w-8 h-8 flex items-center justify-center rounded hover:bg-system-gray-100 text-sm">2</button>
              <button class="w-8 h-8 flex items-center justify-center rounded hover:bg-system-gray-100 text-sm">3</button>
            </div>
            <button onclick="nextPage()" class="system-btn system-btn-secondary w-8 h-8 p-0 flex items-center justify-center">
              <i class="fa fa-angle-right"></i>
            </button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- 创建/编辑任务弹窗（原系统风格） -->
  <div id="task-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-md shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="bg-primary px-6 py-3 text-white flex justify-between items-center">
        <h3 id="task-modal-title" class="font-bold">创建任务</h3>
        <button onclick="closeTaskModal()" class="text-white hover:text-white/80">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="p-6">
        <form id="task-form">
          <input type="hidden" id="task-id">
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-system-gray-600 mb-1.5 text-sm">任务编号 <span class="text-danger">*</span></label>
              <input type="text" id="task-number" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary" required>
            </div>
            
            <div>
              <label class="block text-system-gray-600 mb-1.5 text-sm">任务下达日期 <span class="text-danger">*</span></label>
              <input type="date" id="task-date" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary" required>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-system-gray-600 mb-1.5 text-sm">项目名称 <span class="text-danger">*</span></label>
              <input type="text" id="task-project" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary" required>
            </div>
            
            <div>
              <label class="block text-system-gray-600 mb-1.5 text-sm">咨询类型</label>
              <select id="task-type" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
                <option value="技术咨询">技术咨询</option>
                <option value="管理咨询">管理咨询</option>
                <option value="财务咨询">财务咨询</option>
                <option value="法务咨询">法务咨询</option>
                <option value="其他">其他</option>
              </select>
            </div>
            
            <div>
              <label class="block text-system-gray-600 mb-1.5 text-sm">咨询金额</label>
              <input type="number" id="task-amount" step="0.01" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
            </div>
            
            <div>
              <label class="block text-system-gray-600 mb-1.5 text-sm">咨询人</label>
              <input type="text" id="task-consultant" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
            </div>
            
            <div>
              <label class="block text-system-gray-600 mb-1.5 text-sm">状态</label>
              <select id="task-status" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
                <option value="评审中">评审中</option>
                <option value="待分配">待分配</option>
                <option value="进行中">进行中</option>
                <option value="审核中">审核中</option>
                <option value="复核中">复核中</option>
                <option value="待签发">待签发</option>
                <option value="已完成">已完成</option>
              </select>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-system-gray-600 mb-1.5 text-sm">任务描述</label>
              <textarea id="task-description" rows="3" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary"></textarea>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-system-gray-600 mb-1.5 text-sm">负责人（可多选）</label>
              <select id="task-assignees" multiple class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm h-24 focus:outline-none focus:ring-1 focus:ring-primary focus:border-primary">
                <!-- 由JS动态填充 -->
              </select>
              <div class="text-xs text-system-gray-500 mt-1">按住Ctrl键可多选</div>
            </div>
          </div>
        </form>
      </div>
      
      <div class="px-6 pb-6 pt-3 border-t border-system-gray-200 flex justify-end gap-3">
        <button onclick="closeTaskModal()" class="system-btn system-btn-secondary">取消</button>
        <button onclick="saveTaskForm()" class="system-btn system-btn-primary">保存</button>
      </div>
    </div>
  </div>

  <!-- 团队管理弹窗 -->
  <div id="team-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-md shadow-lg w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div class="bg-primary px-6 py-3 text-white flex justify-between items-center">
        <h3 class="font-bold">团队管理</h3>
        <button onclick="closeTeamModal()" class="text-white hover:text-white/80">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <!-- 管理员功能区 -->
      <div id="admin-section" class="p-6 border-b border-system-gray-200 hidden">
        <h4 class="font-medium text-system-gray-800 mb-3">添加新用户</h4>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-system-gray-600 text-xs mb-1.5">邮箱</label>
            <input type="email" id="new-user-email" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm">
          </div>
          <div>
            <label class="block text-system-gray-600 text-xs mb-1.5">角色</label>
            <select id="new-user-role" class="w-full px-3 py-2 border border-system-gray-300 rounded-md text-sm">
              <option value="经理">经理</option>
              <option value="前台客服">前台客服</option>
              <option value="部门负责人">部门负责人</option>
              <option value="项目负责人">项目负责人</option>
              <option value="审核人">审核人</option>
              <option value="复核人">复核人</option>
              <option value="办公室">办公室</option>
            </select>
          </div>
          <div class="flex items-end">
            <button onclick="addNewUser()" class="system-btn system-btn-primary w-full">添加</button>
          </div>
        </div>
      </div>
      
      <!-- 用户列表 -->
      <div class="p-6">
        <h4 class="font-medium text-system-gray-800 mb-3">用户权限配置</h4>
        <div id="user-list" class="space-y-3">
          <!-- 用户项将通过JS动态生成 -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Supabase配置（使用你的项目信息）
    const supabaseUrl = "https://gpcsknsnwatqqcnywuiv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY";
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    // 全局变量
    let currentUser = null;
    let currentPermissions = {
      canCreate: false,
      canEdit: false,
      canDelete: false,
      canAssign: false,
      isAdmin: false
    };
    let allUsers = [];
    let tasks = [];
    let currentPage = 1;
    const pageSize = 10;

    // 页面加载初始化
    document.addEventListener('DOMContentLoaded', async () => {
      // 设置当前日期
      document.getElementById('current-date').textContent = new Date().toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long'
      });

      // 检查登录状态
      const { data } = await sb.auth.getSession();
      if (data.session) {
        currentUser = data.session.user;
        await initApp();
      } else {
        document.getElementById('login-page').classList.remove('hidden');
      }

      // 监听登录状态变化
      sb.auth.onAuthStateChange((_event, session) => {
        if (session) {
          currentUser = session.user;
          initApp();
        } else {
          currentUser = null;
          document.getElementById('login-page').classList.remove('hidden');
          document.getElementById('app').classList.add('hidden');
        }
      });
    });

    // 初始化应用
    async function initApp() {
      try {
        // 切换显示状态
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        
        // 显示用户信息
        document.getElementById('current-user').textContent = currentUser.email;
        
        // 加载用户权限
        await loadUserPermissions();
        
        // 加载所有用户
        await loadAllUsers();
        
        // 加载任务列表
        await loadTasks();
        
        // 显示备份提醒
        document.getElementById('backup-alert').classList.remove('hidden');
        
        // 绑定按钮事件
        document.getElementById('btn-create-task').addEventListener('click', createTask);
        document.getElementById('btn-team-management').addEventListener('click', openTeamModal);
      } catch (error) {
        console.error('初始化失败:', error);
        alert('系统初始化失败: ' + error.message);
      }
    }

    // 登录处理
    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      
      errorEl.classList.add('hidden');
      
      if (!email || !password) {
        errorEl.textContent = '请输入邮箱和密码';
        errorEl.classList.remove('hidden');
        return;
      }
      
      try {
        const { error } = await sb.auth.signInWithPassword({ email, password });
        if (error) throw error;
      } catch (error) {
        errorEl.textContent = '登录失败: ' + error.message;
        errorEl.classList.remove('hidden');
      }
    }

    // 退出登录
    async function handleLogout() {
      try {
        await sb.auth.signOut();
      } catch (error) {
        alert('退出登录失败: ' + error.message);
      }
    }

    // 加载用户权限
    async function loadUserPermissions() {
      try {
        // 获取用户角色和管理员状态
        const { data: userData } = await sb
          .from('users')
          .select('role, is_admin')
          .eq('id', currentUser.id)
          .single();
          
        currentPermissions.isAdmin = userData.is_admin || false;
        
        // 控制按钮显示
        document.getElementById('btn-team-management').style.display = currentPermissions.isAdmin ? 'inline-flex' : 'none';
        document.getElementById('admin-section').classList.toggle('hidden', !currentPermissions.isAdmin);
        
        // 默认给管理员所有权限
        if (currentPermissions.isAdmin) {
          currentPermissions.canCreate = true;
          currentPermissions.canEdit = true;
          currentPermissions.canDelete = true;
          currentPermissions.canAssign = true;
        } else {
          // 普通用户查询权限表
          const { data: permData } = await sb
            .from('permissions')
            .select('can_create, can_edit, can_delete, can_assign')
            .eq('user_id', currentUser.id)
            .single();
            
          if (permData) {
            currentPermissions.canCreate = permData.can_create;
            currentPermissions.canEdit = permData.can_edit;
            currentPermissions.canDelete = permData.can_delete;
            currentPermissions.canAssign = permData.can_assign;
          }
        }
        
        // 控制创建任务按钮显示
        document.getElementById('btn-create-task').style.display = currentPermissions.canCreate ? 'inline-flex' : 'none';
        
      } catch (error) {
        console.error('加载权限失败:', error);
        // 出错时默认给基础权限
        currentPermissions.canCreate = true;
        currentPermissions.canEdit = true;
      }
    }

    // 加载所有用户
    async function loadAllUsers() {
      try {
        const { data } = await sb.from('users').select('id, email, role, is_admin');
        allUsers = data || [];
        
        // 填充负责人选择框
        const assigneeSelect = document.getElementById('task-assignees');
        assigneeSelect.innerHTML = allUsers.map(user => `
          <option value="${user.id}">${user.email} (${user.role})</option>
        `).join('');
        
        // 渲染用户列表（团队管理）
        renderUserList();
      } catch (error) {
        console.error('加载用户列表失败:', error);
        alert('加载用户列表失败: ' + error.message);
      }
    }

    // 渲染用户列表
    function renderUserList() {
      const container = document.getElementById('user-list');
      if (!container) return;
      
      container.innerHTML = allUsers.map(user => `
        <div class="p-3 border border-system-gray-200 rounded-md">
          <div class="flex justify-between items-start mb-2">
            <div>
              <div class="font-medium text-sm">${user.email}</div>
              <div class="text-xs text-system-gray-500">角色: ${user.role} ${user.is_admin ? '(管理员)' : ''}</div>
            </div>
          </div>
          
          ${!user.is_admin ? `
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
              <label class="flex items-center">
                <input type="checkbox" 
                  onchange="updateUserPermission('${user.id}', 'can_create', this.checked)"
                  ${getUserPermission(user.id, 'can_create') ? 'checked' : ''}>
                <span class="ml-1">创建任务</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" 
                  onchange="updateUserPermission('${user.id}', 'can_assign', this.checked)"
                  ${getUserPermission(user.id, 'can_assign') ? 'checked' : ''}>
                <span class="ml-1">分配任务</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" 
                  onchange="updateUserPermission('${user.id}', 'can_edit', this.checked)"
                  ${getUserPermission(user.id, 'can_edit') ? 'checked' : ''}>
                <span class="ml-1">编辑任务</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" 
                  onchange="updateUserPermission('${user.id}', 'can_delete', this.checked)"
                  ${getUserPermission(user.id, 'can_delete') ? 'checked' : ''}>
                <span class="ml-1">删除任务</span>
              </label>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // 获取用户权限
    function getUserPermission(userId, permission) {
      const user = allUsers.find(u => u.id === userId);
      if (user?.is_admin) return true;
      return false;
    }

    // 更新用户权限
    async function updateUserPermission(userId, permission, value) {
      try {
        const { data: existing } = await sb
          .from('permissions')
          .select('id')
          .eq('user_id', userId)
          .single();
          
        if (existing) {
          await sb.from('permissions').update({ [permission]: value }).eq('id', existing.id);
        } else {
          await sb.from('permissions').insert([{ user_id: userId, [permission]: value }]);
        }
      } catch (error) {
        console.error('更新权限失败:', error);
        alert('更新权限失败: ' + error.message);
      }
    }

    // 添加新用户
    async function addNewUser() {
      const email = document.getElementById('new-user-email').value;
      const role = document.getElementById('new-user-role').value;
      
      if (!email) {
        alert('请输入用户邮箱');
        return;
      }
      
      try {
        // 创建用户
        const { data: authData } = await sb.auth.admin.createUser({
          email,
          password: '123456',
          email_confirm: true
        });
        
        // 保存用户信息
        await sb.from('users').insert([{
          id: authData.user.id,
          email,
          role,
          is_admin: false
        }]);
        
        // 初始化权限
        await sb.from('permissions').insert([{
          user_id: authData.user.id,
          can_create: false,
          can_assign: false,
          can_edit: false,
          can_delete: false
        }]);
        
        loadAllUsers();
        document.getElementById('new-user-email').value = '';
        alert('用户添加成功，初始密码：123456');
      } catch (error) {
        console.error('添加用户失败:', error);
        alert('添加用户失败: ' + error.message);
      }
    }

    // 加载任务列表
    async function loadTasks() {
      try {
        const { data } = await sb.from('tasks').select('*').order('date', { ascending: false });
        tasks = data || [];
        renderTaskTable();
      } catch (error) {
        console.error('加载任务失败:', error);
        document.getElementById('task-table-body').innerHTML = `
          <tr>
            <td colspan="9" class="py-12 text-center text-danger">
              加载任务数据失败: ${error.message}
            </td>
          </tr>
        `;
      }
    }

    // 渲染任务表格
    function renderTaskTable() {
      const container = document.getElementById('task-table-body');
      const totalTasksEl = document.getElementById('total-tasks');
      
      totalTasksEl.textContent = tasks.length;
      
      if (tasks.length === 0) {
        container.innerHTML = `
          <tr>
            <td colspan="9" class="py-12 text-center text-system-gray-500">
              暂无任务数据
            </td>
          </tr>
        `;
        return;
      }
      
      // 分页处理（当前只显示第一页）
      const paginatedTasks = tasks.slice(0, pageSize);
      
      container.innerHTML = paginatedTasks.map((task, index) => `
        <tr class="table-row">
          <td class="py-3 px-4">${index + 1}</td>
          <td class="py-3 px-4">${formatDate(task.date)}</td>
          <td class="py-3 px-4 font-medium">${task.number || '-'}</td>
          <td class="py-3 px-4">${task.project || '-'}</td>
          <td class="py-3 px-4">${task.type || '-'}</td>
          <td class="py-3 px-4">${task.amount ? '¥' + task.amount : '-'}</td>
          <td class="py-3 px-4">${task.consultant || '-'}</td>
          <td class="py-3 px-4">
            <span class="status-tag ${getStatusClass(task.status)}">${task.status || '-'}</span>
          </td>
          <td class="py-3 px-4">
            <div class="flex gap-1">
              ${currentPermissions.canEdit ? `
                <button onclick="editTask('${task.id}')" class="text-primary hover:text-primary/80 p-1" title="编辑">
                  <i class="fa fa-pencil"></i>
                </button>
              ` : ''}
              ${currentPermissions.canAssign ? `
                <button onclick="assignTask('${task.id}')" class="text-secondary hover:text-secondary/80 p-1" title="分配">
                  <i class="fa fa-user-plus"></i>
                </button>
              ` : ''}
              ${currentPermissions.canEdit ? `
                <button onclick="nextStatus('${task.id}')" class="text-success hover:text-success/80 p-1" title="下一步">
                  <i class="fa fa-arrow-right"></i>
                </button>
              ` : ''}
              ${currentPermissions.canDelete ? `
                <button onclick="deleteTask('${task.id}')" class="text-danger hover:text-danger/80 p-1" title="删除">
                  <i class="fa fa-trash"></i>
                </button>
              ` : ''}
            </div>
          </td>
        </tr>
      `).join('');
    }

    // 获取状态标签样式
    function getStatusClass(status) {
      const statusClasses = {
        '评审中': 'bg-purple-100 text-purple-800',
        '待分配': 'bg-yellow-100 text-yellow-800',
        '进行中': 'bg-blue-100 text-blue-800',
        '审核中': 'bg-indigo-100 text-indigo-800',
        '复核中': 'bg-teal-100 text-teal-800',
        '待签发': 'bg-cyan-100 text-cyan-800',
        '已完成': 'bg-green-100 text-green-800'
      };
      return statusClasses[status] || 'bg-gray-100 text-gray-800';
    }

    // 分页控制
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTaskTable();
      }
    }

    function nextPage() {
      const totalPages = Math.ceil(tasks.length / pageSize);
      if (currentPage < totalPages) {
        currentPage++;
        renderTaskTable();
      }
    }

    // 创建任务
    function createTask() {
      document.getElementById('task-modal-title').textContent = '创建任务';
      document.getElementById('task-form').reset();
      document.getElementById('task-id').value = '';
      document.getElementById('task-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('task-status').value = '评审中';
      document.getElementById('task-modal').classList.remove('hidden');
      document.getElementById('task-modal').classList.add('flex');
    }

    // 编辑任务
    async function editTask(taskId) {
      try {
        const { data: task } = await sb
          .from('tasks')
          .select('*')
          .eq('id', taskId)
          .single();
          
        document.getElementById('task-modal-title').textContent = '编辑任务';
        document.getElementById('task-id').value = task.id;
        document.getElementById('task-number').value = task.number || '';
        document.getElementById('task-date').value = task.date || '';
        document.getElementById('task-project').value = task.project || '';
        document.getElementById('task-type').value = task.type || '技术咨询';
        document.getElementById('task-amount').value = task.amount || '';
        document.getElementById('task-consultant').value = task.consultant || '';
        document.getElementById('task-status').value = task.status || '评审中';
        document.getElementById('task-description').value = task.description || '';
        
        // 选中负责人
        const assigneeSelect = document.getElementById('task-assignees');
        Array.from(assigneeSelect.options).forEach(option => {
          option.selected = task.assignees && task.assignees.includes(option.value);
        });
        
        document.getElementById('task-modal').classList.remove('hidden');
        document.getElementById('task-modal').classList.add('flex');
      } catch (error) {
        console.error('获取任务详情失败:', error);
        alert('获取任务详情失败: ' + error.message);
      }
    }

    // 保存任务表单
    async function saveTaskForm() {
      const taskId = document.getElementById('task-id').value;
      const taskData = {
        number: document.getElementById('task-number').value,
        date: document.getElementById('task-date').value,
        project: document.getElementById('task-project').value,
        type: document.getElementById('task-type').value,
        amount: document.getElementById('task-amount').value,
        consultant: document.getElementById('task-consultant').value,
        status: document.getElementById('task-status').value,
        description: document.getElementById('task-description').value,
        assignees: Array.from(document.getElementById('task-assignees').selectedOptions).map(option => option.value)
      };
      
      // 验证必填项
      if (!taskData.number || !taskData.date || !taskData.project) {
        alert('请填写必填字段（带*号）');
        return;
      }
      
      try {
        if (taskId) {
          await sb.from('tasks').update(taskData).eq('id', taskId);
        } else {
          await sb.from('tasks').insert([{
            ...taskData,
            created_by: currentUser.id
          }]);
        }
        
        closeTaskModal();
        loadTasks();
        alert(taskId ? '任务更新成功' : '任务创建成功');
      } catch (error) {
        console.error('保存任务失败:', error);
        alert('保存任务失败: ' + error.message);
      }
    }

    // 分配任务
    async function assignTask(taskId) {
      try {
        const { data: task } = await sb
          .from('tasks')
          .select('id, project, assignees')
          .eq('id', taskId)
          .single();
          
        document.getElementById('task-modal-title').textContent = `分配任务: ${task.project}`;
        document.getElementById('task-id').value = task.id;
        
        // 隐藏不需要的字段
        hideTaskFormFields(['task-number', 'task-date', 'task-project', 'task-type', 'task-amount', 'task-consultant', 'task-status', 'task-description']);
        
        // 显示负责人字段
        document.getElementById('task-assignees').closest('div').classList.remove('hidden');
        
        // 选中当前负责人
        const assigneeSelect = document.getElementById('task-assignees');
        Array.from(assigneeSelect.options).forEach(option => {
          option.selected = task.assignees && task.assignees.includes(option.value);
        });
        
        document.getElementById('task-modal').classList.remove('hidden');
        document.getElementById('task-modal').classList.add('flex');
      } catch (error) {
        console.error('分配任务失败:', error);
        alert('分配任务失败: ' + error.message);
      }
    }

    // 任务进入下一状态
    async function nextStatus(taskId) {
      try {
        const { data: task } = await sb
          .from('tasks')
          .select('id, status, project')
          .eq('id', taskId)
          .single();
          
        const statusFlow = {
          '评审中': '待分配',
          '待分配': '进行中',
          '进行中': '审核中',
          '审核中': '复核中',
          '复核中': '待签发',
          '待签发': '已完成'
        };
        
        const nextStatus = statusFlow[task.status];
        if (!nextStatus) {
          alert('此任务已处于最终状态，无法继续推进');
          return;
        }
        
        if (confirm(`确定要将任务"${task.project}"从"${task.status}"推进到"${nextStatus}"吗？`)) {
          await sb.from('tasks').update({ status: nextStatus }).eq('id', taskId);
          loadTasks();
        }
      } catch (error) {
        console.error('更新任务状态失败:', error);
        alert('更新任务状态失败: ' + error.message);
      }
    }

    // 删除任务
    async function deleteTask(taskId) {
      try {
        const { data: task } = await sb
          .from('tasks')
          .select('project')
          .eq('id', taskId)
          .single();
          
        if (confirm(`确定要删除任务"${task.project}"吗？此操作不可恢复。`)) {
          await sb.from('tasks').delete().eq('id', taskId);
          loadTasks();
          alert('任务已删除');
        }
      } catch (error) {
        console.error('删除任务失败:', error);
        alert('删除任务失败: ' + error.message);
      }
    }

    // 隐藏任务表单字段
    function hideTaskFormFields(fieldIds) {
      fieldIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.closest('div').classList.add('hidden');
        }
      });
    }

    // 显示所有任务表单字段
    function showAllTaskFormFields() {
      document.querySelectorAll('#task-form div[class*="col-span-"]').forEach(div => {
        div.classList.remove('hidden');
      });
    }

    // 关闭任务弹窗
    function closeTaskModal() {
      document.getElementById('task-modal').classList.add('hidden');
      document.getElementById('task-modal').classList.remove('flex');
      showAllTaskFormFields(); // 恢复显示所有字段
    }

    // 导出任务
    function exportTasks() {
      alert('导出功能已触发，实际项目中会生成Excel文件');
    }

    // 导入任务
    function importTasks(event) {
      alert('导入功能已触发，实际项目中会处理上传的Excel文件');
      event.target.value = ''; // 重置
    }

    // 团队管理弹窗控制
    function openTeamModal() {
      document.getElementById('team-modal').classList.remove('hidden');
      document.getElementById('team-modal').classList.add('flex');
    }

    function closeTeamModal() {
      document.getElementById('team-modal').classList.add('hidden');
      document.getElementById('team-modal').classList.remove('flex');
    }

    // 隐藏备份提醒
    function hideBackupAlert() {
      document.getElementById('backup-alert').classList.add('hidden');
    }

    // 格式化日期
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN');
    }
  </script>
</body>
</html>
