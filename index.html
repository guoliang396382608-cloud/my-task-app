<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 引入 Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入 Font Awesome 图标库 -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- 引入 Supabase JS 库 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <title>任务管理系统（完整版）</title>

  <script>
    // 初始化 Supabase 客户端，使用你提供的项目信息
    const supabaseUrl = "https://gpcsknsnwatqqcnywuiv.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdwY3NrbnNud2F0cXFjbnl3dWl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzc5MTMsImV4cCI6MjA2OTk1MzkxM30.M-02UaHW22nU0MLmRtiIIlcmb7tnceoisFIkTK05NCY";
    const sb = window.supabase.createClient(supabaseUrl, supabaseKey);

    // 全局变量，存储当前用户和权限信息
    let currentUser = null;
    let currentPermissions = null;
    let allUsers = [];

    // 页面加载完成后执行的初始化逻辑
    document.addEventListener('DOMContentLoaded', async () => {
      // 检查用户登录状态
      const { data } = await sb.auth.getSession();
      if (data.session) {
        currentUser = data.session.user;
        await initApp();
      } else {
        // 显示登录遮罩层
        document.getElementById('login-mask').classList.remove('hidden');
      }

      // 监听登录状态变化，状态改变时更新页面
      sb.auth.onAuthStateChange((_event, session) => {
        if (session) {
          currentUser = session.user;
          initApp();
        } else {
          currentUser = null;
          document.getElementById('login-mask').classList.remove('hidden');
          document.getElementById('app').classList.add('hidden');
        }
      });
    });

    // 登录功能函数
    async function handleLogin() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorEl = document.getElementById('login-error');
      errorEl.classList.add('hidden');

      if (!email || !password) {
        errorEl.textContent = '请输入邮箱和密码';
        errorEl.classList.remove('hidden');
        return;
      }

      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        errorEl.textContent = '登录失败：' + error.message;
        errorEl.classList.remove('hidden');
      }
    }

    // 退出登录功能函数
    async function handleLogout() {
      await sb.auth.signOut();
    }

    // 应用初始化函数，登录后执行
    async function initApp() {
      document.getElementById('login-mask').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      document.getElementById('current-user').textContent = currentUser.email;

      await loadUserPermissions();
      await loadAllUsers();
      await loadTasks();
      subscribeToTasks();
    }

    // 加载用户权限函数
    async function loadUserPermissions() {
      const { data } = await sb
        .from('permissions')
        .select('*')
        .eq('user_id', currentUser.id)
        .single();

      currentPermissions = data || {
        can_create: false,
        can_assign: false,
        can_edit: false,
        can_delete: false,
        visible_statuses: []
      };

      document.getElementById('btn-create-task').style.display = currentPermissions.can_create ? 'flex' : 'none';

      const { data: userData } = await sb
        .from('users')
        .select('is_admin')
        .eq('id', currentUser.id)
        .single();

      if (userData.is_admin) {
        document.getElementById('btn-team-management').style.display = 'flex';
        document.getElementById('admin-add-user').classList.remove('hidden');
      }
    }

    // 加载所有用户信息函数（用于团队管理）
    async function loadAllUsers() {
      const { data } = await sb.from('users').select('*');
      allUsers = data || [];
      renderUserPermissionsList();
    }

    // 渲染用户权限列表函数（团队管理页面）
    function renderUserPermissionsList() {
      const container = document.getElementById('user-permissions-list');
      if (!container) return;

      container.innerHTML = allUsers.map(user => `
        <div class="p-3 border rounded-md">
          <div class="flex justify-between items-start mb-3">
            <div>
              <div class="font-medium text-sm">${user.email}</div>
              <div class="text-xs text-gray-500">角色：${user.role} ${user.is_admin ? '(系统管理者)' : ''}</div>
            </div>
          </div>

          ${!user.is_admin ? `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
              <label class="flex items-center">
                <input type="checkbox" onchange="updateUserPermission('${user.id}', 'can_create', this.checked)" 
                  ${getUserPermission(user.id, 'can_create') ? 'checked' : ''}>
                <span class="ml-1">创建任务</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" onchange="updateUserPermission('${user.id}', 'can_assign', this.checked)"
                  ${getUserPermission(user.id, 'can_assign') ? 'checked' : ''}>
                <span class="ml-1">分配任务</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" onchange="updateUserPermission('${user.id}', 'can_edit', this.checked)"
                  ${getUserPermission(user.id, 'can_edit') ? 'checked' : ''}>
                <span class="ml-1">编辑任务</span>
              </label>
              <label class="flex items-center">
                <input type="checkbox" onchange="updateUserPermission('${user.id}', 'can_delete', this.checked)"
                  ${getUserPermission(user.id, 'can_delete') ? 'checked' : ''}>
                <span class="ml-1">删除任务</span>
              </label>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    // 获取用户权限辅助函数
    function getUserPermission(userId, permission) {
      const user = allUsers.find(u => u.id === userId);
      if (user?.is_admin) return true;
      return currentPermissions[permission] || false;
    }

    // 更新用户权限函数
    async function updateUserPermission(userId, permission, value) {
      const { data: permData } = await sb
        .from('permissions')
        .select('id')
        .eq('user_id', userId)
        .single();

      if (permData) {
        await sb
          .from('permissions')
          .update({ [permission]: value })
          .eq('id', permData.id);
      } else {
        await sb
          .from('permissions')
          .insert([{ user_id: userId, [permission]: value }]);
      }
    }

    // 添加新用户函数（管理员功能）
    async function addUser() {
      const email = document.getElementById('new-user-email').value;
      const role = document.getElementById('new-user-role').value;

      if (!email) {
        alert('请输入用户邮箱');
        return;
      }

      try {
        const { data: authData } = await sb.auth.admin.createUser({
          email,
          password: '123456',
          email_confirm: true
        });

        await sb.from('users').insert([{
          id: authData.user.id,
          email,
          role,
          is_admin: false
        }]);

        await sb.from('permissions').insert([{
          user_id: authData.user.id,
          can_create: false,
          can_assign: false,
          can_edit: false,
          can_delete: false
        }]);

        loadAllUsers();
        document.getElementById('new-user-email').value = '';
        alert('用户添加成功，初始密码：123456');
      } catch (error) {
        alert('添加失败：' + error.message);
      }
    }

    // 加载任务列表函数（按状态分组）
    async function loadTasks() {
      const { data } = await sb.from('tasks').select('*');
      const tasks = data || [];

      const statusConfig = [
        { status: '评审中', id: 'tasks-reviewing', countId: 'count-reviewing' },
        { status: '待分配', id: 'tasks-to-assign', countId: 'count-to-assign' },
        { status: '进行中', id: 'tasks-in-progress', countId: 'count-in-progress' },
        { status: '审核中', id: 'tasks-reviewing-2', countId: 'count-reviewing-2' },
        { status: '复核中', id: 'tasks-rechecking', countId: 'count-rechecking' },
        { status: '待签发', id: 'tasks-to-sign', countId: 'count-to-sign' },
        { status: '已完成', id: 'tasks-completed', countId: 'count-completed' }
      ];

      statusConfig.forEach(({ status, id, countId }) => {
        const tasksOfStatus = tasks.filter(task => task.status === status);
        const container = document.getElementById(id);
        const countEl = document.getElementById(countId);

        countEl.textContent = tasksOfStatus.length;

        container.innerHTML = tasksOfStatus.map(task => `
          <div class="task-card border-primary" onclick="showTaskActions('${task.id}')">
            <div class="font-medium text-sm mb-1">${task.title}</div>
            <div class="text-xs text-gray-500 mb-2 line-clamp-2">${task.description || '无描述'}</div>
            <div class="flex justify-between items-center">
              <div class="text-xs text-gray-400">
                ${task.due_date ? `截止：${formatDate(task.due_date)}` : ''}
              </div>
              ${task.assignees && task.assignees.length > 0 ? `
                <div class="text-xs bg-gray-100 px-1.5 py-0.5 rounded">
                  ${getAssigneeNames(task.assignees)}
                </div>
              ` : ''}
            </div>
          </div>
        `).join('');
      });

      updateNotifications(tasks);
    }

    // 显示任务操作弹窗函数
    async function showTaskActions(taskId) {
      currentTaskId = taskId;
      const { data: task } = await sb
        .from('tasks')
        .select('*')
        .eq('id', taskId)
        .single();

      let actionsHtml = '';

      if (currentPermissions.can_edit) {
        actionsHtml += `<button onclick="setAction('edit')" class="w-full text-left btn-action bg-gray-100 mb-1">
          <i class="fa fa-pencil mr-1"></i> 编辑任务
        </button>`;
      }

      if (currentPermissions.can_assign && task.status === '评审中') {
        actionsHtml += `<button onclick="setAction('assign')" class="w-full text-left btn-action bg-blue-100 mb-1">
          <i class="fa fa-user-plus mr-1"></i> 分配任务
        </button>`;
      }

      if (currentPermissions.can_edit) {
        const nextStatus = getNextStatus(task.status);
        if (nextStatus) {
          actionsHtml += `<button onclick="setAction('submit')" class="w-full text-left btn-action bg-green-100 mb-1">
            <i class="fa fa-arrow-right mr-1"></i> 提交至${nextStatus}
          </button>`;
        }
      }

      if (currentPermissions.can_edit && task.status !== '评审中') {
        actionsHtml += `<button onclick="setAction('return')" class="w-full text-left btn-action bg-yellow-100 mb-1">
          <i class="fa fa-arrow-left mr-1"></i> 退回任务
        </button>`;
      }

      if (currentPermissions.can_delete) {
        actionsHtml += `<button onclick="setAction('delete')" class="w-full text-left btn-action bg-red-100">
          <i class="fa fa-trash mr-1"></i> 删除任务
        </button>`;
      }

      document.getElementById('task-action-title').textContent = `操作：${task.title}`;
      document.getElementById('task-action-content').innerHTML = actionsHtml;
      document.getElementById('task-action-modal').classList.remove('hidden');
      document.getElementById('task-action-modal').classList.add('flex');
    }

    // 设置当前操作函数
    function setAction(action) {
      currentAction = action;
      document.getElementById('task-action-modal').classList.add('hidden');

      switch (action) {
        case 'edit':
          showEditTaskForm();
          break;
        case 'assign':
          showAssignTaskForm();
          break;
        case 'submit':
          confirmSubmitTask();
          break;
        case 'return':
          showReturnTaskForm();
          break;
        case 'delete':
          confirmDeleteTask();
          break;
      }
    }

    // 编辑任务函数
    async function showEditTaskForm() {
      const { data: task } = await sb
        .from('tasks')
        .select('*')
        .eq('id', currentTaskId)
        .single();

      document.getElementById('task-title').value = task.title;
      document.getElementById('task-description').value = task.description || '';
      document.getElementById('task-due-date').value = task.due_date || '';

      const confirmBtn = document.querySelector('#create-task-modal button:last-child');
      confirmBtn.onclick = async () => {
        const updatedData = {
          title: document.getElementById('task-title').value,
          description: document.getElementById('task-description').value,
          due_date: document.getElementById('task-due-date').value
        };

        await sb.from('tasks').update(updatedData).eq('id', currentTaskId);
        hideCreateTaskModal();
      };

      document.getElementById('create-task-modal').classList.remove('hidden');
      document.getElementById('create-task-modal').classList.add('flex');
    }

    // 分配任务函数
    function showAssignTaskForm() {
      const userOptions = allUsers.map(user => `
        <option value="${user.id}">${user.email} (${user.role})</option>
      `).join('');

      const content = `
        <div class="mb-3">
          <label class="block text-gray-700 text-sm mb-1">选择负责人（可多选）</label>
          <select id="assign-users" class="w-full px-3 py-2 border border-gray-300 rounded text-sm" multiple size="4">
            ${userOptions}
          </select>
          <div class="text-xs text-gray-500 mt-1">按住Ctrl键可多选</div>
        </div>
      `;

      document.getElementById('task-action-title').textContent = '分配任务';
      document.getElementById('task-action-content').innerHTML = content;
      document.getElementById('task-action-confirm').onclick = saveAssignedUsers;
      document.getElementById('task-action-modal').classList.remove('hidden');
      document.getElementById('task-action-modal').classList.add('flex');
    }

    // 保存分配的用户函数
    async function saveAssignedUsers() {
      const selectEl = document.getElementById('assign-users');
      const assignees = Array.from(selectEl.selectedOptions).map(option => option.value);

      if (assignees.length === 0) {
        alert('请至少选择一位负责人');
        return;
      }

      await sb.from('tasks')
        .update({ assignees, status: '待分配' })
        .eq('id', currentTaskId);

      hideTaskActionModal();
    }

    // 提交任务函数（进入下一步）
    async function confirmSubmitTask() {
      const { data: task } = await sb
        .from('tasks')
        .select('status')
        .eq('
